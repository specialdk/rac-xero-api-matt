<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RAC Mining - Executive Dashboard</title>
    <!-- Chart.js for visualizations v3-->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* ========== CSS VARIABLES (Design System) ========== */
      :root {
        /* Semantic Colors */
        --color-positive: #107C10;
        --color-negative: #D13438;
        --color-warning: #FFB900;
        --color-primary: #0078D4;
        --color-primary-dark: #106EBE;
        
        /* Neutrals */
        --color-text-primary: #201F1E;
        --color-text-secondary: #605E5C;
        --color-text-muted: #8A8886;
        --color-border: #EDEBE9;
        
        /* Surfaces */
        --bg-page: #F5F5F5;
        --bg-card: #FFFFFF;
        --bg-header: #2C3E50;
        
        /* Shadows */
        --shadow-card: 0 2px 4px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
        --shadow-card-hover: 0 4px 12px rgba(0,0,0,0.12), 0 2px 4px rgba(0,0,0,0.08);
        --shadow-drawer: -4px 0 24px rgba(0,0,0,0.15);
        
        /* Typography */
        --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        --font-size-kpi: 36px;
        --font-size-kpi-secondary: 24px;
        --font-size-label: 12px;
        --font-size-body: 14px;
        --font-size-heading: 18px;
        
        /* Spacing */
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;
        
        /* Layout */
        --header-height: 56px;
        --drawer-width: 420px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: var(--font-family);
        background: var(--bg-page);
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      /* ========== HEADER ========== */
      .header {
        background: var(--bg-header);
        height: var(--header-height);
        padding: 0 var(--spacing-lg);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
      }

      .header h1 {
        font-size: 18px;
        font-weight: 600;
        color: white;
      }

      .header-status {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: 5px 12px;
        background: rgba(255,255,255,0.1);
        border-radius: 20px;
        font-size: 12px;
        color: rgba(255,255,255,0.9);
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--color-positive);
      }

      .status-dot.warning { background: var(--color-warning); }
      .status-dot.critical { background: var(--color-negative); }

      .header-right {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
      }

      .period-selector {
        padding: 6px 14px;
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 6px;
        font-size: 13px;
        background: rgba(255,255,255,0.1);
        color: white;
        cursor: pointer;
      }

      .period-selector option {
        background: var(--bg-header);
        color: white;
      }

      .btn-refresh {
        padding: 6px 16px;
        background: var(--color-primary);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
      }

      .btn-refresh:hover {
        background: var(--color-primary-dark);
      }

      .btn-chat {
        padding: 6px 14px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
      }

.btn-snapshot {
        padding: 6px 14px;
        background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
      }

      .btn-snapshot:disabled {
        background: #9CA3AF;
        cursor: not-allowed;
      }

      .btn-snapshot.running {
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }

      .snapshot-status {
        font-size: 11px;
        color: rgba(255,255,255,0.8);
        margin-left: 4px;
      }

      .snapshot-status.success { color: #34D399; }
      .snapshot-status.error { color: #F87171; }




      /* ========== MAIN LAYOUT ========== */
      .main-container {
        flex: 1;
        display: flex;
        overflow: hidden;
      }

      .dashboard {
        flex: 1;
        padding: var(--spacing-md);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      /* ========== KPI ROW (Top) ========== */
      .kpi-row {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: var(--spacing-md);
      }

      .kpi-card {
        background: var(--bg-card);
        border-radius: 10px;
        padding: var(--spacing-md);
        box-shadow: var(--shadow-card);
        cursor: pointer;
        transition: box-shadow 0.2s, transform 0.2s;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .kpi-card:hover {
        box-shadow: var(--shadow-card-hover);
        transform: translateY(-2px);
      }

      .kpi-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }

      .kpi-label {
        font-size: var(--font-size-label);
        font-weight: 500;
        color: var(--color-text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .kpi-arrow {
        color: var(--color-text-muted);
        opacity: 0;
        transition: opacity 0.2s;
        font-size: 14px;
      }

      .kpi-card:hover .kpi-arrow {
        opacity: 1;
      }

      .kpi-value {
        font-size: var(--font-size-kpi);
        font-weight: 600;
        color: var(--color-text-primary);
        line-height: 1.1;
        font-variant-numeric: tabular-nums;
        margin: var(--spacing-xs) 0;
      }

      .kpi-value.smaller {
        font-size: var(--font-size-kpi-secondary);
      }

      .kpi-trend {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: 12px;
        font-weight: 500;
      }

      .kpi-trend.positive { color: var(--color-positive); }
      .kpi-trend.negative { color: var(--color-negative); }
      .kpi-trend.neutral { color: var(--color-text-muted); }

      .kpi-sparkline {
        flex: 1;
        min-height: 40px;
        margin-top: var(--spacing-sm);
      }

      .kpi-sparkline canvas {
        width: 100% !important;
        height: 100% !important;
      }

      /* Status indicator bar at bottom of card */
      .kpi-status-bar {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
      }

      .kpi-status-bar.healthy { background: var(--color-positive); }
      .kpi-status-bar.warning { background: var(--color-warning); }
      .kpi-status-bar.critical { background: var(--color-negative); }

      /* ========== CHART ROW (Full Width) ========== */
      .chart-row {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: var(--spacing-md);
        min-height: 200px;
      }

      .chart-card {
        background: var(--bg-card);
        border-radius: 10px;
        padding: var(--spacing-md);
        box-shadow: var(--shadow-card);
        display: flex;
        flex-direction: column;
      }

      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-sm);
      }

      .chart-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--color-text-primary);
      }

      .chart-subtitle {
        font-size: 11px;
        color: var(--color-text-muted);
      }

      .chart-legend {
        display: flex;
        gap: var(--spacing-md);
        font-size: 11px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 4px;
        color: var(--color-text-secondary);
      }

      .legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 2px;
      }

      .chart-container {
        flex: 1;
        position: relative;
        min-height: 150px;
      }

      /* ========== BUDGET HORIZONTAL BARS ========== */
      .budget-bars-container {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
        padding: var(--spacing-sm) 0;
      }

      .budget-bar-item {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .budget-bar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
      }

      .budget-bar-label {
        font-weight: 500;
        color: var(--color-text-primary);
      }

      .budget-bar-values {
        display: flex;
        gap: var(--spacing-sm);
        align-items: center;
      }

      .budget-bar-actual {
        font-weight: 600;
        color: var(--color-text-primary);
      }

      .budget-bar-target {
        color: var(--color-text-muted);
        font-size: 12px;
      }

      .budget-bar-variance {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
      }

      .budget-bar-variance.positive {
        background: #E6F4EA;
        color: var(--color-positive);
      }

      .budget-bar-variance.negative {
        background: #FDECE9;
        color: var(--color-negative);
      }

      .budget-bar-track {
        height: 24px;
        background: var(--color-border);
        border-radius: 4px;
        position: relative;
        overflow: hidden;
      }

      .budget-bar-fill {
        height: 100%;
        border-radius: 4px;
        display: flex;
        align-items: center;
        padding-left: 8px;
        font-size: 11px;
        font-weight: 600;
        color: white;
        transition: width 0.5s ease;
      }

      .budget-bar-fill.under-budget {
        background: linear-gradient(90deg, var(--color-positive), #34D058);
      }

      .budget-bar-fill.over-budget {
        background: linear-gradient(90deg, var(--color-negative), #F97583);
      }

      .budget-bar-fill.at-budget {
        background: linear-gradient(90deg, var(--color-primary), #58A6FF);
      }

      .budget-bar-marker {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 3px;
        background: var(--color-text-primary);
        border-radius: 2px;
      }

      .budget-bar-marker::after {
        content: 'Budget';
        position: absolute;
        top: -16px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 9px;
        color: var(--color-text-muted);
        white-space: nowrap;
      }

      /* ========== SUMMARY ROW (Bottom) ========== */
      .summary-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: var(--spacing-md);
        flex: 1;
        min-height: 0;
      }

      .summary-card {
        background: var(--bg-card);
        border-radius: 10px;
        padding: var(--spacing-md);
        box-shadow: var(--shadow-card);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-sm);
      }

      .card-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--color-text-primary);
      }

      .card-subtitle {
        font-size: 11px;
        color: var(--color-text-muted);
      }

      .card-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }

      /* Budget Progress Card */
      .budget-item {
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding: 10px 0;
        border-bottom: 1px solid var(--color-border);
      }

      .budget-item:last-child {
        border-bottom: none;
      }

      .budget-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .budget-item-label {
        font-size: 15px;
        font-weight: 500;
        color: var(--color-text-primary);
      }

      .budget-item-values {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        font-size: 12px;
      }

      .budget-actual {
        font-weight: 700;
        font-size: 16px;
        color: var(--color-text-primary);
      }

      .budget-target {
        color: var(--color-text-muted);
      }

      .budget-variance {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
      }

      .budget-variance.positive {
        background: #E6F4EA;
        color: var(--color-positive);
      }

      .budget-variance.negative {
        background: #FDECE9;
        color: var(--color-negative);
      }

      .budget-bar {
        height: 6px;
        background: var(--color-border);
        border-radius: 3px;
        overflow: hidden;
      }

      .budget-bar-fill-small {
        height: 100%;
        border-radius: 3px;
        transition: width 0.5s ease;
      }

      .budget-bar-fill-small.under { background: var(--color-positive); }
      .budget-bar-fill-small.over { background: var(--color-negative); }
      .budget-bar-fill-small.at-target { background: var(--color-primary); }

      /* Inventory Summary Card */
      .inventory-total {
        text-align: center;
        padding: var(--spacing-md);
        background: linear-gradient(135deg, #E3F2FD 0%, #F3E5F5 100%);
        border-radius: 8px;
        margin-bottom: var(--spacing-sm);
      }

      .inventory-total-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--color-text-primary);
      }

      .inventory-total-label {
        font-size: 11px;
        color: var(--color-text-secondary);
        margin-top: 2px;
      }

      .inventory-status-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .inventory-status-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 10px;
        background: var(--bg-page);
        border-radius: 6px;
        font-size: 12px;
      }

      .status-badge {
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-badge.at-target { background: #E6F4EA; color: var(--color-positive); }
      .status-badge.below { background: #FDECE9; color: var(--color-negative); }
      .status-badge.above { background: #E6F4EA; color: var(--color-positive); }
      .status-badge.adequate { background: #FFF8E1; color: #F57C00; }

      /* Key Ratios Card */
      .ratios-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-sm);
      }

      .ratio-item {
        background: var(--bg-page);
        padding: 12px;
        border-radius: 8px;
        text-align: center;
      }

      .ratio-label {
        font-size: 11px;
        color: var(--color-text-secondary);
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }

      .ratio-value {
        font-size: 22px;
        font-weight: 700;
        color: var(--color-text-primary);
      }

      .ratio-value.positive { color: var(--color-positive); }
      .ratio-value.negative { color: var(--color-negative); }
      .ratio-value.neutral { color: var(--color-primary); }

      /* Top Customers Card */
      .customer-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .customer-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: 10px;
        background: var(--bg-page);
        border-radius: 8px;
      }

      .customer-rank {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--color-primary);
        color: white;
        border-radius: 50%;
        font-size: 11px;
        font-weight: 600;
      }

      .customer-info {
        flex: 1;
        min-width: 0;
      }

      .customer-name {
        font-size: 13px;
        font-weight: 500;
        color: var(--color-text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .customer-orders {
        font-size: 11px;
        color: var(--color-text-muted);
      }

      .customer-value {
        font-size: 14px;
        font-weight: 600;
        color: var(--color-text-primary);
      }

      .customer-bar {
        width: 100%;
        height: 3px;
        background: var(--color-border);
        border-radius: 2px;
        margin-top: 6px;
      }

      .customer-bar-fill {
        height: 100%;
        background: var(--color-primary);
        border-radius: 2px;
      }

      /* ========== QUICK ACTIONS ROW ========== */
      .actions-row {
        display: flex;
        gap: var(--spacing-sm);
      }

      .action-btn {
        flex: 1;
        padding: 10px 14px;
        background: var(--bg-card);
        border: 1px solid var(--color-border);
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        color: var(--color-text-primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: all 0.2s;
      }

      .action-btn:hover {
        background: var(--bg-page);
        border-color: var(--color-primary);
        color: var(--color-primary);
      }

      .action-btn .icon {
        font-size: 14px;
      }

      /* ========== DRAWER (Drill-down Panel) ========== */
      .drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.3);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
        z-index: 100;
      }

      .drawer-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .drawer {
        position: fixed;
        top: 0;
        right: 0;
        width: var(--drawer-width);
        height: 100vh;
        background: var(--bg-card);
        box-shadow: var(--shadow-drawer);
        transform: translateX(100%);
        transition: transform 0.3s ease;
        z-index: 101;
        display: flex;
        flex-direction: column;
      }

      .drawer.active {
        transform: translateX(0);
      }

      .drawer-header {
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--color-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .drawer-title {
        font-size: var(--font-size-heading);
        font-weight: 600;
        color: var(--color-text-primary);
      }

      .drawer-close {
        width: 32px;
        height: 32px;
        border: none;
        background: var(--bg-page);
        border-radius: 50%;
        cursor: pointer;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--color-text-secondary);
      }

      .drawer-close:hover {
        background: var(--color-border);
      }

      .drawer-content {
        flex: 1;
        padding: var(--spacing-lg);
        overflow-y: auto;
      }

      /* ========== AI CHAT PANEL ========== */
      .chat-panel {
        width: 360px;
        background: var(--bg-card);
        border-left: 1px solid var(--color-border);
        display: none;
        flex-direction: column;
        position: fixed;
        right: 0;
        top: var(--header-height);
        bottom: 0;
        z-index: 50;
        box-shadow: var(--shadow-drawer);
      }

      .chat-panel.active {
        display: flex;
      }

      .chat-header {
        padding: var(--spacing-md);
        border-bottom: 1px solid var(--color-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .chat-header h3 {
        font-size: 14px;
        font-weight: 600;
      }

      .chat-close {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 26px;
        height: 26px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
      }

      .chat-messages {
        flex: 1;
        padding: var(--spacing-md);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .chat-message {
        max-width: 85%;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 13px;
        line-height: 1.4;
      }

      .chat-message.assistant {
        background: var(--bg-page);
        color: var(--color-text-primary);
        align-self: flex-start;
        border-bottom-left-radius: 4px;
      }

      .chat-message.user {
        background: var(--color-primary);
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
      }

      .chat-suggestions {
        padding: var(--spacing-sm);
        border-top: 1px solid var(--color-border);
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .suggestion-chip {
        padding: 6px 12px;
        background: var(--bg-page);
        border: 1px solid var(--color-border);
        border-radius: 16px;
        font-size: 11px;
        color: var(--color-text-secondary);
        cursor: pointer;
        transition: all 0.2s;
      }

      .suggestion-chip:hover {
        border-color: var(--color-primary);
        color: var(--color-primary);
      }

      .chat-input-area {
        padding: var(--spacing-sm);
        border-top: 1px solid var(--color-border);
        display: flex;
        gap: 6px;
      }

      .chat-input {
        flex: 1;
        padding: 10px 14px;
        border: 1px solid var(--color-border);
        border-radius: 20px;
        font-size: 13px;
        outline: none;
      }

      .chat-input:focus {
        border-color: var(--color-primary);
      }

      .chat-send {
        width: 38px;
        height: 38px;
        background: var(--color-primary);
        border: none;
        border-radius: 50%;
        color: white;
        cursor: pointer;
        font-size: 16px;
      }

      /* ========== DATA TABLE (for drawers) ========== */
      .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      .data-table thead {
        background: var(--bg-page);
      }

      .data-table th {
        text-align: left;
        padding: 10px 12px;
        font-weight: 600;
        color: var(--color-text-secondary);
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .data-table td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--color-border);
        color: var(--color-text-primary);
      }

      .data-table tbody tr:hover {
        background: var(--bg-page);
      }

      /* Loading state */
      .loading {
        color: var(--color-text-muted);
        font-style: italic;
      }

      /* ========== RESPONSIVE ========== */
      @media (max-width: 1400px) {
        .kpi-row {
          grid-template-columns: repeat(3, 1fr);
        }
        
        .kpi-value {
          font-size: 28px;
        }
        
        .chart-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- ========== HEADER ========== -->
    <header class="header">
      <div class="header-left">
        <h1>‚õèÔ∏è RAC Mining - Executive Dashboard</h1>
        <div class="header-status">
          <span class="status-dot" id="healthDot"></span>
          <span id="healthStatus">Loading...</span>
        </div>
      </div>
      <div class="header-right">
        <!-- Entity Filter -->
        <select class="period-selector" id="entitySelector" onchange="loadDashboard()" style="min-width: 200px;">
          <option value="ALL">üìä All RAC Entities (Consolidated)</option>
          <option value="Mining" selected>‚õèÔ∏è Rirratjingu Mining</option>
          <option value="Aboriginal Corporation">üèõÔ∏è Aboriginal Corporation</option>
          <option value="Enterprises">üè¢ Enterprises</option>
          <option value="Property">üè† Property Management</option>
          <option value="Ngarrkuwuy">üî® Ngarrkuwuy Developments</option>
          <option value="Invest">üí∞ Miliditjpi Trust</option>
          <option value="Marrin">üèóÔ∏è Marrin Square</option>
        </select>
        <select class="period-selector" id="periodSelector" onchange="loadDashboard()">
          <option value="Q1">Q1 FY25/26 (Jul-Sep)</option>
          <option value="Q2">Q2 FY25/26 (Oct-Dec)</option>
          <option value="Q3" selected>Q3 FY25/26 (Jan-Mar)</option>
          <option value="Q4">Q4 FY25/26 (Apr-Jun)</option>
        </select>
        <button class="btn-refresh" onclick="loadDashboard()">‚Üª Refresh</button>
        <button class="btn-snapshot" id="snapshotBtn" onclick="runDailySnapshot()">üì∏ Snapshot</button>
        <span class="snapshot-status" id="snapshotStatus"></span>
        <button class="btn-chat" onclick="toggleChat()">üí¨ Ask AI</button>
      </div>
    </header>

    <!-- ========== MAIN CONTAINER ========== -->
    <div class="main-container">
      <!-- ========== DASHBOARD ========== -->
      <div class="dashboard">
        
        <!-- KPI Row - Primary Metrics with Sparklines -->
        <div class="kpi-row">
          <!-- Cash Position -->
          <div class="kpi-card" onclick="openDrawer('cash')">
            <div class="kpi-header">
              <div class="kpi-label">Cash Position</div>
              <span class="kpi-arrow">‚Üí</span>
            </div>
            <div class="kpi-value" id="kpi-cash">Loading...</div>
            <div class="kpi-trend neutral" id="kpi-cash-trend">--</div>
            <div class="kpi-sparkline">
              <canvas id="sparkCash"></canvas>
            </div>
            <div class="kpi-status-bar healthy" id="kpi-cash-status"></div>
          </div>

          <!-- Revenue -->
          <div class="kpi-card" onclick="openDrawer('revenue')">
            <div class="kpi-header">
              <div class="kpi-label">Revenue (Period)</div>
              <span class="kpi-arrow">‚Üí</span>
            </div>
            <div class="kpi-value" id="kpi-revenue">Loading...</div>
            <div class="kpi-trend neutral" id="kpi-revenue-trend">--</div>
            <div class="kpi-sparkline">
              <canvas id="sparkRevenue"></canvas>
            </div>
            <div class="kpi-status-bar warning" id="kpi-revenue-status"></div>
          </div>

          <!-- Net Profit -->
          <div class="kpi-card" onclick="openDrawer('profit')">
            <div class="kpi-header">
              <div class="kpi-label">Net Profit</div>
              <span class="kpi-arrow">‚Üí</span>
            </div>
            <div class="kpi-value" id="kpi-profit">Loading...</div>
            <div class="kpi-trend neutral" id="kpi-profit-trend">--</div>
            <div class="kpi-sparkline">
              <canvas id="sparkProfit"></canvas>
            </div>
            <div class="kpi-status-bar critical" id="kpi-profit-status"></div>
          </div>

          <!-- Receivables -->
          <div class="kpi-card" onclick="openDrawer('receivables')">
            <div class="kpi-header">
              <div class="kpi-label">Receivables</div>
              <span class="kpi-arrow">‚Üí</span>
            </div>
            <div class="kpi-value smaller" id="kpi-receivables">Loading...</div>
            <div class="kpi-trend neutral" id="kpi-receivables-trend">--</div>
            <div class="kpi-sparkline">
              <canvas id="sparkReceivables"></canvas>
            </div>
            <div class="kpi-status-bar healthy" id="kpi-receivables-status"></div>
          </div>

          <!-- Inventory Value -->
          <div class="kpi-card" onclick="openDrawer('inventory')">
            <div class="kpi-header">
              <div class="kpi-label">Inventory Value</div>
              <span class="kpi-arrow">‚Üí</span>
            </div>
            <div class="kpi-value" id="kpi-inventory">Loading...</div>
            <div class="kpi-trend neutral" id="kpi-inventory-trend">--</div>
            <div class="kpi-sparkline">
              <canvas id="sparkInventory"></canvas>
            </div>
            <div class="kpi-status-bar healthy" id="kpi-inventory-status"></div>
          </div>
        </div>

        <!-- Chart Row - Visual Impact -->
        <div class="chart-row">
          <!-- Revenue & Expenses Trend -->
          <div class="chart-card">
            <div class="chart-header">
              <div>
                <div class="chart-title">Revenue & Expenses Trend</div>
                <div class="chart-subtitle">Last 6 months performance</div>
              </div>
              <div class="chart-legend">
                <span class="legend-item"><span class="legend-dot" style="background: #0078D4"></span> Revenue</span>
                <span class="legend-item"><span class="legend-dot" style="background: #D13438"></span> Expenses</span>
                <span class="legend-item"><span class="legend-dot" style="background: #107C10"></span> Profit</span>
              </div>
            </div>
            <div class="chart-container">
              <canvas id="trendChart"></canvas>
            </div>
          </div>

          <!-- Budget vs Actual - Horizontal Bars -->
          <div class="chart-card">
            <div class="chart-header">
              <div>
                <div class="chart-title">Budget vs Actual</div>
                <div class="chart-subtitle" id="budget-period">Current quarter (pro-rated)</div>
              </div>
            </div>
            <div class="budget-bars-container" id="budgetBars">
              <!-- Revenue Bar -->
              <div class="budget-bar-item">
                <div class="budget-bar-header">
                  <span class="budget-bar-label">Revenue</span>
                  <div class="budget-bar-values">
                    <span class="budget-bar-actual" id="bar-rev-actual">$0</span>
                    <span class="budget-bar-target" id="bar-rev-target">of $0</span>
                    <span class="budget-bar-variance negative" id="bar-rev-var">0%</span>
                  </div>
                </div>
                <div class="budget-bar-track">
                  <div class="budget-bar-fill at-budget" id="bar-rev-fill" style="width: 0%"></div>
                  <div class="budget-bar-marker" id="bar-rev-marker" style="left: 100%"></div>
                </div>
              </div>

              <!-- Expenses Bar -->
              <div class="budget-bar-item">
                <div class="budget-bar-header">
                  <span class="budget-bar-label">Expenses</span>
                  <div class="budget-bar-values">
                    <span class="budget-bar-actual" id="bar-exp-actual">$0</span>
                    <span class="budget-bar-target" id="bar-exp-target">of $0</span>
                    <span class="budget-bar-variance negative" id="bar-exp-var">0%</span>
                  </div>
                </div>
                <div class="budget-bar-track">
                  <div class="budget-bar-fill at-budget" id="bar-exp-fill" style="width: 0%"></div>
                  <div class="budget-bar-marker" id="bar-exp-marker" style="left: 100%"></div>
                </div>
              </div>

              <!-- Gross Profit Bar -->
              <div class="budget-bar-item">
                <div class="budget-bar-header">
                  <span class="budget-bar-label">Gross Profit</span>
                  <div class="budget-bar-values">
                    <span class="budget-bar-actual" id="bar-gp-actual">$0</span>
                    <span class="budget-bar-target" id="bar-gp-target">of $0</span>
                    <span class="budget-bar-variance negative" id="bar-gp-var">0%</span>
                  </div>
                </div>
                <div class="budget-bar-track">
                  <div class="budget-bar-fill at-budget" id="bar-gp-fill" style="width: 0%"></div>
                  <div class="budget-bar-marker" id="bar-gp-marker" style="left: 100%"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Summary Row - Detail Cards -->
        <div class="summary-row">
          
          <!-- Budget Progress (Detailed) -->
          <div class="summary-card">
            <div class="card-header">
              <div>
                <div class="card-title">P&L Summary</div>
                <div class="card-subtitle" id="pl-period">Q3 FY25/26</div>
              </div>
            </div>
            <div class="card-content">
              <div class="budget-item">
                <div class="budget-item-header">
                  <span class="budget-item-label">Revenue</span>
                  <span class="budget-actual" id="pl-revenue">$0</span>
                </div>
              </div>
              <div class="budget-item">
                <div class="budget-item-header">
                  <span class="budget-item-label">COGS</span>
                  <span class="budget-actual" id="pl-cogs">$0</span>
                </div>
              </div>
              <div class="budget-item" style="background: #FFFBEB; margin: 0 -16px; padding: 10px 16px;">
                <div class="budget-item-header">
                  <span class="budget-item-label"><strong>Gross Profit</strong></span>
                  <span class="budget-actual" id="pl-gross"><strong>$0</strong></span>
                </div>
              </div>
              <div class="budget-item">
                <div class="budget-item-header">
                  <span class="budget-item-label">OpEx</span>
                  <span class="budget-actual" id="pl-opex">$0</span>
                </div>
              </div>
              <div class="budget-item">
                <div class="budget-item-header">
                  <span class="budget-item-label"><strong>Net Profit</strong></span>
                  <span class="budget-actual" id="pl-net"><strong>$0</strong></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Key Financial Ratios -->
          <div class="summary-card">
            <div class="card-header">
              <div>
                <div class="card-title">Key Ratios</div>
                <div class="card-subtitle">Financial health indicators</div>
              </div>
            </div>
            <div class="card-content">
              <div class="ratios-grid">
                <div class="ratio-item">
                  <div class="ratio-label">Current Ratio</div>
                  <div class="ratio-value neutral" id="ratio-current">-</div>
                </div>
                <div class="ratio-item">
                  <div class="ratio-label">Gross Margin</div>
                  <div class="ratio-value" id="ratio-gross-margin">-</div>
                </div>
                <div class="ratio-item">
                  <div class="ratio-label">Net Margin</div>
                  <div class="ratio-value" id="ratio-net-margin">-</div>
                </div>
                <div class="ratio-item">
                  <div class="ratio-label">Debt/Equity</div>
                  <div class="ratio-value neutral" id="ratio-debt-equity">-</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Top Customers -->
          <div class="summary-card">
            <div class="card-header">
              <div>
                <div class="card-title">Top Customers</div>
                <div class="card-subtitle">FY26 Year to Date</div>
              </div>
            </div>
            <div class="card-content">
              <div class="customer-list" id="customerList">
                <div class="customer-item loading">Loading customers...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Action Buttons -->
        <div class="actions-row">
          <button class="action-btn" onclick="openDrawer('pl')">
            <span class="icon">üìä</span> Full P&L
          </button>
          <button class="action-btn" onclick="openDrawer('balance')">
            <span class="icon">üìã</span> Balance Sheet
          </button>
          <button class="action-btn" onclick="openDrawer('ratios')">
            <span class="icon">üìà</span> Ratios
          </button>
          <button class="action-btn" onclick="openDrawer('aged')">
            <span class="icon">üìÖ</span> Aged Debtors
          </button>
          <button class="action-btn" onclick="window.location.href='index.html'">
            <span class="icon">üîó</span> Full Dashboard
          </button>
        </div>
      </div>

      <!-- ========== AI CHAT PANEL ========== -->
      <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
          <h3>üí¨ Ask about your finances</h3>
          <button class="chat-close" onclick="toggleChat()">√ó</button>
        </div>
        <div class="chat-messages" id="chatMessages">
          <div class="chat-message assistant">
            Hi! I can help you understand your Mining financial data. Try asking me things like:
            <br><br>
            ‚Ä¢ "What's driving our revenue decline?"<br>
            ‚Ä¢ "Show me our biggest expenses"<br>
            ‚Ä¢ "Compare to last year"
          </div>
        </div>
        <div class="chat-suggestions">
          <span class="suggestion-chip" onclick="sendSuggestion('Top 3 expenses?')">Top expenses</span>
          <span class="suggestion-chip" onclick="sendSuggestion('Why profit negative?')">Profit analysis</span>
          <span class="suggestion-chip" onclick="sendSuggestion('Cash forecast')">Cash forecast</span>
        </div>
        <div class="chat-input-area">
          <input type="text" class="chat-input" id="chatInput" placeholder="Ask a question..." onkeypress="handleChatKeypress(event)">
          <button class="chat-send" onclick="sendChat()">‚û§</button>
        </div>
      </div>
    </div>

    <!-- ========== DRAWER OVERLAY ========== -->
    <div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>

    <!-- ========== DRILL-DOWN DRAWER ========== -->
    <div class="drawer" id="drawer">
      <div class="drawer-header">
        <span class="drawer-title" id="drawerTitle">Detail View</span>
        <button class="drawer-close" onclick="closeDrawer()">√ó</button>
      </div>
      <div class="drawer-content" id="drawerContent">
        <!-- Dynamic content loaded here -->
      </div>
    </div>

    <!-- ========== JAVASCRIPT ========== -->
    <script>
      // ========== CONFIGURATION ==========
      const API_BASE = "https://rac-xero-api-matt-production.up.railway.app";
      
      // Get selected entity from dropdown
      function getSelectedEntity() {
        return document.getElementById('entitySelector').value;
      }

      // Store loaded data globally
      window.dashboardData = {
        pl: {},
        budget: {},
        cash: {},
        receivables: {},
        balance: {}
      };

      // ========== QUARTER DATE CALCULATIONS ==========
      function getQuarterDates(quarter) {
        const today = new Date();
        const year = today.getMonth() >= 6 ? today.getFullYear() : today.getFullYear() - 1;

        const quarters = {
          Q1: { start: `${year}-07-01`, end: `${year}-09-30`, days: 92 },
          Q2: { start: `${year}-10-01`, end: `${year}-12-31`, days: 92 },
          Q3: { start: `${year + 1}-01-01`, end: `${year + 1}-03-31`, days: 90 },
          Q4: { start: `${year + 1}-04-01`, end: `${year + 1}-06-30`, days: 91 },
        };

        const q = quarters[quarter];
        const startDate = new Date(q.start);
        const endDate = new Date(q.end);
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        const hasStarted = yesterday >= startDate;
        const isComplete = yesterday >= endDate;
        const daysElapsed = hasStarted
          ? Math.min(Math.floor((yesterday - startDate) / (1000 * 60 * 60 * 24)) + 1, q.days)
          : 0;

        return {
          quarterCode: quarter,
          startDate: q.start,
          endDate: isComplete ? q.end : today.toISOString().split("T")[0],
          totalDays: q.days,
          daysElapsed,
          isComplete,
          hasStarted,
          proRateFactor: daysElapsed / q.days,
        };
      }

      // ========== MAIN DASHBOARD LOAD ==========
      async function loadDashboard() {
        const entity = getSelectedEntity();
        const period = document.getElementById("periodSelector").value;
        const quarterInfo = getQuarterDates(period);

        console.log("Loading dashboard for:", entity, period, quarterInfo);

        // Update header title based on entity
        const entityNames = {
          'ALL': 'All RAC Entities (Consolidated)',
          'Mining': 'RAC Mining',
          'Aboriginal Corporation': 'RAC Aboriginal Corporation',
          'Enterprises': 'RAC Enterprises',
          'Property': 'Property Management',
          'Ngarrkuwuy': 'Ngarrkuwuy Developments',
          'Invest': 'Miliditjpi Trust',
          'Marrin': 'Marrin Square'
        };
        document.querySelector('.header h1').textContent = '‚õèÔ∏è ' + (entityNames[entity] || entity) + ' - Executive Dashboard';

        // Handle consolidated view differently
        if (entity === 'ALL') {
          await loadConsolidatedDashboard(quarterInfo);
          return;
        }

        // Load historical snapshot data
        const historical = await loadHistoricalData(entity);

        // Update period displays
        document.getElementById("budget-period").textContent = 
          `${period} (${Math.round(quarterInfo.proRateFactor * 100)}% elapsed)`;
        document.getElementById("pl-period").textContent = 
          `${period} FY25/26`;

        // Load all data
        await Promise.all([
          loadCashPosition(),
          loadTrialBalance(),
          loadProfitLoss(quarterInfo),
          loadAgedReceivables(),
          loadInventory(),
          loadTopCustomers(),
          loadHistoricalData(),
        ]);

        // Load budget after P&L (needs P&L data)
        await loadBudget(quarterInfo);

        // Update health status
        updateHealthStatus();

        // Calculate and display financial ratios
        loadFinancialRatios();

        // Initialize charts
        initSparklines();
        initTrendChart();
      }

      // ========== CONSOLIDATED DASHBOARD (All Entities) ==========
      async function loadConsolidatedDashboard(quarterInfo) {
        const entities = ['Mining', 'Aboriginal Corporation', 'Enterprises', 'Property', 'Ngarrkuwuy', 'Invest', 'Marrin'];
        
        let totalCash = 0;
        let totalRevenue = 0;
        let totalExpenses = 0;
        let totalReceivables = 0;
        let allInvoices = [];
        let successCount = 0;

        document.getElementById("kpi-cash").textContent = "Loading...";
        document.getElementById("kpi-revenue").textContent = "Loading...";
        document.getElementById("kpi-receivables").textContent = "Loading...";

        for (const entity of entities) {
          try {
            // Cash
            const cashResp = await fetch(`${API_BASE}/api/cash-position`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ organizationName: entity }),
            });
            const cashData = await cashResp.json();
            if (cashData.totalCash) {
              totalCash += cashData.totalCash;
              successCount++;
            }

            // P&L
            const plResp = await fetch(`${API_BASE}/api/profit-loss-summary`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                organizationName: entity,
                date: quarterInfo.endDate,
                periodMonths: 3,
              }),
            });
            const plData = await plResp.json();
            totalRevenue += plData.summary?.totalRevenue || 0;
            totalExpenses += plData.summary?.totalExpenses || 0;

            // Invoices
            const invResp = await fetch(`${API_BASE}/api/outstanding-invoices`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ organizationName: entity }),
            });
            const invData = await invResp.json();
            if (Array.isArray(invData)) {
              allInvoices = allInvoices.concat(invData);
              totalReceivables += invData.reduce((sum, inv) => sum + (inv.amountDue || 0), 0);
            }
          } catch (e) {
            console.warn(`Error loading ${entity}:`, e);
          }
        }

        // Update consolidated KPIs
        document.getElementById("kpi-cash").textContent = "$" + totalCash.toLocaleString();
        document.getElementById("kpi-cash-trend").innerHTML = `üí∞ ${successCount} entities`;
        document.getElementById("kpi-cash-trend").className = "kpi-trend positive";

        const netProfit = totalRevenue - totalExpenses;
        document.getElementById("kpi-revenue").textContent = "$" + totalRevenue.toLocaleString();
        document.getElementById("kpi-revenue-trend").textContent = "üìä Consolidated";
        
        document.getElementById("kpi-profit").textContent = "$" + netProfit.toLocaleString();
        document.getElementById("kpi-profit-trend").textContent = netProfit < 0 ? "‚ö† Loss position" : "‚úì Profitable";
        document.getElementById("kpi-profit-trend").className = netProfit < 0 ? "kpi-trend negative" : "kpi-trend positive";

        document.getElementById("kpi-receivables").textContent = "$" + totalReceivables.toLocaleString();
        document.getElementById("kpi-receivables-trend").textContent = `${allInvoices.length} invoices across all entities`;

        // Store for other functions
        window.dashboardData.pl = { revenue: totalRevenue, netProfit: netProfit };

        // Update P&L Summary card
        document.getElementById("pl-revenue").textContent = "$" + totalRevenue.toLocaleString();
        document.getElementById("pl-net").innerHTML = "<strong>$" + netProfit.toLocaleString() + "</strong>";

        // Inventory stays the same
        document.getElementById("kpi-inventory").textContent = "$3.5M";
        document.getElementById("kpi-inventory-trend").innerHTML = "‚úì Stock levels healthy";

        updateHealthStatus();
        initSparklines();
        initTrendChart();
      }

      // ========== CASH POSITION ==========
      async function loadCashPosition() {
        try {
          const response = await fetch(`${API_BASE}/api/cash-position`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ organizationName: getSelectedEntity() }),
          });
          const data = await response.json();
          
          const totalCash = data.totalCash || 0;
          window.dashboardData.cash = data;

          document.getElementById("kpi-cash").textContent = "$" + totalCash.toLocaleString();
          document.getElementById("kpi-cash-trend").innerHTML = 
            `<span>üí∞</span> ${data.accounts?.length || 0} accounts`;
          document.getElementById("kpi-cash-trend").className = "kpi-trend positive";
          
        } catch (error) {
          console.error("Error loading cash:", error);
          document.getElementById("kpi-cash").textContent = "Error";
        }
      }

      // ========== TRIAL BALANCE ==========
      async function loadTrialBalance() {
        try {
          const response = await fetch(`${API_BASE}/api/trial-balance`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ organizationName: getSelectedEntity() }),
          });
          const data = await response.json();
          
          window.dashboardData.balance = data.trialBalance?.totals || {};
          
        } catch (error) {
          console.error("Error loading trial balance:", error);
        }
      }

      // ========== PROFIT & LOSS ==========
      async function loadProfitLoss(quarterInfo) {
        try {
          const start = new Date(quarterInfo.startDate);
          const end = new Date(quarterInfo.endDate);
          let periodMonths = quarterInfo.isComplete ? 3 : 
            (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth()) + 1;

          const response = await fetch(`${API_BASE}/api/profit-loss-summary`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              organizationName: getSelectedEntity(),
              date: quarterInfo.endDate,
              periodMonths: periodMonths,
            }),
          });

          const data = await response.json();
          console.log("P&L Response:", data);

          const revenue = data.summary?.totalRevenue || 0;
          const totalExpenses = data.summary?.totalExpenses || 0;
          const netProfit = data.summary?.netProfit || 0;

          // Categorize COGS vs Opex
          const expenseAccounts = data.summary?.expenseAccounts || [];
          let cogs = 0;
          let opex = 0;

          expenseAccounts.forEach((account) => {
            const name = account.name.toLowerCase();
            if (name.includes("cost of") || name.includes("cost -") || 
                name.includes("haulage expense") || name.includes("freight")) {
              cogs += account.amount;
            } else {
              opex += account.amount;
            }
          });

          const gross = revenue - cogs;

          // Store for budget comparison
          window.dashboardData.pl = { revenue, totalExpenses, cogs, opex, gross, netProfit };

          // Update KPI cards
          document.getElementById("kpi-revenue").textContent = "$" + revenue.toLocaleString();
          document.getElementById("kpi-revenue-trend").innerHTML = 
            revenue >= 0 ? `<span>‚Üë</span> Period revenue` : `<span>‚Üì</span> Negative revenue`;
          document.getElementById("kpi-revenue-trend").className = 
            revenue >= 0 ? "kpi-trend positive" : "kpi-trend negative";
          document.getElementById("kpi-revenue-status").className = 
            revenue >= 0 ? "kpi-status-bar healthy" : "kpi-status-bar warning";

          document.getElementById("kpi-profit").textContent = "$" + netProfit.toLocaleString();
          document.getElementById("kpi-profit-trend").innerHTML = 
            netProfit >= 0 ? `<span>‚Üë</span> Profitable` : `<span>‚Üì</span> Loss position`;
          document.getElementById("kpi-profit-trend").className = 
            netProfit >= 0 ? "kpi-trend positive" : "kpi-trend negative";
          document.getElementById("kpi-profit-status").className = 
            netProfit >= 0 ? "kpi-status-bar healthy" : "kpi-status-bar critical";

          // Update P&L summary card
          document.getElementById("pl-revenue").textContent = "$" + revenue.toLocaleString();
          document.getElementById("pl-cogs").textContent = "$" + cogs.toLocaleString();
          document.getElementById("pl-gross").innerHTML = "<strong>$" + gross.toLocaleString() + "</strong>";
          document.getElementById("pl-opex").textContent = "$" + opex.toLocaleString();
          document.getElementById("pl-net").innerHTML = "<strong>$" + netProfit.toLocaleString() + "</strong>";

        } catch (error) {
          console.error("Error loading P&L:", error);
        }
      }

      // ========== BUDGET ==========
      async function loadBudget(quarterInfo) {
        try {
          const response = await fetch(`${API_BASE}/api/budget-summary`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              organizationName: getSelectedEntity(),
              quarter: quarterInfo.quarterCode,
            }),
          });
          const data = await response.json();
          
          const budget = parseBudgetFromReport(data.report);
          const proRatedRevenue = Math.round(budget.revenue * quarterInfo.proRateFactor);
          const proRatedExpenses = Math.round(budget.expenses * quarterInfo.proRateFactor);
          const proRatedGrossProfit = proRatedRevenue - (proRatedExpenses * 0.55); // Approximate COGS

          const actualRevenue = window.dashboardData.pl?.revenue || 0;
          const actualExpenses = window.dashboardData.pl?.totalExpenses || 0;
          const actualGross = window.dashboardData.pl?.gross || 0;

          // Calculate variances
          const revVar = proRatedRevenue > 0 ? ((actualRevenue - proRatedRevenue) / proRatedRevenue) * 100 : 0;
          const expVar = proRatedExpenses > 0 ? ((actualExpenses - proRatedExpenses) / proRatedExpenses) * 100 : 0;
          const gpVar = proRatedGrossProfit > 0 ? ((actualGross - proRatedGrossProfit) / proRatedGrossProfit) * 100 : 0;

          // Update horizontal budget bars
          updateBudgetBar('rev', actualRevenue, proRatedRevenue, revVar);
          updateBudgetBar('exp', actualExpenses, proRatedExpenses, expVar);
          updateBudgetBar('gp', actualGross, proRatedGrossProfit, gpVar);

        } catch (error) {
          console.error("Error loading budget:", error);
        }
      }

      function updateBudgetBar(type, actual, budget, variance) {
        const maxVal = Math.max(Math.abs(actual), Math.abs(budget)) * 1.2;
        const fillPct = budget > 0 ? Math.min(Math.abs(actual) / maxVal * 100, 100) : 0;
        const markerPct = budget > 0 ? Math.min(budget / maxVal * 100, 100) : 0;

        document.getElementById(`bar-${type}-actual`).textContent = "$" + actual.toLocaleString();
        document.getElementById(`bar-${type}-target`).textContent = "of $" + budget.toLocaleString();
        
        const varEl = document.getElementById(`bar-${type}-var`);
        varEl.textContent = (variance >= 0 ? "+" : "") + variance.toFixed(1) + "%";
        varEl.className = "budget-bar-variance " + (
          type === 'exp' ? (variance <= 0 ? "positive" : "negative") :
          (variance >= 0 ? "positive" : "negative")
        );

        const fillEl = document.getElementById(`bar-${type}-fill`);
        fillEl.style.width = fillPct + "%";
        
        // Color based on type and performance
        if (type === 'exp') {
          fillEl.className = "budget-bar-fill " + (actual <= budget ? "under-budget" : "over-budget");
        } else {
          fillEl.className = "budget-bar-fill " + (actual >= budget ? "under-budget" : "over-budget");
        }

        document.getElementById(`bar-${type}-marker`).style.left = markerPct + "%";
      }

      function parseBudgetFromReport(report) {
        let revenue = 0;
        let expenses = 0;

        if (report?.Reports?.[0]?.Rows) {
          report.Reports[0].Rows.forEach(row => {
            if (row.RowType === "Section" && row.Rows) {
              row.Rows.forEach(subRow => {
                if (subRow.RowType === "SummaryRow" && subRow.Cells) {
                  const label = subRow.Cells[0]?.Value?.toLowerCase() || "";
                  const month1 = parseFloat(subRow.Cells[1]?.Value) || 0;
                  const month2 = parseFloat(subRow.Cells[2]?.Value) || 0;
                  const month3 = parseFloat(subRow.Cells[3]?.Value) || 0;
                  const total = month1 + month2 + month3;

                  if (label.includes("total income") || label.includes("total revenue")) {
                    if (total > revenue) revenue = total;
                  }
                  if (label.includes("total operating expenses") || label.includes("total expenses")) {
                    if (total > expenses) expenses = total;
                  }
                }
              });
            }
          });
        }
        return { revenue, expenses };
      }

      // ========== AGED RECEIVABLES (via Outstanding Invoices) ==========
      async function loadAgedReceivables() {
        try {
          // Use outstanding-invoices endpoint instead of broken aged-receivables report
          const response = await fetch(`${API_BASE}/api/outstanding-invoices`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ organizationName: getSelectedEntity() }),
          });
          const invoices = await response.json();

          if (!Array.isArray(invoices)) {
            console.error("Invalid invoices response:", invoices);
            document.getElementById("kpi-receivables").textContent = "$0";
            return;
          }

          // Calculate aging from invoice due dates
          const today = new Date();
          let current = 0, days31_60 = 0, days61_90 = 0, over90 = 0;

          invoices.forEach(inv => {
            const dueDate = new Date(inv.dueDate);
            const daysOverdue = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
            const amount = inv.amountDue || 0;

            if (daysOverdue <= 30) {
              current += amount;
            } else if (daysOverdue <= 60) {
              days31_60 += amount;
            } else if (daysOverdue <= 90) {
              days61_90 += amount;
            } else {
              over90 += amount;
            }
          });

          const total = current + days31_60 + days61_90 + over90;
          
          // Store with same field names for drawer compatibility
          window.dashboardData.receivables = {
            aged30Days: current,
            aged60Days: days31_60,
            aged90Days: days61_90,
            agedOver120Days: over90,
            total: total,
            invoiceCount: invoices.length
          };

          document.getElementById("kpi-receivables").textContent = "$" + total.toLocaleString();
          
          const currentPct = total > 0 ? Math.round(current / total * 100) : 0;
          const overduePct = 100 - currentPct;
          document.getElementById("kpi-receivables-trend").textContent = 
            `${currentPct}% current ‚Ä¢ ${overduePct}% overdue`;
          document.getElementById("kpi-receivables-trend").className = 
            currentPct >= 70 ? "kpi-trend positive" : (currentPct >= 50 ? "kpi-trend neutral" : "kpi-trend negative");

          // Update status bar color
          const statusBar = document.getElementById("kpi-receivables-status");
          statusBar.className = "kpi-status-bar " + (currentPct >= 70 ? "healthy" : (currentPct >= 50 ? "warning" : "critical"));

        } catch (error) {
          console.error("Error loading receivables:", error);
          document.getElementById("kpi-receivables").textContent = "Error";
        }
      }

      // ========== INVENTORY ==========
      async function loadInventory() {
        // Static data for now - would come from inventory system
        const inventoryData = [
          { product: "Roadbase", current: "8,000t", value: 563840, status: "at-target" },
          { product: "Type E (500-700)", current: "4,510t", value: 377848, status: "below" },
          { product: "20mm Minus", current: "12,118t", value: 1088923, status: "above" },
          { product: "Crusher Dust", current: "2,000t", value: 69420, status: "at-target" },
          { product: "Sand", current: "19,084t", value: 600000, status: "above" },
          { product: "Other Rock", current: "10,000t", value: 800000, status: "adequate" },
        ];

        const totalValue = inventoryData.reduce((sum, item) => sum + item.value, 0);

        document.getElementById("kpi-inventory").textContent = "$" + (totalValue / 1000000).toFixed(1) + "M";
        document.getElementById("kpi-inventory-trend").innerHTML = `<span>‚úì</span> Stock levels healthy`;
        document.getElementById("kpi-inventory-trend").className = "kpi-trend positive";

        // TODO: Restore when Inventory Status card returns (currently replaced by Key Ratios)
        // Will connect to Quarry APP API for real inventory data
        /*
        document.getElementById("inv-total-value").textContent = "$" + totalValue.toLocaleString();

        const statusList = document.getElementById("inventoryStatusList");
        statusList.innerHTML = inventoryData.slice(0, 4).map(item => `
          <div class="inventory-status-item">
            <span>${item.product}</span>
            <span class="status-badge ${item.status}">${
              item.status === "at-target" ? "At Target" :
              item.status === "below" ? "Below" :
              item.status === "above" ? "Above" : "OK"
            }</span>
          </div>
        `).join("");
        */
      }

      // ========== TOP CUSTOMERS ==========
      async function loadTopCustomers() {
        // Static data - would come from invoices analysis
        const customers = [
          { name: "Liberty Industrial Pty Ltd", value: 205723, orders: 2 },
          { name: "RMG Project Construction", value: 73088, orders: 13 },
          { name: "Sitzler", value: 65073, orders: 6 },
        ];

        const maxValue = customers[0]?.value || 1;

        const customerList = document.getElementById("customerList");
        customerList.innerHTML = customers.map((c, i) => `
          <div class="customer-item">
            <span class="customer-rank">${i + 1}</span>
            <div class="customer-info">
              <div class="customer-name">${c.name}</div>
              <div class="customer-orders">${c.orders} orders</div>
              <div class="customer-bar">
                <div class="customer-bar-fill" style="width: ${(c.value / maxValue) * 100}%"></div>
              </div>
            </div>
            <span class="customer-value">$${c.value.toLocaleString()}</span>
          </div>
        `).join("");
      }

      // ========== FINANCIAL RATIOS ==========
      function loadFinancialRatios() {
        const pl = window.dashboardData.pl;
        const balance = window.dashboardData.balance;

        // Current Ratio = Current Assets / Current Liabilities (simplified using totals)
        const currentRatio = balance.totalLiabilities > 0 
          ? (balance.totalAssets / balance.totalLiabilities).toFixed(2) 
          : '-';
        
        // Gross Margin = (Revenue - COGS) / Revenue √ó 100
        const revenue = Math.abs(pl.revenue || 0);
        const cogs = Math.abs(pl.cogs || 0);
        const grossMargin = revenue > 0 
          ? (((revenue - cogs) / revenue) * 100).toFixed(1) + '%'
          : '-';
        
        // Net Profit Margin = Net Profit / Revenue √ó 100
        const netProfit = pl.netProfit || 0;
        const netMargin = revenue > 0 
          ? ((netProfit / revenue) * 100).toFixed(1) + '%'
          : '-';
        
        // Debt to Equity = Total Liabilities / Total Equity
        const debtEquity = balance.totalEquity > 0 
          ? (balance.totalLiabilities / balance.totalEquity).toFixed(2)
          : '-';

        // Update DOM
        document.getElementById('ratio-current').textContent = currentRatio;
        document.getElementById('ratio-current').className = 'ratio-value ' + 
          (parseFloat(currentRatio) >= 1.5 ? 'positive' : parseFloat(currentRatio) >= 1 ? 'neutral' : 'negative');

        document.getElementById('ratio-gross-margin').textContent = grossMargin;
        document.getElementById('ratio-gross-margin').className = 'ratio-value ' + 
          (parseFloat(grossMargin) > 0 ? 'positive' : 'negative');

        document.getElementById('ratio-net-margin').textContent = netMargin;
        document.getElementById('ratio-net-margin').className = 'ratio-value ' + 
          (parseFloat(netMargin) > 0 ? 'positive' : 'negative');

        document.getElementById('ratio-debt-equity').textContent = debtEquity;
        document.getElementById('ratio-debt-equity').className = 'ratio-value ' + 
          (parseFloat(debtEquity) < 0.5 ? 'positive' : parseFloat(debtEquity) < 1 ? 'neutral' : 'negative');
      }

      // ========== HEALTH STATUS ==========
      function updateHealthStatus() {
        const pl = window.dashboardData.pl;
        const dot = document.getElementById("healthDot");
        const status = document.getElementById("healthStatus");

        if (pl.netProfit < 0) {
          dot.className = "status-dot critical";
          status.textContent = "Attention Required";
        } else if (pl.netProfit < 10000) {
          dot.className = "status-dot warning";
          status.textContent = "Monitor";
        } else {
          dot.className = "status-dot";
          status.textContent = "Healthy";
        }
      }

      // ========== LOAD HISTORICAL DATA FROM SNAPSHOTS ==========
      async function loadHistoricalData(entity) {
        try {
          const org = entity || getSelectedEntity();
          const response = await fetch(`${API_BASE}/api/historical-metrics/${org}`);
          const data = await response.json();
          
          console.log('Historical data:', data);
          
          // Store for charts
          window.historicalData = data;
          
          return data;
        } catch (error) {
          console.error('Error loading historical data:', error);
          return { daily: [], monthly: [] };
        }
      }

      // ========== SPARKLINE CHARTS ==========
      function initSparklines() {
        const monthly = window.historicalData?.monthly || [];
        
        // Build month labels and data from snapshots
        const monthLabels = monthly.map(m => {
          const [year, month] = m.period_month.split('-');
          const monthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          return monthNames[parseInt(month)];
        });
        
        // If no data, use placeholders
        const defaultLabels = ['Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan'];
        const labels = monthLabels.length > 0 ? monthLabels : defaultLabels;
        
        const sparklineConfig = {
          type: 'line',
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
              legend: { display: false }, 
              tooltip: { 
                enabled: true,
                callbacks: {
                  label: function(context) {
                    return '$' + context.raw.toLocaleString();
                  }
                }
              } 
            },
            scales: { 
              x: { 
                display: true,
                grid: { display: false },
                ticks: { font: { size: 9 }, color: '#8A8886', maxRotation: 0 }
              }, 
              y: { display: false } 
            },
            elements: { 
              point: { radius: 0, hoverRadius: 4 },
              line: { borderWidth: 2, tension: 0.4 }
            }
          }
        };

        // Destroy existing charts if they exist
        ['sparkCash', 'sparkRevenue', 'sparkProfit', 'sparkReceivables', 'sparkInventory'].forEach(id => {
          const canvas = document.getElementById(id);
          if (canvas && canvas.chart) {
            canvas.chart.destroy();
          }
        });

        // Get daily data for cash (or use current value repeated)
        const dailyCash = window.historicalData?.daily || [];
        const cashData = dailyCash.length > 0 
          ? dailyCash.map(d => parseFloat(d.cash_position))
          : [window.dashboardData.cash.totalCash || 485000];
        
        // Get monthly revenue and profit from snapshots - use actual current value as endpoint
        const actualRevenue = window.dashboardData.pl?.revenue || 0;
        const revenueData = monthly.length > 0 
          ? monthly.map(m => parseFloat(m.revenue))
          : [230000, 211000, 499000, 159000, 151000, 465000, actualRevenue];
        // Ensure last point matches actual data
        revenueData[revenueData.length - 1] = actualRevenue;
          
        const actualProfit = window.dashboardData.pl?.netProfit || 0;
        const profitData = monthly.length > 0 
          ? monthly.map(m => parseFloat(m.net_profit))
          : [10000, -44000, 223000, -243000, 155000, -96000, actualProfit];
        // Ensure last point matches actual data
        profitData[profitData.length - 1] = actualProfit;

        // Cash sparkline (use daily if available, otherwise monthly trend)
        const cashLabels = dailyCash.length > 0 
          ? dailyCash.map(d => d.snapshot_date.split('-')[2]) // Day of month
          : labels;
        const cashChart = new Chart(document.getElementById('sparkCash'), {
          ...sparklineConfig,
          data: {
            labels: cashLabels.length > 1 ? cashLabels : labels,
            datasets: [{
              data: cashData.length > 1 ? cashData : Array(labels.length).fill(cashData[0]),
              borderColor: '#107C10',
              fill: true,
              backgroundColor: 'rgba(16, 124, 16, 0.1)'
            }]
          }
        });
        document.getElementById('sparkCash').chart = cashChart;

        // Revenue sparkline
        const revChart = new Chart(document.getElementById('sparkRevenue'), {
          ...sparklineConfig,
          data: {
            labels: labels,
            datasets: [{
              data: revenueData,
              borderColor: revenueData[revenueData.length - 1] >= 0 ? '#107C10' : '#D13438',
              fill: true,
              backgroundColor: revenueData[revenueData.length - 1] >= 0 ? 'rgba(16, 124, 16, 0.1)' : 'rgba(209, 52, 56, 0.1)'
            }]
          }
        });
        document.getElementById('sparkRevenue').chart = revChart;

        // Profit sparkline
        const latestProfit = profitData[profitData.length - 1] || 0;
        const profitChart = new Chart(document.getElementById('sparkProfit'), {
          ...sparklineConfig,
          data: {
            labels: labels,
            datasets: [{
              data: profitData,
              borderColor: latestProfit >= 0 ? '#107C10' : '#D13438',
              fill: true,
              backgroundColor: latestProfit >= 0 ? 'rgba(16, 124, 16, 0.1)' : 'rgba(209, 52, 56, 0.1)'
            }]
          }
        });
        document.getElementById('sparkProfit').chart = profitChart;

        // Receivables sparkline (from daily snapshots)
        const receivablesData = dailyCash.length > 0 
          ? dailyCash.map(d => parseFloat(d.receivables_total))
          : [175000, 172000, 168000, 180000, 175000, 178000, 175754];
        const recChart = new Chart(document.getElementById('sparkReceivables'), {
          ...sparklineConfig,
          data: {
            labels: cashLabels.length > 1 ? cashLabels : labels,
            datasets: [{
              data: receivablesData.length > 1 ? receivablesData : Array(labels.length).fill(receivablesData[0]),
              borderColor: '#0078D4',
              fill: true,
              backgroundColor: 'rgba(0, 120, 212, 0.1)'
            }]
          }
        });
        document.getElementById('sparkReceivables').chart = recChart;

        // Inventory sparkline (static for now - no inventory in snapshots)
        const invChart = new Chart(document.getElementById('sparkInventory'), {
          ...sparklineConfig,
          data: {
            labels: labels,
            datasets: [{
              data: [3200000, 3350000, 3400000, 3450000, 3480000, 3490000, 3500031],
              borderColor: '#107C10',
              fill: true,
              backgroundColor: 'rgba(16, 124, 16, 0.1)'
            }]
          }
        });
        document.getElementById('sparkInventory').chart = invChart;
      }

      // ========== TREND CHART ==========
      function initTrendChart() {
        const ctx = document.getElementById('trendChart').getContext('2d');
        const monthly = window.historicalData?.monthly || [];
        
        // Build labels and data from snapshots
        const labels = monthly.length > 0 
          ? monthly.map(m => {
              const [year, month] = m.period_month.split('-');
              const monthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
              return monthNames[parseInt(month)];
            })
          : ['Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan'];
        
        const actualRevenue = window.dashboardData.pl?.revenue || 0;
        const actualExpenses = window.dashboardData.pl?.totalExpenses || 0;
        const actualProfit = window.dashboardData.pl?.netProfit || 0;

        const revenueData = monthly.length > 0 
          ? monthly.map(m => parseFloat(m.revenue))
          : [180000, 120000, 95000, 80000, 60000, actualRevenue];
        revenueData[revenueData.length - 1] = actualRevenue;
          
        const expenseData = monthly.length > 0 
          ? monthly.map(m => parseFloat(m.revenue) - parseFloat(m.net_profit))
          : [145000, 105000, 100000, 92000, 68000, actualExpenses];
        expenseData[expenseData.length - 1] = actualExpenses;
          
        const profitData = monthly.length > 0 
          ? monthly.map(m => parseFloat(m.net_profit))
          : [35000, 15000, -5000, -12000, -8000, actualProfit];
        profitData[profitData.length - 1] = actualProfit;
        
        // Destroy if exists
        if (window.trendChartInstance) {
          window.trendChartInstance.destroy();
        }

        window.trendChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Revenue',
                data: revenueData,
                backgroundColor: '#0078D4',
                borderRadius: 4
              },
              {
                label: 'Expenses',
                data: expenseData,
                backgroundColor: '#D13438',
                borderRadius: 4
              },
              {
                label: 'Profit',
                data: profitData,
                backgroundColor: '#107C10',
                borderRadius: 4
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ': $' + context.raw.toLocaleString();
                  }
                }
              }
            },
            scales: {
              x: { grid: { display: false }, ticks: { font: { size: 11 } } },
              y: { 
                grid: { color: '#EDEBE9' },
                border: { display: false },
                ticks: { 
                  font: { size: 10, weight: '500' },
                  color: '#605E5C',
                  padding: 8,
                  callback: function(value) { 
                    if (value === 0) return '$0';
                    return '$' + (value / 1000).toFixed(0) + 'K'; 
                  }
                }
              }
            }
          }
        });
      }

      // ========== DRAWER FUNCTIONS ==========
      function openDrawer(type) {
        const drawer = document.getElementById('drawer');
        const overlay = document.getElementById('drawerOverlay');
        const title = document.getElementById('drawerTitle');
        const content = document.getElementById('drawerContent');

        const titles = {
          cash: 'Cash Position Details',
          revenue: 'Revenue Breakdown',
          profit: 'Profit & Loss Detail',
          receivables: 'Aged Receivables',
          inventory: 'Inventory Detail',
          pl: 'Full P&L Statement',
          balance: 'Balance Sheet',
          ratios: 'Financial Ratios',
          aged: 'Aged Debtors Analysis'
        };

        title.textContent = titles[type] || 'Detail View';
        content.innerHTML = getDrawerContent(type);

        drawer.classList.add('active');
        overlay.classList.add('active');
      }

      function closeDrawer() {
        document.getElementById('drawer').classList.remove('active');
        document.getElementById('drawerOverlay').classList.remove('active');
      }

      function getDrawerContent(type) {
        const cash = window.dashboardData.cash;
        const balance = window.dashboardData.balance;
        const receivables = window.dashboardData.receivables;

        const contents = {
          cash: `
            <div style="padding: 16px 0;">
              <h3 style="margin-bottom: 16px; font-size: 15px;">Bank Accounts</h3>
              <table class="data-table">
                <thead><tr><th>Account</th><th style="text-align:right">Balance</th></tr></thead>
                <tbody>
                  ${(cash.accounts || []).map(acc => `
                    <tr><td>${acc.name}</td><td style="text-align:right">$${(acc.balance || 0).toLocaleString()}</td></tr>
                  `).join('') || '<tr><td colspan="2">No accounts found</td></tr>'}
                  <tr style="font-weight:600; background:#f5f5f5;">
                    <td>Total Cash</td><td style="text-align:right">$${(cash.totalCash || 0).toLocaleString()}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          `,
          balance: `
            <div style="padding: 16px 0;">
              <h3 style="margin-bottom: 16px; font-size: 15px;">Balance Sheet Summary</h3>
              <table class="data-table">
                <tbody>
                  <tr><td>Total Assets</td><td style="text-align:right">$${(balance.totalAssets || 0).toLocaleString()}</td></tr>
                  <tr><td>Total Liabilities</td><td style="text-align:right">$${(balance.totalLiabilities || 0).toLocaleString()}</td></tr>
                  <tr style="font-weight:600; background:#f5f5f5;">
                    <td>Net Equity</td><td style="text-align:right">$${(balance.totalEquity || 0).toLocaleString()}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          `,
          aged: `
            <div style="padding: 16px 0;">
              <h3 style="margin-bottom: 16px; font-size: 15px;">Aged Receivables</h3>
              <table class="data-table">
                <thead><tr><th>Age</th><th style="text-align:right">Amount</th></tr></thead>
                <tbody>
                  <tr><td>Current (0-30 days)</td><td style="text-align:right">$${(receivables.aged30Days || 0).toLocaleString()}</td></tr>
                  <tr><td>31-60 days</td><td style="text-align:right">$${(receivables.aged60Days || 0).toLocaleString()}</td></tr>
                  <tr><td>61-90 days</td><td style="text-align:right">$${(receivables.aged90Days || 0).toLocaleString()}</td></tr>
                  <tr><td>90+ days</td><td style="text-align:right">$${(receivables.agedOver120Days || 0).toLocaleString()}</td></tr>
                </tbody>
              </table>
            </div>
          `,
          ratios: `
            <div style="padding: 16px 0;">
              <h3 style="margin-bottom: 16px; font-size: 15px;">Financial Ratios</h3>
              <table class="data-table">
                <tbody>
                  <tr><td>Current Ratio</td><td style="text-align:right">${balance.totalAssets && balance.totalLiabilities ? (balance.totalAssets / balance.totalLiabilities).toFixed(2) : 'N/A'}</td></tr>
                  <tr><td>Debt to Equity</td><td style="text-align:right">${balance.totalLiabilities && balance.totalEquity ? (balance.totalLiabilities / balance.totalEquity).toFixed(2) : 'N/A'}</td></tr>
                </tbody>
              </table>
            </div>
          `
        };

        return contents[type] || '<p>Loading...</p>';
      }

      // ========== CHAT FUNCTIONS ==========
      function toggleChat() {
        document.getElementById('chatPanel').classList.toggle('active');
      }

      function sendChat() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;

        addChatMessage(message, 'user');
        input.value = '';

        setTimeout(() => {
          addChatMessage("I'm analyzing your Mining financial data... This would connect to your MCP tools for real-time analysis.", 'assistant');
        }, 1000);
      }

      function sendSuggestion(text) {
        document.getElementById('chatInput').value = text;
        sendChat();
      }

      function addChatMessage(text, type) {
        const messages = document.getElementById('chatMessages');
        const div = document.createElement('div');
        div.className = `chat-message ${type}`;
        div.textContent = text;
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
      }

      function handleChatKeypress(event) {
        if (event.key === 'Enter') sendChat();
      }

// ========== SNAPSHOT FUNCTIONS ==========
      async function runDailySnapshot() {
        const btn = document.getElementById('snapshotBtn');
        const status = document.getElementById('snapshotStatus');
        
        if (!confirm('Run daily snapshot now?\\n\\nThis will capture data for all 7 organizations.')) {
          return;
        }
        
        btn.disabled = true;
        btn.classList.add('running');
        btn.innerHTML = '‚è≥ Running...';
        status.textContent = 'Processing...';
        status.className = 'snapshot-status';
        
        try {
          const response = await fetch(`${API_BASE}/api/run-daily-snapshot`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ triggeredBy: 'manual' })
          });
          
          const result = await response.json();
          
          if (result.success) {
            status.textContent = `‚úì ${result.orgsProcessed}/${result.orgsProcessed + result.orgsFailed} orgs (${result.durationSeconds}s)`;
            status.className = 'snapshot-status success';
            alert(`Snapshot complete!\n\nProcessed: ${result.orgsProcessed} orgs\nFailed: ${result.orgsFailed}\nDuration: ${result.durationSeconds}s`);


          } else {
            throw new Error(result.error || 'Unknown error');
          }
          
        } catch (error) {
          console.error('Snapshot failed:', error);
          status.textContent = '‚úó Failed';
          status.className = 'snapshot-status error';
          alert('Snapshot failed: ' + error.message);
        } finally {
          btn.disabled = false;
          btn.classList.remove('running');
          btn.innerHTML = 'üì∏ Snapshot';
        }
      }

      // ========== INITIALIZE ==========
      document.addEventListener('DOMContentLoaded', () => {
        loadDashboard();
      });
    </script>
  </body>
  </html>