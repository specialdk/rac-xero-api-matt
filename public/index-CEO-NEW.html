<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RAC Mining - Executive Dashboard</title>
    <!-- Chart.js for visualizations v3-->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* ========== CSS VARIABLES (Design System) ========== */
      :root {
        /* Semantic Colors */
        --color-positive: #107C10;
        --color-negative: #D13438;
        --color-warning: #FFB900;
        --color-primary: #0078D4;
        --color-primary-dark: #106EBE;
        
        /* Neutrals */
        --color-text-primary: #201F1E;
        --color-text-secondary: #605E5C;
        --color-text-muted: #8A8886;
        --color-border: #EDEBE9;
        
        /* Surfaces */
        --bg-page: #F5F5F5;
        --bg-card: #FFFFFF;
        --bg-header: #2C3E50;
        
        /* Shadows */
        --shadow-card: 0 2px 4px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
        --shadow-card-hover: 0 4px 12px rgba(0,0,0,0.12), 0 2px 4px rgba(0,0,0,0.08);
        --shadow-drawer: -4px 0 24px rgba(0,0,0,0.15);
        
        /* Typography */
        --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        --font-size-kpi: 36px;
        --font-size-kpi-secondary: 24px;
        --font-size-label: 12px;
        --font-size-body: 14px;
        --font-size-heading: 18px;
        
        /* Spacing */
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;
        
        /* Layout */
        --header-height: 56px;
        --drawer-width: 450px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: var(--font-family);
        background: var(--bg-page);
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      /* ========== HEADER ========== */
      .header {
        background: var(--bg-header);
        height: var(--header-height);
        padding: 0 var(--spacing-lg);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
      }

      .header h1 {
        font-size: 18px;
        font-weight: 600;
        color: white;
      }

      .header-status {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: 5px 12px;
        background: rgba(255,255,255,0.1);
        border-radius: 20px;
        font-size: 12px;
        color: rgba(255,255,255,0.9);
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--color-positive);
      }

      .status-dot.warning { background: var(--color-warning); }
      .status-dot.critical { background: var(--color-negative); }

      .header-right {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
      }

      .period-selector {
        padding: 6px 14px;
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 6px;
        font-size: 13px;
        background: rgba(255,255,255,0.1);
        color: white;
        cursor: pointer;
      }

      .period-selector option {
        background: var(--bg-header);
        color: white;
      }

      .btn-refresh {
        padding: 6px 16px;
        background: var(--color-primary);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
      }

      .btn-refresh:hover {
        background: var(--color-primary-dark);
      }

  .btn-chat {
        padding: 6px 14px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .btn-dashboard {
        padding: 6px 14px;
        background: rgba(255,255,255,0.15);
        color: white;
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      /* ========== ENTITY MULTI-SELECT ========== */
      .entity-picker {
        position: relative;
      }

      .entity-picker-btn {
        padding: 6px 14px;
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 6px;
        font-size: 13px;
        background: rgba(255,255,255,0.1);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 200px;
        transition: all 0.2s;
      }

      .entity-picker-btn:hover {
        background: rgba(255,255,255,0.2);
        border-color: rgba(255,255,255,0.5);
      }

      .entity-picker-btn .arrow {
        margin-left: auto;
        font-size: 10px;
        transition: transform 0.2s;
      }

      .entity-picker.open .entity-picker-btn .arrow {
        transform: rotate(180deg);
      }

      .entity-picker-dropdown {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        min-width: 280px;
        background: var(--bg-header);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 8px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        z-index: 200;
        display: none;
        overflow: hidden;
      }

      .entity-picker.open .entity-picker-dropdown {
        display: block;
      }

      .entity-option {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        cursor: pointer;
        color: rgba(255,255,255,0.9);
        font-size: 13px;
        transition: background 0.15s;
        user-select: none;
      }

      .entity-option:hover {
        background: rgba(255,255,255,0.1);
      }

      .entity-option.selected {
        background: rgba(0, 120, 212, 0.3);
      }

      .entity-option input[type="radio"] {
        width: 16px;
        height: 16px;
        accent-color: var(--color-primary);
        cursor: pointer;
        flex-shrink: 0;
      }

      .entity-option .entity-emoji {
        font-size: 15px;
        width: 20px;
        text-align: center;
      }

      .entity-option-divider {
        height: 1px;
        background: rgba(255,255,255,0.1);
        margin: 2px 0;
      }

      .entity-count-badge {
        background: var(--color-primary);
        color: white;
        border-radius: 10px;
        padding: 1px 7px;
        font-size: 11px;
        font-weight: 600;
      }

      .btn-snapshot {
        padding: 6px 14px;
        background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
      }

      .btn-snapshot:disabled {
        background: #9CA3AF;
        cursor: not-allowed;
      }

      .btn-snapshot.running {
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }

      .snapshot-status {
        font-size: 11px;
        color: rgba(255,255,255,0.8);
        margin-left: 4px;
      }

      .snapshot-status.success { color: #34D399; }

      /* ========== REVERSAL TOGGLE ========== */
      .btn-reversal {
        padding: 6px 14px;
        background: rgba(255,255,255,0.15);
        color: white;
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .btn-reversal:hover {
        background: rgba(255,255,255,0.25);
        border-color: rgba(255,255,255,0.5);
      }

      .btn-reversal.active {
        background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
        border-color: transparent;
        color: white;
      }

      .btn-reversal .reversal-count {
        background: rgba(255,255,255,0.25);
        padding: 1px 6px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 700;
      }

      .btn-reversal.active .reversal-count {
        background: rgba(255,255,255,0.3);
      }

      .btn-reversal.loading {
        opacity: 0.7;
        pointer-events: none;
      }

      /* Reversal drawer content */
      .reversal-summary {
        background: #FEF2F2;
        border: 1px solid #FECACA;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
      }

      .reversal-summary h4 {
        color: #991B1B;
        font-size: 14px;
        margin-bottom: 12px;
      }

      .reversal-summary-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .reversal-summary-item {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        padding: 4px 0;
      }

      .reversal-summary-item .label { color: #6B7280; }
      .reversal-summary-item .value { font-weight: 600; color: #111827; }

      .reversal-journal-card {
        background: white;
        border: 1px solid var(--color-border);
        border-radius: 8px;
        padding: 14px;
        margin-bottom: 10px;
      }

      .reversal-journal-card .journal-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
      }

      .reversal-journal-card .journal-ref {
        font-weight: 600;
        font-size: 13px;
        color: var(--color-text-primary);
      }

      .reversal-journal-card .journal-date {
        font-size: 12px;
        color: var(--color-text-muted);
      }

      .reversal-journal-card .journal-amount {
        font-weight: 700;
        font-size: 14px;
        color: #DC2626;
      }

      .reversal-journal-card .journal-lines {
        margin-top: 8px;
        border-top: 1px solid var(--color-border);
        padding-top: 8px;
      }

      .reversal-journal-card .journal-line {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        padding: 3px 0;
        color: var(--color-text-secondary);
      }

      .reversal-journal-card .journal-line .line-account {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin-right: 8px;
      }

      .reversal-journal-card .journal-line .line-amount {
        font-weight: 600;
        white-space: nowrap;
      }

      .reversal-journal-card .journal-line .line-amount.debit { color: #DC2626; }
      .reversal-journal-card .journal-line .line-amount.credit { color: #059669; }

      .reversal-journal-card .journal-desc {
        font-size: 11px;
        color: var(--color-text-muted);
        margin-top: 6px;
        font-style: italic;
        line-height: 1.4;
      }
      .snapshot-status.error { color: #F87171; }




      /* ========== MAIN LAYOUT ========== */
      .main-container {
        flex: 1;
        display: flex;
        overflow: hidden;
      }

      .dashboard {
        flex: 1;
        padding: var(--spacing-md);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      /* ========== KPI ROW (Top) ========== */
      .kpi-row {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: var(--spacing-md);
      }

      .kpi-card {
        background: var(--bg-card);
        border-radius: 10px;
        padding: var(--spacing-md);
        box-shadow: var(--shadow-card);
        cursor: pointer;
        transition: box-shadow 0.2s, transform 0.2s;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .kpi-card:hover {
        box-shadow: var(--shadow-card-hover);
        transform: translateY(-2px);
      }

      .kpi-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }

      .kpi-label {
        font-size: var(--font-size-label);
        font-weight: 600;
        color: var(--color-text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .kpi-arrow {
        color: var(--color-text-muted);
        opacity: 0;
        transition: opacity 0.2s;
        font-size: 14px;
      }

      .kpi-card:hover .kpi-arrow {
        opacity: 1;
      }

      .summary-card .card-arrow {
        opacity: 0;
        transition: opacity 0.2s;
      }

      .summary-card:hover .card-arrow {
        opacity: 1;
      }


      .kpi-value {
        font-size: var(--font-size-kpi);
        font-weight: 600;
        color: var(--color-text-primary);
        line-height: 1.1;
        font-variant-numeric: tabular-nums;
        margin: var(--spacing-xs) 0;
      }

      .kpi-value.smaller {
        font-size: var(--font-size-kpi-secondary);
      }

      .kpi-trend {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: 12px;
        font-weight: 600;
      }

      .kpi-trend.positive { color: var(--color-positive); }
      .kpi-trend.negative { color: var(--color-negative); }
      .kpi-trend.neutral { color: var(--color-text-muted); }

      .kpi-sparkline {
        flex: 1;
        min-height: 40px;
        margin-top: var(--spacing-sm);
      }

      .kpi-sparkline canvas {
        width: 100% !important;
        height: 100% !important;
      }

      /* Status indicator bar at bottom of card */
      .kpi-status-bar {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
      }

      .kpi-status-bar.healthy { background: var(--color-positive); }
      .kpi-status-bar.warning { background: var(--color-warning); }
      .kpi-status-bar.critical { background: var(--color-negative); }

      /* ========== CHART ROW (Full Width) ========== */
      .chart-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;
        gap: var(--spacing-md);
        min-height: 200px;
      }

      .chart-card {
        background: var(--bg-card);
        border-radius: 10px;
        padding: var(--spacing-md);
        box-shadow: var(--shadow-card);
        display: flex;
        flex-direction: column;
      }

      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-sm);
      }

      .chart-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--color-text-primary);
      }

      .chart-subtitle {
        font-size: 11px;
        color: var(--color-text-muted);
      }

      .chart-legend {
        display: flex;
        gap: var(--spacing-md);
        font-size: 11px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 4px;
        color: var(--color-text-secondary);
      }

      .legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 2px;
      }

      .chart-container {
        flex: 1;
        position: relative;
        min-height: 150px;
      }

      /* ========== BUDGET HORIZONTAL BARS ========== */
      .budget-bars-container {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
        padding: var(--spacing-sm) 0;
      }

      .budget-bar-item {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .budget-bar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
      }

      .budget-bar-label {
        font-weight: 600;
        color: var(--color-text-primary);
      }

      .budget-bar-values {
        display: flex;
        gap: var(--spacing-sm);
        align-items: center;
      }

      .budget-bar-actual {
        font-weight: 600;
        color: var(--color-text-primary);
      }

      .budget-bar-target {
        color: var(--color-text-muted);
        font-size: 12px;
      }

      .budget-bar-variance {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
      }

      .budget-bar-variance.positive {
        background: #E6F4EA;
        color: var(--color-positive);
      }

      .budget-bar-variance.negative {
        background: #FDECE9;
        color: var(--color-negative);
      }

      .budget-bar-track {
        height: 24px;
        background: var(--color-border);
        border-radius: 4px;
        position: relative;
        overflow: hidden;
      }

      .budget-bar-fill {
        height: 100%;
        border-radius: 4px;
        display: flex;
        align-items: center;
        padding-left: 8px;
        font-size: 11px;
        font-weight: 600;
        color: white;
        transition: width 0.5s ease;
      }

      .budget-bar-fill.under-budget {
        background: linear-gradient(90deg, var(--color-positive), #34D058);
      }

      .budget-bar-fill.over-budget {
        background: linear-gradient(90deg, var(--color-negative), #F97583);
      }

      .budget-bar-fill.at-budget {
        background: linear-gradient(90deg, var(--color-primary), #58A6FF);
      }

      .budget-bar-marker {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 3px;
        background: var(--color-text-primary);
        border-radius: 2px;
      }

      .budget-bar-marker::after {
        content: 'Budget';
        position: absolute;
        top: -16px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 9px;
        color: var(--color-text-muted);
        white-space: nowrap;
      }

      /* ========== PRODUCTION CARD ========== */
      .production-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      .production-table thead th {
        font-size: 10px;
        text-transform: uppercase;
        color: var(--color-text-muted);
        font-weight: 600;
        padding: 4px 6px;
        text-align: right;
        border-bottom: 1px solid var(--color-border);
        white-space: nowrap;
      }

      .production-table thead th:first-child {
        text-align: left;
      }

      .production-table tbody td {
        padding: 5px 6px;
        text-align: right;
        border-bottom: 1px solid #f0f0f0;
        white-space: nowrap;
      }

      .production-table tbody td:first-child {
        text-align: left;
        font-weight: 500;
        max-width: 120px;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .production-table tfoot td {
        padding: 6px;
        text-align: right;
        font-weight: 700;
        border-top: 2px solid var(--color-border);
        font-size: 12px;
      }

      .production-table tfoot td:first-child {
        text-align: left;
      }

      .prod-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 2px;
        vertical-align: middle;
      }

      .prod-indicator.green { background: var(--color-positive); }
      .prod-indicator.amber { background: #F59E0B; }
      .prod-indicator.red { background: var(--color-negative); }
      .prod-indicator.grey { background: #D1D5DB; }

      .production-scroll {
        flex: 1;
        overflow-y: auto;
        min-height: 0;
      }

      /* ========== SUMMARY ROW (Bottom) ========== */
     .summary-row {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: var(--spacing-md);
        flex: 1;
        min-height: 0;
      }

      .summary-card {
        background: var(--bg-card);
        border-radius: 10px;
        padding: var(--spacing-md);
        box-shadow: var(--shadow-card);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-sm);
      }

      .card-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--color-text-primary);
      }

      .card-subtitle {
        font-size: 11px;
        color: var(--color-text-muted);
      }

      .card-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }

      /* Budget Progress Card */
      .budget-item {
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding: 10px 0;
        border-bottom: 1px solid var(--color-border);
      }

      .budget-item:last-child {
        border-bottom: none;
      }

      .budget-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .budget-item-label {
        font-size: 15px;
        font-weight: 600;
        color: var(--color-text-primary);
      }

      .budget-item-values {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        font-size: 12px;
      }

      .budget-actual {
  font-weight: 600;
  font-size: var(--font-size-kpi);
  color: var(--color-text-primary);
}

      .budget-target {
        color: var(--color-text-muted);
      }

      .budget-variance {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
      }

      .budget-variance.positive {
        background: #E6F4EA;
        color: var(--color-positive);
      }

      .budget-variance.negative {
        background: #FDECE9;
        color: var(--color-negative);
      }

      .budget-bar {
        height: 6px;
        background: var(--color-border);
        border-radius: 3px;
        overflow: hidden;
      }

      .budget-bar-fill-small {
        height: 100%;
        border-radius: 3px;
        transition: width 0.5s ease;
      }

      .budget-bar-fill-small.under { background: var(--color-positive); }
      .budget-bar-fill-small.over { background: var(--color-negative); }
      .budget-bar-fill-small.at-target { background: var(--color-primary); }

      /* Inventory Summary Card */
      .inventory-total {
        text-align: center;
        padding: var(--spacing-md);
        background: linear-gradient(135deg, #E3F2FD 0%, #F3E5F5 100%);
        border-radius: 8px;
        margin-bottom: var(--spacing-sm);
      }

      .inventory-total-value {
        font-size: 28px;
        font-weight: 600;
        color: var(--color-text-primary);
      }

      .inventory-total-label {
        font-size: 11px;
        color: var(--color-text-secondary);
        margin-top: 2px;
      }

      .inventory-status-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .inventory-status-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 10px;
        background: var(--bg-page);
        border-radius: 6px;
        font-size: 12px;
      }

      .status-badge {
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-badge.at-target { background: #E6F4EA; color: var(--color-positive); }
      .status-badge.below { background: #FDECE9; color: var(--color-negative); }
      .status-badge.above { background: #E6F4EA; color: var(--color-positive); }
      .status-badge.adequate { background: #FFF8E1; color: #F57C00; }

      /* Key Ratios Card */
      .ratios-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-sm);
      }

      .ratio-item {
        background: var(--bg-page);
        padding: 12px;
        border-radius: 8px;
        text-align: center;
      }

      .ratio-label {
        font-size: 11px;
        color: var(--color-text-secondary);
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }

      .ratio-value {
        font-size: var(--font-size-kpi);
        font-weight: 600;
        color: var(--color-text-primary);
      }

      .ratio-value.positive { color: var(--color-positive); }
      .ratio-value.negative { color: var(--color-negative); }
      .ratio-value.neutral { color: var(--color-primary); }

      /* Top Customers Card */
      .customer-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .customer-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: 10px;
        background: var(--bg-page);
        border-radius: 8px;
      }

      .customer-rank {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--color-primary);
        color: white;
        border-radius: 50%;
        font-size: 11px;
        font-weight: 600;
      }

      .customer-info {
        flex: 1;
        min-width: 0;
      }

      .customer-name {
        font-size: 13px;
        font-weight: 600;
        color: var(--color-text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .customer-orders {
        font-size: 11px;
        color: var(--color-text-muted);
      }

      .customer-value {
        font-size: 26px;
        font-weight: 600;
        color: var(--color-text-primary);
      }

      .customer-bar {
        width: 100%;
        height: 3px;
        background: var(--color-border);
        border-radius: 2px;
        margin-top: 6px;
      }

      .customer-bar-fill {
        height: 100%;
        background: var(--color-primary);
        border-radius: 2px;
      }

      /* ========== DRAWER (Drill-down Panel) ========== */
      .drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.3);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
        z-index: 100;
      }

      .drawer-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .drawer {
        position: fixed;
        top: 0;
        right: 0;
        width: var(--drawer-width);
        height: 100vh;
        background: var(--bg-card);
        box-shadow: var(--shadow-drawer);
        transform: translateX(100%);
        transition: transform 0.3s ease;
        z-index: 101;
        display: flex;
        flex-direction: column;
      }

      .drawer.active {
        transform: translateX(0);
      }

      .drawer-header {
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--color-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .drawer-title {
        font-size: var(--font-size-heading);
        font-weight: 600;
        color: var(--color-text-primary);
      }

      .drawer-close {
        width: 32px;
        height: 32px;
        border: none;
        background: var(--bg-page);
        border-radius: 50%;
        cursor: pointer;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--color-text-secondary);
      }

      .drawer-close:hover {
        background: var(--color-border);
      }

      .drawer-content {
        flex: 1;
        padding: var(--spacing-lg);
        overflow-y: auto;
      }

       /* ========== AI CHAT PANEL ========== */
      .chat-panel {
        width: 450px;
        min-width: 450px;
        background: var(--bg-card);
        border-left: 1px solid var(--color-border);
        display: flex;
        flex-direction: column;
        z-index: 50;
      }

      .chat-panel.expanded {
        width: 600px;
        min-width: 600px;
      }

      .chat-header {
        padding: var(--spacing-md);
        border-bottom: 1px solid var(--color-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .chat-header h3 {
        font-size: 14px;
        font-weight: 600;
      }

      .chat-header-actions {
        display: flex;
        gap: 6px;
      }

      .chat-header-actions button {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .chat-header-actions button:hover {
        background: rgba(255,255,255,0.3);
      }

      .chat-context {
        padding: 6px 12px;
        background: rgba(102, 126, 234, 0.08);
        border-bottom: 1px solid var(--color-border);
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 11px;
        color: var(--color-text-secondary);
      }

      .chat-context .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #10b981;
        margin-left: auto;
      }

      .chat-context .status-dot.live {
        animation: pulse-dot 2s infinite;
      }

      @keyframes pulse-dot {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
      }

      .chat-messages {
        flex: 1;
        padding: var(--spacing-md);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .chat-message {
        max-width: 85%;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 13px;
        line-height: 1.5;
      }

      .chat-message.assistant {
        background: var(--bg-page);
        color: var(--color-text-primary);
        align-self: flex-start;
        border-bottom-left-radius: 4px;
      }

      .chat-message.user {
        background: var(--color-primary);
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
      }

      .message-content strong {
        font-weight: 600;
      }

      .message-meta {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 4px;
        font-size: 10px;
        color: var(--color-text-muted);
      }

      .chat-message.user .message-meta {
        color: rgba(255,255,255,0.6);
        justify-content: flex-end;
      }

      .copy-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 12px;
        padding: 0;
        opacity: 0.5;
      }

      .copy-btn:hover {
        opacity: 1;
      }

      /* Typing indicator */
      .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 12px 16px !important;
        align-self: flex-start;
        background: var(--bg-page);
        border-radius: 12px;
        border-bottom-left-radius: 4px;
      }

      .typing-indicator .dot {
        width: 8px;
        height: 8px;
        background: var(--color-text-secondary);
        border-radius: 50%;
        animation: typing-bounce 1.4s infinite ease-in-out;
      }

      .typing-indicator .dot:nth-child(2) { animation-delay: 0.2s; }
      .typing-indicator .dot:nth-child(3) { animation-delay: 0.4s; }

      @keyframes typing-bounce {
        0%, 80%, 100% { transform: translateY(0); opacity: 0.4; }
        40% { transform: translateY(-6px); opacity: 1; }
      }

      .chat-suggestions {
        padding: var(--spacing-sm);
        border-top: 1px solid var(--color-border);
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .suggestion-chip {
        padding: 6px 12px;
        background: var(--bg-page);
        border: 1px solid var(--color-border);
        border-radius: 16px;
        font-size: 11px;
        color: var(--color-text-secondary);
        cursor: pointer;
        transition: all 0.2s;
      }

      .suggestion-chip:hover {
        border-color: var(--color-primary);
        color: var(--color-primary);
      }

      .chat-input-area {
        padding: var(--spacing-sm);
        border-top: 1px solid var(--color-border);
        display: flex;
        gap: 6px;
      }

      .chat-input {
        flex: 1;
        padding: 10px 14px;
        border: 1px solid var(--color-border);
        border-radius: 20px;
        font-size: 13px;
        outline: none;
      }

      .chat-input:focus {
        border-color: var(--color-primary);
      }

      .chat-send {
        width: 38px;
        height: 38px;
        background: var(--color-primary);
        border: none;
        border-radius: 50%;
        color: white;
        cursor: pointer;
        font-size: 16px;
      }

      

      /* ========== DATA TABLE (for drawers) ========== */
      .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      .data-table thead {
        background: var(--bg-page);
      }

      .data-table th {
        text-align: left;
        padding: 10px 12px;
        font-weight: 600;
        color: var(--color-text-secondary);
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .data-table td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--color-border);
        color: var(--color-text-primary);
      }

      .data-table tbody tr:hover {
        background: var(--bg-page);
      }

      /* Loading state */
      .loading {
        color: var(--color-text-muted);
        font-style: italic;
      }

      /* ========== RESPONSIVE ========== */
      @media (max-width: 1400px) {
        .kpi-row {
          grid-template-columns: repeat(3, 1fr);
        }
        
        .kpi-value {
          font-size: 28px;
        }
        
        .chart-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- ========== HEADER ========== -->
    <header class="header">
      <div class="header-left">
        <h1>&#x26CF;&#xFE0F; RAC Mining - Executive Dashboard</h1>
        <div class="header-status">
          <span class="status-dot" id="healthDot"></span>
          <span id="healthStatus">Loading...</span>
        </div>
      </div>
      <div class="header-right">
        <!-- Entity Multi-Select -->
        <div class="entity-picker" id="entityPicker">
          <button class="entity-picker-btn" onclick="toggleEntityPicker(event)">
            <span id="entityPickerLabel">&#x26CF;&#xFE0F; Rirratjingu Mining</span>
            <span class="arrow">&#x25BC;</span>
          </button>
          <div class="entity-picker-dropdown" id="entityDropdown">
            <label class="entity-option" data-value="ALL">
              <input type="radio" name="entity" value="ALL">
              <span class="entity-emoji">&#x1F4CA;</span>
              <span>All Entities (Consolidated)</span>
            </label>
            <div class="entity-option-divider"></div>
            <label class="entity-option selected" data-value="Mining">
              <input type="radio" name="entity" value="Mining" checked>
              <span class="entity-emoji">&#x26CF;&#xFE0F;</span>
              <span>Rirratjingu Mining</span>
            </label>
            <label class="entity-option" data-value="Aboriginal Corporation">
              <input type="radio" name="entity" value="Aboriginal Corporation">
              <span class="entity-emoji">&#x1F3DB;&#xFE0F;</span>
              <span>Aboriginal Corporation</span>
            </label>
            <label class="entity-option" data-value="Enterprises">
              <input type="radio" name="entity" value="Enterprises">
              <span class="entity-emoji">&#x1F3E2;</span>
              <span>Enterprises</span>
            </label>
            <label class="entity-option" data-value="Property">
              <input type="radio" name="entity" value="Property">
              <span class="entity-emoji">&#x1F3E0;</span>
              <span>Property Management</span>
            </label>
            <label class="entity-option" data-value="Ngarrkuwuy">
              <input type="radio" name="entity" value="Ngarrkuwuy">
              <span class="entity-emoji">&#x1F528;</span>
              <span>Ngarrkuwuy Developments</span>
            </label>
            <label class="entity-option" data-value="Invest">
              <input type="radio" name="entity" value="Invest">
              <span class="entity-emoji">&#x1F4B0;</span>
              <span>Miliditjpi Trust</span>
            </label>
            <label class="entity-option" data-value="Marrin">
              <input type="radio" name="entity" value="Marrin">
              <span class="entity-emoji">&#x1F3D7;&#xFE0F;</span>
              <span>Marrin Square</span>
            </label>
          </div>
        </div>
        <select class="period-selector" id="periodSelector" onchange="loadDashboard()">
          <option value="Q1">Q1 FY25/26 (Jul-Sep)</option>
          <option value="Q2">Q2 FY25/26 (Oct-Dec)</option>
          <option value="Q3" selected>Q3 FY25/26 (Jan-Mar)</option>
          <option value="Q4">Q4 FY25/26 (Apr-Jun)</option>
        </select>
        <button class="btn-refresh" onclick="loadDashboard()">&#x21BB; Refresh</button>
        <button class="btn-snapshot" id="snapshotBtn" onclick="runDailySnapshot()">&#x1F4F8; Snapshot</button>
        <span class="snapshot-status" id="snapshotStatus"></span>
        <button class="btn-reversal" id="reversalToggle" onclick="toggleReversals()" title="Hide/show reversal journal entries from P&L">&#x1F504; Reversals <span class="reversal-count" id="reversalCount" style="display:none">0</span></button>
        <button class="btn-dashboard" onclick="window.location.href='/'">ðŸ”— Connection Manager</button>
      </div>
    </header>

    <!-- ========== MAIN CONTAINER ========== -->
    <div class="main-container">
      <!-- ========== DASHBOARD ========== -->
      <div class="dashboard">
        
        <!-- KPI Row - Primary Metrics with Sparklines -->
        <div class="kpi-row">
          <!-- Cash Position -->
          <div class="kpi-card" onclick="openDrawer('cash')">
            <div class="kpi-header">
              <div class="kpi-label">Cash Position</div>
              <span class="kpi-arrow">&#x2192;</span>
            </div>
            <div class="kpi-value" id="kpi-cash">Loading...</div>
            <div class="kpi-trend neutral" id="kpi-cash-trend">--</div>
            <div class="kpi-sparkline">
              <canvas id="sparkCash"></canvas>
            </div>
            <div class="kpi-status-bar healthy" id="kpi-cash-status"></div>
          </div>

          <!-- Revenue -->
          <div class="kpi-card" onclick="openDrawer('revenue')">
            <div class="kpi-header">
              <div class="kpi-label">Revenue (Period)</div>
              <span class="kpi-arrow">&#x2192;</span>
            </div>
            <div class="kpi-value" id="kpi-revenue">Loading...</div>
            <div class="kpi-trend neutral" id="kpi-revenue-trend">--</div>
            <div class="kpi-sparkline">
              <canvas id="sparkRevenue"></canvas>
            </div>
            <div class="kpi-status-bar warning" id="kpi-revenue-status"></div>
          </div>

          <!-- Net Profit -->
          <div class="kpi-card" onclick="openDrawer('profit')">
            <div class="kpi-header">
              <div class="kpi-label">Net Profit</div>
              <span class="kpi-arrow">&#x2192;</span>
            </div>
            <div class="kpi-value" id="kpi-profit">Loading...</div>
            <div class="kpi-trend neutral" id="kpi-profit-trend">--</div>
            <div class="kpi-sparkline">
              <canvas id="sparkProfit"></canvas>
            </div>
            <div class="kpi-status-bar critical" id="kpi-profit-status"></div>
          </div>

          <!-- Receivables -->
          <div class="kpi-card" onclick="openDrawer('receivables')">
            <div class="kpi-header">
              <div class="kpi-label">Receivables</div>
              <span class="kpi-arrow">&#x2192;</span>
            </div>
            <div class="kpi-value" id="kpi-receivables">Loading...</div>
            <div class="kpi-trend neutral" id="kpi-receivables-trend">--</div>
            <div class="kpi-sparkline">
              <canvas id="sparkReceivables"></canvas>
            </div>
            <div class="kpi-status-bar healthy" id="kpi-receivables-status"></div>
          </div>

          <!-- Inventory Value (Mining only) / Top Expenses (other entities) -->
          <div id="inventory-card" class="kpi-card" onclick="openDrawer('inventory')">
            <div class="kpi-header">
              <div class="kpi-label">Inventory Value</div>
              <span class="kpi-arrow">&#x2192;</span>
            </div>
            <div class="kpi-value" id="kpi-inventory">Loading...</div>
            <div class="kpi-trend neutral" id="kpi-inventory-trend">--</div>
            <div class="kpi-sparkline">
              <canvas id="sparkInventory"></canvas>
            </div>
            <div class="kpi-status-bar healthy" id="kpi-inventory-status"></div>
          </div>

          <!-- Top Expenses (non-Mining entities) -->
          <div id="expenses-card" class="kpi-card" onclick="openDrawer('expenses')" style="display: none;">
            <div class="kpi-header">
              <div class="kpi-label">OPERATING EXPENSES</div>
              <span class="kpi-arrow">&#x2192;</span>
            </div>
            <div class="kpi-value" id="kpi-top-expense">Loading...</div>
            <div class="kpi-trend neutral" id="kpi-expense-trend">--</div>
            <div class="kpi-sparkline">
              <canvas id="sparkExpenses"></canvas>
            </div>
            <div class="kpi-status-bar" id="kpi-expense-status"></div>
          </div>
        </div>

        <!-- Chart Row - Visual Impact -->
        <div class="chart-row">
          <!-- Revenue & Expenses Trend -->
          <div class="chart-card">
            <div class="chart-header">
              <div>
                <div class="chart-title">Revenue & Expenses Trend</div>
                <div class="chart-subtitle">Monthly performance with YTD totals</div>
              </div>
              <div style="display: flex; align-items: center; gap: 16px;">
                <div class="chart-legend">
                  <span class="legend-item"><span class="legend-dot" style="background: #0078D4"></span> Revenue</span>
                  <span class="legend-item"><span class="legend-dot" style="background: #D13438"></span> Expenses</span>
                  <span class="legend-item"><span class="legend-dot" style="background: #107C10"></span> Profit</span>
                </div>
                <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--color-text-secondary); cursor: pointer;">
                  <input type="checkbox" id="ytdToggle" onchange="initTrendChart()" style="accent-color: var(--color-primary);">
                  YTD Lines
                </label>
              </div>
            </div>
            <!-- YTD Summary Bar -->
            <div id="ytdSummaryBar" style="display: flex; gap: 24px; padding: 6px 0 8px; border-bottom: 1px solid var(--color-border); margin-bottom: 4px;">
              <div style="font-size: 12px;">
                <span style="color: var(--color-text-muted);">YTD Revenue:</span>
                <span id="ytd-revenue" style="font-weight: 600; color: #0078D4; margin-left: 4px;">$0</span>
              </div>
              <div style="font-size: 12px;">
                <span style="color: var(--color-text-muted);">YTD Expenses:</span>
                <span id="ytd-expenses" style="font-weight: 600; color: #D13438; margin-left: 4px;">$0</span>
              </div>
              <div style="font-size: 12px;">
                <span style="color: var(--color-text-muted);">YTD Profit:</span>
                <span id="ytd-profit" style="font-weight: 600; margin-left: 4px;">$0</span>
              </div>
            </div>
            <div class="chart-container">
              <canvas id="trendChart"></canvas>
            </div>
          </div>

          <!-- Budget vs Actual - Horizontal Bars -->
          <div class="chart-card">
            <div class="chart-header">
              <div>
                <div class="chart-title">Budget vs Actual</div>
                <div class="chart-subtitle" id="budget-period">Current quarter (pro-rated)</div>
              </div>
            </div>
            <div class="budget-bars-container" id="budgetBars">
              <!-- Revenue Bar -->
              <div class="budget-bar-item">
                <div class="budget-bar-header">
                  <span class="budget-bar-label">Revenue</span>
                  <div class="budget-bar-values">
                    <span class="budget-bar-actual" id="bar-rev-actual">$0</span>
                    <span class="budget-bar-target" id="bar-rev-target">of $0</span>
                    <span class="budget-bar-variance negative" id="bar-rev-var">0%</span>
                  </div>
                </div>
                <div class="budget-bar-track">
                  <div class="budget-bar-fill at-budget" id="bar-rev-fill" style="width: 0%"></div>
                  <div class="budget-bar-marker" id="bar-rev-marker" style="left: 100%"></div>
                </div>
              </div>

              <!-- Expenses Bar -->
              <div class="budget-bar-item">
                <div class="budget-bar-header">
                  <span class="budget-bar-label">Expenses</span>
                  <div class="budget-bar-values">
                    <span class="budget-bar-actual" id="bar-exp-actual">$0</span>
                    <span class="budget-bar-target" id="bar-exp-target">of $0</span>
                    <span class="budget-bar-variance negative" id="bar-exp-var">0%</span>
                  </div>
                </div>
                <div class="budget-bar-track">
                  <div class="budget-bar-fill at-budget" id="bar-exp-fill" style="width: 0%"></div>
                  <div class="budget-bar-marker" id="bar-exp-marker" style="left: 100%"></div>
                </div>
              </div>

              <!-- Gross Profit Bar -->
              <div class="budget-bar-item">
                <div class="budget-bar-header">
                  <span class="budget-bar-label">Gross Profit</span>
                  <div class="budget-bar-values">
                    <span class="budget-bar-actual" id="bar-gp-actual">$0</span>
                    <span class="budget-bar-target" id="bar-gp-target">of $0</span>
                    <span class="budget-bar-variance negative" id="bar-gp-var">0%</span>
                  </div>
                </div>
                <div class="budget-bar-track">
                  <div class="budget-bar-fill at-budget" id="bar-gp-fill" style="width: 0%"></div>
                  <div class="budget-bar-marker" id="bar-gp-marker" style="left: 100%"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Production Overview (Mining only) -->
          <div class="chart-card" id="production-card" onclick="openDrawer('production')" style="cursor: pointer; display: none;">
            <div class="chart-header">
              <div>
                <div class="chart-title">&#x2692;&#xFE0F; Production</div>
                <div class="chart-subtitle" id="production-period">QTD overview</div>
              </div>
              <span style="color: var(--color-text-muted); font-size: 18px;">&#x203A;</span>
            </div>
            <div class="production-scroll">
              <table class="production-table">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>SOH</th>
                    <th>Made</th>
                    <th>Sold</th>
                    <th>Orders</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="productionBody">
                  <tr><td colspan="6" style="text-align:center; color: var(--color-text-muted); padding: 20px;">Loading...</td></tr>
                </tbody>
                <tfoot id="productionFoot"></tfoot>
              </table>
            </div>
          </div>
        </div>

        <!-- Summary Row - Detail Cards -->
        <div class="summary-row">
          
          <!-- Budget Progress (Detailed) -->
          <div class="summary-card" onclick="openDrawer('profit')" style="cursor: pointer;">
            <div class="card-header">
              <div>
                <div class="card-title">P&L Summary</div>
                <div class="card-subtitle" id="pl-period">Q3 FY25/26</div>
              </div>
              <span class="card-arrow" style="color: var(--color-text-muted); font-size: 18px;">&#x2192;</span>
            </div>
            <div class="card-content">
              <div class="budget-item">
                <div class="budget-item-header">
                  <span class="budget-item-label">Revenue</span>
                  <span class="budget-actual" id="pl-revenue">$0</span>
                </div>
              </div>
              <div class="budget-item">
                <div class="budget-item-header">
                  <span class="budget-item-label">COGS</span>
                  <span class="budget-actual" id="pl-cogs">$0</span>
                </div>
              </div>
              <div class="budget-item" style="background: #FFFBEB; margin: 0 -16px; padding: 10px 16px;">
                <div class="budget-item-header">
                  <span class="budget-item-label">Gross Profit</span>
                  <span class="budget-actual" id="pl-gross">$0</span>
                </div>
              </div>
              <div class="budget-item">
                <div class="budget-item-header">
                  <span class="budget-item-label">OpEx</span>
                  <span class="budget-actual" id="pl-opex">$0</span>
                </div>
              </div>
              <div class="budget-item">
                <div class="budget-item-header">
                  <span class="budget-item-label">Net Profit</span>
               <span class="budget-actual" id="pl-net">$0</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Top Customers -->
          <div class="summary-card">
            <div class="card-header">
              <div>
                <div class="card-title">Top Customers</div>
                <div class="card-subtitle" id="customers-period">FY26 Year to Date</div>
              </div>
            </div>
            <div class="card-content">
              <div class="customer-list" id="customerList">
                <div class="customer-item loading">Loading customers...</div>
              </div>
            </div>
          </div>
       

        <!-- Balance Sheet Summary -->
          <div class="summary-card" onclick="openDrawer('balance')" style="cursor: pointer;">
            <div class="card-header">
              <div>
                <div class="card-title">Balance Sheet</div>
                <div class="card-subtitle">Current position</div>
              </div>
             <span style="color: var(--color-text-muted); font-size: 18px;">&#x2192;</span>
            </div>
            <div class="card-content">
              <div class="budget-item">
                <div class="budget-item-header">
                  <span class="budget-item-label">Total Assets</span>
                  <span class="budget-actual" id="bs-assets">$0</span>
                </div>
              </div>
              <div class="budget-item">
                <div class="budget-item-header">
                  <span class="budget-item-label">Total Liabilities</span>
                  <span class="budget-actual" id="bs-liabilities">$0</span>
                </div>
              </div>
              <div class="budget-item" style="background: #E8F5E9; margin: 0 -16px; padding: 10px 16px;">
                <div class="budget-item-header">
                  <span class="budget-item-label">Net Equity</span>
                  <span class="budget-actual" id="bs-equity">$0</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Key Financial Ratios -->
          <div class="summary-card" onclick="openDrawer('ratios')" style="cursor: pointer;">
            <div class="card-header">
              <div>
               <div class="card-title">Key Ratios</div>
                <div class="card-subtitle" id="ratios-subtitle">Financial health indicators</div>
              </div>
              <span style="color: var(--color-text-muted); font-size: 18px;">&#x2192;</span>
            </div>
            <div class="card-content">
              <div class="budget-item">
                <div class="budget-item-header">
                  <span class="budget-item-label">Current Ratio</span>
                  <span class="budget-actual" id="ratio-current">--</span>
                </div>
              </div>
              <div class="budget-item">
                <div class="budget-item-header">
                  <span class="budget-item-label">Gross Margin</span>
                  <span class="budget-actual" id="ratio-gross-margin">--</span>
                </div>
              </div>
              <div class="budget-item">
                <div class="budget-item-header">
                  <span class="budget-item-label">Net Profit Margin</span>
                  <span class="budget-actual" id="ratio-net-margin">--</span>
                </div>
              </div>
              <div class="budget-item">
                <div class="budget-item-header">
                  <span class="budget-item-label">Debt to Equity</span>
                  <span class="budget-actual" id="ratio-debt-equity">--</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Aged Debtors Summary -->
          <div class="summary-card">
            <div class="card-header">
              <div>
               <div class="card-title">Aged Debtors</div>
                <div class="card-subtitle" id="aged-subtitle">Outstanding invoices</div>
              </div>
            </div>
            <div class="card-content">
              <div class="budget-item">
                <div class="budget-item-header">
                  <span class="budget-item-label">Current (0-30)</span>
                  <span class="budget-actual" id="aged-current">$0</span>
                </div>
              </div>
              <div class="budget-item">
                <div class="budget-item-header">
                  <span class="budget-item-label">31-60 days</span>
                  <span class="budget-actual" id="aged-31-60">$0</span>
                </div>
              </div>
              <div class="budget-item">
                <div class="budget-item-header">
                  <span class="budget-item-label">61-90 days</span>
                  <span class="budget-actual" id="aged-61-90">$0</span>
                </div>
              </div>
              <div class="budget-item" style="background: #FDECE9; margin: 0 -16px; padding: 10px 16px;">
                <div class="budget-item-header">
                  <span class="budget-item-label">90+ days</span>
                  <span class="budget-actual" id="aged-90plus">$0</span>
                </div>
              </div>
              <div class="budget-item" style="border-top: 2px solid var(--color-border); margin-top: 8px; padding-top: 8px;">
                <div class="budget-item-header">
                  <span class="budget-item-label" style="font-weight: 600;">Total</span>
                  <span class="budget-actual" id="aged-total" style="font-weight: 600;">$0</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        </div>
     
      <!-- ========== AI CHAT PANEL ========== -->
      <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
          <h3>&#x1F4AC; Ask about your finances</h3>
          <div class="chat-header-actions">
            <button onclick="toggleChatExpand()" title="Expand/Collapse">&#x2922;</button>
            <button onclick="clearChat()" title="Clear chat">&#x1F5D1;</button>
            <button onclick="toggleChat()" title="Close">&#x2715;</button>
          </div>
        </div>
        <div class="chat-context" id="chatContext">
          <span>&#x1F4CA; Loading...</span>
          <span>&#x1F4C5; Current</span>
          <span class="status-dot live"></span>
        </div>
        <div class="chat-messages" id="chatMessages">
          <div class="chat-message assistant">
            Hi! I'm your AI financial analyst. I can help you understand your dashboard data in real time.
            <br><br>
            &#x2022; "What's driving our revenue?"<br>
            &#x2022; "Summarise our cash position"<br>
            &#x2022; "Any concerns I should know about?"
          </div>
        </div>
        <div class="chat-suggestions" id="chatSuggestions">
          <span class="suggestion-chip" onclick="sendSuggestion('Top 3 expenses?')">Top expenses</span>
          <span class="suggestion-chip" onclick="sendSuggestion('How is revenue tracking?')">Revenue trend</span>
          <span class="suggestion-chip" onclick="sendSuggestion('What is our cash position?')">Cash position</span>
          <span class="suggestion-chip" onclick="sendSuggestion('Any concerns?')">Risk check</span>
        </div>
        <div class="chat-input-area">
          <input type="text" class="chat-input" id="chatInput" placeholder="Ask about your finances..." onkeypress="handleChatKeypress(event)">
          <button class="chat-send" onclick="sendChat()">&#x27A4;</button>
        </div>
      </div>

    <!-- ========== DRAWER OVERLAY ========== -->
    <div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>

    <!-- ========== DRILL-DOWN DRAWER ========== -->
    <div class="drawer" id="drawer">
      <div class="drawer-header">
        <span class="drawer-title" id="drawerTitle">Detail View</span>
        <button class="drawer-close" onclick="closeDrawer()">&times;</button>
      </div>
      <div class="drawer-content" id="drawerContent">
        <!-- Dynamic content loaded here -->
      </div>
    </div>

    <!-- ========== JAVASCRIPT ========== -->
    <script>
      // ========== CONFIGURATION ==========
      const API_BASE = "https://rac-xero-api-matt-production.up.railway.app";
      
      // ========== ENTITY PICKER (Radio Buttons) ==========
      function getSelectedEntity() {
        const selected = document.querySelector('#entityDropdown input[type="radio"]:checked');
        if (!selected) return 'Mining';
        if (selected.value === 'ALL') return 'ALL';
        return selected.value;
      }

      // Backward compatible - returns array for consolidated view
      function getSelectedEntities() {
        const entity = getSelectedEntity();
        if (entity === 'ALL') {
          return ['Mining', 'Aboriginal Corporation', 'Enterprises', 'Property', 'Ngarrkuwuy', 'Invest', 'Marrin'];
        }
        return [entity];
      }

      function toggleEntityPicker(event) {
        event.stopPropagation();
        document.getElementById('entityPicker').classList.toggle('open');
      }

      // Handle radio button selection
      document.addEventListener('click', function(e) {
        const picker = document.getElementById('entityPicker');
        
        // Close dropdown when clicking outside
        if (!picker.contains(e.target)) {
          picker.classList.remove('open');
          return;
        }

        // Handle entity option clicks
        const option = e.target.closest('.entity-option[data-value]');
        if (option) {
          e.stopPropagation();
          const radio = option.querySelector('input[type="radio"]');
          radio.checked = true;
          
          // Update selected styling
          document.querySelectorAll('#entityDropdown .entity-option').forEach(opt => {
            opt.classList.remove('selected');
          });
          option.classList.add('selected');
          
          updateEntityPickerLabel();
          
          // Close dropdown after selection
          picker.classList.remove('open');
          
          loadDashboard();
        }
      });

      function updateEntityPickerLabel() {
        const entity = getSelectedEntity();
        const label = document.getElementById('entityPickerLabel');
        
        const entityDisplay = {
          'ALL': '\u{1F4CA} All Entities',
          'Mining': '\u26CF\uFE0F Mining',
          'Aboriginal Corporation': '\u{1F3DB}\uFE0F Aboriginal Corp',
          'Enterprises': '\u{1F3E2} Enterprises',
          'Property': '\u{1F3E0} Property Mgmt',
          'Ngarrkuwuy': '\u{1F528} Ngarrkuwuy',
          'Invest': '\u{1F4B0} Miliditjpi Trust',
          'Marrin': '\u{1F3D7}\uFE0F Marrin Square'
        };

        label.textContent = entityDisplay[entity] || entity;
      }

      // Store loaded data globally
      window.dashboardData = {
        pl: {},
        budget: {},
        cash: {},
        receivables: {},
        balance: {}
      };

      // ========== REVERSAL JOURNALS STATE ==========
      window.reversalState = {
        active: false,
        loading: false,
        data: null,
        originalPL: null,
      };

      function resetReversalState() {
        window.reversalState = { active: false, loading: false, data: null, originalPL: null };
        const btn = document.getElementById('reversalToggle');
        if (btn) {
          btn.classList.remove('active');
          btn.innerHTML = '&#x1F504; Reversals <span class="reversal-count" id="reversalCount" style="display:none">0</span>';
        }
      }

      async function toggleReversals() {
        const btn = document.getElementById('reversalToggle');
        const state = window.reversalState;
        if (state.loading) return;

        if (!state.active) {
          // === TURNING ON - hide reversals ===
          if (!state.data) {
            state.loading = true;
            btn.classList.add('loading');
            btn.innerHTML = '&#x23F3; Loading...';

            try {
              const entity = getSelectedEntity();
              const period = document.getElementById("periodSelector").value;
              const quarterInfo = getQuarterDates(period);

              if (entity === 'ALL') {
                const entities = getSelectedEntities();
                let combined = {
                  reversalCount: 0,
                  plImpact: { revenueAdjustment: 0, cogsAdjustment: 0, expenseAdjustment: 0, netProfitAdjustment: 0 },
                  reversalJournals: [],
                  totalManualJournals: 0,
                };
                for (const ent of entities) {
                  try {
                    const resp = await fetch(`${API_BASE}/api/reversal-journals`, {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ organizationName: ent, dateFrom: quarterInfo.startDate, dateTo: quarterInfo.endDate }),
                    });
                    const data = await resp.json();
                    if (data.reversalCount > 0) {
                      combined.reversalCount += data.reversalCount;
                      combined.totalManualJournals += data.totalManualJournals;
                      combined.plImpact.revenueAdjustment += data.plImpact.revenueAdjustment;
                      combined.plImpact.cogsAdjustment += data.plImpact.cogsAdjustment;
                      combined.plImpact.expenseAdjustment += data.plImpact.expenseAdjustment;
                      combined.plImpact.netProfitAdjustment += data.plImpact.netProfitAdjustment;
                      data.reversalJournals.forEach(j => { j.entityName = ent; });
                      combined.reversalJournals.push(...data.reversalJournals);
                    }
                  } catch (e) { console.warn(`Reversal fetch failed for ${ent}:`, e); }
                }
                state.data = combined;
              } else {
                const resp = await fetch(`${API_BASE}/api/reversal-journals`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ organizationName: entity, dateFrom: quarterInfo.startDate, dateTo: quarterInfo.endDate }),
                });
                state.data = await resp.json();
              }

              const countEl = document.getElementById('reversalCount');
              countEl.textContent = state.data.reversalCount;
              countEl.style.display = state.data.reversalCount > 0 ? 'inline' : 'none';
            } catch (error) {
              console.error("Failed to fetch reversal journals:", error);
              state.loading = false;
              btn.classList.remove('loading');
              btn.innerHTML = '&#x1F504; Reversals <span class="reversal-count" id="reversalCount" style="display:none">0</span>';
              return;
            }
            state.loading = false;
            btn.classList.remove('loading');
          }

          if (state.data.reversalCount === 0) {
            btn.innerHTML = '&#x1F504; Reversals <span class="reversal-count" id="reversalCount">0</span>';
            // Open drawer to show "no reversals found" message
            document.getElementById('drawerTitle').textContent = 'Reversal Journals';
            document.getElementById('drawerContent').innerHTML = '<div style="text-align:center; padding:40px; color:#6B7280;"><p style="font-size:32px; margin-bottom:12px;">&#x1F50D;</p><p>No reversal journals found in this period.</p></div>';
            document.getElementById('drawer').classList.add('active');
            document.getElementById('drawerOverlay').classList.add('active');
            return;
          }

          // Store original P&L values
          state.originalPL = { ...window.dashboardData.pl };
          state.active = true;
          applyReversalAdjustments();
          btn.classList.add('active');
          btn.innerHTML = '&#x1F504; Reversals Hidden <span class="reversal-count" id="reversalCount">' + state.data.reversalCount + '</span>';
          showReversalDrawer();

        } else {
          // === TURNING OFF - show reversals again ===
          state.active = false;
          if (state.originalPL) {
            window.dashboardData.pl = { ...state.originalPL };
            restoreOriginalPL();
          }
          btn.classList.remove('active');
          btn.innerHTML = '&#x1F504; Reversals <span class="reversal-count" id="reversalCount">' + (state.data?.reversalCount || 0) + '</span>';
          closeDrawer();
        }
      }

      function applyReversalAdjustments() {
        const adj = window.reversalState.data.plImpact;
        const pl = window.dashboardData.pl;

        const adjRevenue = (pl.revenue || 0) + adj.revenueAdjustment;
        const adjCogs = (pl.cogs || 0) - adj.cogsAdjustment;
        const adjOpex = (pl.opex || 0) - adj.expenseAdjustment;
        const adjGross = adjRevenue - adjCogs;
        const adjNetProfit = adjGross - adjOpex;

        // Update the dashboardData so sparklines reflect the changes
        window.dashboardData.pl.revenue = adjRevenue;
        window.dashboardData.pl.cogs = adjCogs;
        window.dashboardData.pl.opex = adjOpex;
        window.dashboardData.pl.gross = adjGross;
        window.dashboardData.pl.netProfit = adjNetProfit;

        document.getElementById("kpi-revenue").textContent = "$" + adjRevenue.toLocaleString();
        document.getElementById("kpi-profit").textContent = "$" + adjNetProfit.toLocaleString();

        const plRevEl = document.getElementById("pl-revenue");
        const plCogsEl = document.getElementById("pl-cogs");
        const plGrossEl = document.getElementById("pl-gross");
        const plOpexEl = document.getElementById("pl-opex");
        const plNetEl = document.getElementById("pl-net");
        if (plRevEl) plRevEl.textContent = "$" + adjRevenue.toLocaleString();
        if (plCogsEl) plCogsEl.textContent = "$" + adjCogs.toLocaleString();
        if (plGrossEl) plGrossEl.textContent = "$" + adjGross.toLocaleString();
        if (plOpexEl) plOpexEl.textContent = "$" + adjOpex.toLocaleString();
        if (plNetEl) plNetEl.textContent = "$" + adjNetProfit.toLocaleString();

        document.getElementById("kpi-profit-trend").innerHTML =
          adjNetProfit >= 0 ? '<span>\u2191</span> Profitable (excl. reversals)' : '<span>\u2193</span> Loss (excl. reversals)';
        document.getElementById("kpi-profit-trend").className =
          adjNetProfit >= 0 ? "kpi-trend positive" : "kpi-trend negative";
        document.getElementById("kpi-revenue-trend").innerHTML = '<span>\u2191</span> Excl. reversals';

        // Refresh sparklines to show adjusted values
        initSparklines();
        // Also update financial ratios
        loadFinancialRatios();
        updateSummaryCards();
      }

      function restoreOriginalPL() {
        const pl = window.dashboardData.pl;
        const origPL = window.reversalState.originalPL;
        
        // Restore actual values in dashboardData
        window.dashboardData.pl.revenue = origPL.revenue;
        window.dashboardData.pl.cogs = origPL.cogs;
        window.dashboardData.pl.opex = origPL.opex;
        window.dashboardData.pl.gross = origPL.gross;
        window.dashboardData.pl.netProfit = origPL.netProfit;

        document.getElementById("kpi-revenue").textContent = "$" + (origPL.revenue || 0).toLocaleString();
        const netProfit = origPL.netProfit || 0;
        document.getElementById("kpi-profit").textContent = "$" + netProfit.toLocaleString();

        const plRevEl = document.getElementById("pl-revenue");
        const plCogsEl = document.getElementById("pl-cogs");
        const plGrossEl = document.getElementById("pl-gross");
        const plOpexEl = document.getElementById("pl-opex");
        const plNetEl = document.getElementById("pl-net");
        if (plRevEl) plRevEl.textContent = "$" + (origPL.revenue || 0).toLocaleString();
        if (plCogsEl) plCogsEl.textContent = "$" + (origPL.cogs || 0).toLocaleString();
        if (plGrossEl) plGrossEl.textContent = "$" + (origPL.gross || 0).toLocaleString();
        if (plOpexEl) plOpexEl.textContent = "$" + (origPL.opex || 0).toLocaleString();
        if (plNetEl) plNetEl.textContent = "$" + netProfit.toLocaleString();

        document.getElementById("kpi-profit-trend").innerHTML =
          netProfit >= 0 ? '<span>\u2191</span> Profitable' : '<span>\u2193</span> Loss position';
        document.getElementById("kpi-profit-trend").className =
          netProfit >= 0 ? "kpi-trend positive" : "kpi-trend negative";
        document.getElementById("kpi-revenue-trend").innerHTML =
          (origPL.revenue || 0) >= 0 ? '<span>\u2191</span> Period revenue' : '<span>\u2193</span> Negative revenue';

        // Refresh sparklines to show original values
        initSparklines();
        // Also update financial ratios
        loadFinancialRatios();
        updateSummaryCards();
      }

      function showReversalDrawer() {
        const data = window.reversalState.data;
        const adj = data.plImpact;

        let html = `
          <div class="reversal-summary">
            <h4>&#x26A0;&#xFE0F; ${data.reversalCount} Reversal Journal${data.reversalCount !== 1 ? 's' : ''} Excluded</h4>
            <div class="reversal-summary-grid">
              <div class="reversal-summary-item" style="grid-column: span 2;">
                <span class="label">Revenue Impact</span>
                <span class="value" style="color: ${adj.revenueAdjustment >= 0 ? '#059669' : '#DC2626'}">
                  ${adj.revenueAdjustment >= 0 ? '+' : ''}$${adj.revenueAdjustment.toLocaleString()}
                </span>
              </div>
              <div class="reversal-summary-item" style="grid-column: span 2;">
                <span class="label">COGS Impact</span>
                <span class="value" style="color: ${adj.cogsAdjustment <= 0 ? '#059669' : '#DC2626'}">
                  ${adj.cogsAdjustment > 0 ? '-' : '+'}$${Math.abs(adj.cogsAdjustment).toLocaleString()}
                </span>
              </div>
              <div class="reversal-summary-item" style="grid-column: span 2;">
                <span class="label">Expense Impact</span>
                <span class="value" style="color: ${adj.expenseAdjustment <= 0 ? '#059669' : '#DC2626'}">
                  ${adj.expenseAdjustment > 0 ? '-' : '+'}$${Math.abs(adj.expenseAdjustment).toLocaleString()}
                </span>
              </div>
              <div class="reversal-summary-item" style="grid-column: span 2; border-top: 1px solid #FECACA; padding-top: 8px; margin-top: 4px;">
                <span class="label" style="font-weight: 600;">Net Profit Impact</span>
                <span class="value" style="color: ${adj.netProfitAdjustment >= 0 ? '#059669' : '#DC2626'}; font-size: 15px;">
                  ${adj.netProfitAdjustment >= 0 ? '+' : ''}$${adj.netProfitAdjustment.toLocaleString()}
                </span>
              </div>
            </div>
          </div>
        `;

        data.reversalJournals.forEach(journal => {
          const journalDate = new Date(journal.date).toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' });
          const totalAmount = Math.max(journal.totalDebits, journal.totalCredits);
          const entityTag = journal.entityName ? `<span style="font-size:11px; color:#6B7280; margin-left:6px;">(${journal.entityName})</span>` : '';
          const reversalLine = journal.lines.find(l => (l.description || '').toLowerCase().includes('reversal:'));
          const description = reversalLine ? reversalLine.description : (journal.narration || journal.reference || 'No description');

          html += `
            <div class="reversal-journal-card">
              <div class="journal-header">
                <div>
                  <span class="journal-ref">${journal.reference || 'Journal #' + (journal.journalNumber || 'N/A')}${entityTag}</span>
                  <div class="journal-date">${journalDate}</div>
                </div>
                <span class="journal-amount">$${totalAmount.toLocaleString()}</span>
              </div>
              <div class="journal-desc">${description.length > 150 ? description.substring(0, 150) + '...' : description}</div>
              <div class="journal-lines">
          `;

          journal.lines.forEach(line => {
            const amount = Math.abs(line.lineAmount);
            const isDebit = line.lineAmount > 0;
            html += `
              <div class="journal-line">
                <span class="line-account" title="${line.accountName}">${line.accountName}</span>
                <span class="line-amount ${isDebit ? 'debit' : 'credit'}">
                  ${isDebit ? 'Dr' : 'Cr'} $${amount.toLocaleString()}
                </span>
              </div>
            `;
          });

          html += '</div></div>';
        });

        document.getElementById('drawerTitle').textContent = 'Reversal Journals';
        document.getElementById('drawerContent').innerHTML = html;
        document.getElementById('drawer').classList.add('active');
        document.getElementById('drawerOverlay').classList.add('active');
      }

      // ========== QUARTER DATE CALCULATIONS ==========
      function getQuarterDates(quarter) {
        const today = new Date();
        const year = today.getMonth() >= 6 ? today.getFullYear() : today.getFullYear() - 1;

        const quarters = {
          Q1: { start: `${year}-07-01`, end: `${year}-09-30`, days: 92 },
          Q2: { start: `${year}-10-01`, end: `${year}-12-31`, days: 92 },
          Q3: { start: `${year + 1}-01-01`, end: `${year + 1}-03-31`, days: 90 },
          Q4: { start: `${year + 1}-04-01`, end: `${year + 1}-06-30`, days: 91 },
        };

        const q = quarters[quarter];
        const startDate = new Date(q.start);
        const endDate = new Date(q.end);
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        const hasStarted = yesterday >= startDate;
        const isComplete = yesterday >= endDate;
        const daysElapsed = hasStarted
          ? Math.min(Math.floor((yesterday - startDate) / (1000 * 60 * 60 * 24)) + 1, q.days)
          : 0;

        return {
          quarterCode: quarter,
          startDate: q.start,
          endDate: isComplete ? q.end : today.toISOString().split("T")[0],
          totalDays: q.days,
          daysElapsed,
          isComplete,
          hasStarted,
          proRateFactor: daysElapsed / q.days,
        };
      }

      // ========== MAIN DASHBOARD LOAD ==========
      async function loadDashboard() {
        // Reset reversal filter when dashboard reloads
        resetReversalState();
        
        const entity = getSelectedEntity();
        const period = document.getElementById("periodSelector").value;
        const quarterInfo = getQuarterDates(period);

        console.log("Loading dashboard for:", entity, period, quarterInfo);

        // Toggle Inventory vs Top Expenses card based on entity
        // Mining shows Inventory (the quarry operation) + Production card
        // ALL and other individual entities show Top Expenses
        const inventoryCard = document.getElementById('inventory-card');
        const expensesCard = document.getElementById('expenses-card');
        const productionCard = document.getElementById('production-card');
        const chartRow = document.querySelector('.chart-row');
        if (entity === 'Mining') {
          inventoryCard.style.display = 'block';
          expensesCard.style.display = 'none';
          productionCard.style.display = 'flex';
          chartRow.style.gridTemplateColumns = '2fr 1fr 1fr';
        } else {
          inventoryCard.style.display = 'none';
          expensesCard.style.display = 'block';
          productionCard.style.display = 'none';
          chartRow.style.gridTemplateColumns = '2fr 1fr';
        }

        // Update header title based on selection
        const selectedEntities = getSelectedEntities();
        const entityNames = {
          'Mining': 'RAC Mining',
          'Aboriginal Corporation': 'RAC Aboriginal Corporation',
          'Enterprises': 'RAC Enterprises',
          'Property': 'Property Management',
          'Ngarrkuwuy': 'Ngarrkuwuy Developments',
          'Invest': 'Miliditjpi Trust',
          'Marrin': 'Marrin Square'
        };

        if (entity === 'ALL') {
          document.querySelector('.header h1').textContent = '\u{1F4CA} All RAC Entities - Executive Dashboard';
        } else {
          document.querySelector('.header h1').textContent = '\u26CF\uFE0F ' + (entityNames[entity] || entity) + ' - Executive Dashboard';
        }

        // Handle consolidated view when ALL selected
        if (entity === 'ALL') {
          await loadConsolidatedDashboard(quarterInfo, selectedEntities);
          return;
        }

        // Load historical snapshot data
        const historical = await loadHistoricalData(entity);

        // Update period displays
        document.getElementById("budget-period").textContent = 
          `${period} (${Math.round(quarterInfo.proRateFactor * 100)}% elapsed)`;
        document.getElementById("pl-period").textContent = 
          `${period} FY25/26`;

        // Load all data
        await Promise.all([
          loadCashPosition(),
          loadTrialBalance(),
          loadProfitLoss(quarterInfo),
          loadAgedReceivables(),
          loadInventory(),
          loadHistoricalData(),
        ]);

        // Load top customers after receivables data is available
        await loadTopCustomers(quarterInfo);

        // Load production card (Mining only, needs inventory data first)
        if (entity === 'Mining') {
          await loadProduction(quarterInfo);
        }

        // Load budget after P&L (needs P&L data)
        await loadBudget(quarterInfo);

        // Update health status
        updateHealthStatus();

        // Calculate and display financial ratios
        loadFinancialRatios();
        // Load top expenses (for non-Mining entities)
        loadTopExpenses();
        // Update Balance Sheet and Aged Debtors cards
        updateSummaryCards();

        // Initialize charts
        initSparklines();
        initTrendChart();
        updateChatContext();
        updateSuggestions();
      }

      // ========== CONSOLIDATED DASHBOARD (All Entities) ==========
     async function loadConsolidatedDashboard(quarterInfo, entityList) {
        const entities = entityList || ['Mining', 'Aboriginal Corporation', 'Enterprises', 'Property', 'Ngarrkuwuy', 'Invest', 'Marrin'];
        
        let totalCash = 0;
        let totalRevenue = 0;
        let totalExpenses = 0;
        let totalCogs = 0;
        let totalReceivables = 0;
        let totalAssets = 0;
        let totalLiabilities = 0;
        let totalEquity = 0;
        let allInvoices = [];
        let allBankAccounts = [];
        let allEntityPL = [];
        let allEntityBalance = [];
        let successCount = 0;

        document.getElementById("kpi-cash").textContent = "Loading...";
        document.getElementById("kpi-revenue").textContent = "Loading...";
        document.getElementById("kpi-receivables").textContent = "Loading...";

        for (const entity of entities) {
          try {
            // Cash
            const cashResp = await fetch(`${API_BASE}/api/cash-position`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ organizationName: entity }),
            });
            const cashData = await cashResp.json();
            if (cashData.totalCash) {
              totalCash += cashData.totalCash;
              successCount++;
            }
            // Collect bank accounts tagged with entity name
            if (cashData.bankAccounts) {
              const entityDisplay = { 'Mining': 'Mining', 'Aboriginal Corporation': 'Aboriginal Corp', 'Enterprises': 'Enterprises', 'Property': 'Property Mgmt', 'Ngarrkuwuy': 'Ngarrkuwuy', 'Invest': 'Miliditjpi Trust', 'Marrin': 'Marrin Square' };
              cashData.bankAccounts.forEach(acc => {
                allBankAccounts.push({ name: acc.name, balance: acc.balance, entity: entityDisplay[entity] || entity });
              });
            }

            // P&L
            const plResp = await fetch(`${API_BASE}/api/profit-loss-summary`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
              organizationName: entity,
              date: quarterInfo.endDate,
              periodMonths: quarterInfo.isComplete ? 3 : 
                (new Date(quarterInfo.endDate).getFullYear() - new Date(quarterInfo.startDate).getFullYear()) * 12 + 
                (new Date(quarterInfo.endDate).getMonth() - new Date(quarterInfo.startDate).getMonth()) + 1,
            }),
            });
            const plData = await plResp.json();
            const entityRevenue = plData.summary?.totalRevenue || 0;
            const entityCogs = plData.summary?.totalCOGS || 0;
            const entityExpenses = plData.summary?.totalExpenses || 0;
            totalRevenue += entityRevenue;
            totalCogs += entityCogs;
            totalExpenses += entityExpenses;

            // Collect per-entity P&L for revenue sidecard
            const entityDisplay = { 'Mining': 'Mining', 'Aboriginal Corporation': 'Aboriginal Corp', 'Enterprises': 'Enterprises', 'Property': 'Property Mgmt', 'Ngarrkuwuy': 'Ngarrkuwuy', 'Invest': 'Miliditjpi Trust', 'Marrin': 'Marrin Square' };
            allEntityPL.push({
              entity: entityDisplay[entity] || entity,
              revenue: entityRevenue,
              cogs: entityCogs,
              opex: entityExpenses,
              gross: entityRevenue - entityCogs,
              netProfit: entityRevenue - entityCogs - entityExpenses,
              revenueAccounts: plData.summary?.revenueAccounts || [],
              cogsAccounts: plData.summary?.cogsAccounts || [],
              expenseAccounts: plData.summary?.expenseAccounts || []
            });

            // Invoices
            const invResp = await fetch(`${API_BASE}/api/outstanding-invoices`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ organizationName: entity }),
            });
            const invData = await invResp.json();
            if (Array.isArray(invData)) {
              allInvoices = allInvoices.concat(invData);
              totalReceivables += invData.reduce((sum, inv) => sum + (inv.amountDue || 0), 0);
            }

            // Trial Balance (for Balance Sheet)
            const tbResp = await fetch(`${API_BASE}/api/trial-balance`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ organizationName: entity }),
            });
            const tbData = await tbResp.json();
            const entityAssets = tbData.trialBalance?.totals?.totalAssets || 0;
            const entityLiabilities = tbData.trialBalance?.totals?.totalLiabilities || 0;
            const entityEquity = tbData.trialBalance?.totals?.totalEquity || 0;
            totalAssets += entityAssets;
            totalLiabilities += entityLiabilities;
            totalEquity += entityEquity;

            // Collect per-entity balance for sidecard
            const entityDisplayBal = { 'Mining': 'Mining', 'Aboriginal Corporation': 'Aboriginal Corp', 'Enterprises': 'Enterprises', 'Property': 'Property Mgmt', 'Ngarrkuwuy': 'Ngarrkuwuy', 'Invest': 'Miliditjpi Trust', 'Marrin': 'Marrin Square' };
            allEntityBalance.push({
              entity: entityDisplayBal[entity] || entity,
              assets: entityAssets,
              liabilities: entityLiabilities,
              equity: entityEquity
            });
          } catch (e) {
            console.warn(`Error loading ${entity}:`, e);
          }
        }

        // Update consolidated KPIs
        document.getElementById("kpi-cash").textContent = "$" + totalCash.toLocaleString();
        document.getElementById("kpi-cash-trend").innerHTML = `&#x1F4B0; ${successCount} entities`;
        document.getElementById("kpi-cash-trend").className = "kpi-trend positive";

        // Store consolidated cash for drawer
        window.dashboardData.cash = { totalCash, bankAccounts: allBankAccounts, isConsolidated: true };

        const grossProfit = totalRevenue - totalCogs;
        const netProfit = grossProfit - totalExpenses;
        document.getElementById("kpi-revenue").textContent = "$" + totalRevenue.toLocaleString();
        document.getElementById("kpi-revenue-trend").textContent = "\u{1F4CA} Consolidated";
        
        document.getElementById("kpi-profit").textContent = "$" + netProfit.toLocaleString();
        document.getElementById("kpi-profit-trend").textContent = netProfit < 0 ? "\u26A0 Loss position" : "\u2714 Profitable";
        document.getElementById("kpi-profit-trend").className = netProfit < 0 ? "kpi-trend negative" : "kpi-trend positive";

        document.getElementById("kpi-receivables").textContent = "$" + totalReceivables.toLocaleString();
        document.getElementById("kpi-receivables-trend").textContent = `${allInvoices.length} invoices across all entities`;

        // Store consolidated receivables for drawer (calculate aging from allInvoices)
        let arCurrent = 0, ar31_60 = 0, ar61_90 = 0, arOver90 = 0;
        const now = new Date();
        allInvoices.forEach(inv => {
          const amount = inv.amountDue || 0;
          const dueDate = inv.dueDate ? new Date(inv.dueDate) : now;
          const daysOverdue = Math.max(0, Math.floor((now - dueDate) / (1000 * 60 * 60 * 24)));
          if (daysOverdue <= 30) arCurrent += amount;
          else if (daysOverdue <= 60) ar31_60 += amount;
          else if (daysOverdue <= 90) ar61_90 += amount;
          else arOver90 += amount;
        });
        window.dashboardData.receivables = {
          aged30Days: arCurrent,
          aged60Days: ar31_60,
          aged90Days: ar61_90,
          agedOver120Days: arOver90,
          total: totalReceivables,
          invoiceCount: allInvoices.length,
          invoices: allInvoices,
          isConsolidated: true
        };

        // Store for other functions (with entity breakdown for sidecard)
        // Aggregate expense accounts across all entities
        const allExpenseAccounts = {};
        allEntityPL.forEach(entityPL => {
          (entityPL.expenseAccounts || []).forEach(exp => {
            const name = exp.name || 'Unknown';
            if (!allExpenseAccounts[name]) {
              allExpenseAccounts[name] = { name, amount: 0 };
            }
            allExpenseAccounts[name].amount += exp.amount || 0;
          });
        });
        const aggregatedExpenses = Object.values(allExpenseAccounts);

        window.dashboardData.pl = { revenue: totalRevenue, cogs: totalCogs, gross: grossProfit, opex: totalExpenses, netProfit: netProfit, entityBreakdown: allEntityPL, expenseAccounts: aggregatedExpenses, isConsolidated: true };

        // Store consolidated balance sheet for drawer
        window.dashboardData.balance = {
          totalAssets: totalAssets,
          totalLiabilities: totalLiabilities,
          totalEquity: totalEquity,
          entityBreakdown: allEntityBalance,
          isConsolidated: true
        };

        // Update Balance Sheet card
        document.getElementById('bs-assets').textContent = '$' + totalAssets.toLocaleString();
        document.getElementById('bs-liabilities').textContent = '$' + totalLiabilities.toLocaleString();
        document.getElementById('bs-equity').textContent = '$' + totalEquity.toLocaleString();

        // Update P&L Summary card
        document.getElementById("pl-revenue").textContent = "$" + totalRevenue.toLocaleString();
        document.getElementById("pl-cogs").textContent = "$" + totalCogs.toLocaleString();
        document.getElementById("pl-gross").textContent = "$" + grossProfit.toLocaleString();
        document.getElementById("pl-opex").textContent = "$" + totalExpenses.toLocaleString();
        document.getElementById("pl-net").innerHTML = "<strong>$" + netProfit.toLocaleString() + "</strong>";

        // Update Operating Expenses card to match P&L OpEx exactly
        document.getElementById("kpi-top-expense").textContent = "$" + totalExpenses.toLocaleString();

        // Load live inventory data for Mining's quarry operation
        await loadInventory();

        // Load Top Customers from aggregated invoices
        await loadTopCustomers(quarterInfo);

        updateHealthStatus();
        loadFinancialRatios();
        loadTopExpenses();
        updateSummaryCards();
        initSparklines();
        initTrendChart();
      }

      // ========== CASH POSITION ==========
      async function loadCashPosition() {
        try {
          const response = await fetch(`${API_BASE}/api/cash-position`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ organizationName: getSelectedEntity() }),
          });
          const data = await response.json();
          
          const totalCash = data.totalCash || 0;
          window.dashboardData.cash = data;

          document.getElementById("kpi-cash").textContent = "$" + totalCash.toLocaleString();
          document.getElementById("kpi-cash-trend").innerHTML = 
            `<span>&#x1F4B0;</span> ${data.bankAccounts?.length || 0} accounts`;
          document.getElementById("kpi-cash-trend").className = "kpi-trend positive";
          
        } catch (error) {
          console.error("Error loading cash:", error);
          document.getElementById("kpi-cash").textContent = "Error";
        }
      }

      // ========== TRIAL BALANCE ==========
      async function loadTrialBalance() {
        try {
          const response = await fetch(`${API_BASE}/api/trial-balance`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ organizationName: getSelectedEntity() }),
          });
          const data = await response.json();
          
          // Store totals plus account arrays for sidecard detail
          window.dashboardData.balance = {
            totalAssets: data.trialBalance?.totals?.totalAssets || 0,
            totalLiabilities: data.trialBalance?.totals?.totalLiabilities || 0,
            totalEquity: data.trialBalance?.totals?.totalEquity || 0,
            assets: data.trialBalance?.assets || [],
            liabilities: data.trialBalance?.liabilities || [],
            equity: data.trialBalance?.equity || []
          };
          
        } catch (error) {
          console.error("Error loading trial balance:", error);
        }
      }

      // ========== PROFIT & LOSS ==========
      async function loadProfitLoss(quarterInfo) {
        try {
          const start = new Date(quarterInfo.startDate);
          const end = new Date(quarterInfo.endDate);
          let periodMonths = quarterInfo.isComplete ? 3 : 
            (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth()) + 1;

          const response = await fetch(`${API_BASE}/api/profit-loss-summary`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              organizationName: getSelectedEntity(),
              date: quarterInfo.endDate,
              periodMonths: periodMonths,
            }),
          });

          const data = await response.json();
          console.log("P&L Response:", data);

          const revenue = data.summary?.totalRevenue || 0;
          const cogs = data.summary?.totalCOGS || 0;
          const gross = data.summary?.grossProfit || (revenue - cogs);
          const opex = data.summary?.totalExpenses || 0;
          const netProfit = data.summary?.netProfit || 0;
          const totalExpenses = cogs + opex; // For budget comparison

          // Store for budget comparison
          window.dashboardData.pl = { revenue, totalExpenses, cogs, opex, gross, netProfit, revenueAccounts: data.summary?.revenueAccounts || [], cogsAccounts: data.summary?.cogsAccounts || [], expenseAccounts: data.summary?.expenseAccounts || [] };

          // Update KPI cards
          document.getElementById("kpi-revenue").textContent = "$" + revenue.toLocaleString();
          document.getElementById("kpi-revenue-trend").innerHTML = 
            revenue >= 0 ? `<span>\u2191</span> Period revenue` : `<span>\u2193</span> Negative revenue`;
          document.getElementById("kpi-revenue-trend").className = 
            revenue >= 0 ? "kpi-trend positive" : "kpi-trend negative";
          document.getElementById("kpi-revenue-status").className = 
            revenue >= 0 ? "kpi-status-bar healthy" : "kpi-status-bar warning";

          document.getElementById("kpi-profit").textContent = "$" + netProfit.toLocaleString();
          document.getElementById("kpi-profit-trend").innerHTML = 
            netProfit >= 0 ? `<span>\u2191</span> Profitable` : `<span>\u2193</span> Loss position`;
          document.getElementById("kpi-profit-trend").className = 
            netProfit >= 0 ? "kpi-trend positive" : "kpi-trend negative";
          document.getElementById("kpi-profit-status").className = 
            netProfit >= 0 ? "kpi-status-bar healthy" : "kpi-status-bar critical";

          // Update P&L summary card
          document.getElementById("pl-revenue").textContent = "$" + revenue.toLocaleString();
          document.getElementById("pl-cogs").textContent = "$" + cogs.toLocaleString();
          document.getElementById("pl-gross").textContent = "$" + gross.toLocaleString();
          document.getElementById("pl-opex").textContent = "$" + opex.toLocaleString();
          document.getElementById("pl-net").textContent = "$" + netProfit.toLocaleString();

          // Update Operating Expenses card to match P&L OpEx (for non-Mining entities)
          const expCard = document.getElementById("kpi-top-expense");
          if (expCard) expCard.textContent = "$" + opex.toLocaleString();

        } catch (error) {
          console.error("Error loading P&L:", error);
        }
      }

      // ========== BUDGET ==========
      async function loadBudget(quarterInfo) {
        try {
          const response = await fetch(`${API_BASE}/api/budget-summary`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              organizationName: getSelectedEntity(),
              date: quarterInfo.startDate,
              periods: 3,
            }),
          });
          const data = await response.json();
          console.log("Budget API response:", JSON.stringify(data).substring(0, 500));
          
          const budget = parseBudgetFromReport(data.report);
          console.log("Parsed budget:", budget);
          const proRatedRevenue = Math.round(budget.revenue * quarterInfo.proRateFactor);
          const proRatedExpenses = Math.round(budget.expenses * quarterInfo.proRateFactor);
          const proRatedGrossProfit = proRatedRevenue - (proRatedExpenses * 0.55); // Approximate COGS

          const actualRevenue = window.dashboardData.pl?.revenue || 0;
          const actualExpenses = window.dashboardData.pl?.totalExpenses || 0;
          const actualGross = window.dashboardData.pl?.gross || 0;

          // Calculate variances
          const revVar = proRatedRevenue > 0 ? ((actualRevenue - proRatedRevenue) / proRatedRevenue) * 100 : 0;
          const expVar = proRatedExpenses > 0 ? ((actualExpenses - proRatedExpenses) / proRatedExpenses) * 100 : 0;
          const gpVar = proRatedGrossProfit > 0 ? ((actualGross - proRatedGrossProfit) / proRatedGrossProfit) * 100 : 0;

          // Update horizontal budget bars
          updateBudgetBar('rev', actualRevenue, proRatedRevenue, revVar);
          updateBudgetBar('exp', actualExpenses, proRatedExpenses, expVar);
          updateBudgetBar('gp', actualGross, proRatedGrossProfit, gpVar);

        } catch (error) {
          console.error("Error loading budget:", error);
        }
      }

      function updateBudgetBar(type, actual, budget, variance) {
        const maxVal = Math.max(Math.abs(actual), Math.abs(budget)) * 1.2;
        const fillPct = budget > 0 ? Math.min(Math.abs(actual) / maxVal * 100, 100) : 0;
        const markerPct = budget > 0 ? Math.min(budget / maxVal * 100, 100) : 0;

        document.getElementById(`bar-${type}-actual`).textContent = "$" + actual.toLocaleString();
        document.getElementById(`bar-${type}-target`).textContent = "of $" + budget.toLocaleString();
        
        const varEl = document.getElementById(`bar-${type}-var`);
        varEl.textContent = (variance >= 0 ? "+" : "") + variance.toFixed(1) + "%";
        varEl.className = "budget-bar-variance " + (
          type === 'exp' ? (variance <= 0 ? "positive" : "negative") :
          (variance >= 0 ? "positive" : "negative")
        );

        const fillEl = document.getElementById(`bar-${type}-fill`);
        fillEl.style.width = fillPct + "%";
        
        // Color based on type and performance
        if (type === 'exp') {
          fillEl.className = "budget-bar-fill " + (actual <= budget ? "under-budget" : "over-budget");
        } else {
          fillEl.className = "budget-bar-fill " + (actual >= budget ? "under-budget" : "over-budget");
        }

        document.getElementById(`bar-${type}-marker`).style.left = markerPct + "%";
      }

      function parseBudgetFromReport(report) {
        let revenue = 0;
        let expenses = 0;

        // Railway API returns: { rows: [...] } with camelCase properties
        const rows = report?.rows || report?.Reports?.[0]?.Rows || [];
        
        for (const section of rows) {
          const rowType = section.rowType || section.RowType;
          if (rowType === "Section") {
            const title = section.title || section.Title || "";
            const subRows = section.rows || section.Rows || [];
            
            for (const r of subRows) {
              const subType = r.rowType || r.RowType;
              if (subType === "SummaryRow") {
                const cells = r.cells || r.Cells || [];
                const label = (cells[0]?.value || cells[0]?.Value || "").toLowerCase();
                const m1 = parseFloat(cells[1]?.value || cells[1]?.Value) || 0;
                const m2 = parseFloat(cells[2]?.value || cells[2]?.Value) || 0;
                const m3 = parseFloat(cells[3]?.value || cells[3]?.Value) || 0;
                const total = m1 + m2 + m3;

                if (label.includes("total income") || label.includes("total revenue")) {
                  if (total > revenue) revenue = total;
                }
                if (label.includes("total operating expenses") || label.includes("total expenses")) {
                  if (total > expenses) expenses = total;
                }
              }
            }
          }
        }
        return { revenue, expenses };
      }

      // ========== AGED RECEIVABLES (via Outstanding Invoices) ==========
      async function loadAgedReceivables() {
        try {
          // Use outstanding-invoices endpoint instead of broken aged-receivables report
          const response = await fetch(`${API_BASE}/api/outstanding-invoices`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ organizationName: getSelectedEntity() }),
          });
          const invoices = await response.json();

          if (!Array.isArray(invoices)) {
            console.error("Invalid invoices response:", invoices);
            document.getElementById("kpi-receivables").textContent = "$0";
            return;
          }

          // Calculate aging from invoice due dates
          const today = new Date();
          let current = 0, days31_60 = 0, days61_90 = 0, over90 = 0;

          invoices.forEach(inv => {
            const dueDate = new Date(inv.dueDate);
            const daysOverdue = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
            const amount = inv.amountDue || 0;

            if (daysOverdue <= 30) {
              current += amount;
            } else if (daysOverdue <= 60) {
              days31_60 += amount;
            } else if (daysOverdue <= 90) {
              days61_90 += amount;
            } else {
              over90 += amount;
            }
          });

          const total = current + days31_60 + days61_90 + over90;
          
          // Store with same field names for drawer compatibility
          window.dashboardData.receivables = {
            aged30Days: current,
            aged60Days: days31_60,
            aged90Days: days61_90,
            agedOver120Days: over90,
            total: total,
            invoiceCount: invoices.length,
            invoices: invoices
          };

          document.getElementById("kpi-receivables").textContent = "$" + total.toLocaleString();
          
          const currentPct = total > 0 ? Math.round(current / total * 100) : 0;
          const overduePct = 100 - currentPct;
          document.getElementById("kpi-receivables-trend").textContent = 
            `${currentPct}% current \u2022 ${overduePct}% overdue`;
          document.getElementById("kpi-receivables-trend").className = 
            currentPct >= 70 ? "kpi-trend positive" : (currentPct >= 50 ? "kpi-trend neutral" : "kpi-trend negative");

          // Update status bar color
          const statusBar = document.getElementById("kpi-receivables-status");
          statusBar.className = "kpi-status-bar " + (currentPct >= 70 ? "healthy" : (currentPct >= 50 ? "warning" : "critical"));

        } catch (error) {
          console.error("Error loading receivables:", error);
          document.getElementById("kpi-receivables").textContent = "Error";
        }
      }

      // ========== INVENTORY (LIVE from Quarry APP API) ==========
      const INVENTORY_API = "https://rac-inventory-production.up.railway.app/api/inventory-summary";

      async function loadInventory() {
        try {
          const res = await fetch(INVENTORY_API);
          if (!res.ok) throw new Error(`Inventory API ${res.status}`);
          const data = await res.json();

          // Store globally for drawer + sparkline access
          window.inventoryLive = data;

          const totalValue = data.totals.inventoryValue || 0;
          const totalTonnes = data.totals.sohTonnes || 0;
          const forwardOrders = data.totals.forwardOrders || {};

          // KPI value
          if (totalValue >= 1000000) {
            document.getElementById("kpi-inventory").textContent = "$" + (totalValue / 1000000).toFixed(2) + "M";
          } else {
            document.getElementById("kpi-inventory").textContent = "$" + Math.round(totalValue).toLocaleString();
          }

          // Trend line â€” SOH tonnes + forward order pipeline
          const trendParts = [];
          trendParts.push(`${Math.round(totalTonnes).toLocaleString()}t on hand`);
          if (forwardOrders.orderCount > 0) {
            trendParts.push(`${forwardOrders.orderCount} order${forwardOrders.orderCount > 1 ? 's' : ''} pending (${Math.round(forwardOrders.tonnes).toLocaleString()}t)`);
          }
          document.getElementById("kpi-inventory-trend").innerHTML =
            `<span>\u2714</span> ${trendParts.join(' \u00b7 ')}`;
          document.getElementById("kpi-inventory-trend").className = "kpi-trend positive";

          // Status bar
          const statusBar = document.getElementById("kpi-inventory-status");
          statusBar.className = "kpi-status-bar " + (totalValue >= 500000 ? "healthy" : (totalValue >= 100000 ? "warning" : "critical"));

          // Rescale sparkline to anchor at real value
          const sparkCanvas = document.getElementById('sparkInventory');
          if (sparkCanvas && sparkCanvas.chart) {
            const chart = sparkCanvas.chart;
            const points = chart.data.datasets[0].data;
            if (points.length > 0) {
              const oldLast = points[points.length - 1];
              const scale = oldLast > 0 ? totalValue / oldLast : 1;
              chart.data.datasets[0].data = points.map(v => Math.round(v * scale));
              chart.update('none');
            }
          }

        } catch (error) {
          console.error("Error loading inventory:", error);
          document.getElementById("kpi-inventory").textContent = "Offline";
          document.getElementById("kpi-inventory-trend").innerHTML = "\u26a0 Inventory API unavailable";
          document.getElementById("kpi-inventory-trend").className = "kpi-trend neutral";
          window.inventoryLive = null;
        }
      }

      // ========== PRODUCTION OVERVIEW (LIVE from Quarry APP API) ==========
      async function loadProduction(quarterInfo) {
        const tbody = document.getElementById('productionBody');
        const tfoot = document.getElementById('productionFoot');

        try {
          // Calculate days since quarter start for sub-endpoint queries
          const qStart = new Date(quarterInfo.startDate);
          const today = new Date();
          const daysSinceQStart = Math.max(1, Math.ceil((today - qStart) / (1000 * 60 * 60 * 24)));

          // Update period subtitle
          document.getElementById('production-period').textContent =
            `${quarterInfo.quarterCode} FY25/26 \u00b7 ${daysSinceQStart} days`;

          // Fetch QTD production and sales from sub-endpoints
          const [prodRes, salesRes] = await Promise.all([
            fetch(`${INVENTORY_API}/production?days=${daysSinceQStart}`).then(r => r.ok ? r.json() : null).catch(() => null),
            fetch(`${INVENTORY_API}/sales?days=${daysSinceQStart}`).then(r => r.ok ? r.json() : null).catch(() => null),
          ]);

          // Aggregate production by product
          const qtdProduction = {};
          if (prodRes && Array.isArray(prodRes.production)) {
            prodRes.production.forEach(row => {
              const key = row.productName || row.product || row.name || 'Unknown';
              qtdProduction[key] = (qtdProduction[key] || 0) + (row.tonnes || row.quantity || 0);
            });
          }

          // Aggregate sales by product (tonnes shipped = demand fulfilled)
          const qtdSales = {};
          if (salesRes && Array.isArray(salesRes.sales)) {
            salesRes.sales.forEach(row => {
              const key = row.productName || row.product || row.name || 'Unknown';
              qtdSales[key] = (qtdSales[key] || 0) + (row.tonnes || row.quantity || 0);
            });
          }

          // Get SOH and forward orders from main inventory data
          const inv = window.inventoryLive;
          const products = inv ? (inv.products || []) : [];

          // Build merged product list
          const productMap = {};

          // Start with products from main inventory (has SOH and forward orders)
          products.forEach(p => {
            productMap[p.name] = {
              name: p.name,
              group: p.group,
              soh: p.sohTonnes || 0,
              produced: qtdProduction[p.name] || 0,
              demand: (qtdSales[p.name] || 0) + (p.demandTonnes || 0),
              forwardOrders: p.demandTonnes || 0,
              salesQtd: qtdSales[p.name] || 0,
              mtdProd: p.mtdProduction || 0,
              mtdSales: p.mtdSales || 0,
            };
          });

          // Add any products from sub-endpoints not in main inventory
          Object.keys(qtdProduction).forEach(name => {
            if (!productMap[name]) {
              productMap[name] = {
                name, group: '', soh: 0,
                produced: qtdProduction[name] || 0,
                demand: qtdSales[name] || 0,
                forwardOrders: 0, salesQtd: qtdSales[name] || 0,
                mtdProd: 0, mtdSales: 0,
              };
            }
          });

          // Filter: ONLY products with sales, production, or forward orders
          let active = Object.values(productMap).filter(p =>
            p.produced > 0 || p.forwardOrders > 0 || p.mtdProd > 0 || p.mtdSales > 0 || p.salesQtd > 0
          );

          // If sub-endpoints returned no data, fall back to MTD from main endpoint
          const hasQtdData = Object.keys(qtdProduction).length > 0 || Object.keys(qtdSales).length > 0;
          if (!hasQtdData) {
            active = Object.values(productMap).filter(p =>
              p.mtdProd > 0 || p.mtdSales > 0 || p.forwardOrders > 0
            );
            active.forEach(p => {
              p.produced = p.mtdProd;
              p.salesQtd = p.mtdSales;
            });
            document.getElementById('production-period').textContent =
              `${quarterInfo.quarterCode} FY25/26 \u00b7 MTD data`;
          }

          // Sort: products with largest forward orders first, then by sales
          active.sort((a, b) => (b.forwardOrders + b.salesQtd) - (a.forwardOrders + a.salesQtd));

          // Store for drawer
          window.productionData = { active, hasQtdData, quarterInfo };

          // Render table
          if (active.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color: var(--color-text-muted); padding: 16px; font-size: 12px;">No production or demand activity this period</td></tr>';
            tfoot.innerHTML = '';
            return;
          }

          tbody.innerHTML = active.map(p => {
            // Traffic light based on forward orders vs production + existing stock
            let indicator = 'grey';
            let tooltip = 'No orders';
            if (p.forwardOrders > 0) {
              const coverage = (p.soh + p.produced) / p.forwardOrders;
              if (coverage >= 1.0) { indicator = 'green'; tooltip = 'Can fulfil'; }
              else if (coverage >= 0.5 || p.produced > 0) { indicator = 'amber'; tooltip = 'Partial cover'; }
              else { indicator = 'red'; tooltip = 'At risk'; }
            } else if (p.produced > 0 || p.salesQtd > 0) {
              indicator = 'green'; tooltip = p.produced > 0 ? 'Building stock' : 'Sales only';
            }

            return `<tr>
              <td title="${p.name}">${p.name}</td>
              <td>${Math.round(p.soh).toLocaleString()}</td>
              <td>${Math.round(p.produced).toLocaleString()}</td>
              <td>${Math.round(p.salesQtd).toLocaleString()}</td>
              <td>${Math.round(p.forwardOrders).toLocaleString()}</td>
              <td title="${tooltip}"><span class="prod-indicator ${indicator}"></span></td>
            </tr>`;
          }).join('');

          // Totals row
          const totProd = active.reduce((s, p) => s + p.produced, 0);
          const totSales = active.reduce((s, p) => s + p.salesQtd, 0);
          const totOrders = active.reduce((s, p) => s + p.forwardOrders, 0);
          const totSoh = active.reduce((s, p) => s + p.soh, 0);
          tfoot.innerHTML = `<tr>
            <td>TOTAL</td>
            <td>${Math.round(totSoh).toLocaleString()}</td>
            <td>${Math.round(totProd).toLocaleString()}</td>
            <td>${Math.round(totSales).toLocaleString()}</td>
            <td>${Math.round(totOrders).toLocaleString()}</td>
            <td></td>
          </tr>`;

        } catch (error) {
          console.error("Error loading production:", error);
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color: var(--color-text-muted); padding: 16px; font-size: 12px;">\u26a0 Production data unavailable</td></tr>';
          tfoot.innerHTML = '';
        }
      }

      // ========== TOP EXPENSES ==========
      function loadTopExpenses() {
        const pl = window.dashboardData.pl || {};
        const expenseAccounts = pl.expenseAccounts || [];
        
        // Sort by absolute value descending, take top 5
        const topExpenses = [...expenseAccounts]
          .sort((a, b) => Math.abs(b.amount || 0) - Math.abs(a.amount || 0))
          .slice(0, 5);

        // Store for drawer
        window.dashboardData.topExpenses = topExpenses;

        const totalExpenses = Math.abs(pl.opex || 0);

        if (topExpenses.length === 0) {
          document.getElementById("kpi-top-expense").textContent = "No data";
          document.getElementById("kpi-expense-trend").textContent = "--";
          return;
        }

        // Show Total Operating Expenses as the main value
        document.getElementById("kpi-top-expense").textContent = "$" + totalExpenses.toLocaleString();
        
        // Show #1 expense as the subtitle
        const topExpense = topExpenses[0];
        document.getElementById("kpi-expense-trend").innerHTML = `#1: ${topExpense.name?.substring(0, 20) || "Unknown"}`;
        document.getElementById("kpi-expense-trend").className = "kpi-trend neutral";

        // Initialize expense sparkline with historical trend
        initExpenseSparkline();
      }

      function initExpenseSparkline() {
        const canvas = document.getElementById('sparkExpenses');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        
        // Generate trend data from monthly historical if available, else use pattern
        const monthly = window.historicalData?.monthly || [];
        let expenseData;
        
        if (monthly.length >= 3) {
          // Use actual historical expense data
          expenseData = monthly.slice(-7).map(m => Math.abs(m.expenses || 0));
        } else {
          // Generate realistic pattern based on current OpEx
          const currentOpex = Math.abs(window.dashboardData.pl?.opex || 100000);
          const monthlyAvg = currentOpex / 3; // Quarterly to monthly estimate
          expenseData = [
            monthlyAvg * 0.85,
            monthlyAvg * 0.92,
            monthlyAvg * 1.05,
            monthlyAvg * 0.98,
            monthlyAvg * 1.10,
            monthlyAvg * 0.95,
            monthlyAvg * 1.02
          ];
        }

        // Destroy existing chart if any
        if (window.expenseSparkChart) {
          window.expenseSparkChart.destroy();
        }

        window.expenseSparkChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: ['', '', '', '', '', '', ''],
            datasets: [{
              data: expenseData,
              borderColor: '#FF8C00',
              backgroundColor: 'rgba(255, 140, 0, 0.1)',
              borderWidth: 2,
              fill: true,
              tension: 0.4,
              pointRadius: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { display: false },
              y: { display: false }
            }
          }
        });
      }

      // ========== TOP CUSTOMERS ==========
      async function loadTopCustomers(quarterInfo) {
        // Update subtitle to show current period
        const period = document.getElementById("periodSelector").value;
        document.getElementById("customers-period").textContent = `${period} FY25/26`;
        
        // Get invoices from receivables data
        const invoices = window.dashboardData.receivables?.invoices || [];
        
        // Group by customer name and sum amounts
        const customerTotals = {};
        invoices.forEach(inv => {
          const name = inv.contact || inv.contactName || 'Unknown';
          if (!customerTotals[name]) {
            customerTotals[name] = { name, value: 0, orders: 0 };
          }
          customerTotals[name].value += inv.amountDue || 0;
          customerTotals[name].orders += 1;
        });

        // Convert to array, sort by value descending, take top 5
        const customers = Object.values(customerTotals)
          .sort((a, b) => b.value - a.value)
          .slice(0, 5);

        const maxValue = customers[0]?.value || 1;

        const customerList = document.getElementById("customerList");
        
        if (customers.length === 0) {
          customerList.innerHTML = '<div class="customer-item" style="color: var(--color-text-muted);">No outstanding receivables</div>';
          return;
        }

        customerList.innerHTML = customers.map((c, i) => `
          <div class="customer-item">
            <span class="customer-rank">${i + 1}</span>
            <div class="customer-info">
              <div class="customer-name">${c.name}</div>
              <div class="customer-orders">${c.orders} invoice${c.orders !== 1 ? 's' : ''}</div>
              <div class="customer-bar">
                <div class="customer-bar-fill" style="width: ${(c.value / maxValue) * 100}%"></div>
              </div>
            </div>
            <span class="customer-value">$${c.value.toLocaleString()}</span>
          </div>
        `).join("");
      }

      // ========== FINANCIAL RATIOS ==========
      function loadFinancialRatios() {
        const pl = window.dashboardData.pl;
        const balance = window.dashboardData.balance;

        // Current Ratio = Current Assets / Current Liabilities (simplified using totals)
        const currentRatio = balance.totalLiabilities > 0 
          ? (balance.totalAssets / balance.totalLiabilities).toFixed(2) 
          : '-';
        
        // Gross Margin = (Revenue - COGS) / Revenue ÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â 100
        const revenue = Math.abs(pl.revenue || 0);
        const cogs = Math.abs(pl.cogs || 0);
        const grossMargin = revenue > 0 
          ? (((revenue - cogs) / revenue) * 100).toFixed(1) + '%'
          : '-';
        
        // Net Profit Margin = Net Profit / Revenue ÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â 100
        const netProfit = pl.netProfit || 0;
        const netMargin = revenue > 0 
          ? ((netProfit / revenue) * 100).toFixed(1) + '%'
          : '-';
        
        // Debt to Equity = Total Liabilities / Total Equity
        const debtEquity = balance.totalEquity > 0 
          ? (balance.totalLiabilities / balance.totalEquity).toFixed(2)
          : '-';

        // Update DOM
        document.getElementById('ratio-current').textContent = currentRatio;
        document.getElementById('ratio-gross-margin').textContent = grossMargin;
        document.getElementById('ratio-net-margin').textContent = netMargin;
        document.getElementById('ratio-debt-equity').textContent = debtEquity;
      }
        
        // ========== UPDATE BALANCE SHEET & AGED CARDS ==========
      function updateSummaryCards() {
        const balance = window.dashboardData.balance;
        const receivables = window.dashboardData.receivables;

        // Balance Sheet card
        document.getElementById('bs-assets').textContent = '$' + (balance.totalAssets || 0).toLocaleString();
        document.getElementById('bs-liabilities').textContent = '$' + (balance.totalLiabilities || 0).toLocaleString();
        document.getElementById('bs-equity').textContent = '$' + (balance.totalEquity || 0).toLocaleString();

        // Key Ratios card
        const pl = window.dashboardData.pl || {};
        const revenue = pl.revenue || 0;
        const grossProfit = pl.gross || 0;
        const netProfit = pl.netProfit || 0;

        // Current Ratio (Assets / Liabilities)
        const currentRatio = balance.totalLiabilities > 0 
          ? (balance.totalAssets / balance.totalLiabilities).toFixed(2) 
          : 'N/A';
        document.getElementById('ratio-current').textContent = currentRatio;

        // Gross Margin (Gross Profit / Revenue Ãƒâ€” 100)
        const grossMargin = revenue !== 0 
          ? ((grossProfit / revenue) * 100).toFixed(1) + '%'
          : 'N/A';
        document.getElementById('ratio-gross-margin').textContent = grossMargin;

        // Net Profit Margin (Net Profit / Revenue Ãƒâ€” 100)
        const netMargin = revenue !== 0 
          ? ((netProfit / revenue) * 100).toFixed(1) + '%'
          : 'N/A';
        document.getElementById('ratio-net-margin').textContent = netMargin;
        document.getElementById('ratio-net-margin').style.color = netProfit >= 0 ? 'var(--color-positive)' : 'var(--color-negative)';

        // Debt to Equity
        const debtEquity = balance.totalEquity > 0 
          ? (balance.totalLiabilities / balance.totalEquity).toFixed(2) 
          : 'N/A';
        document.getElementById('ratio-debt-equity').textContent = debtEquity;

        // Aged Debtors card
        document.getElementById('aged-current').textContent = '$' + (receivables.aged30Days || 0).toLocaleString();
        document.getElementById('aged-31-60').textContent = '$' + (receivables.aged60Days || 0).toLocaleString();
        document.getElementById('aged-61-90').textContent = '$' + (receivables.aged90Days || 0).toLocaleString();
        document.getElementById('aged-90plus').textContent = '$' + (receivables.agedOver120Days || 0).toLocaleString();
        document.getElementById('aged-total').textContent = '$' + (receivables.total || 0).toLocaleString();
        document.getElementById('aged-subtitle').textContent = (receivables.invoiceCount || 0) + ' invoices outstanding';
      }

      // ========== HEALTH STATUS ==========
      function updateHealthStatus() {
        const pl = window.dashboardData.pl;
        const dot = document.getElementById("healthDot");
        const status = document.getElementById("healthStatus");

        if (pl.netProfit < 0) {
          dot.className = "status-dot critical";
          status.textContent = "Attention Required";
        } else if (pl.netProfit < 10000) {
          dot.className = "status-dot warning";
          status.textContent = "Monitor";
        } else {
          dot.className = "status-dot";
          status.textContent = "Healthy";
        }
      }

      // ========== LOAD HISTORICAL DATA FROM SNAPSHOTS ==========
      async function loadHistoricalData(entity) {
        try {
          const org = entity || getSelectedEntity();
          const response = await fetch(`${API_BASE}/api/historical-metrics/${org}`);
          const data = await response.json();
          
          console.log('Historical data:', data);
          
          // Store for charts
          window.historicalData = data;
          
          return data;
        } catch (error) {
          console.error('Error loading historical data:', error);
          return { daily: [], monthly: [] };
        }
      }

      // ========== SPARKLINE CHARTS ==========
      function initSparklines() {
        const monthly = window.historicalData?.monthly || [];
        
        // Build month labels and data from snapshots
        const monthLabels = monthly.map(m => {
          const [year, month] = m.period_month.split('-');
          const monthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          return monthNames[parseInt(month)];
        });
        
        // If no data, use placeholders
        const defaultLabels = ['Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan'];
        const labels = monthLabels.length > 0 ? monthLabels : defaultLabels;
        
        const sparklineConfig = {
          type: 'line',
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
              legend: { display: false }, 
              tooltip: { 
                enabled: true,
                callbacks: {
                  label: function(context) {
                    return '$' + context.raw.toLocaleString();
                  }
                }
              } 
            },
            scales: { 
              x: { 
                display: true,
                grid: { display: false },
                ticks: { font: { size: 9 }, color: '#8A8886', maxRotation: 0 }
              }, 
              y: { display: false } 
            },
            elements: { 
              point: { 
                radius: function(context) {
                  // Show dot on last point only
                  return context.dataIndex === context.dataset.data.length - 1 ? 3 : 0;
                },
                hoverRadius: 4 
              },
              line: { borderWidth: 2, tension: 0.4 }
            }
          },
          plugins: [{
            id: 'endpointLabel',
            afterDatasetsDraw: function(chart) {
              const ctx = chart.ctx;
              chart.data.datasets.forEach((dataset) => {
                const meta = chart.getDatasetMeta(0);
                const lastPoint = meta.data[meta.data.length - 1];
                if (lastPoint) {
                  const value = dataset.data[dataset.data.length - 1];
                  let label;
                  if (Math.abs(value) >= 1000000) {
                    label = '$' + (value / 1000000).toFixed(1) + 'M';
                  } else if (Math.abs(value) >= 1000) {
                    label = (value < 0 ? '-$' : '$') + Math.round(Math.abs(value) / 1000) + 'K';
                  } else {
                    label = '$' + Math.round(value);
                  }
                  
                  ctx.save();
                  ctx.font = 'bold 9px -apple-system, sans-serif';
                  ctx.fillStyle = dataset.borderColor;
                  ctx.textAlign = 'right';
                  ctx.textBaseline = 'bottom';
                  ctx.fillText(label, lastPoint.x - 4, lastPoint.y - 6);
                  ctx.restore();
                }
              });
            }
          }]
        };

        // Destroy existing charts if they exist
        ['sparkCash', 'sparkRevenue', 'sparkProfit', 'sparkReceivables', 'sparkInventory'].forEach(id => {
          const canvas = document.getElementById(id);
          if (canvas && canvas.chart) {
            canvas.chart.destroy();
          }
        });

        // Get daily data for cash (or use current value repeated)
        const dailyCash = window.historicalData?.daily || [];
        const cashData = dailyCash.length > 0 
          ? dailyCash.map(d => parseFloat(d.cash_position))
          : [window.dashboardData.cash.totalCash || 485000];
        
        // Get monthly revenue and profit from snapshots - use actual current value as endpoint
        const actualRevenue = window.dashboardData.pl?.revenue || 0;
        const revenueData = monthly.length > 0 
          ? monthly.map(m => parseFloat(m.revenue))
          : [230000, 211000, 499000, 159000, 151000, 465000, actualRevenue];
        // Ensure last point matches actual data
        revenueData[revenueData.length - 1] = actualRevenue;
          
        const actualProfit = window.dashboardData.pl?.netProfit || 0;
        const profitData = monthly.length > 0 
          ? monthly.map(m => parseFloat(m.net_profit))
          : [10000, -44000, 223000, -243000, 155000, -96000, actualProfit];
        // Ensure last point matches actual data
        profitData[profitData.length - 1] = actualProfit;

        // Cash sparkline (use daily if available, otherwise monthly trend)
        const cashLabels = dailyCash.length > 0 
          ? dailyCash.map(d => { const ds = d.snapshot_date.split('T')[0]; const mn = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; return mn[parseInt(ds.split('-')[1]) - 1]; })
          : labels;
        const cashChart = new Chart(document.getElementById('sparkCash'), {
          ...sparklineConfig,
          data: {
            labels: cashLabels.length > 1 ? cashLabels : labels,
            datasets: [{
              data: cashData.length > 1 ? cashData : Array(labels.length).fill(cashData[0]),
              borderColor: '#107C10',
              fill: true,
              backgroundColor: 'rgba(16, 124, 16, 0.1)'
            }]
          }
        });
        document.getElementById('sparkCash').chart = cashChart;

        // Revenue sparkline
        const revChart = new Chart(document.getElementById('sparkRevenue'), {
          ...sparklineConfig,
          data: {
            labels: labels,
            datasets: [{
              data: revenueData,
              borderColor: revenueData[revenueData.length - 1] >= 0 ? '#107C10' : '#D13438',
              fill: true,
              backgroundColor: revenueData[revenueData.length - 1] >= 0 ? 'rgba(16, 124, 16, 0.1)' : 'rgba(209, 52, 56, 0.1)'
            }]
          }
        });
        document.getElementById('sparkRevenue').chart = revChart;

        // Profit sparkline
        const latestProfit = profitData[profitData.length - 1] || 0;
        const profitChart = new Chart(document.getElementById('sparkProfit'), {
          ...sparklineConfig,
          data: {
            labels: labels,
            datasets: [{
              data: profitData,
              borderColor: latestProfit >= 0 ? '#107C10' : '#D13438',
              fill: true,
              backgroundColor: latestProfit >= 0 ? 'rgba(16, 124, 16, 0.1)' : 'rgba(209, 52, 56, 0.1)'
            }]
          }
        });
        document.getElementById('sparkProfit').chart = profitChart;

        // Receivables sparkline (from daily snapshots)
        const receivablesData = dailyCash.length > 0 
          ? dailyCash.map(d => parseFloat(d.receivables_total))
          : [175000, 172000, 168000, 180000, 175000, 178000, 175754];
        const recChart = new Chart(document.getElementById('sparkReceivables'), {
          ...sparklineConfig,
          data: {
            labels: cashLabels.length > 1 ? cashLabels : labels,
            datasets: [{
              data: receivablesData.length > 1 ? receivablesData : Array(labels.length).fill(receivablesData[0]),
              borderColor: '#0078D4',
              fill: true,
              backgroundColor: 'rgba(0, 120, 212, 0.1)'
            }]
          }
        });
        document.getElementById('sparkReceivables').chart = recChart;

        // Inventory sparkline (static for now - no inventory in snapshots)
        const invChart = new Chart(document.getElementById('sparkInventory'), {
          ...sparklineConfig,
          data: {
            labels: labels,
            datasets: [{
              data: [3200000, 3350000, 3400000, 3450000, 3480000, 3490000, 3500031],
              borderColor: '#107C10',
              fill: true,
              backgroundColor: 'rgba(16, 124, 16, 0.1)'
            }]
          }
        });
        document.getElementById('sparkInventory').chart = invChart;
      }

      // ========== TREND CHART ==========
      function initTrendChart() {
        const ctx = document.getElementById('trendChart').getContext('2d');
        const monthly = window.historicalData?.monthly || [];
        const showYTD = document.getElementById('ytdToggle')?.checked || false;
        
        // Build labels and data from snapshots
        const labels = monthly.length > 0 
          ? monthly.map(m => {
              const [year, month] = m.period_month.split('-');
              const monthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
              return monthNames[parseInt(month)];
            })
          : ['Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan'];
        
        const actualRevenue = window.dashboardData.pl?.revenue || 0;
        const actualExpenses = window.dashboardData.pl?.totalExpenses || 0;
        const actualProfit = window.dashboardData.pl?.netProfit || 0;

        const revenueData = monthly.length > 0 
          ? monthly.map(m => parseFloat(m.revenue))
          : [180000, 120000, 95000, 80000, 60000, actualRevenue];
        revenueData[revenueData.length - 1] = actualRevenue;
          
        const expenseData = monthly.length > 0 
          ? monthly.map(m => parseFloat(m.revenue) - parseFloat(m.net_profit))
          : [145000, 105000, 100000, 92000, 68000, actualExpenses];
        expenseData[expenseData.length - 1] = actualExpenses;
          
        const profitData = monthly.length > 0 
          ? monthly.map(m => parseFloat(m.net_profit))
          : [35000, 15000, -5000, -12000, -8000, actualProfit];
        profitData[profitData.length - 1] = actualProfit;

        // Calculate YTD cumulative totals
        const ytdRevenue = [], ytdExpenses = [], ytdProfit = [];
        let cumRev = 0, cumExp = 0, cumProf = 0;
        for (let i = 0; i < revenueData.length; i++) {
          cumRev += revenueData[i];
          cumExp += expenseData[i];
          cumProf += profitData[i];
          ytdRevenue.push(cumRev);
          ytdExpenses.push(cumExp);
          ytdProfit.push(cumProf);
        }

        // Update YTD summary bar
        const totalYtdRev = ytdRevenue[ytdRevenue.length - 1] || 0;
        const totalYtdExp = ytdExpenses[ytdExpenses.length - 1] || 0;
        const totalYtdProf = ytdProfit[ytdProfit.length - 1] || 0;
        
        document.getElementById('ytd-revenue').textContent = '$' + totalYtdRev.toLocaleString();
        document.getElementById('ytd-expenses').textContent = '$' + totalYtdExp.toLocaleString();
        
        const ytdProfEl = document.getElementById('ytd-profit');
        ytdProfEl.textContent = (totalYtdProf < 0 ? '-$' : '$') + Math.abs(totalYtdProf).toLocaleString();
        ytdProfEl.style.color = totalYtdProf >= 0 ? '#107C10' : '#D13438';
        
        // Destroy if exists
        if (window.trendChartInstance) {
          window.trendChartInstance.destroy();
        }

        // Build datasets - bars always, YTD lines when toggled
        const datasets = [
          {
            label: 'Revenue',
            data: revenueData,
            backgroundColor: '#0078D4',
            borderRadius: 4,
            order: 2
          },
          {
            label: 'Expenses',
            data: expenseData,
            backgroundColor: '#D13438',
            borderRadius: 4,
            order: 2
          },
          {
            label: 'Profit',
            data: profitData,
            backgroundColor: '#107C10',
            borderRadius: 4,
            order: 2
          }
        ];

        if (showYTD) {
          datasets.push({
            label: 'YTD Revenue',
            data: ytdRevenue,
            type: 'line',
            borderColor: '#0078D4',
            borderWidth: 2,
            borderDash: [6, 3],
            pointRadius: 3,
            pointBackgroundColor: '#0078D4',
            fill: false,
            tension: 0.3,
            yAxisID: 'y1',
            order: 1
          });
          datasets.push({
            label: 'YTD Expenses',
            data: ytdExpenses,
            type: 'line',
            borderColor: '#D13438',
            borderWidth: 2,
            borderDash: [6, 3],
            pointRadius: 3,
            pointBackgroundColor: '#D13438',
            fill: false,
            tension: 0.3,
            yAxisID: 'y1',
            order: 1
          });
          datasets.push({
            label: 'YTD Profit',
            data: ytdProfit,
            type: 'line',
            borderColor: '#107C10',
            borderWidth: 2,
            borderDash: [6, 3],
            pointRadius: 3,
            pointBackgroundColor: '#107C10',
            fill: false,
            tension: 0.3,
            yAxisID: 'y1',
            order: 1
          });
        }

        const scales = {
          x: { grid: { display: false }, ticks: { font: { size: 11 } } },
          y: { 
            grid: { color: '#EDEBE9' },
            border: { display: false },
            ticks: { 
              font: { size: 10, weight: '500' },
              color: '#605E5C',
              padding: 8,
              callback: function(value) { 
                if (value === 0) return '$0';
                if (Math.abs(value) >= 1000000) return '$' + (value / 1000000).toFixed(1) + 'M';
                return '$' + (value / 1000).toFixed(0) + 'K'; 
              }
            }
          }
        };

        // Add second Y axis for YTD cumulative values
        if (showYTD) {
          scales.y1 = {
            position: 'right',
            grid: { display: false },
            border: { display: false },
            ticks: {
              font: { size: 10 },
              color: '#8A8886',
              callback: function(value) {
                if (value === 0) return '$0';
                if (Math.abs(value) >= 1000000) return '$' + (value / 1000000).toFixed(1) + 'M';
                return '$' + (value / 1000).toFixed(0) + 'K';
              }
            }
          };
        }

        window.trendChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ': $' + context.raw.toLocaleString();
                  }
                }
              }
            },
            scales: scales
          }
        });
      }

      // ========== DRAWER FUNCTIONS ==========
      function openDrawer(type) {
        const drawer = document.getElementById('drawer');
        const overlay = document.getElementById('drawerOverlay');
        const title = document.getElementById('drawerTitle');
        const content = document.getElementById('drawerContent');

        const titles = {
          cash: 'Cash Position Details',
          revenue: 'Revenue Breakdown',
          profit: 'Profit & Loss Detail',
          receivables: 'Aged Receivables',
          inventory: 'Inventory Detail',
          production: 'Production Overview',
          expenses: 'Top Expenses',
          pl: 'Full P&L Statement',
          balance: 'Balance Sheet',
          ratios: 'Key Financial Ratios'
        };

        title.textContent = titles[type] || 'Detail View';
        content.innerHTML = getDrawerContent(type);

        drawer.classList.add('active');
        overlay.classList.add('active');
      }

      function closeDrawer() {
        document.getElementById('drawer').classList.remove('active');
        document.getElementById('drawerOverlay').classList.remove('active');
      }

      function getDrawerContent(type) {
        const cash = window.dashboardData.cash;
        const pl = window.dashboardData.pl || {};
        const balance = window.dashboardData.balance;
        const receivables = window.dashboardData.receivables;

        const contents = {
          cash: `
            <div style="padding: 16px 0;">
              ${cash.isConsolidated ? (() => {
                const grouped = {};
                (cash.bankAccounts || []).forEach(acc => {
                  if (!grouped[acc.entity]) grouped[acc.entity] = { accounts: [], subtotal: 0 };
                  grouped[acc.entity].accounts.push(acc);
                  grouped[acc.entity].subtotal += acc.balance || 0;
                });
                return Object.entries(grouped).map(([entity, data]) => `
                  <h3 style="margin: 16px 0 8px 0; font-size: 14px; color: #6366F1;">${entity} &#x2014; $${data.subtotal.toLocaleString()}</h3>
                  <table class="data-table" style="margin-bottom: 12px;">
                    <tbody>
                      ${data.accounts.map(acc => `
                        <tr><td style="padding-left:12px; font-size:13px;">${acc.name}</td><td style="text-align:right; font-size:13px;">$${(acc.balance || 0).toLocaleString()}</td></tr>
                      `).join('')}
                    </tbody>
                  </table>
                `).join('');
              })() : `
                <h3 style="margin-bottom: 16px; font-size: 15px;">Bank Accounts</h3>
                <table class="data-table">
                  <thead><tr><th>Account</th><th style="text-align:right">Balance</th></tr></thead>
                  <tbody>
                    ${(cash.bankAccounts || []).map(acc => `
                      <tr><td>${acc.name}</td><td style="text-align:right">$${(acc.balance || 0).toLocaleString()}</td></tr>
                    `).join('') || '<tr><td colspan="2">No accounts found</td></tr>'}
                  </tbody>
                </table>
              `}
              <table class="data-table" style="margin-top: 8px;">
                <tbody>
                  <tr style="font-weight:600; background:#f5f5f5;">
                    <td>Total Cash</td><td style="text-align:right">$${(cash.totalCash || 0).toLocaleString()}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          `,
          revenue: `
            <div style="padding: 16px 0;">
              ${pl.isConsolidated ? (() => {
                const breakdown = pl.entityBreakdown || [];
                return `
                  <div style="font-size: 28px; font-weight: 600; color: ${(pl.revenue || 0) >= 0 ? 'var(--color-positive)' : 'var(--color-negative)'}; margin-bottom: 4px;">
                    $${(pl.revenue || 0).toLocaleString()}
                  </div>
                  <div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: 20px;">
                    Total Revenue across ${breakdown.length} entities
                  </div>
                  ${breakdown.filter(e => e.revenue !== 0).map(e => `
                    <h3 style="margin: 16px 0 8px 0; font-size: 14px; color: #6366F1;">${e.entity} \u2014 $${e.revenue.toLocaleString()}</h3>
                    <table class="data-table" style="margin-bottom: 12px;">
                      <tbody>
                        ${(e.revenueAccounts || []).sort((a, b) => Math.abs(b.amount) - Math.abs(a.amount)).map(acc => `
                          <tr>
                            <td style="padding-left:12px; font-size:13px;">${acc.name}</td>
                            <td style="text-align:right; font-size:13px; color: ${acc.amount >= 0 ? 'var(--color-positive)' : 'var(--color-negative)'};">$${acc.amount.toLocaleString()}</td>
                          </tr>
                        `).join('') || '<tr><td colspan="2" style="font-size:13px; color: var(--color-text-muted);">No revenue accounts</td></tr>'}
                      </tbody>
                    </table>
                  `).join('')}
                  <table class="data-table" style="margin-top: 8px;">
                    <tbody>
                      <tr style="font-weight:600; background:#f5f5f5;">
                        <td>Total Revenue</td><td style="text-align:right">$${(pl.revenue || 0).toLocaleString()}</td>
                      </tr>
                    </tbody>
                  </table>
                `;
              })() : (() => {
                const accounts = (pl.revenueAccounts || []).sort((a, b) => Math.abs(b.amount) - Math.abs(a.amount));
                return `
                  <div style="font-size: 28px; font-weight: 600; color: ${(pl.revenue || 0) >= 0 ? 'var(--color-positive)' : 'var(--color-negative)'}; margin-bottom: 4px;">
                    $${(pl.revenue || 0).toLocaleString()}
                  </div>
                  <div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: 20px;">
                    ${accounts.length} revenue accounts
                  </div>
                  <h3 style="margin-bottom: 12px; font-size: 14px; font-weight: 600;">Revenue Accounts</h3>
                  <table class="data-table">
                    <thead><tr><th>Account</th><th style="text-align:right">Amount</th></tr></thead>
                    <tbody>
                      ${accounts.map(acc => `
                        <tr>
                          <td style="font-size:13px;">${acc.name}</td>
                          <td style="text-align:right; font-size:13px; color: ${acc.amount >= 0 ? 'var(--color-positive)' : 'var(--color-negative)'}; font-weight:600;">$${acc.amount.toLocaleString()}</td>
                        </tr>
                      `).join('') || '<tr><td colspan="2">No revenue accounts found</td></tr>'}
                      <tr style="font-weight:600; background:#f5f5f5; border-top: 2px solid #ddd;">
                        <td>Total Revenue</td>
                        <td style="text-align:right; color: ${(pl.revenue || 0) >= 0 ? 'var(--color-positive)' : 'var(--color-negative)'};">$${(pl.revenue || 0).toLocaleString()}</td>
                      </tr>
                    </tbody>
                  </table>
                `;
              })()}
            </div>
          `,
          profit: (() => {
            // Helper to render the P&L waterfall with COGS and OpEx line items
            const renderPLWaterfall = (data, title) => {
              const cogsItems = (data.cogsAccounts || []).sort((a, b) => Math.abs(b.amount) - Math.abs(a.amount));
              const opexItems = (data.expenseAccounts || []).sort((a, b) => Math.abs(b.amount) - Math.abs(a.amount));
              return `
                ${title ? `<h3 style="margin: 16px 0 8px 0; font-size: 14px; color: #6366F1;">${title}</h3>` : ''}
                <table class="data-table" style="margin-bottom: 16px;">
                  <tbody>
                    <tr style="background:#E6F4EA;">
                      <td style="font-weight:600;">Revenue</td>
                      <td style="text-align:right; font-weight:600; color: var(--color-positive);">$${(data.revenue || 0).toLocaleString()}</td>
                    </tr>
                    ${cogsItems.length > 0 ? `
                      <tr style="background:#f9f9f9;"><td colspan="2" style="font-size:12px; font-weight:600; color: var(--color-text-muted); padding-top:8px;">COST OF GOODS SOLD</td></tr>
                      ${cogsItems.map(acc => `
                        <tr>
                          <td style="padding-left:12px; font-size:13px;">${acc.name}</td>
                          <td style="text-align:right; font-size:13px;">$${acc.amount.toLocaleString()}</td>
                        </tr>
                      `).join('')}
                      <tr style="font-weight:600; background:#FFF4E5;">
                        <td>Total COGS</td>
                        <td style="text-align:right">$${(data.cogs || 0).toLocaleString()}</td>
                      </tr>
                    ` : ''}
                    <tr style="font-weight:600; background:#E8F0FE;">
                      <td>Gross Profit</td>
                      <td style="text-align:right; color: var(--color-primary);">$${(data.gross || 0).toLocaleString()}</td>
                    </tr>
                    ${opexItems.length > 0 ? `
                      <tr style="background:#f9f9f9;"><td colspan="2" style="font-size:12px; font-weight:600; color: var(--color-text-muted); padding-top:8px;">OPERATING EXPENSES</td></tr>
                      ${opexItems.map(acc => `
                        <tr>
                          <td style="padding-left:12px; font-size:13px;">${acc.name}</td>
                          <td style="text-align:right; font-size:13px;">$${acc.amount.toLocaleString()}</td>
                        </tr>
                      `).join('')}
                      <tr style="font-weight:600; background:#FFF4E5;">
                        <td>Total OpEx</td>
                        <td style="text-align:right">$${(data.opex || 0).toLocaleString()}</td>
                      </tr>
                    ` : ''}
                    <tr style="font-weight:700; background:#f5f5f5; border-top: 2px solid #ddd; font-size: 15px;">
                      <td>Net Profit</td>
                      <td style="text-align:right; color: ${(data.netProfit || 0) >= 0 ? 'var(--color-positive)' : 'var(--color-negative)'};">$${(data.netProfit || 0).toLocaleString()}</td>
                    </tr>
                  </tbody>
                </table>
              `;
            };

            if (pl.isConsolidated) {
              const breakdown = pl.entityBreakdown || [];
              return `
                <div style="padding: 16px 0;">
                  <div style="font-size: 28px; font-weight: 600; color: ${(pl.netProfit || 0) >= 0 ? 'var(--color-positive)' : 'var(--color-negative)'}; margin-bottom: 4px;">
                    $${(pl.netProfit || 0).toLocaleString()}
                  </div>
                  <div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: 20px;">
                    Net Profit across ${breakdown.length} entities
                  </div>
                  ${breakdown.filter(e => e.revenue !== 0 || e.cogs !== 0 || e.opex !== 0).map(e => 
                    renderPLWaterfall(e, `${e.entity} \u2014 Net: $${e.netProfit.toLocaleString()}`)
                  ).join('')}
                  <table class="data-table" style="margin-top: 8px;">
                    <tbody>
                      <tr style="font-weight:700; background:#f5f5f5; font-size: 15px;">
                        <td>Consolidated Net Profit</td><td style="text-align:right; color: ${(pl.netProfit || 0) >= 0 ? 'var(--color-positive)' : 'var(--color-negative)'};">$${(pl.netProfit || 0).toLocaleString()}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              `;
            } else {
              return `
                <div style="padding: 16px 0;">
                  <div style="font-size: 28px; font-weight: 600; color: ${(pl.netProfit || 0) >= 0 ? 'var(--color-positive)' : 'var(--color-negative)'}; margin-bottom: 4px;">
                    $${(pl.netProfit || 0).toLocaleString()}
                  </div>
                  <div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: 20px;">
                    Full P&L breakdown
                  </div>
                  ${renderPLWaterfall(pl)}
                </div>
              `;
            }
          })(),
          balance: `
            <div style="padding: 16px 0;">
              ${balance.isConsolidated ? (() => {
                const breakdown = balance.entityBreakdown || [];
                return `
                  <div style="font-size: 28px; font-weight: 600; color: var(--color-primary); margin-bottom: 4px;">
                    $${(balance.totalEquity || 0).toLocaleString()}
                  </div>
                  <div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: 20px;">
                    Net Equity across ${breakdown.length} entities
                  </div>
                  <h3 style="margin-bottom: 12px; font-size: 14px; font-weight: 600;">Balance by Entity</h3>
                  <table class="data-table" style="margin-bottom: 16px;">
                    <thead><tr><th>Entity</th><th style="text-align:right">Assets</th><th style="text-align:right">Liabilities</th><th style="text-align:right">Equity</th></tr></thead>
                    <tbody>
                      ${breakdown.map(e => `
                        <tr>
                          <td style="font-size:13px;">${e.entity}</td>
                          <td style="text-align:right; font-size:13px;">$${(e.assets || 0).toLocaleString()}</td>
                          <td style="text-align:right; font-size:13px; color: var(--color-text-muted);">$${(e.liabilities || 0).toLocaleString()}</td>
                          <td style="text-align:right; font-size:13px; color: ${(e.equity || 0) >= 0 ? 'var(--color-positive)' : 'var(--color-negative)'}; font-weight:600;">$${(e.equity || 0).toLocaleString()}</td>
                        </tr>
                      `).join('')}
                      <tr style="font-weight:600; background:#f5f5f5; border-top: 2px solid #ddd;">
                        <td>Total</td>
                        <td style="text-align:right">$${(balance.totalAssets || 0).toLocaleString()}</td>
                        <td style="text-align:right; color: var(--color-text-muted);">$${(balance.totalLiabilities || 0).toLocaleString()}</td>
                        <td style="text-align:right; color: ${(balance.totalEquity || 0) >= 0 ? 'var(--color-positive)' : 'var(--color-negative)'};">$${(balance.totalEquity || 0).toLocaleString()}</td>
                      </tr>
                    </tbody>
                  </table>
                  <h3 style="margin: 16px 0 12px; font-size: 14px; font-weight: 600;">Consolidated Summary</h3>
                  <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                    <div style="padding: 10px; background: #E8F0FE; border-radius: 6px;">
                      <div style="font-size: 11px; color: var(--color-text-muted);">Total Assets</div>
                      <div style="font-size: 16px; font-weight: 600; color: var(--color-primary);">$${(balance.totalAssets || 0).toLocaleString()}</div>
                    </div>
                    <div style="padding: 10px; background: #FFF4E5; border-radius: 6px;">
                      <div style="font-size: 11px; color: var(--color-text-muted);">Liabilities</div>
                      <div style="font-size: 16px; font-weight: 600; color: var(--color-warning);">$${(balance.totalLiabilities || 0).toLocaleString()}</div>
                    </div>
                    <div style="padding: 10px; background: ${(balance.totalEquity || 0) >= 0 ? '#E6F4EA' : '#FDECE9'}; border-radius: 6px;">
                      <div style="font-size: 11px; color: var(--color-text-muted);">Net Equity</div>
                      <div style="font-size: 16px; font-weight: 600; color: ${(balance.totalEquity || 0) >= 0 ? 'var(--color-positive)' : 'var(--color-negative)'};">$${(balance.totalEquity || 0).toLocaleString()}</div>
                    </div>
                  </div>
                `;
              })() : (() => {
                const assetAccounts = (balance.assets || []).sort((a, b) => Math.abs(b.balance) - Math.abs(a.balance));
                const liabilityAccounts = (balance.liabilities || []).sort((a, b) => Math.abs(b.balance) - Math.abs(a.balance));
                const equityAccounts = (balance.equity || []).sort((a, b) => Math.abs(b.balance) - Math.abs(a.balance));
                return `
                  <div style="font-size: 28px; font-weight: 600; color: var(--color-primary); margin-bottom: 4px;">
                    $${(balance.totalEquity || 0).toLocaleString()}
                  </div>
                  <div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: 20px;">
                    Net Equity
                  </div>

                  <h3 style="margin-bottom: 8px; font-size: 14px; font-weight: 600; color: var(--color-primary);">Assets</h3>
                  <table class="data-table" style="margin-bottom: 16px;">
                    <tbody>
                      ${assetAccounts.map(acc => `
                        <tr>
                          <td style="font-size:13px;">${acc.name}</td>
                          <td style="text-align:right; font-size:13px;">$${(acc.balance || 0).toLocaleString()}</td>
                        </tr>
                      `).join('') || '<tr><td colspan="2" style="color: var(--color-text-muted);">No asset accounts</td></tr>'}
                      <tr style="font-weight:600; background:#E8F0FE;">
                        <td>Total Assets</td>
                        <td style="text-align:right; color: var(--color-primary);">$${(balance.totalAssets || 0).toLocaleString()}</td>
                      </tr>
                    </tbody>
                  </table>

                  <h3 style="margin-bottom: 8px; font-size: 14px; font-weight: 600; color: var(--color-warning);">Liabilities</h3>
                  <table class="data-table" style="margin-bottom: 16px;">
                    <tbody>
                      ${liabilityAccounts.map(acc => `
                        <tr>
                          <td style="font-size:13px;">${acc.name}</td>
                          <td style="text-align:right; font-size:13px;">$${(acc.balance || 0).toLocaleString()}</td>
                        </tr>
                      `).join('') || '<tr><td colspan="2" style="color: var(--color-text-muted);">No liability accounts</td></tr>'}
                      <tr style="font-weight:600; background:#FFF4E5;">
                        <td>Total Liabilities</td>
                        <td style="text-align:right; color: var(--color-warning);">$${(balance.totalLiabilities || 0).toLocaleString()}</td>
                      </tr>
                    </tbody>
                  </table>

                  <h3 style="margin-bottom: 8px; font-size: 14px; font-weight: 600; color: var(--color-positive);">Equity</h3>
                  <table class="data-table">
                    <tbody>
                      ${equityAccounts.map(acc => `
                        <tr>
                          <td style="font-size:13px;">${acc.name}</td>
                          <td style="text-align:right; font-size:13px; color: ${(acc.balance || 0) >= 0 ? 'var(--color-positive)' : 'var(--color-negative)'};">$${(acc.balance || 0).toLocaleString()}</td>
                        </tr>
                      `).join('') || '<tr><td colspan="2" style="color: var(--color-text-muted);">No equity accounts</td></tr>'}
                      <tr style="font-weight:600; background:#E6F4EA;">
                        <td>Net Equity</td>
                        <td style="text-align:right; color: ${(balance.totalEquity || 0) >= 0 ? 'var(--color-positive)' : 'var(--color-negative)'};">$${(balance.totalEquity || 0).toLocaleString()}</td>
                      </tr>
                    </tbody>
                  </table>
                `;
              })()}
            </div>
          `,
          ratios: (() => {
            const revenue = pl.revenue || 0;
            const grossProfit = pl.gross || 0;
            const netProfit = pl.netProfit || 0;
            const assets = balance.totalAssets || 0;
            const liabilities = balance.totalLiabilities || 0;
            const equity = balance.totalEquity || 0;

            const currentRatio = liabilities > 0 ? (assets / liabilities).toFixed(2) : 'N/A';
            const grossMargin = revenue !== 0 ? ((grossProfit / revenue) * 100).toFixed(1) : 'N/A';
            const netMargin = revenue !== 0 ? ((netProfit / revenue) * 100).toFixed(1) : 'N/A';
            const debtEquity = equity > 0 ? (liabilities / equity).toFixed(2) : 'N/A';

            return `
              <div style="padding: 16px 0;">
                <h3 style="margin-bottom: 20px; font-size: 15px;">Financial Ratios</h3>

                <!-- Current Ratio -->
                <div style="margin-bottom: 20px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-weight: 600;">Current Ratio</span>
                    <span style="font-size: 18px; font-weight: 700; color: ${parseFloat(currentRatio) >= 1.5 ? 'var(--color-positive)' : parseFloat(currentRatio) >= 1 ? 'var(--color-warning)' : 'var(--color-negative)'};">${currentRatio}</span>
                  </div>
                  <div style="font-size: 12px; color: var(--color-text-muted);">
                    = Total Assets &#xF7; Total Liabilities<br>
                    = $${assets.toLocaleString()} &#xF7; $${liabilities.toLocaleString()}
                  </div>
                  <div style="font-size: 11px; color: var(--color-text-muted); margin-top: 6px; font-style: italic;">
                    ${parseFloat(currentRatio) >= 1.5 ? '&#x2705; Strong liquidity' : parseFloat(currentRatio) >= 1 ? '&#x26A0; Adequate liquidity' : '&#x26A0; Low liquidity'}
                  </div>
                </div>

                <!-- Gross Margin -->
                <div style="margin-bottom: 20px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-weight: 600;">Gross Margin</span>
                    <span style="font-size: 18px; font-weight: 700; color: ${parseFloat(grossMargin) >= 30 ? 'var(--color-positive)' : parseFloat(grossMargin) >= 15 ? 'var(--color-warning)' : 'var(--color-negative)'};">${grossMargin}%</span>
                  </div>
                  <div style="font-size: 12px; color: var(--color-text-muted);">
                    = Gross Profit &#xF7; Revenue &#xD7; 100<br>
                    = $${grossProfit.toLocaleString()} &#xF7; $${revenue.toLocaleString()} &#xD7; 100
                  </div>
                  <div style="font-size: 11px; color: var(--color-text-muted); margin-top: 6px; font-style: italic;">
                    Profit after direct costs
                  </div>
                </div>

                <!-- Net Profit Margin -->
                <div style="margin-bottom: 20px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-weight: 600;">Net Profit Margin</span>
                    <span style="font-size: 18px; font-weight: 700; color: ${parseFloat(netMargin) >= 10 ? 'var(--color-positive)' : parseFloat(netMargin) >= 0 ? 'var(--color-warning)' : 'var(--color-negative)'};">${netMargin}%</span>
                  </div>
                  <div style="font-size: 12px; color: var(--color-text-muted);">
                    = Net Profit &#xF7; Revenue &#xD7; 100<br>
                    = $${netProfit.toLocaleString()} &#xF7; $${revenue.toLocaleString()} &#xD7; 100
                  </div>
                  <div style="font-size: 11px; color: var(--color-text-muted); margin-top: 6px; font-style: italic;">
                    ${parseFloat(netMargin) >= 10 ? '&#x2705; Healthy profitability' : parseFloat(netMargin) >= 0 ? '&#x26A0; Marginal profit' : '&#x26A0; Operating at a loss'}
                  </div>
                </div>

                <!-- Debt to Equity -->
                <div style="margin-bottom: 8px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-weight: 600;">Debt to Equity</span>
                    <span style="font-size: 18px; font-weight: 700; color: ${parseFloat(debtEquity) <= 1 ? 'var(--color-positive)' : parseFloat(debtEquity) <= 2 ? 'var(--color-warning)' : 'var(--color-negative)'};">${debtEquity}</span>
                  </div>
                  <div style="font-size: 12px; color: var(--color-text-muted);">
                    = Total Liabilities &#xF7; Total Equity<br>
                    = $${liabilities.toLocaleString()} &#xF7; $${equity.toLocaleString()}
                  </div>
                  <div style="font-size: 11px; color: var(--color-text-muted); margin-top: 6px; font-style: italic;">
                    ${parseFloat(debtEquity) <= 1 ? '&#x2705; Low leverage' : parseFloat(debtEquity) <= 2 ? '&#x26A0; Moderate leverage' : '&#x26A0; High leverage'}
                  </div>
                </div>
              </div>
            `;
          })(),
          expenses: (() => {
            const topExpenses = window.dashboardData.topExpenses || [];
            const totalOpex = Math.abs(pl.opex || 0);
            
            if (topExpenses.length === 0) {
              return `
                <div style="padding: 16px 0;">
                  <div style="color: var(--color-text-muted);">No expense data available</div>
                </div>
              `;
            }

            return `
              <div style="padding: 16px 0;">
                <div style="font-size: 28px; font-weight: 600; color: var(--color-warning); margin-bottom: 4px;">
                  $${totalOpex.toLocaleString()}
                </div>
                <div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: 20px;">
                  Total Operating Expenses
                </div>

                <h3 style="margin-bottom: 12px; font-size: 14px; font-weight: 600;">Top Expense Categories</h3>
                <table class="data-table">
                  <thead><tr><th>Expense Category</th><th style="text-align:right">Amount</th><th style="text-align:right">% of Total</th></tr></thead>
                  <tbody>
                    ${topExpenses.map((exp, i) => {
                      const amount = Math.abs(exp.amount || 0);
                      const pct = totalOpex > 0 ? ((amount / totalOpex) * 100).toFixed(1) : 0;
                      return `
                        <tr>
                          <td style="font-size:13px;">
                            <span style="display: inline-block; width: 18px; height: 18px; line-height: 18px; text-align: center; border-radius: 50%; background: ${i === 0 ? '#D13438' : i === 1 ? '#FF8C00' : '#FFC300'}; color: white; font-size: 11px; margin-right: 8px;">${i + 1}</span>
                            ${exp.name || 'Unknown'}
                          </td>
                          <td style="text-align:right; font-size:13px; font-weight: 600;">$${amount.toLocaleString()}</td>
                          <td style="text-align:right; font-size:13px; color: var(--color-text-muted);">${pct}%</td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>

                <div style="margin-top: 20px;">
                  <h3 style="margin-bottom: 12px; font-size: 14px; font-weight: 600;">Expense Breakdown</h3>
                  ${topExpenses.slice(0, 5).map((exp, i) => {
                    const amount = Math.abs(exp.amount || 0);
                    const pct = totalOpex > 0 ? ((amount / totalOpex) * 100) : 0;
                    return `
                      <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                          <span style="font-size: 12px;">${exp.name || 'Unknown'}</span>
                          <span style="font-size: 12px; font-weight: 600;">$${amount.toLocaleString()}</span>
                        </div>
                        <div style="height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden;">
                          <div style="height: 100%; width: ${pct}%; background: ${i === 0 ? '#D13438' : i === 1 ? '#FF8C00' : '#FFC300'}; border-radius: 4px;"></div>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            `;
          })(),
          receivables: `
            <div style="padding: 16px 0;">
              <div style="font-size: 28px; font-weight: 600; color: var(--color-primary); margin-bottom: 4px;">
                $${(receivables.total || 0).toLocaleString()}
              </div>
              <div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: 20px;">
                ${receivables.invoiceCount || 0} invoices &#x2022; ${receivables.total > 0 ? Math.round(receivables.aged30Days / receivables.total * 100) : 0}% current
              </div>
              
              <h3 style="margin-bottom: 12px; font-size: 14px; font-weight: 600;">Top Customers</h3>
              <table class="data-table">
                <thead><tr><th>Customer</th><th style="text-align:center">Inv</th><th style="text-align:right">Amount</th></tr></thead>
                <tbody>
                  ${(() => {
                    const invoices = receivables.invoices || [];
                    const byCustomer = {};
                    invoices.forEach(inv => {
                      const name = inv.contact || 'Unknown';
                      if (!byCustomer[name]) byCustomer[name] = { amount: 0, count: 0 };
                      byCustomer[name].amount += inv.amountDue || 0;
                      byCustomer[name].count++;
                    });
                    return Object.entries(byCustomer)
                      .sort((a, b) => b[1].amount - a[1].amount)
                      .slice(0, 10)
                      .map(([name, data]) => `
                        <tr>
                          <td style="max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${name}</td>
                          <td style="text-align:center; color: var(--color-text-muted);">${data.count}</td>
                          <td style="text-align:right; font-weight: 600;">$${data.amount.toLocaleString()}</td>
                        </tr>
                      `).join('');
                  })()}
                </tbody>
              </table>
              
              <h3 style="margin: 20px 0 12px; font-size: 14px; font-weight: 600;">Aging Summary</h3>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <div style="padding: 10px; background: #E6F4EA; border-radius: 6px;">
                  <div style="font-size: 11px; color: var(--color-text-muted);">Current (0-30)</div>
                  <div style="font-size: 16px; font-weight: 600; color: var(--color-positive);">$${(receivables.aged30Days || 0).toLocaleString()}</div>
                </div>
                <div style="padding: 10px; background: #FFF4E5; border-radius: 6px;">
                  <div style="font-size: 11px; color: var(--color-text-muted);">31-60 days</div>
                  <div style="font-size: 16px; font-weight: 600; color: var(--color-warning);">$${(receivables.aged60Days || 0).toLocaleString()}</div>
                </div>
                <div style="padding: 10px; background: #FFF4E5; border-radius: 6px;">
                  <div style="font-size: 11px; color: var(--color-text-muted);">61-90 days</div>
                  <div style="font-size: 16px; font-weight: 600; color: var(--color-warning);">$${(receivables.aged90Days || 0).toLocaleString()}</div>
                </div>
                <div style="padding: 10px; background: #FDECE9; border-radius: 6px;">
                  <div style="font-size: 11px; color: var(--color-text-muted);">90+ days</div>
                  <div style="font-size: 16px; font-weight: 600; color: var(--color-negative);">$${(receivables.agedOver120Days || 0).toLocaleString()}</div>
                </div>
              </div>
            </div>
          `,
          inventory: (() => {
            const inv = window.inventoryLive;
            if (!inv) return '<p style="color: var(--color-text-muted);">Inventory data unavailable. The Quarry API may be offline.</p>';
            const t = inv.totals;
            const groups = inv.familyGroups || [];
            const products = inv.products || [];
            const fwd = t.forwardOrders || {};
            return `
              <div style="padding: 16px 0;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                  <div style="padding: 12px; background: #E6F4EA; border-radius: 8px; text-align: center;">
                    <div style="font-size: 11px; color: var(--color-text-muted);">Total Stock Value</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--color-positive);">$${Math.round(t.inventoryValue).toLocaleString()}</div>
                  </div>
                  <div style="padding: 12px; background: #E8F0FE; border-radius: 8px; text-align: center;">
                    <div style="font-size: 11px; color: var(--color-text-muted);">Stock on Hand</div>
                    <div style="font-size: 20px; font-weight: 700; color: #1967D2;">${Math.round(t.sohTonnes).toLocaleString()}t</div>
                  </div>
                  <div style="padding: 12px; background: #FFF4E5; border-radius: 8px; text-align: center;">
                    <div style="font-size: 11px; color: var(--color-text-muted);">Forward Orders</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--color-warning);">${fwd.orderCount || 0} (${Math.round(fwd.tonnes || 0).toLocaleString()}t)</div>
                  </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                  <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;">
                    <div style="font-size: 11px; color: var(--color-text-muted);">MTD Sales Revenue</div>
                    <div style="font-size: 16px; font-weight: 600;">$${Math.round(t.mtd?.salesRevenue || 0).toLocaleString()}</div>
                  </div>
                  <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;">
                    <div style="font-size: 11px; color: var(--color-text-muted);">MTD Gross Margin</div>
                    <div style="font-size: 16px; font-weight: 600; color: ${((t.mtd?.salesRevenue || 0) - (t.mtd?.salesCost || 0)) >= 0 ? 'var(--color-positive)' : 'var(--color-negative)'};">$${Math.round((t.mtd?.salesRevenue || 0) - (t.mtd?.salesCost || 0)).toLocaleString()}</div>
                  </div>
                </div>

                <h3 style="margin: 0 0 10px; font-size: 14px; font-weight: 600;">Stock by Category</h3>
                <table class="data-table">
                  <thead><tr><th>Category</th><th style="text-align:right">Tonnes</th><th style="text-align:right">Value</th></tr></thead>
                  <tbody>
                    ${groups.map(g => `
                      <tr>
                        <td>${g.group.replace(/_/g, ' ')}</td>
                        <td style="text-align:right">${Math.round(g.totalTonnes).toLocaleString()}</td>
                        <td style="text-align:right">$${Math.round(g.totalValue).toLocaleString()}</td>
                      </tr>
                    `).join('')}
                    <tr style="font-weight:600; background:#f5f5f5;">
                      <td>TOTAL</td>
                      <td style="text-align:right">${Math.round(t.sohTonnes).toLocaleString()}</td>
                      <td style="text-align:right">$${Math.round(t.inventoryValue).toLocaleString()}</td>
                    </tr>
                  </tbody>
                </table>

                <h3 style="margin: 20px 0 10px; font-size: 14px; font-weight: 600;">All Products</h3>
                <table class="data-table">
                  <thead><tr><th>Product</th><th style="text-align:right">SOH (t)</th><th style="text-align:right">Avg Cost</th><th style="text-align:right">Value</th></tr></thead>
                  <tbody>
                    ${products.map(p => `
                      <tr>
                        <td style="font-size: 12px;">${p.name}</td>
                        <td style="text-align:right">${Math.round(p.sohTonnes).toLocaleString()}</td>
                        <td style="text-align:right">$${(p.avgCost || 0).toFixed(2)}</td>
                        <td style="text-align:right">$${Math.round(p.stockValue).toLocaleString()}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>

                <div style="margin-top: 16px; font-size: 11px; color: var(--color-text-muted); text-align: right;">
                  Live data from RAC Inventory System \u00b7 ${new Date(inv.timestamp).toLocaleString()}
                </div>
              </div>
            `;
          })(),
          production: (() => {
            const pd = window.productionData;
            if (!pd || !pd.active) return '<p style="color: var(--color-text-muted);">Production data unavailable.</p>';
            const active = pd.active;
            const qi = pd.quarterInfo;
            const totProd = active.reduce((s, p) => s + p.produced, 0);
            const totSales = active.reduce((s, p) => s + p.salesQtd, 0);
            const totOrders = active.reduce((s, p) => s + p.forwardOrders, 0);
            const totSoh = active.reduce((s, p) => s + p.soh, 0);

            return `
              <div style="padding: 16px 0;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                  <div style="padding: 12px; background: #E8F0FE; border-radius: 8px; text-align: center;">
                    <div style="font-size: 11px; color: var(--color-text-muted);">Produced</div>
                    <div style="font-size: 18px; font-weight: 700; color: #1967D2;">${Math.round(totProd).toLocaleString()}t</div>
                  </div>
                  <div style="padding: 12px; background: #E6F4EA; border-radius: 8px; text-align: center;">
                    <div style="font-size: 11px; color: var(--color-text-muted);">Sold</div>
                    <div style="font-size: 18px; font-weight: 700; color: var(--color-positive);">${Math.round(totSales).toLocaleString()}t</div>
                  </div>
                  <div style="padding: 12px; background: #FFF4E5; border-radius: 8px; text-align: center;">
                    <div style="font-size: 11px; color: var(--color-text-muted);">Forward Orders</div>
                    <div style="font-size: 18px; font-weight: 700; color: var(--color-warning);">${Math.round(totOrders).toLocaleString()}t</div>
                  </div>
                  <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                    <div style="font-size: 11px; color: var(--color-text-muted);">Stock on Hand</div>
                    <div style="font-size: 18px; font-weight: 700;">${Math.round(totSoh).toLocaleString()}t</div>
                  </div>
                </div>

                <h3 style="margin: 0 0 10px; font-size: 14px; font-weight: 600;">Active Products</h3>
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th style="text-align:right">SOH (t)</th>
                      <th style="text-align:right">Made</th>
                      <th style="text-align:right">Sold</th>
                      <th style="text-align:right">Orders</th>
                      <th style="text-align:center">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${active.map(p => {
                      let status = '\u2705';
                      if (p.forwardOrders > 0) {
                        const coverage = (p.soh + p.produced) / p.forwardOrders;
                        if (coverage < 0.5 && p.produced === 0) { status = '\u{1F534}'; }
                        else if (coverage < 1.0) { status = '\u{1F7E1}'; }
                      }
                      return '<tr>' +
                        '<td style="font-size: 12px;">' + p.name + '</td>' +
                        '<td style="text-align:right">' + Math.round(p.soh).toLocaleString() + '</td>' +
                        '<td style="text-align:right">' + Math.round(p.produced).toLocaleString() + '</td>' +
                        '<td style="text-align:right">' + Math.round(p.salesQtd).toLocaleString() + '</td>' +
                        '<td style="text-align:right; font-weight:' + (p.forwardOrders > 0 ? '600' : '400') + ';">' + Math.round(p.forwardOrders).toLocaleString() + '</td>' +
                        '<td style="text-align:center">' + status + '</td>' +
                      '</tr>';
                    }).join('')}
                    <tr style="font-weight:600; background:#f5f5f5;">
                      <td>TOTAL</td>
                      <td style="text-align:right">${Math.round(totSoh).toLocaleString()}</td>
                      <td style="text-align:right">${Math.round(totProd).toLocaleString()}</td>
                      <td style="text-align:right">${Math.round(totSales).toLocaleString()}</td>
                      <td style="text-align:right">${Math.round(totOrders).toLocaleString()}</td>
                      <td></td>
                    </tr>
                  </tbody>
                </table>

                <div style="margin-top: 16px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 12px;">
                  <strong>Legend:</strong>
                  <span style="margin-left: 8px;">\u2705 Can fulfil (SOH + produced covers orders)</span>
                  <span style="margin-left: 8px;">\u{1F7E1} Partial cover (producing but short)</span>
                  <span style="margin-left: 8px;">\u{1F534} At risk (orders with insufficient stock)</span>
                </div>

                <div style="margin-top: 12px; font-size: 11px; color: var(--color-text-muted); text-align: right;">
                  ${qi.quarterCode} FY25/26 \u00b7 ${pd.hasQtdData ? 'QTD' : 'MTD'} data from RAC Inventory System
                </div>
              </div>
            `;
          })()
        };

        return contents[type] || '<p>Loading...</p>';
      }

      // ========== CHAT FUNCTIONS ==========
      let chatHistory = [];

      function toggleChat() {
        document.getElementById('chatPanel').classList.toggle('active');
      }

      function toggleChatExpand() {
        document.getElementById('chatPanel').classList.toggle('expanded');
      }

      function clearChat() {
        chatHistory = [];
        const messages = document.getElementById('chatMessages');
        messages.innerHTML = `
          <div class="chat-message assistant">
            Chat cleared. Ask me anything about your financial data!
          </div>`;
        updateSuggestions();
      }

      function updateChatContext() {
        const contextBar = document.getElementById('chatContext');
        if (!contextBar) return;
        const entity = getSelectedEntity();
        const period = document.getElementById('periodSelector')?.value || 'Current';
        contextBar.innerHTML = `<span>\u{1F4CA} ${entity}</span><span>\u{1F4C5} ${period}</span><span class="status-dot live"></span>`;
      }

      function getDashboardMetrics() {
        const metrics = {};
        try {
          // Grab visible KPI values from the dashboard cards
          document.querySelectorAll('.metric-value, .kpi-value, [data-metric]').forEach(el => {
            const card = el.closest('.card, .metric-card, .grid-card');
            const label = card?.querySelector('.metric-label, .card-title, h3, .card-header');
            if (label && el.textContent.trim()) {
              metrics[label.textContent.trim()] = el.textContent.trim();
            }
          });
        } catch (e) { /* metrics are optional context */ }
        return metrics;
      }

      function updateSuggestions() {
        const entity = getSelectedEntity();
        const suggestions = document.getElementById('chatSuggestions');
        if (!suggestions) return;

        const isMining = entity.toLowerCase().includes('mining');
        const isConsolidated = entity.toLowerCase().includes('all') || entity.toLowerCase().includes('consolidated');

        let chips;
        if (isConsolidated) {
          chips = [
            { text: 'Which entity has the most cash?', label: 'Cash comparison' },
            { text: 'Total group revenue?', label: 'Group revenue' },
            { text: 'Any entities losing money?', label: 'Loss check' },
            { text: 'Group financial health?', label: 'Health check' },
          ];
        } else if (isMining) {
          chips = [
            { text: 'Top 3 expenses?', label: 'Top expenses' },
            { text: 'How is revenue tracking?', label: 'Revenue trend' },
            { text: 'What is our cash position?', label: 'Cash position' },
            { text: 'Compare to last quarter', label: 'QoQ compare' },
          ];
        } else {
          chips = [
            { text: 'Summarise this entity', label: 'Summary' },
            { text: 'Any concerns?', label: 'Risk check' },
            { text: 'Cash position?', label: 'Cash position' },
            { text: 'What are the key metrics?', label: 'Key metrics' },
          ];
        }

        suggestions.innerHTML = chips
          .map(c => `<span class="suggestion-chip" onclick="sendSuggestion('${c.text}')">${c.label}</span>`)
          .join('');
      }

      function showTypingIndicator() {
        const messages = document.getElementById('chatMessages');
        const typing = document.createElement('div');
        typing.className = 'typing-indicator';
        typing.id = 'typingIndicator';
        typing.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
        messages.appendChild(typing);
        messages.scrollTop = messages.scrollHeight;
      }

      function hideTypingIndicator() {
        const el = document.getElementById('typingIndicator');
        if (el) el.remove();
      }

      function getAdjustedAccountBreakdowns() {
        const reversals = window.reversalState?.data?.reversalJournals || [];
        const rawPL = window.reversalState?.originalPL || window.dashboardData?.pl || {};
        
        // Build per-account adjustment map from reversal journal lines
        const adjustments = {};
        reversals.forEach(journal => {
          journal.lines.forEach(line => {
            const key = line.accountName;
            if (!adjustments[key]) {
              adjustments[key] = { amount: 0, category: line.plCategory };
            }
            adjustments[key].amount += line.lineAmount;
          });
        });

        // Apply adjustments to raw P&L accounts
        function adjustAccounts(rawAccounts, category) {
          const adjusted = (rawAccounts || []).map(acc => {
            const adj = adjustments[acc.name];
            let adjAmount = acc.amount;
            if (adj && adj.category === category) {
              if (category === 'revenue') {
                adjAmount = acc.amount + adj.amount;
              } else {
                adjAmount = acc.amount - adj.amount;
              }
            }
            return { name: acc.name, amount: adjAmount };
          });
          
          // Add any reversal accounts that aren't in the raw P&L
          Object.entries(adjustments).forEach(([name, adj]) => {
            if (adj.category === category && !rawAccounts?.some(a => a.name === name)) {
              const amount = category === 'revenue' ? adj.amount : -adj.amount;
              if (Math.abs(amount) > 0.01) {
                adjusted.push({ name, amount });
              }
            }
          });
          
          return adjusted.filter(a => Math.abs(a.amount) > 0.01)
                         .sort((a, b) => Math.abs(b.amount) - Math.abs(a.amount));
        }

        return {
          revenueAccounts: adjustAccounts(rawPL.revenueAccounts, 'revenue'),
          cogsAccounts: adjustAccounts(rawPL.cogsAccounts, 'cogs'),
          expenseAccounts: adjustAccounts(rawPL.expenseAccounts, 'expense'),
        };
      }

      async function sendChat() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;

        // Add user message
        addChatMessage(message, 'user');
        chatHistory.push({ role: 'user', content: message });
        input.value = '';

        // Show typing animation
        showTypingIndicator();

        try {
          const entity = getSelectedEntity();
          const period = document.getElementById('periodSelector')?.value || 'Q3';
          const quarterInfo = getQuarterDates(period);
          const metrics = getDashboardMetrics();
          
          // Include reversal state so AI knows what the user is seeing
          const reversalContext = window.reversalState?.active ? {
            active: true,
            reversalCount: window.reversalState.data?.reversalCount || 0,
            plImpact: window.reversalState.data?.plImpact || {},
            adjustedPL: { ...window.dashboardData.pl },
            originalPL: window.reversalState.originalPL || {},
            adjustedRatios: {
              currentRatio: document.getElementById('ratio-current')?.textContent || '',
              grossMargin: document.getElementById('ratio-gross-margin')?.textContent || '',
              netProfitMargin: document.getElementById('ratio-net-margin')?.textContent || '',
              debtToEquity: document.getElementById('ratio-debt-equity')?.textContent || '',
            },
            adjustedAccounts: getAdjustedAccountBreakdowns(),
          } : { active: false };

          const response = await fetch(`${API_BASE}/api/ai-chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message,
              context: { entity, period, metrics, quarterInfo, reversals: reversalContext },
              history: chatHistory.slice(-6),
            }),
          });

          hideTypingIndicator();

          if (!response.ok) throw new Error(`Server returned ${response.status}`);

          const data = await response.json();
          const reply = data.response || 'Sorry, I couldn\'t generate a response.';

          addChatMessage(reply, 'assistant');
          chatHistory.push({ role: 'assistant', content: reply });

        } catch (error) {
          hideTypingIndicator();
          addChatMessage('Sorry, I couldn\'t connect to the AI service. Check that the server is running and ANTHROPIC_API_KEY is set in Railway.', 'assistant');
          console.error('Chat error:', error);
        }
      }

      function sendSuggestion(text) {
        document.getElementById('chatInput').value = text;
        sendChat();
      }

      function addChatMessage(text, type) {
        const messages = document.getElementById('chatMessages');
        const div = document.createElement('div');
        div.className = `chat-message ${type}`;

        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });

        // Simple markdown: **bold** and newlines
        const formatted = text
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\n/g, '<br>');

        div.innerHTML = `
          <div class="message-content">${formatted}</div>
          <div class="message-meta">
            <span class="message-time">${timeStr}</span>
            ${type === 'assistant' ? '<button class="copy-btn" onclick="copyMessage(this)" title="Copy">\u{1F4CB}</button>' : ''}
          </div>`;

        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
      }

      function copyMessage(btn) {
        const content = btn.closest('.chat-message').querySelector('.message-content').textContent;
        navigator.clipboard.writeText(content).then(() => {
          btn.textContent = '\u2713';
          setTimeout(() => btn.textContent = '\u{1F4CB}', 1500);
        });
      }

      function handleChatKeypress(event) {
        if (event.key === 'Enter') sendChat();
      }
      
// ========== SNAPSHOT FUNCTIONS ==========
      async function runDailySnapshot() {
        const btn = document.getElementById('snapshotBtn');
        const status = document.getElementById('snapshotStatus');
        
        if (!confirm('Run daily snapshot now?\\n\\nThis will capture data for all 7 organizations.')) {
          return;
        }
        
        btn.disabled = true;
        btn.classList.add('running');
        btn.innerHTML = '\u23F3 Running...';
        status.textContent = 'Processing...';
        status.className = 'snapshot-status';
        
        try {
          const response = await fetch(`${API_BASE}/api/run-daily-snapshot`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ triggeredBy: 'manual' })
          });
          
          const result = await response.json();
          
          if (result.success) {
            status.textContent = `\u2714 ${result.orgsProcessed}/${result.orgsProcessed + result.orgsFailed} orgs (${result.durationSeconds}s)`;
            status.className = 'snapshot-status success';
            alert(`Snapshot complete!\n\nProcessed: ${result.orgsProcessed} orgs\nFailed: ${result.orgsFailed}\nDuration: ${result.durationSeconds}s`);


          } else {
            throw new Error(result.error || 'Unknown error');
          }
          
        } catch (error) {
          console.error('Snapshot failed:', error);
          status.textContent = '\u2717 Failed';
          status.className = 'snapshot-status error';
          alert('Snapshot failed: ' + error.message);
        } finally {
          btn.disabled = false;
          btn.classList.remove('running');
          btn.innerHTML = '&#x1F4F8; Snapshot';
        }
      }


      // ========== INITIALIZE ==========
      document.addEventListener('DOMContentLoaded', () => {
        loadDashboard();
      });
    </script>
  </body>
  </html>