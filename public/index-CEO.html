<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RAC Mining - CEO Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: #f5f5f5;
        padding: 20px;
      }

      .header {
        background: white;
        padding: 15px 25px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        font-size: 24px;
        color: #2c3e50;
      }

      .period-info {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }

      .company-selector {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .period-selector {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        background: white;
      }

      .dashboard {
        display: grid;
        gap: 20px;
      }

      .top-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
      }

      .middle-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
      }

      .bottom-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .panel {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .panel h2 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #2c3e50;
      }

      /* P&L Section */
      .pl-section {
        display: grid;
        grid-template-columns: 250px 1fr;
        gap: 20px;
      }

      .pl-metrics {
        padding: 10px;
      }

      .pl-row {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        padding: 8px 0;
        font-size: 14px;
      }

      .pl-row.pl-highlight {
        font-weight: 600;
        padding: 10px 0;
      }

      .pl-value {
        font-weight: 600;
        color: #000;
      }

      .pl-percentage {
        font-size: 11px;
        color: #666;
        margin-left: 8px;
      }

      .budget-comparison {
        background: #fffbeb;
        padding: 15px;
        border-radius: 4px;
      }

      .budget-comparison h3 {
        font-size: 14px;
        margin-bottom: 15px;
        color: #333;
        text-align: center;
      }

      .budget-simple {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .budget-section {
        background: white;
        padding: 12px;
        border-radius: 4px;
      }

      .budget-section-header {
        font-weight: 600;
        font-size: 13px;
        color: #333;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e0e0e0;
      }

      .budget-detail-grid {
        display: grid;
        grid-template-columns: 80px 1fr;
        gap: 10px;
        padding: 5px 0;
        font-size: 12px;
      }

      .budget-detail-label {
        color: #666;
      }

      .budget-detail-value {
        text-align: right;
        font-weight: 500;
        color: #000;
      }

      .cogs-section {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid #e0e0e0;
      }

      .cogs-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        font-size: 14px;
      }

      /* Tables */
      .inventory-table,
      .orders-table {
        width: 100%;
        font-size: 12px;
        border-collapse: collapse;
      }

      .inventory-table th,
      .inventory-table td,
      .orders-table th,
      .orders-table td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }

      .inventory-table th,
      .orders-table th {
        font-weight: 600;
        color: #666;
        font-size: 11px;
        text-transform: uppercase;
      }

      .forecast-value {
        color: #3b82f6;
        font-weight: 500;
      }

      .placeholder-note {
        font-size: 11px;
        color: #999;
        font-style: italic;
        margin-top: 10px;
      }

      /* Balance */
      .balance-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
        font-size: 14px;
      }

      .balance-chart {
        margin-top: 15px;
        background: #f8f9fa;
        height: 150px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 12px;
      }

      /* Customers */
      .customer-list {
        list-style: none;
      }

      .customer-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        font-size: 13px;
      }

      .customer-amount {
        font-weight: 600;
        color: #27ae60;
      }

      /* Aged */
      .aged-legend {
        display: flex;
        gap: 15px;
        margin-bottom: 12px;
        font-size: 11px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 2px;
      }

      .aged-bar {
        display: flex;
        height: 60px;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 15px;
      }

      .aged-segment {
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 13px;
        font-weight: 600;
      }

      .aged-30 {
        background: #94a3b8;
      }
      .aged-60 {
        background: #fb923c;
      }
      .aged-90 {
        background: #f97316;
      }
      .aged-120 {
        background: #ef4444;
      }

      .aged-summary {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-top: 1px solid #eee;
        font-size: 13px;
      }

      /* Cash */
      .cash-current {
        font-size: 24px;
        font-weight: 700;
        color: #27ae60;
        margin-bottom: 15px;
      }

      .cash-chart {
        margin-top: 15px;
        background: #f8f9fa;
        height: 180px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 12px;
      }

      /* Ratios */
      .ratio-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        font-size: 13px;
      }

      .ratio-value {
        font-weight: 600;
        color: #3b82f6;
      }

      /* Future Panel */
      .future-panel {
        border: 2px dashed #cbd5e1;
        background: #f8fafc;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 300px;
      }

      .future-panel-icon {
        font-size: 48px;
        color: #cbd5e1;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      /* Open Orders Card Styling */
.open-orders-card {
  background: white;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  border: 1px solid #e0e0e0;
}

.open-orders-header {
  font-size: 18px;
  font-weight: 600;
  color: #2c3e50;
  margin-bottom: 16px;
  padding-bottom: 8px;
  border-bottom: 2px solid #3498db;
}

.open-orders-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.open-orders-table thead tr {
  background: #f8f9fa;
  border-bottom: 2px solid #dee2e6;
}

.open-orders-table th {
  padding: 10px 8px;
  text-align: left;
  font-weight: 600;
  color: #495057;
  font-size: 12px;
  text-transform: uppercase;
}

.open-orders-table th:first-child {
  padding-left: 12px;
}

.open-orders-table th:not(:first-child) {
  text-align: right;
}

.open-orders-table tbody tr {
  border-bottom: 1px solid #e9ecef;
  transition: background-color 0.2s;
}

.open-orders-table tbody tr:hover {
  background-color: #f8f9fa;
}

.open-orders-table tbody tr:last-child {
  border-bottom: 2px solid #dee2e6;
  font-weight: 600;
  background-color: #f1f3f5;
}

.open-orders-table td {
  padding: 10px 8px;
  color: #2c3e50;
}

.open-orders-table td:first-child {
  padding-left: 12px;
  font-weight: 500;
}

.open-orders-table td:not(:first-child) {
  text-align: right;
}

.order-value {
  color: #3498db;
  font-weight: 500;
  padding: 4px 8px;
  background: #e3f2fd;
  border-radius: 4px;
  display: inline-block;
  min-width: 50px;
  text-align: right;
}

.order-value.zero {
  color: #95a5a6;
  background: transparent;
  font-weight: 400;
}

/* Top Customers Card */
.top-customers-card {
  background: white;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  border: 1px solid #e0e0e0;
}

.top-customers-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 18px;
  font-weight: 600;
  color: #2c3e50;
  margin-bottom: 16px;
  padding-bottom: 8px;
  border-bottom: 2px solid #3498db;
}

.customer-slider-container {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  font-weight: 400;
}

.customer-slider-container label {
  color: #7f8c8d;
}

#customerSlider {
  width: 80px;
  cursor: pointer;
}

#customerSliderValue {
  min-width: 20px;
  font-weight: 600;
  color: #3498db;
}

.customer-legend {
  display: flex;
  gap: 20px;
  margin-bottom: 12px;
  font-size: 12px;
  color: #7f8c8d;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
}

.legend-color {
  width: 16px;
  height: 16px;
  border-radius: 3px;
}

.legend-color.past {
  background: #3498db;
}

.legend-color.future {
  background: #f39c12;
}

.customer-item {
  margin-bottom: 16px;
}

.customer-name-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 4px;
  font-size: 13px;
}

.customer-name {
  font-weight: 600;
  color: #2c3e50;
}

.customer-stats {
  display: flex;
  gap: 12px;
  font-size: 12px;
  color: #7f8c8d;
}

.customer-revenue {
  font-weight: 500;
}

.revenue-past {
  color: #3498db;
}

.revenue-future {
  color: #f39c12;
}

.customer-bar-container {
  width: 100%;
  height: 24px;
  background: #ecf0f1;
  border-radius: 4px;
  overflow: hidden;
  display: flex;
}

.customer-bar-past {
  background: #3498db;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 11px;
  font-weight: 600;
  transition: width 0.3s ease;
}

.customer-bar-future {
  background: #f39c12;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 11px;
  font-weight: 600;
  transition: width 0.3s ease;
}

.customer-bar-past:empty,
.customer-bar-future:empty {
  justify-content: flex-start;
}


    </style>
  </head>
  <body>
    <div class="header">
      <div>
        <h1>üèîÔ∏è Mining - CEO Dashboard</h1>
        <div class="period-info" id="period-info">Loading...</div>
      </div>
      <div class="company-selector">
        <select
          id="periodSelector"
          class="period-selector"
          onchange="loadDashboard()"
        >
          <option value="Q1">Q1 FY25/26 (Jul-Sep)</option>
          <option value="Q2" selected>Q2 FY25/26 (Oct-Dec)</option>
          <option value="Q3">Q3 FY25/26 (Jan-Mar)</option>
          <option value="Q4">Q4 FY25/26 (Apr-Jun)</option>
        </select>
        <button
          onclick="loadDashboard()"
          style="
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
          "
        >
          LOAD
        </button>
      </div>
    </div>

    <div class="dashboard">
      <div class="top-row">
        <!-- P&L -->
        <div class="panel">
          <h2>P&L Section</h2>
          <div class="pl-section">
            <div class="pl-metrics">
              <div class="pl-row">
                <span>Revenue</span>
                <span class="pl-value" id="pl-revenue">$X.XM</span>
              </div>
              <div class="pl-row">
                <span>COGS</span>
                <span class="pl-value" id="pl-cogs">$X.XM</span>
              </div>
              <div class="pl-row pl-highlight">
                <span>Gross Profit</span>
                <span class="pl-value" id="pl-gross-profit">$X.XM</span>
                <span class="pl-percentage" id="pl-margin">(% Margin)</span>
              </div>
              <div style="height: 15px"></div>
              <div class="pl-row">
                <span>Opex</span>
                <span class="pl-value" id="pl-opex">$X.XM</span>
              </div>
              <div class="pl-row">
                <span>EBITDA</span>
                <span class="pl-value" id="pl-ebitda">$X.XM</span>
                <span class="pl-percentage" id="pl-ebitda-vs-budget"
                  >(vs Budget %)</span
                >
              </div>
              <div class="pl-row pl-highlight">
                <span>Net Profit</span>
                <span class="pl-value" id="pl-net-profit">$X.XM</span>
              </div>
            </div>
            <div class="budget-comparison">
              <h3>Actual v Budget</h3>
              <div class="budget-simple">
                <div class="budget-section">
                  <div class="budget-section-header">Revenue</div>
                  <div class="budget-detail-grid">
                    <span class="budget-detail-label">Budget</span>
                    <span class="budget-detail-value" id="revenue-budget"
                      >-</span
                    >
                  </div>
                  <div class="budget-detail-grid">
                    <span class="budget-detail-label">Actual</span>
                    <span class="budget-detail-value" id="revenue-actual"
                      >-</span
                    >
                  </div>
                  <div class="budget-detail-grid">
                    <span class="budget-detail-label">Variance</span>
                    <span class="budget-detail-value" id="revenue-variance"
                      >-</span
                    >
                  </div>
                </div>
                <div class="budget-section">
                  <div class="budget-section-header">Expenses</div>
                  <div class="budget-detail-grid">
                    <span class="budget-detail-label">Budget</span>
                    <span class="budget-detail-value" id="expenses-budget"
                      >-</span
                    >
                  </div>
                  <div class="budget-detail-grid">
                    <span class="budget-detail-label">Actual</span>
                    <span class="budget-detail-value" id="expenses-actual"
                      >-</span
                    >
                  </div>
                  <div class="budget-detail-grid">
                    <span class="budget-detail-label">Variance</span>
                    <span class="budget-detail-value" id="expenses-variance"
                      >-</span
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="cogs-section">
            <div class="cogs-row">
              <strong>COGS</strong>
              <span id="cogs-summary">-</span>
            </div>
            <div class="cogs-row">
              <strong>Overheads</strong>
              <span id="overheads-summary">-</span>
            </div>
          </div>
        </div>

        <!-- Inventory -->
        <div class="panel">
          <h2>Inventory & Forecasting</h2>
          <table class="inventory-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Cur.STK</th>
                <th>Q2 Plan</th>
                <th>Q3/4 Plan</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>1. Sand</td>
                <td>250</td>
                <td>200</td>
                <td class="forecast-value">800</td>
              </tr>
              <tr>
                <td>2. 20mm</td>
                <td>580</td>
                <td>200</td>
                <td class="forecast-value">200</td>
              </tr>
              <tr>
                <td>3. 40mm</td>
                <td>150</td>
                <td>0</td>
                <td class="forecast-value">500</td>
              </tr>
              <tr>
                <td>4. 80mm</td>
                <td>50</td>
                <td>50</td>
                <td class="forecast-value">300</td>
              </tr>
              <tr>
                <td>5. RBase</td>
                <td>0</td>
                <td>100</td>
                <td class="forecast-value">100</td>
              </tr>
              <tr>
                <td>6. XYZ</td>
                <td>0</td>
                <td>150</td>
                <td class="forecast-value">300</td>
              </tr>
            </tbody>
          </table>
          <div class="placeholder-note">
            Note: Requires manual input or integration
          </div>
        </div>

        <!-- Open Orders -->
<div class="open-orders-card">
  <div class="open-orders-header">
    üì¶ Open Orders - Customer Pipeline
  </div>
  
  <div id="openOrdersContent">
    <div class="loading-spinner">Loading open orders...</div>
  </div>

  <table class="open-orders-table" id="openOrdersTable" style="display: none;">
    <thead>
  <tr>
    <th>Product</th>
    <th>Q1 Ordered</th>
    <th>Q1 Delivered</th>
    <th>Q2 Ordered</th>
    <th>Q2 Delivered</th>
    <th>Q3/Q4 Ordered</th>
    <th>Outstanding</th>
  </tr>
</thead>
    <tbody id="openOrdersBody">
      <!-- Data will be populated here -->
    </tbody>
  </table>
</div>

      <div class="middle-row">
        <!-- Balance -->
        <div class="panel">
          <h2>Balance</h2>
          <div class="balance-item">
            <span>Total Assets</span>
            <strong id="total-assets">-</strong>
          </div>
          <div class="balance-item">
            <span>Total Liabilities</span>
            <strong id="total-liabilities">-</strong>
          </div>
          <div class="balance-item">
            <span>Total Equity</span>
            <strong id="total-equity">-</strong>
          </div>
          <div class="balance-chart">Visual chart placeholder</div>
        </div>

        <!-- Top X Customers -->
<div class="top-customers-card">
  <div class="top-customers-header">
    <span>üë• Top Customers (FY26)</span>
    <div class="customer-slider-container">
      <label for="customerSlider">Show top</label>
      <input type="range" id="customerSlider" min="5" max="10" value="5" step="1">
      <span id="customerSliderValue">5</span>
    </div>
  </div>
  
  <div id="topCustomersContent">
    <div class="loading-spinner">Loading customers...</div>
  </div>

  <div id="topCustomersDisplay" style="display: none;">
    <div class="customer-legend">
      <span class="legend-item"><span class="legend-color past"></span> Delivered (Paid + Authorised)</span>
      <span class="legend-item"><span class="legend-color future"></span> Future Orders (Draft)</span>
    </div>
    <div id="topCustomersList"></div>
  </div>
</div>

        <!-- Aged -->
        <div class="panel">
          <h2>Aged Debtors</h2>
          <div class="aged-legend">
            <div class="legend-item">
              <div class="legend-color aged-30"></div>
              <span>30 Days</span>
            </div>
            <div class="legend-item">
              <div class="legend-color aged-60"></div>
              <span>60 Days</span>
            </div>
            <div class="legend-item">
              <div class="legend-color aged-90"></div>
              <span>90 Days</span>
            </div>
            <div class="legend-item">
              <div class="legend-color aged-120"></div>
              <span>120+ Days</span>
            </div>
          </div>
          <div class="aged-bar" id="aged-bar">
            <div class="aged-segment aged-30" style="width: 30%">30%</div>
            <div class="aged-segment aged-60" style="width: 20%">20%</div>
            <div class="aged-segment aged-90" style="width: 20%">20%</div>
            <div class="aged-segment aged-120" style="width: 30%">30%</div>
          </div>
          <div class="aged-summary">
            <span>Total Outstanding</span>
            <strong id="aged-total">-</strong>
          </div>
          <div class="aged-summary">
            <span>Critical (90+ days)</span>
            <strong id="aged-critical">-</strong>
          </div>
        </div>

        <!-- Cash -->
        <div class="panel">
          <h2>Cash Position</h2>
          <div class="cash-current" id="current-cash">-</div>
          <div class="cash-chart">Cash trend chart placeholder</div>
          <div class="placeholder-note">Requires historical data</div>
        </div>
      </div>

      <div class="bottom-row">
        <!-- Ratios -->
        <div class="panel">
          <h2>Financial Ratios</h2>
          <div class="ratio-item">
            <span>Current Ratio</span
            ><span class="ratio-value" id="ratio-current">-</span>
          </div>
          <div class="ratio-item">
            <span>Gross Margin %</span
            ><span class="ratio-value" id="ratio-gross-margin">-</span>
          </div>
          <div class="ratio-item">
            <span>Net Profit Margin %</span
            ><span class="ratio-value" id="ratio-net-margin">-</span>
          </div>
          <div class="ratio-item">
            <span>Debt to Equity</span
            ><span class="ratio-value" id="ratio-debt-equity">-</span>
          </div>
          <div class="ratio-item">
            <span>Return on Assets %</span
            ><span class="ratio-value" id="ratio-roa">-</span>
          </div>
          <div class="ratio-item">
            <span>Debtor Days</span
            ><span class="ratio-value" id="ratio-debtor-days">-</span>
          </div>
        </div>

        <!-- Future -->
        <div class="panel future-panel">
          <div class="future-panel-icon">+</div>
          <div style="color: #94a3b8; font-size: 14px">
            Optional future visualization
          </div>
        </div>
      </div>
    </div>

    <script>
      // API Configuration
      
      const API_BASE = "https://rac-xero-api-matt-production.up.railway.app";
      const MINING_ORG = "Mining";

      const QUARTERS = {
        Q1: { start: "2025-07-01", end: "2025-09-30", days: 92 },
        Q2: { start: "2025-10-01", end: "2025-12-31", days: 92 },
        Q3: { start: "2026-01-01", end: "2026-03-31", days: 90 },
        Q4: { start: "2026-04-01", end: "2026-06-30", days: 91 },
      };

      function getQuarterDates(quarterCode) {
        const quarter = QUARTERS[quarterCode];
        const today = new Date("2025-10-14");
        const startDate = new Date(quarter.start);
        const endDate = new Date(quarter.end);

        let actualEndDate = endDate;
        let daysElapsed = 0;
        let isComplete = false;
        let hasStarted = true;

        if (today < startDate) {
          hasStarted = false;
          daysElapsed = 0;
        } else if (today > endDate) {
          isComplete = true;
          daysElapsed = quarter.days;
        } else {
          actualEndDate = today;
          daysElapsed =
            Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;
        }

        return {
          quarterCode,
          startDate: quarter.start,
          endDate: isComplete ? quarter.end : today.toISOString().split("T")[0],
          totalDays: quarter.days,
          daysElapsed,
          isComplete,
          hasStarted,
          proRateFactor: daysElapsed / quarter.days,
        };
      }

      async function loadDashboard() {
        const period = document.getElementById("periodSelector").value;
        const quarterInfo = getQuarterDates(period);
        console.log("Quarter Info:", quarterInfo);

        if (!quarterInfo.hasStarted) {
          document.getElementById(
            "period-info"
          ).textContent = `${period} has not started yet`;
          return;
        }

        const statusText = quarterInfo.isComplete
          ? `Complete: ${quarterInfo.startDate} to ${quarterInfo.endDate}`
          : `${quarterInfo.daysElapsed} of ${quarterInfo.totalDays} days (${(
              quarterInfo.proRateFactor * 100
            ).toFixed(1)}%) | ${quarterInfo.startDate} to ${
              quarterInfo.endDate
            }`;

        document.getElementById("period-info").textContent = statusText;
        document.getElementById("period-info").style.color =
          quarterInfo.isComplete ? "#27ae60" : "#3b82f6";

        try {
          await loadTrialBalance();
          await loadProfitLoss(quarterInfo);
          await loadBudget(quarterInfo);
          await loadCashPosition();
          await loadOpenOrders();
          await loadTopCustomers();
          await loadAgedReceivables();
          await loadFinancialRatios();
        } catch (error) {
          console.error("Error:", error);
        }
      }

      async function loadTrialBalance() {
        try {
          const response = await fetch(`${API_BASE}/api/trial-balance`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ organizationName: MINING_ORG }),
          });
          const data = await response.json();
          console.log("Trial Balance:", data);

          document.getElementById("total-assets").textContent =
            "$" +
            (data.trialBalance?.totals?.totalAssets || 0).toLocaleString();
          document.getElementById("total-liabilities").textContent =
            "$" +
            (data.trialBalance?.totals?.totalLiabilities || 0).toLocaleString();
          document.getElementById("total-equity").textContent =
            "$" +
            (data.trialBalance?.totals?.totalEquity || 0).toLocaleString();
        } catch (error) {
          console.error("Error loading trial balance:", error);
        }
      }

      async function loadProfitLoss(quarterInfo) {
        try {
          const start = new Date(quarterInfo.startDate);
          const end = new Date(quarterInfo.endDate);
          const monthsDiff =
            (end.getFullYear() - start.getFullYear()) * 12 +
            (end.getMonth() - start.getMonth()) +
            1;

          const response = await fetch(`${API_BASE}/api/profit-loss-summary`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              organizationName: MINING_ORG,
              date: quarterInfo.endDate,
              periodMonths: monthsDiff,
            }),
          });

          const data = await response.json();
          console.log("P&L:", data);

          const revenue = data.summary?.totalRevenue || 0;
          const totalExpenses = data.summary?.totalExpenses || 0;
          const netProfit = data.summary?.netProfit || 0;

          // Categorize COGS vs Opex
          const expenseAccounts = data.summary?.expenseAccounts || [];
          let cogs = 0;
          let opex = 0;

          expenseAccounts.forEach((account) => {
            const name = account.name.toLowerCase();
            // COGS patterns: "cost of", "costs of goods sold", "cost -", "haulage expense", "freight"
            if (
              name.includes("cost of") ||
              name.includes("costs of goods sold") ||
              name.includes("cost -") || // Catches "Cost - Fuel", "Cost - Parts & Labour", etc.
              name.includes("haulage expense") ||
              name.includes("freight")
            ) {
              cogs += account.amount;
              console.log(
                "COGS account:",
                account.name,
                "$" + account.amount.toLocaleString()
              );
            } else {
              opex += account.amount;
              console.log(
                "Opex account:",
                account.name,
                "$" + account.amount.toLocaleString()
              );
            }
          });

          const grossProfit = revenue - cogs;
          const grossMargin =
            revenue > 0 ? ((grossProfit / revenue) * 100).toFixed(1) : 0;
          const ebitda = netProfit;

          // Smart formatting: use K for thousands, M for millions
          function formatAmount(amount) {
            const absAmount = Math.abs(amount);
            if (absAmount >= 1000000) {
              return "$" + (amount / 1000000).toFixed(2) + "M";
            } else if (absAmount >= 1000) {
              return "$" + (amount / 1000).toFixed(1) + "K";
            } else {
              return "$" + amount.toFixed(0);
            }
          }

          document.getElementById("pl-revenue").textContent =
            formatAmount(revenue);
          document.getElementById("pl-cogs").textContent = formatAmount(cogs);
          document.getElementById("pl-gross-profit").textContent =
            formatAmount(grossProfit);
          document.getElementById("pl-margin").textContent =
            "(" + grossMargin + "% Margin)";
          document.getElementById("pl-opex").textContent = formatAmount(opex);
          document.getElementById("pl-ebitda").textContent =
            formatAmount(ebitda);
          document.getElementById("pl-net-profit").textContent =
            formatAmount(netProfit);

          document.getElementById("revenue-actual").textContent =
            "$" + revenue.toLocaleString();
          document.getElementById("expenses-actual").textContent =
            "$" + totalExpenses.toLocaleString();
          document.getElementById("cogs-summary").textContent =
            "$" + cogs.toLocaleString();
          document.getElementById("overheads-summary").textContent =
            "$" + opex.toLocaleString();

          console.log("P&L Breakdown:", {
            revenue,
            cogs,
            grossProfit,
            opex,
            ebitda,
            netProfit,
          });

          window.plData = { revenue, totalExpenses, ebitda };
        } catch (error) {
          console.error("Error loading P&L:", error);
        }
      }

      async function loadBudget(quarterInfo) {
        try {
          const response = await fetch(`${API_BASE}/api/budget-summary`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              organizationName: MINING_ORG,
              quarter: quarterInfo.quarterCode,
            }),
          });

          const data = await response.json();
          console.log("Budget:", data);

          const budget = parseBudgetFromReport(data.report);
          const proRatedRevenueBudget = Math.round(
            budget.revenue * quarterInfo.proRateFactor
          );
          const proRatedExpensesBudget = Math.round(
            budget.expenses * quarterInfo.proRateFactor
          );

          console.log("Budget:", {
            full: { revenue: budget.revenue, expenses: budget.expenses },
            proRated: {
              revenue: proRatedRevenueBudget,
              expenses: proRatedExpensesBudget,
              factor: quarterInfo.proRateFactor,
            },
          });

          document.getElementById("revenue-budget").textContent =
            "$" + proRatedRevenueBudget.toLocaleString();
          document.getElementById("expenses-budget").textContent =
            "$" + proRatedExpensesBudget.toLocaleString();

          const revenueActual = window.plData?.revenue || 0;
          const expensesActual = window.plData?.totalExpenses || 0;
          const revenueVar = revenueActual - proRatedRevenueBudget;
          const expensesVar = expensesActual - proRatedExpensesBudget;

          document.getElementById("revenue-variance").textContent =
            (revenueVar >= 0 ? "+$" : "-$") +
            Math.abs(revenueVar).toLocaleString();
          document.getElementById("expenses-variance").textContent =
            (expensesVar >= 0 ? "+$" : "-$") +
            Math.abs(expensesVar).toLocaleString();

          const ebitdaActual = window.plData?.ebitda || 0;
          const budgetNetProfit =
            proRatedRevenueBudget - proRatedExpensesBudget;
          const ebitdaVsBudgetPct =
            budgetNetProfit !== 0
              ? (
                  ((ebitdaActual - budgetNetProfit) /
                    Math.abs(budgetNetProfit)) *
                  100
                ).toFixed(1)
              : 0;
          document.getElementById("pl-ebitda-vs-budget").textContent =
            "(" +
            (ebitdaVsBudgetPct >= 0 ? "+" : "") +
            ebitdaVsBudgetPct +
            "% vs Budget)";

          console.log("Variances:", {
            revenue: revenueVar,
            expenses: expensesVar,
            ebitda: ebitdaVsBudgetPct + "%",
          });
        } catch (error) {
          console.error("Error loading budget:", error);
        }
      }

      function parseBudgetFromReport(report) {
        let revenue = 0;
        let expenses = 0;

        if (!report || !report.rows) {
          console.error("‚ùå Budget report is empty or invalid");
          return { revenue: 0, expenses: 0 };
        }

        console.log("üìä Parsing budget report...");
        console.log("Report structure:", JSON.stringify(report, null, 2));

        // Try to find the budget values in the report
        for (const section of report.rows) {
          if (section.rowType === "Section" && section.title) {
            const title = section.title.toLowerCase();
            console.log("Found section:", section.title);

            if (title.includes("income") || title.includes("revenue")) {
              // Look through all rows for totals
              section.rows?.forEach((row) => {
                if (row.rowType === "SummaryRow" || row.rowType === "Row") {
                  const label = row.cells?.[0]?.value || "";
                  console.log("  Row:", label, "Cells:", row.cells?.length);

                  if (
                    label.toLowerCase().includes("total") &&
                    row.cells &&
                    row.cells.length >= 4
                  ) {
                    const month1 = parseFloat(row.cells[1]?.value || 0);
                    const month2 = parseFloat(row.cells[2]?.value || 0);
                    const month3 = parseFloat(row.cells[3]?.value || 0);
                    const total = month1 + month2 + month3;

                    if (total > revenue) {
                      // Take the largest total (usually "Total Income")
                      revenue = total;
                      console.log("‚úÖ Found revenue:", {
                        month1,
                        month2,
                        month3,
                        total,
                      });
                    }
                  }
                }
              });
            } else if (
              title.includes("expense") ||
              title.includes("operating")
            ) {
              section.rows?.forEach((row) => {
                if (row.rowType === "SummaryRow" || row.rowType === "Row") {
                  const label = row.cells?.[0]?.value || "";

                  if (
                    label.toLowerCase().includes("total") &&
                    row.cells &&
                    row.cells.length >= 4
                  ) {
                    const month1 = parseFloat(row.cells[1]?.value || 0);
                    const month2 = parseFloat(row.cells[2]?.value || 0);
                    const month3 = parseFloat(row.cells[3]?.value || 0);
                    const total = month1 + month2 + month3;

                    if (total > expenses) {
                      // Take the largest total
                      expenses = total;
                      console.log("‚úÖ Found expenses:", {
                        month1,
                        month2,
                        month3,
                        total,
                      });
                    }
                  }
                }
              });
            }
          }
        }

        console.log("üìã Final budget parsed:", { revenue, expenses });

        // Validation check
        if (revenue === 0 || expenses === 0) {
          console.warn("‚ö†Ô∏è Budget parsing may have failed - got zero values");
        }

        return { revenue, expenses };
      }

      async function loadCashPosition() {
        try {
          const response = await fetch(`${API_BASE}/api/cash-position`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ organizationName: MINING_ORG }),
          });
          const data = await response.json();
          document.getElementById("current-cash").textContent =
            "$" + (data.totalCash || 0).toLocaleString();
        } catch (error) {
          console.error("Error loading cash:", error);
        }
      }

      async function loadAgedReceivables() {
        try {
          const response = await fetch(`${API_BASE}/api/aged-receivables`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ organizationName: MINING_ORG }),
          });
          const data = await response.json();
          const total = data.totalOutstanding || 0;
          document.getElementById("aged-total").textContent =
            "$" + total.toLocaleString();
          document.getElementById("aged-critical").textContent =
            "$" + Math.round(total * 0.3).toLocaleString();
        } catch (error) {
          console.error("Error loading aged receivables:", error);
        }
      }

      // Product mapping - now using partial matching
function mapProductType(description) {
  const desc = description.toLowerCase();
  
  // Sand products
  if (desc.includes('screened sand') || desc.includes('crusher dust')) {
    return 'Sand';
  }
  
  // 20mm products
  if (desc.includes('7/10 aggregate') || 
      desc.includes('7/10mm aggregate') || 
      desc.includes('aggregate concrete 20mm') || 
      desc.includes('20mm aggregate')) {
    return '20mm';
  }
  
  // 40mm products
  if (desc.includes('type d 250-350mm') || 
      desc.includes('type c (d50 100 - 200mm)')) {
    return '40mm';
  }
  
  // 80mm products
  if (desc.includes('type e (d50 500 - 700mm)') || 
      desc.includes('oversize rock')) {
    return '80mm';
  }
  
  // Road base
  if (desc.includes('type 2 road base') || 
      desc.includes('road base')) {
    return 'RBase';
  }
  
  // Pre-mix
  if (desc.includes('pre-mix sand & gravel')) {
    return 'XYZ';
  }
  
  // Skip delivery fees and weighbridge
  if (desc.includes('delivery') || 
      desc.includes('weighbridge') || 
      desc.includes('hire of')) {
    return null; // Don't count these
  }
  
  return 'Other';
}

// Determine quarter from date (FY26: July 2025 - June 2026)
function getQuarter(dateStr) {
  const date = new Date(dateStr);
  const month = date.getMonth() + 1;
  if (month >= 7 && month <= 9) return 'Q1';
  if (month >= 10 && month <= 12) return 'Q2';
  if (month >= 1 && month <= 3) return 'Q3';
  if (month >= 4 && month <= 6) return 'Q4';
}

// Load open orders
async function loadOpenOrders() {
  console.log('üîç Starting loadOpenOrders()...');
  
  try {
    console.log('üì° Fetching invoices...');
    
    // Fetch AUTHORISED invoices (ordered but not paid)
    const authResponse = await fetch(`${API_BASE}/api/invoices-detail`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        organizationName: MINING_ORG,
        dateFrom: "2025-07-01",
        dateTo: "2026-06-30",
        status: "AUTHORISED"
      }),
    });

    if (!authResponse.ok) {
      throw new Error(`Failed to fetch AUTHORISED invoices: ${authResponse.status}`);
    }

    const authData = await authResponse.json();

    // Fetch PAID invoices (delivered)
    const paidResponse = await fetch(`${API_BASE}/api/invoices-detail`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        organizationName: MINING_ORG,
        dateFrom: "2025-07-01",
        dateTo: "2026-06-30",
        status: "PAID"
      }),
    });

    if (!paidResponse.ok) {
      throw new Error(`Failed to fetch PAID invoices: ${paidResponse.status}`);
    }

    const paidData = await paidResponse.json();

    console.log('‚úÖ AUTHORISED invoices:', authData.invoices.length);
    console.log('‚úÖ PAID invoices:', paidData.invoices.length);

    // Combine all invoices
    const allInvoices = [...authData.invoices, ...paidData.invoices];
    console.log('üìä Total invoices:', allInvoices.length);
    
    // Filter for sales invoices only
    const salesInvoices = allInvoices.filter(inv => inv.type === 'ACCREC');
    console.log('üí∞ Sales invoices (ACCREC):', salesInvoices.length);
    
    // Initialize products
    const products = {};
    ['Sand', '20mm', '40mm', '80mm', 'RBase', 'XYZ'].forEach(p => {
      products[p] = { Q1: 0, Q2: 0, Q3: 0, Q4: 0, total: 0 };
    });

    // Process invoices
    console.log('üîÑ Processing invoices...');
    salesInvoices.forEach((inv, idx) => {
      const quarter = getQuarter(inv.date);
      console.log(`üìÖ [${idx + 1}/${salesInvoices.length}] Invoice ${inv.invoiceNumber} | Date: ${inv.date} | Quarter: ${quarter} | Lines: ${inv.lineItems.length}`);
      
      inv.lineItems.forEach((item, lineIdx) => {
        const productType = mapProductType(item.description);
        console.log(`  üì¶ Line ${lineIdx + 1}: "${item.description}" ‚Üí ${productType} | Qty: ${item.quantity}t`);
        
        if (productType && productType !== 'Other' && products[productType]) {
          const tonnes = item.quantity;
          products[productType][quarter] += tonnes;
          products[productType].total += tonnes;
          console.log(`    ‚úÖ Added ${tonnes}t to ${productType} ${quarter}`);
        } else if (productType === 'Other') {
          console.log(`    ‚ö†Ô∏è Unmapped product: "${item.description}"`);
        }
      });
    });

    console.log('üìà Final products summary:', products);
    renderOpenOrdersTable(products);
    console.log('‚úÖ Open Orders loaded successfully!');

  } catch (error) {
    console.error('‚ùå ERROR in loadOpenOrders:', error);
    document.getElementById('openOrdersContent').innerHTML = 
      `<div style="text-align: center; padding: 20px; color: #e74c3c;">
        Error loading data<br>
        <small>${error.message}</small>
      </div>`;
  }
}
    
// Render the table
function renderOpenOrdersTable(products) {
  const tbody = document.getElementById('openOrdersBody');
  tbody.innerHTML = '';

  let grandTotal = { Q1: 0, Q2: 0, Q3: 0, Q4: 0, total: 0 };

  Object.entries(products).forEach(([product, quarters]) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${product}</td>
      <td>${formatOrderValue(quarters.Q1)}</td>
      <td>${formatOrderValue(quarters.Q2)}</td>
      <td>${formatOrderValue(quarters.Q3)}</td>
      <td>${formatOrderValue(quarters.Q4)}</td>
      <td><strong>${formatOrderValue(quarters.total)}</strong></td>
    `;
    tbody.appendChild(row);

    grandTotal.Q1 += quarters.Q1;
    grandTotal.Q2 += quarters.Q2;
    grandTotal.Q3 += quarters.Q3;
    grandTotal.Q4 += quarters.Q4;
    grandTotal.total += quarters.total;
  });

  const totalRow = document.createElement('tr');
  totalRow.className = 'total-row';
  totalRow.innerHTML = `
    <td>TOTAL</td>
    <td>${formatOrderValue(grandTotal.Q1)}</td>
    <td>${formatOrderValue(grandTotal.Q2)}</td>
    <td>${formatOrderValue(grandTotal.Q3)}</td>
    <td>${formatOrderValue(grandTotal.Q4)}</td>
    <td><strong>${formatOrderValue(grandTotal.total)}</strong></td>
  `;
  tbody.appendChild(totalRow);

  document.getElementById('openOrdersContent').style.display = 'none';
  document.getElementById('openOrdersTable').style.display = 'table';
}

// Format order values
function formatOrderValue(value) {
  const formatted = value.toFixed(1) + 't';
  if (value === 0) {
    return `<span class="order-value zero">-</span>`;
  }
  return `<span class="order-value">${formatted}</span>`;
}

// Load top customers
async function loadTopCustomers() {
  console.log('üîç Starting loadTopCustomers()...');
  
  try {
    // Fetch all invoice statuses
    const [draftRes, authRes, paidRes] = await Promise.all([
      fetch(`${API_BASE}/api/invoices-detail`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          organizationName: MINING_ORG,
          dateFrom: "2025-07-01",
          dateTo: "2026-06-30",
          status: "DRAFT"
        }),
      }),
      fetch(`${API_BASE}/api/invoices-detail`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          organizationName: MINING_ORG,
          dateFrom: "2025-07-01",
          dateTo: "2026-06-30",
          status: "AUTHORISED"
        }),
      }),
      fetch(`${API_BASE}/api/invoices-detail`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          organizationName: MINING_ORG,
          dateFrom: "2025-07-01",
          dateTo: "2026-06-30",
          status: "PAID"
        }),
      })
    ]);

    const draftData = await draftRes.json();
    const authData = await authRes.json();
    const paidData = await paidRes.json();

    console.log('‚úÖ DRAFT invoices:', draftData.invoices.length);
    console.log('‚úÖ AUTHORISED invoices:', authData.invoices.length);
    console.log('‚úÖ PAID invoices:', paidData.invoices.length);

    // Group by customer
    const customers = {};

    // Process DRAFT (future orders)
    draftData.invoices
      .filter(inv => inv.type === 'ACCREC')
      .forEach(inv => {
        const name = inv.contact.name;
        if (!customers[name]) {
          customers[name] = { name, past: 0, future: 0, pastOrders: 0, futureOrders: 0 };
        }
        customers[name].future += inv.total;
        customers[name].futureOrders += 1;
      });

    // Process AUTHORISED + PAID (past delivered orders)
    [...authData.invoices, ...paidData.invoices]
      .filter(inv => inv.type === 'ACCREC')
      .forEach(inv => {
        const name = inv.contact.name;
        if (!customers[name]) {
          customers[name] = { name, past: 0, future: 0, pastOrders: 0, futureOrders: 0 };
        }
        customers[name].past += inv.total;
        customers[name].pastOrders += 1;
      });

    // Convert to array and calculate totals
    const customersArray = Object.values(customers).map(c => ({
      ...c,
      total: c.past + c.future,
      totalOrders: c.pastOrders + c.futureOrders
    }));

    // Sort by total revenue descending
    customersArray.sort((a, b) => b.total - a.total);

    console.log('üìä Total unique customers:', customersArray.length);
    console.log('üèÜ Top customer:', customersArray[0]);

    // Store for rendering
    window.topCustomersData = customersArray;

    // Initial render
    renderTopCustomers(5);

    // Setup slider
    const slider = document.getElementById('customerSlider');
    const sliderValue = document.getElementById('customerSliderValue');
    
    slider.addEventListener('input', (e) => {
      const value = parseInt(e.target.value);
      sliderValue.textContent = value;
      renderTopCustomers(value);
    });

    console.log('‚úÖ Top Customers loaded successfully!');

  } catch (error) {
    console.error('‚ùå ERROR in loadTopCustomers:', error);
    document.getElementById('topCustomersContent').innerHTML = 
      `<div style="text-align: center; padding: 20px; color: #e74c3c;">
        Error loading customers<br>
        <small>${error.message}</small>
      </div>`;
  }
}

// Render top X customers
function renderTopCustomers(topX) {
  const data = window.topCustomersData || [];
  const topCustomers = data.slice(0, topX);
  
  // Calculate max total for bar sizing
  const maxTotal = topCustomers[0]?.total || 1;

  const container = document.getElementById('topCustomersList');
  container.innerHTML = '';

  topCustomers.forEach((customer, idx) => {
    const pastPercent = (customer.past / maxTotal) * 100;
    const futurePercent = (customer.future / maxTotal) * 100;
    const totalPercent = pastPercent + futurePercent;

    const item = document.createElement('div');
    item.className = 'customer-item';
    item.innerHTML = `
      <div class="customer-name-row">
        <span class="customer-name">${idx + 1}. ${customer.name}</span>
        <div class="customer-stats">
          <span class="customer-revenue revenue-past">$${customer.past.toLocaleString()} past</span>
          <span class="customer-revenue revenue-future">$${customer.future.toLocaleString()} future</span>
          <span>${customer.totalOrders} orders</span>
        </div>
      </div>
      <div class="customer-bar-container">
        <div class="customer-bar-past" style="width: ${pastPercent}%">
          ${pastPercent > 10 ? '$' + (customer.past / 1000).toFixed(0) + 'k' : ''}
        </div>
        <div class="customer-bar-future" style="width: ${futurePercent}%">
          ${futurePercent > 10 ? '$' + (customer.future / 1000).toFixed(0) + 'k' : ''}
        </div>
      </div>
    `;
    container.appendChild(item);
  });

  document.getElementById('topCustomersContent').style.display = 'none';
  document.getElementById('topCustomersDisplay').style.display = 'block';
}

      async function loadFinancialRatios() {
        try {
          const response = await fetch(`${API_BASE}/api/financial-ratios`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ organizationName: MINING_ORG }),
          });
          const data = await response.json();
          document.getElementById("ratio-current").textContent = (
            data.currentRatio || 0
          ).toFixed(2);
          document.getElementById("ratio-gross-margin").textContent =
            (data.grossMargin || 0).toFixed(1) + "%";
          document.getElementById("ratio-net-margin").textContent =
            (data.netProfitMargin || 0).toFixed(1) + "%";
          document.getElementById("ratio-debt-equity").textContent = (
            data.debtToEquity || 0
          ).toFixed(2);
          document.getElementById("ratio-roa").textContent =
            (data.returnOnAssets || 0).toFixed(1) + "%";
          document.getElementById("ratio-debtor-days").textContent = Math.round(
            data.debtorDays || 0
          );
        } catch (error) {
          console.error("Error loading ratios:", error);
        }
      }

      window.addEventListener("load", () => loadDashboard());
    </script>
  </body>
</html>
