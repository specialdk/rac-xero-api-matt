<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RAC Mining - CEO Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: #f5f5f5;
        padding: 20px;
      }

      .header {
        background: white;
        padding: 15px 25px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        font-size: 24px;
        color: #2c3e50;
      }

      .period-info {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }

      .company-selector {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .period-selector {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        background: white;
      }

      .dashboard {
        display: grid;
        gap: 20px;
      }

      .top-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
      }

      .middle-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
      }

      .bottom-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .panel {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .panel h2 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #2c3e50;
      }

      /* P&L Section */
      .pl-section {
        display: grid;
        grid-template-columns: 250px 1fr;
        gap: 20px;
      }

      .pl-metrics {
        padding: 10px;
      }

      .pl-row {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        padding: 8px 0;
        font-size: 14px;
      }

      .pl-row.pl-highlight {
        font-weight: 600;
        padding: 10px 0;
      }

      .pl-value {
        font-weight: 600;
        color: #000;
      }

      .pl-percentage {
        font-size: 11px;
        color: #666;
        margin-left: 8px;
      }

      .budget-comparison {
        background: #fffbeb;
        padding: 15px;
        border-radius: 4px;
      }

      .budget-comparison h3 {
        font-size: 14px;
        margin-bottom: 15px;
        color: #333;
        text-align: center;
      }

      .budget-simple {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .budget-section {
        background: white;
        padding: 12px;
        border-radius: 4px;
      }

      .budget-section-header {
        font-weight: 600;
        font-size: 13px;
        color: #333;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e0e0e0;
      }

      .budget-detail-grid {
        display: grid;
        grid-template-columns: 80px 1fr;
        gap: 10px;
        padding: 5px 0;
        font-size: 12px;
      }

      .budget-detail-label {
        color: #666;
      }

      .budget-detail-value {
        text-align: right;
        font-weight: 500;
        color: #000;
      }

      .cogs-section {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid #e0e0e0;
      }

      .cogs-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        font-size: 14px;
      }

      /* Tables */
      .inventory-table,
      .orders-table {
        width: 100%;
        font-size: 12px;
        border-collapse: collapse;
      }

      .inventory-table th,
      .inventory-table td,
      .orders-table th,
      .orders-table td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }

      .inventory-table th,
      .orders-table th {
        font-weight: 600;
        color: #666;
        font-size: 11px;
        text-transform: uppercase;
      }

      .forecast-value {
        color: #3b82f6;
        font-weight: 500;
      }

      .placeholder-note {
        font-size: 11px;
        color: #999;
        font-style: italic;
        margin-top: 10px;
      }

      /* Balance */
      .balance-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
        font-size: 14px;
      }

      .balance-chart {
        margin-top: 15px;
        background: #f8f9fa;
        height: 150px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 12px;
      }

      /* Customers */
      .customer-list {
        list-style: none;
      }

      .customer-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        font-size: 13px;
      }

      .customer-amount {
        font-weight: 600;
        color: #27ae60;
      }

      /* Aged */
      .aged-legend {
        display: flex;
        gap: 15px;
        margin-bottom: 12px;
        font-size: 11px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 2px;
      }

      .aged-bar {
        display: flex;
        height: 60px;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 15px;
      }

      .aged-segment {
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 13px;
        font-weight: 600;
      }

      .aged-30 {
        background: #94a3b8;
      }
      .aged-60 {
        background: #fb923c;
      }
      .aged-90 {
        background: #f97316;
      }
      .aged-120 {
        background: #ef4444;
      }

      .aged-summary {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-top: 1px solid #eee;
        font-size: 13px;
      }

      /* Cash */
      .cash-current {
        font-size: 24px;
        font-weight: 700;
        color: #27ae60;
        margin-bottom: 15px;
      }

      .cash-chart {
        margin-top: 15px;
        background: #f8f9fa;
        height: 180px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 12px;
      }

      /* Ratios */
      .ratio-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        font-size: 13px;
      }

      .ratio-value {
        font-weight: 600;
        color: #3b82f6;
      }

      /* Future Panel */
      .future-panel {
        border: 2px dashed #cbd5e1;
        background: #f8fafc;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 300px;
      }

      .future-panel-icon {
        font-size: 48px;
        color: #cbd5e1;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div>
        <h1>üèîÔ∏è Mining - CEO Dashboard</h1>
        <div class="period-info" id="period-info">Loading...</div>
      </div>
      <div class="company-selector">
        <select
          id="periodSelector"
          class="period-selector"
          onchange="loadDashboard()"
        >
          <option value="Q1">Q1 FY25/26 (Jul-Sep)</option>
          <option value="Q2" selected>Q2 FY25/26 (Oct-Dec)</option>
          <option value="Q3">Q3 FY25/26 (Jan-Mar)</option>
          <option value="Q4">Q4 FY25/26 (Apr-Jun)</option>
        </select>
        <button
          onclick="loadDashboard()"
          style="
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
          "
        >
          LOAD
        </button>
      </div>
    </div>

    <div class="dashboard">
      <div class="top-row">
        <!-- P&L -->
        <div class="panel">
          <h2>P&L Section</h2>
          <div class="pl-section">
            <div class="pl-metrics">
              <div class="pl-row">
                <span>Revenue</span>
                <span class="pl-value" id="pl-revenue">$X.XM</span>
              </div>
              <div class="pl-row">
                <span>COGS</span>
                <span class="pl-value" id="pl-cogs">$X.XM</span>
              </div>
              <div class="pl-row pl-highlight">
                <span>Gross Profit</span>
                <span class="pl-value" id="pl-gross-profit">$X.XM</span>
                <span class="pl-percentage" id="pl-margin">(% Margin)</span>
              </div>
              <div style="height: 15px"></div>
              <div class="pl-row">
                <span>Opex</span>
                <span class="pl-value" id="pl-opex">$X.XM</span>
              </div>
              <div class="pl-row">
                <span>EBITDA</span>
                <span class="pl-value" id="pl-ebitda">$X.XM</span>
                <span class="pl-percentage" id="pl-ebitda-vs-budget"
                  >(vs Budget %)</span
                >
              </div>
              <div class="pl-row pl-highlight">
                <span>Net Profit</span>
                <span class="pl-value" id="pl-net-profit">$X.XM</span>
              </div>
            </div>
            <div class="budget-comparison">
              <h3>Actual v Budget</h3>
              <div class="budget-simple">
                <div class="budget-section">
                  <div class="budget-section-header">Revenue</div>
                  <div class="budget-detail-grid">
                    <span class="budget-detail-label">Budget</span>
                    <span class="budget-detail-value" id="revenue-budget"
                      >-</span
                    >
                  </div>
                  <div class="budget-detail-grid">
                    <span class="budget-detail-label">Actual</span>
                    <span class="budget-detail-value" id="revenue-actual"
                      >-</span
                    >
                  </div>
                  <div class="budget-detail-grid">
                    <span class="budget-detail-label">Variance</span>
                    <span class="budget-detail-value" id="revenue-variance"
                      >-</span
                    >
                  </div>
                </div>
                <div class="budget-section">
                  <div class="budget-section-header">Expenses</div>
                  <div class="budget-detail-grid">
                    <span class="budget-detail-label">Budget</span>
                    <span class="budget-detail-value" id="expenses-budget"
                      >-</span
                    >
                  </div>
                  <div class="budget-detail-grid">
                    <span class="budget-detail-label">Actual</span>
                    <span class="budget-detail-value" id="expenses-actual"
                      >-</span
                    >
                  </div>
                  <div class="budget-detail-grid">
                    <span class="budget-detail-label">Variance</span>
                    <span class="budget-detail-value" id="expenses-variance"
                      >-</span
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="cogs-section">
            <div class="cogs-row">
              <strong>COGS</strong>
              <span id="cogs-summary">-</span>
            </div>
            <div class="cogs-row">
              <strong>Overheads</strong>
              <span id="overheads-summary">-</span>
            </div>
          </div>
        </div>

        <!-- Inventory -->
        <div class="panel">
          <h2>Inventory & Forecasting</h2>
          <table class="inventory-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Cur.STK</th>
                <th>Q2 Plan</th>
                <th>Q3/4 Plan</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>1. Sand</td>
                <td>250</td>
                <td>200</td>
                <td class="forecast-value">800</td>
              </tr>
              <tr>
                <td>2. 20mm</td>
                <td>580</td>
                <td>200</td>
                <td class="forecast-value">200</td>
              </tr>
              <tr>
                <td>3. 40mm</td>
                <td>150</td>
                <td>0</td>
                <td class="forecast-value">500</td>
              </tr>
              <tr>
                <td>4. 80mm</td>
                <td>50</td>
                <td>50</td>
                <td class="forecast-value">300</td>
              </tr>
              <tr>
                <td>5. RBase</td>
                <td>0</td>
                <td>100</td>
                <td class="forecast-value">100</td>
              </tr>
              <tr>
                <td>6. XYZ</td>
                <td>0</td>
                <td>150</td>
                <td class="forecast-value">300</td>
              </tr>
            </tbody>
          </table>
          <div class="placeholder-note">
            Note: Requires manual input or integration
          </div>
        </div>

        <!-- Open Orders -->
        <div class="panel">
          <h2>Open Orders</h2>
          <table class="orders-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Q1</th>
                <th>Q2</th>
                <th>Q3</th>
                <th>Q4</th>
              </tr>
            </thead>
            <tbody id="open-orders-table">
              <tr>
                <td colspan="5" class="loading">Loading...</td>
              </tr>
            </tbody>
          </table>
          <div class="placeholder-note">Note: Requires CRM integration</div>
        </div>
      </div>

      <div class="middle-row">
        <!-- Balance -->
        <div class="panel">
          <h2>Balance</h2>
          <div class="balance-item">
            <span>Total Assets</span>
            <strong id="total-assets">-</strong>
          </div>
          <div class="balance-item">
            <span>Total Liabilities</span>
            <strong id="total-liabilities">-</strong>
          </div>
          <div class="balance-item">
            <span>Total Equity</span>
            <strong id="total-equity">-</strong>
          </div>
          <div class="balance-chart">Visual chart placeholder</div>
        </div>

        <!-- Customers -->
        <div class="panel">
          <h2>Top X Customers</h2>
          <div style="font-size: 11px; color: #666; margin-bottom: 12px">
            FY25/26
          </div>
          <ul class="customer-list" id="customer-list">
            <li class="loading">Loading...</li>
          </ul>
          <div class="placeholder-note">From Aged Receivables API</div>
        </div>

        <!-- Aged -->
        <div class="panel">
          <h2>Aged Debtors</h2>
          <div class="aged-legend">
            <div class="legend-item">
              <div class="legend-color aged-30"></div>
              <span>30 Days</span>
            </div>
            <div class="legend-item">
              <div class="legend-color aged-60"></div>
              <span>60 Days</span>
            </div>
            <div class="legend-item">
              <div class="legend-color aged-90"></div>
              <span>90 Days</span>
            </div>
            <div class="legend-item">
              <div class="legend-color aged-120"></div>
              <span>120+ Days</span>
            </div>
          </div>
          <div class="aged-bar" id="aged-bar">
            <div class="aged-segment aged-30" style="width: 30%">30%</div>
            <div class="aged-segment aged-60" style="width: 20%">20%</div>
            <div class="aged-segment aged-90" style="width: 20%">20%</div>
            <div class="aged-segment aged-120" style="width: 30%">30%</div>
          </div>
          <div class="aged-summary">
            <span>Total Outstanding</span>
            <strong id="aged-total">-</strong>
          </div>
          <div class="aged-summary">
            <span>Critical (90+ days)</span>
            <strong id="aged-critical">-</strong>
          </div>
        </div>

        <!-- Cash -->
        <div class="panel">
          <h2>Cash Position</h2>
          <div class="cash-current" id="current-cash">-</div>
          <div class="cash-chart">Cash trend chart placeholder</div>
          <div class="placeholder-note">Requires historical data</div>
        </div>
      </div>

      <div class="bottom-row">
        <!-- Ratios -->
        <div class="panel">
          <h2>Financial Ratios</h2>
          <div class="ratio-item">
            <span>Current Ratio</span
            ><span class="ratio-value" id="ratio-current">-</span>
          </div>
          <div class="ratio-item">
            <span>Gross Margin %</span
            ><span class="ratio-value" id="ratio-gross-margin">-</span>
          </div>
          <div class="ratio-item">
            <span>Net Profit Margin %</span
            ><span class="ratio-value" id="ratio-net-margin">-</span>
          </div>
          <div class="ratio-item">
            <span>Debt to Equity</span
            ><span class="ratio-value" id="ratio-debt-equity">-</span>
          </div>
          <div class="ratio-item">
            <span>Return on Assets %</span
            ><span class="ratio-value" id="ratio-roa">-</span>
          </div>
          <div class="ratio-item">
            <span>Debtor Days</span
            ><span class="ratio-value" id="ratio-debtor-days">-</span>
          </div>
        </div>

        <!-- Future -->
        <div class="panel future-panel">
          <div class="future-panel-icon">+</div>
          <div style="color: #94a3b8; font-size: 14px">
            Optional future visualization
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "https://rac-xero-api-matt-production.up.railway.app";
      const MINING_ORG = "Mining";

      const QUARTERS = {
        Q1: { start: "2025-07-01", end: "2025-09-30", days: 92 },
        Q2: { start: "2025-10-01", end: "2025-12-31", days: 92 },
        Q3: { start: "2026-01-01", end: "2026-03-31", days: 90 },
        Q4: { start: "2026-04-01", end: "2026-06-30", days: 91 },
      };

      function getQuarterDates(quarterCode) {
        const quarter = QUARTERS[quarterCode];
        const today = new Date("2025-10-14");
        const startDate = new Date(quarter.start);
        const endDate = new Date(quarter.end);

        let actualEndDate = endDate;
        let daysElapsed = 0;
        let isComplete = false;
        let hasStarted = true;

        if (today < startDate) {
          hasStarted = false;
          daysElapsed = 0;
        } else if (today > endDate) {
          isComplete = true;
          daysElapsed = quarter.days;
        } else {
          actualEndDate = today;
          daysElapsed =
            Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;
        }

        return {
          quarterCode,
          startDate: quarter.start,
          endDate: isComplete ? quarter.end : today.toISOString().split("T")[0],
          totalDays: quarter.days,
          daysElapsed,
          isComplete,
          hasStarted,
          proRateFactor: daysElapsed / quarter.days,
        };
      }

      async function loadDashboard() {
        const period = document.getElementById("periodSelector").value;
        const quarterInfo = getQuarterDates(period);
        console.log("Quarter Info:", quarterInfo);

        if (!quarterInfo.hasStarted) {
          document.getElementById(
            "period-info"
          ).textContent = `${period} has not started yet`;
          return;
        }

        const statusText = quarterInfo.isComplete
          ? `Complete: ${quarterInfo.startDate} to ${quarterInfo.endDate}`
          : `${quarterInfo.daysElapsed} of ${quarterInfo.totalDays} days (${(
              quarterInfo.proRateFactor * 100
            ).toFixed(1)}%) | ${quarterInfo.startDate} to ${
              quarterInfo.endDate
            }`;

        document.getElementById("period-info").textContent = statusText;
        document.getElementById("period-info").style.color =
          quarterInfo.isComplete ? "#27ae60" : "#3b82f6";

        try {
          await loadTrialBalance();
          await loadProfitLoss(quarterInfo);
          await loadBudget(quarterInfo);
          await loadCashPosition();
          await loadAgedReceivables();
          await loadFinancialRatios();
        } catch (error) {
          console.error("Error:", error);
        }
      }

      async function loadTrialBalance() {
        try {
          const response = await fetch(`${API_BASE}/api/trial-balance`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ organizationName: MINING_ORG }),
          });
          const data = await response.json();
          console.log("Trial Balance:", data);

          document.getElementById("total-assets").textContent =
            "$" +
            (data.trialBalance?.totals?.totalAssets || 0).toLocaleString();
          document.getElementById("total-liabilities").textContent =
            "$" +
            (data.trialBalance?.totals?.totalLiabilities || 0).toLocaleString();
          document.getElementById("total-equity").textContent =
            "$" +
            (data.trialBalance?.totals?.totalEquity || 0).toLocaleString();
        } catch (error) {
          console.error("Error loading trial balance:", error);
        }
      }

      async function loadProfitLoss(quarterInfo) {
        try {
          const start = new Date(quarterInfo.startDate);
          const end = new Date(quarterInfo.endDate);
          const monthsDiff =
            (end.getFullYear() - start.getFullYear()) * 12 +
            (end.getMonth() - start.getMonth()) +
            1;

          const response = await fetch(`${API_BASE}/api/profit-loss-summary`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              organizationName: MINING_ORG,
              date: quarterInfo.endDate,
              periodMonths: monthsDiff,
            }),
          });

          const data = await response.json();
          console.log("P&L:", data);

          const revenue = data.summary?.totalRevenue || 0;
          const totalExpenses = data.summary?.totalExpenses || 0;
          const netProfit = data.summary?.netProfit || 0;

          // Categorize COGS vs Opex
          const expenseAccounts = data.summary?.expenseAccounts || [];
          let cogs = 0;
          let opex = 0;

          expenseAccounts.forEach((account) => {
            const name = account.name.toLowerCase();
            if (
              name.includes("cost of") ||
              name.includes("costs of goods sold") ||
              name.includes("haulage expense") ||
              name.includes("freight")
            ) {
              cogs += account.amount;
            } else {
              opex += account.amount;
            }
          });

          const grossProfit = revenue - cogs;
          const grossMargin =
            revenue > 0 ? ((grossProfit / revenue) * 100).toFixed(1) : 0;
          const ebitda = netProfit;

          // Smart formatting: use K for thousands, M for millions
          function formatAmount(amount) {
            const absAmount = Math.abs(amount);
            if (absAmount >= 1000000) {
              return "$" + (amount / 1000000).toFixed(2) + "M";
            } else if (absAmount >= 1000) {
              return "$" + (amount / 1000).toFixed(1) + "K";
            } else {
              return "$" + amount.toFixed(0);
            }
          }

          document.getElementById("pl-revenue").textContent =
            formatAmount(revenue);
          document.getElementById("pl-cogs").textContent = formatAmount(cogs);
          document.getElementById("pl-gross-profit").textContent =
            formatAmount(grossProfit);
          document.getElementById("pl-margin").textContent =
            "(" + grossMargin + "% Margin)";
          document.getElementById("pl-opex").textContent = formatAmount(opex);
          document.getElementById("pl-ebitda").textContent =
            formatAmount(ebitda);
          document.getElementById("pl-net-profit").textContent =
            formatAmount(netProfit);

          document.getElementById("revenue-actual").textContent =
            "$" + revenue.toLocaleString();
          document.getElementById("expenses-actual").textContent =
            "$" + totalExpenses.toLocaleString();
          document.getElementById("cogs-summary").textContent =
            "$" + cogs.toLocaleString();
          document.getElementById("overheads-summary").textContent =
            "$" + opex.toLocaleString();

          console.log("P&L Breakdown:", {
            revenue,
            cogs,
            grossProfit,
            opex,
            ebitda,
            netProfit,
          });

          window.plData = { revenue, totalExpenses, ebitda };
        } catch (error) {
          console.error("Error loading P&L:", error);
        }
      }

      async function loadBudget(quarterInfo) {
        try {
          const response = await fetch(`${API_BASE}/api/budget-summary`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              organizationName: MINING_ORG,
              quarter: quarterInfo.quarterCode,
            }),
          });

          const data = await response.json();
          console.log("Budget:", data);

          const budget = parseBudgetFromReport(data.report);
          const proRatedRevenueBudget = Math.round(
            budget.revenue * quarterInfo.proRateFactor
          );
          const proRatedExpensesBudget = Math.round(
            budget.expenses * quarterInfo.proRateFactor
          );

          console.log("Budget:", {
            full: { revenue: budget.revenue, expenses: budget.expenses },
            proRated: {
              revenue: proRatedRevenueBudget,
              expenses: proRatedExpensesBudget,
              factor: quarterInfo.proRateFactor,
            },
          });

          document.getElementById("revenue-budget").textContent =
            "$" + proRatedRevenueBudget.toLocaleString();
          document.getElementById("expenses-budget").textContent =
            "$" + proRatedExpensesBudget.toLocaleString();

          const revenueActual = window.plData?.revenue || 0;
          const expensesActual = window.plData?.totalExpenses || 0;
          const revenueVar = revenueActual - proRatedRevenueBudget;
          const expensesVar = expensesActual - proRatedExpensesBudget;

          document.getElementById("revenue-variance").textContent =
            (revenueVar >= 0 ? "+$" : "-$") +
            Math.abs(revenueVar).toLocaleString();
          document.getElementById("expenses-variance").textContent =
            (expensesVar >= 0 ? "+$" : "-$") +
            Math.abs(expensesVar).toLocaleString();

          const ebitdaActual = window.plData?.ebitda || 0;
          const budgetNetProfit =
            proRatedRevenueBudget - proRatedExpensesBudget;
          const ebitdaVsBudgetPct =
            budgetNetProfit !== 0
              ? (
                  ((ebitdaActual - budgetNetProfit) /
                    Math.abs(budgetNetProfit)) *
                  100
                ).toFixed(1)
              : 0;
          document.getElementById("pl-ebitda-vs-budget").textContent =
            "(" +
            (ebitdaVsBudgetPct >= 0 ? "+" : "") +
            ebitdaVsBudgetPct +
            "% vs Budget)";

          console.log("Variances:", {
            revenue: revenueVar,
            expenses: expensesVar,
            ebitda: ebitdaVsBudgetPct + "%",
          });
        } catch (error) {
          console.error("Error loading budget:", error);
        }
      }

      function parseBudgetFromReport(report) {
        let revenue = 0;
        let expenses = 0;

        if (!report || !report.rows) {
          console.error("Budget report is empty or invalid");
          return { revenue: 0, expenses: 0 };
        }

        console.log(
          "Parsing budget report with",
          report.rows.length,
          "sections"
        );

        for (const section of report.rows) {
          if (section.rowType === "Section" && section.title) {
            const title = section.title.toLowerCase();

            if (title.includes("income")) {
              console.log("Found Income section:", section.title);

              // Look for "Total Income" row
              const totalRow = section.rows?.find(
                (r) =>
                  r.rowType === "SummaryRow" &&
                  r.cells?.[0]?.value &&
                  r.cells[0].value.toLowerCase().includes("total")
              );

              if (totalRow && totalRow.cells && totalRow.cells.length >= 4) {
                // Sum columns 1, 2, 3 (months of the quarter)
                const month1 = parseFloat(totalRow.cells[1]?.value || 0);
                const month2 = parseFloat(totalRow.cells[2]?.value || 0);
                const month3 = parseFloat(totalRow.cells[3]?.value || 0);
                revenue = month1 + month2 + month3;

                console.log("Income breakdown:", {
                  month1,
                  month2,
                  month3,
                  total: revenue,
                });
              } else {
                console.warn(
                  "Could not find Total Income row or insufficient cells"
                );
              }
            } else if (
              title.includes("expense") ||
              title.includes("operating")
            ) {
              console.log("Found Expense section:", section.title);

              // Look for "Total Operating Expenses" or "Total Expenses" row
              const totalRow = section.rows?.find(
                (r) =>
                  r.rowType === "SummaryRow" &&
                  r.cells?.[0]?.value &&
                  r.cells[0].value.toLowerCase().includes("total")
              );

              if (totalRow && totalRow.cells && totalRow.cells.length >= 4) {
                const month1 = parseFloat(totalRow.cells[1]?.value || 0);
                const month2 = parseFloat(totalRow.cells[2]?.value || 0);
                const month3 = parseFloat(totalRow.cells[3]?.value || 0);
                expenses = month1 + month2 + month3;

                console.log("Expense breakdown:", {
                  month1,
                  month2,
                  month3,
                  total: expenses,
                });
              } else {
                console.warn(
                  "Could not find Total Expenses row or insufficient cells"
                );
              }
            }
          }
        }

        console.log("Final budget parsed:", { revenue, expenses });
        return { revenue, expenses };
      }

      async function loadCashPosition() {
        try {
          const response = await fetch(`${API_BASE}/api/cash-position`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ organizationName: MINING_ORG }),
          });
          const data = await response.json();
          document.getElementById("current-cash").textContent =
            "$" + (data.totalCash || 0).toLocaleString();
        } catch (error) {
          console.error("Error loading cash:", error);
        }
      }

      async function loadAgedReceivables() {
        try {
          const response = await fetch(`${API_BASE}/api/aged-receivables`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ organizationName: MINING_ORG }),
          });
          const data = await response.json();
          const total = data.totalOutstanding || 0;
          document.getElementById("aged-total").textContent =
            "$" + total.toLocaleString();
          document.getElementById("aged-critical").textContent =
            "$" + Math.round(total * 0.3).toLocaleString();
        } catch (error) {
          console.error("Error loading aged receivables:", error);
        }
      }

      async function loadFinancialRatios() {
        try {
          const response = await fetch(`${API_BASE}/api/financial-ratios`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ organizationName: MINING_ORG }),
          });
          const data = await response.json();
          document.getElementById("ratio-current").textContent = (
            data.currentRatio || 0
          ).toFixed(2);
          document.getElementById("ratio-gross-margin").textContent =
            (data.grossMargin || 0).toFixed(1) + "%";
          document.getElementById("ratio-net-margin").textContent =
            (data.netProfitMargin || 0).toFixed(1) + "%";
          document.getElementById("ratio-debt-equity").textContent = (
            data.debtToEquity || 0
          ).toFixed(2);
          document.getElementById("ratio-roa").textContent =
            (data.returnOnAssets || 0).toFixed(1) + "%";
          document.getElementById("ratio-debtor-days").textContent = Math.round(
            data.debtorDays || 0
          );
        } catch (error) {
          console.error("Error loading ratios:", error);
        }
      }

      window.addEventListener("load", () => loadDashboard());
    </script>
  </body>
</html>
