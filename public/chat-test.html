<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RAC Financial Chat Test</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useRef, useEffect } = React;
      const { Send, DollarSign, TrendingUp, FileText, AlertCircle, Loader2 } =
        lucide;

      const RACXeroChat = () => {
        const [messages, setMessages] = useState([
          {
            id: 1,
            type: "assistant",
            content:
              "Hello! I can help you access RAC financial data from Xero. Try asking me about trial balance, cash position, profit & loss, or outstanding invoices.",
            timestamp: new Date(),
          },
        ]);
        const [inputMessage, setInputMessage] = useState("");
        const [isLoading, setIsLoading] = useState(false);
        const [selectedOrg, setSelectedOrg] = useState(
          "Rirratjingu Aboriginal Corporation 8538"
        );
        const messagesEndRef = useRef(null);

        // Available organizations - this would typically come from your API
        const organizations = [
          "Rirratjingu Aboriginal Corporation 8538",
          "Rirratjingu Mining Pty Ltd 7168",
          "Rirratjingu Enterprises Pty Ltd",
          "Rirratjingu Property Management & Maintenance Services Pty Ltd",
        ];

        const scrollToBottom = () => {
          messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
        };

        useEffect(() => {
          scrollToBottom();
        }, [messages]);

        // Quick action buttons for common queries
        const quickActions = [
          {
            label: "Trial Balance",
            icon: FileText,
            query: "Show me the trial balance",
          },
          {
            label: "Cash Position",
            icon: DollarSign,
            query: "What is our current cash position?",
          },
          {
            label: "P&L Summary",
            icon: TrendingUp,
            query: "Show me the profit and loss summary",
          },
          {
            label: "Outstanding Invoices",
            icon: AlertCircle,
            query: "What invoices are outstanding?",
          },
        ];

        // This function integrates with your Railway API
        const processFinancialQuery = async (query, organization) => {
          const API_BASE_URL =
            "https://rac-financial-dashboard-production.up.railway.app/api";

          try {
            // Determine which endpoint to call based on the query
            let endpoint = "";
            let params = { organizationName: organization };

            if (query.toLowerCase().includes("trial balance")) {
              endpoint = "/trial-balance";
            } else if (
              query.toLowerCase().includes("cash") ||
              query.toLowerCase().includes("bank")
            ) {
              endpoint = "/cash-position";
            } else if (
              query.toLowerCase().includes("profit") ||
              query.toLowerCase().includes("loss") ||
              query.toLowerCase().includes("p&l")
            ) {
              endpoint = "/profit-loss-summary";
              params.periodMonths = 12;
            } else if (
              query.toLowerCase().includes("outstanding") ||
              query.toLowerCase().includes("invoice")
            ) {
              endpoint = "/outstanding-invoices";
            } else if (query.toLowerCase().includes("ratio")) {
              endpoint = "/financial-ratios";
            } else {
              // Default to trial balance for general queries
              endpoint = "/trial-balance";
            }

            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(params),
            });

            if (!response.ok) {
              throw new Error(`API Error: ${response.status}`);
            }

            const data = await response.json();
            return formatFinancialData(data, endpoint);
          } catch (error) {
            return `Sorry, I couldn't retrieve that information right now. Error: ${error.message}`;
          }
        };

        // Format the API response for display
        const formatFinancialData = (data, endpoint) => {
          if (endpoint === "/trial-balance") {
            const tb = data.trialBalance;
            const totals = tb.totals;
            const balanced = data.balanceCheck.debitsEqualCredits
              ? "BALANCED"
              : "OUT OF BALANCE";

            return `**Trial Balance Summary**
Organization: ${data.tenantName}
Report Date: ${data.reportDate}

**Balance Status: ${balanced}**
Total Assets: $${totals.totalAssets.toLocaleString()}
Total Liabilities: $${totals.totalLiabilities.toLocaleString()}
Total Equity: $${totals.totalEquity.toLocaleString()}

Asset Accounts: ${tb.assets.length}
Liability Accounts: ${tb.liabilities.length}
Equity Accounts: ${tb.equity.length}`;
          } else if (endpoint === "/cash-position") {
            return `**Cash Position**
Total Cash: $${data.totalCash.toLocaleString()}
Bank Accounts: ${data.bankAccounts.length}

**Bank Account Details:**
${data.bankAccounts
  .map((acc) => `• ${acc.name}: $${acc.balance.toLocaleString()}`)
  .join("\n")}`;
          } else if (endpoint === "/profit-loss-summary") {
            const summary = data.summary;
            const margin = (
              (summary.netProfit / summary.totalRevenue) *
              100
            ).toFixed(1);

            return `**Profit & Loss Summary**
Period: ${data.period.from} to ${data.period.to}

Revenue: $${summary.totalRevenue.toLocaleString()}
Expenses: $${summary.totalExpenses.toLocaleString()}
Net Profit: $${summary.netProfit.toLocaleString()}
Profit Margin: ${margin}%

**Top Revenue Sources:**
${summary.revenueAccounts
  .slice(0, 3)
  .map((acc) => `• ${acc.name}: $${acc.amount.toLocaleString()}`)
  .join("\n")}`;
          } else if (endpoint === "/outstanding-invoices") {
            if (data.length === 0) {
              return "No outstanding invoices found.";
            }

            const total = data.reduce((sum, inv) => sum + inv.amountDue, 0);
            return `**Outstanding Invoices**
Total Outstanding: $${total.toLocaleString()}
Number of Invoices: ${data.length}

**Recent Invoices:**
${data
  .slice(0, 5)
  .map(
    (inv) =>
      `• Invoice ${inv.invoiceNumber}: $${inv.amountDue.toLocaleString()} (${
        inv.contact
      })`
  )
  .join("\n")}`;
          } else if (endpoint === "/financial-ratios") {
            const ratios = data.ratios;
            return `**Financial Ratios Analysis**
Report Date: ${data.reportDate}

**Liquidity:**
Current Ratio: ${ratios.liquidity.currentRatio.toFixed(2)} (${
              data.interpretations.currentRatio
            })
Working Capital: $${ratios.liquidity.workingCapital.toLocaleString()}

**Profitability:**
Net Profit Margin: ${ratios.profitability.netProfitMargin.toFixed(1)}% (${
              data.interpretations.profitability
            })
Return on Assets: ${ratios.profitability.returnOnAssets.toFixed(1)}%`;
          }

          return "Data retrieved successfully";
        };

        const handleSendMessage = async () => {
          if (!inputMessage.trim()) return;

          const userMessage = {
            id: Date.now(),
            type: "user",
            content: inputMessage,
            timestamp: new Date(),
          };

          setMessages((prev) => [...prev, userMessage]);
          setIsLoading(true);
          setInputMessage("");

          // Process the query
          const response = await processFinancialQuery(
            inputMessage,
            selectedOrg
          );

          const assistantMessage = {
            id: Date.now() + 1,
            type: "assistant",
            content: response,
            timestamp: new Date(),
          };

          setMessages((prev) => [...prev, assistantMessage]);
          setIsLoading(false);
        };

        const handleQuickAction = (query) => {
          setInputMessage(query);
        };

        const handleKeyPress = (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            handleSendMessage();
          }
        };

        return (
          <div className="flex flex-col h-screen max-w-4xl mx-auto bg-white shadow-lg">
            {/* Header */}
            <div className="bg-blue-600 text-white p-4 flex justify-between items-center">
              <div>
                <h1 className="text-xl font-bold">RAC Financial Assistant</h1>
                <p className="text-blue-200 text-sm">
                  Xero Integration Dashboard
                </p>
              </div>
              <div className="flex items-center space-x-2">
                <select
                  value={selectedOrg}
                  onChange={(e) => setSelectedOrg(e.target.value)}
                  className="bg-blue-500 text-white p-2 rounded border border-blue-400 text-sm"
                >
                  {organizations.map((org) => (
                    <option key={org} value={org}>
                      {org.replace("Rirratjingu ", "")}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            {/* Quick Actions */}
            <div className="bg-gray-50 p-4 border-b">
              <p className="text-sm text-gray-600 mb-2">Quick Actions:</p>
              <div className="flex flex-wrap gap-2">
                {quickActions.map((action, index) => (
                  <button
                    key={index}
                    onClick={() => handleQuickAction(action.query)}
                    className="flex items-center space-x-1 bg-white hover:bg-blue-50 border border-gray-200 rounded-lg px-3 py-2 text-sm transition-colors"
                  >
                    <action.icon className="w-4 h-4 text-blue-600" />
                    <span>{action.label}</span>
                  </button>
                ))}
              </div>
            </div>

            {/* Messages */}
            <div className="flex-1 overflow-y-auto p-4 space-y-4">
              {messages.map((message) => (
                <div
                  key={message.id}
                  className={`flex ${
                    message.type === "user" ? "justify-end" : "justify-start"
                  }`}
                >
                  <div
                    className={`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                      message.type === "user"
                        ? "bg-blue-500 text-white"
                        : "bg-gray-100 text-gray-800"
                    }`}
                  >
                    <div className="whitespace-pre-wrap">{message.content}</div>
                    <div
                      className={`text-xs mt-1 ${
                        message.type === "user"
                          ? "text-blue-100"
                          : "text-gray-500"
                      }`}
                    >
                      {message.timestamp.toLocaleTimeString()}
                    </div>
                  </div>
                </div>
              ))}

              {isLoading && (
                <div className="flex justify-start">
                  <div className="bg-gray-100 text-gray-800 px-4 py-2 rounded-lg flex items-center space-x-2">
                    <Loader2 className="w-4 h-4 animate-spin" />
                    <span>Processing your request...</span>
                  </div>
                </div>
              )}
              <div ref={messagesEndRef} />
            </div>

            {/* Input */}
            <div className="border-t p-4">
              <div className="flex space-x-2">
                <input
                  type="text"
                  value={inputMessage}
                  onChange={(e) => setInputMessage(e.target.value)}
                  onKeyPress={handleKeyPress}
                  placeholder="Ask about financial data... (e.g., 'Show me the current cash position')"
                  className="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  disabled={isLoading}
                />
                <button
                  onClick={handleSendMessage}
                  disabled={isLoading || !inputMessage.trim()}
                  className="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white p-3 rounded-lg transition-colors"
                >
                  <Send className="w-5 h-5" />
                </button>
              </div>
            </div>
          </div>
        );
      };

      ReactDOM.render(<RACXeroChat />, document.getElementById("root"));
    </script>
  </body>
</html>
