<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RAC Live Financial Dashboard - Xero Integration</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        line-height: 1.6;
        color: #333;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      /* ====== LOGIN MANAGER STYLES ====== */
      .login-manager {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        display: none;
      }

      .login-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        text-align: center;
      }

      .login-header h1 {
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
      }

      .login-content {
        padding: 2rem;
      }

      .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
      }

      .step {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        background: #f8f9fa;
        color: #666;
        font-size: 0.9rem;
        margin: 0 0.5rem;
      }

      .step.active {
        background: #667eea;
        color: white;
      }

      .step.completed {
        background: #28a745;
        color: white;
      }

      .step-number {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
      }

      .company-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .company-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        transition: background-color 0.2s;
        cursor: pointer;
      }

      .company-item:hover {
        background-color: #f8f9fa;
      }

      .company-item.all-companies {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: bold;
        margin-bottom: 1rem;
      }

      .company-checkbox {
        width: 18px;
        height: 18px;
        margin-right: 1rem;
        cursor: pointer;
      }

      .company-name {
        flex: 1;
        font-size: 1rem;
      }

      .selection-summary {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
        text-align: center;
      }

      .continue-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 6px;
        font-size: 1rem;
        cursor: pointer;
        width: 100%;
        transition: background 0.2s;
      }

      .continue-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .oauth-flow {
        display: none;
        text-align: center;
      }

      .current-connection {
        background: #f8f9fa;
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
      }

      .oauth-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 6px;
        font-size: 1rem;
        cursor: pointer;
        margin: 0.5rem;
      }

      .oauth-btn.primary {
        background: #667eea;
      }

      .completion {
        display: none;
        text-align: center;
      }

      .launch-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 1.5rem 3rem;
        border-radius: 8px;
        font-size: 1.1rem;
        cursor: pointer;
        transition: background 0.2s;
        margin-top: 1rem;
      }

      /* ====== MAIN DASHBOARD STYLES ====== */
      .main-dashboard {
        display: none;
      }

      .header {
        position: relative;
        z-index: 1;
        text-align: center;
        color: white;
        margin-bottom: 40px;
        padding: 40px 0;
      }

      .header h1 {
        font-size: 3rem;
        margin-bottom: 10px;
        font-weight: 700;
      }

      .live-indicator {
        display: inline-flex;
        align-items: center;
        background: rgba(76, 175, 80, 0.2);
        padding: 8px 16px;
        border-radius: 20px;
        margin-top: 15px;
        font-size: 0.9rem;
      }

      .live-dot {
        width: 8px;
        height: 8px;
        background: #4caf50;
        border-radius: 50%;
        margin-right: 8px;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .controls {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .controls h3 {
        color: #13547a;
        margin-bottom: 15px;
      }

      .demo-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 40px;
      }

      .demo-card.financial-overview {
        grid-column: 1 / -1;
      }

      .demo-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: transform 0.3s ease;
      }

      .card-header {
        background: linear-gradient(45deg, #13547a 0%, #80d0c7 100%);
        color: white;
        padding: 20px;
        text-align: center;
      }

      .card-content {
        padding: 25px;
      }

      .dashboard-mockup {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin: 15px 0;
        border-left: 4px solid #13547a;
      }

      .metric-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
      }

      .metric-label {
        font-weight: 600;
        color: #666;
      }

      .metric-value {
        font-weight: bold;
        color: #13547a;
      }

      .metric-value.large {
        font-size: 1.2rem;
      }

      .success-box {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 8px;
        padding: 12px;
        margin: 10px 0;
        color: #155724;
      }

      .alert-box {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 12px;
        margin: 10px 0;
        color: #856404;
      }

      .error {
        color: #dc3545;
        font-style: italic;
        text-align: center;
        padding: 20px;
      }

      .loading {
        color: #666;
        font-style: italic;
        text-align: center;
        padding: 20px;
      }

      .progress-bar {
        background: #e0e0e0;
        border-radius: 10px;
        height: 8px;
        margin: 15px 0;
        overflow: hidden;
      }

      .progress-fill {
        background: linear-gradient(45deg, #4caf50, #8bc34a);
        height: 100%;
        transition: width 0.3s ease;
      }

      .toggle-btn {
        padding: 8px 16px;
        border: 2px solid #13547a;
        background: white;
        color: #13547a;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 0 5px;
      }

      .toggle-btn.active {
        background: #13547a;
        color: white;
      }

      .last-updated {
        font-size: 0.8rem;
        color: #888;
        text-align: center;
        margin-top: 15px;
        font-style: italic;
      }

      /* Main container modifications */
      .main-container {
        display: flex;
        height: 100vh;
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .dashboard-area {
        flex: 1;
        overflow-y: auto;
        transition: margin-right 0.3s ease;
      }

      .dashboard-area.with-chat {
        margin-right: 400px;
      }

      /* AI Chat Side Panel */
      .ai-chat-panel {
        position: fixed;
        right: calc(
          (100vw - 1400px) / 2
        ); /* This positions it next to your max-width container */
        top: 0;
        bottom: 0;
        width: 400px;
        background: white;
        border-left: 1px solid #ddd;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        transform: translateX(100%);
        transition: transform 0.3s ease;
        z-index: 1000;
        display: flex;
        flex-direction: column;
      }

      .ai-chat-panel.open {
        transform: translateX(0);
      }

      .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .chat-header h3 {
        font-size: 1.2rem;
        margin: 0;
        flex: 1;
      }

      .close-chat-btn {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 5px 10px;
        border-radius: 4px;
        transition: background 0.2s;
      }

      .close-chat-btn:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .organization-selector {
        padding: 15px;
        background: #f8f9fa;
        border-bottom: 1px solid #ddd;
      }

      .organization-selector select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        background: white;
        font-size: 0.9rem;
      }

      .quick-actions {
        padding: 15px;
        background: #f8f9fa;
        border-bottom: 1px solid #ddd;
      }

      .quick-actions-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .quick-action-btn {
        padding: 8px 12px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        text-align: center;
        transition: all 0.2s;
      }

      .quick-action-btn:hover {
        background: #667eea;
        color: white;
        border-color: #667eea;
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .message {
        max-width: 85%;
        padding: 12px 16px;
        border-radius: 12px;
        word-wrap: break-word;
      }

      .message.user {
        align-self: flex-end;
        background: #667eea;
        color: white;
        border-bottom-right-radius: 4px;
      }

      .message.assistant {
        align-self: flex-start;
        background: #f1f3f4;
        color: #333;
        border-bottom-left-radius: 4px;
      }

      .message-time {
        font-size: 0.7rem;
        opacity: 0.7;
        margin-top: 4px;
      }

      .typing-indicator {
        align-self: flex-start;
        background: #f1f3f4;
        color: #666;
        padding: 12px 16px;
        border-radius: 12px;
        border-bottom-left-radius: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .typing-dots {
        display: flex;
        gap: 4px;
      }

      .typing-dots span {
        width: 6px;
        height: 6px;
        background: #666;
        border-radius: 50%;
        animation: typing 1.4s infinite;
      }

      .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        60%,
        100% {
          transform: translateY(0);
          opacity: 0.4;
        }
        30% {
          transform: translateY(-10px);
          opacity: 1;
        }
      }

      .chat-input-area {
        padding: 20px;
        border-top: 1px solid #ddd;
        background: white;
      }

      .chat-input-container {
        display: flex;
        gap: 10px;
        align-items: flex-end;
      }

      .chat-input {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid #ddd;
        border-radius: 20px;
        resize: none;
        font-family: inherit;
        font-size: 0.9rem;
        max-height: 100px;
        min-height: 44px;
      }

      .chat-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
      }

      .send-btn {
        background: #667eea;
        color: white;
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
      }

      .send-btn:hover:not(:disabled) {
        background: #5a67d8;
      }

      .send-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .chat-toggle-btn {
        position: fixed;
        right: 20px;
        bottom: 20px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
        z-index: 999;
      }

      .chat-toggle-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
      }

      .financial-data {
        font-family: "Courier New", monospace;
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        border-left: 4px solid #667eea;
        margin: 8px 0;
        font-size: 0.85rem;
        line-height: 1.4;
      }

      .financial-data h4 {
        color: #667eea;
        margin-bottom: 8px;
        font-family: inherit;
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      <!-- Main Dashboard Area -->
      <div class="dashboard-area" id="dashboardArea">
        <div class="container">
          <!-- ====== MULTI-COMPANY LOGIN MANAGER ====== -->
          <div class="login-manager" id="loginManager">
            <div class="login-header">
              <h1>RAC Multi-Company Login Manager</h1>
              <p>Streamlined access to your Xero organisations</p>
            </div>

            <div class="login-content">
              <!-- Step Indicator -->
              <div class="step-indicator">
                <div class="step active" id="step1Indicator">
                  <div class="step-number">1</div>
                  <span>Select Companies</span>
                </div>
                <div class="step" id="step2Indicator">
                  <div class="step-number">2</div>
                  <span>OAuth Authentication</span>
                </div>
                <div class="step" id="step3Indicator">
                  <div class="step-number">3</div>
                  <span>Launch Dashboard</span>
                </div>
              </div>

              <!-- Step 1: Company Selection -->
              <div class="company-selection" id="step1">
                <h2>Select Companies to Connect</h2>

                <div class="company-list">
                  <!-- ALL Companies Option -->
                  <div
                    class="company-item all-companies"
                    onclick="toggleAllCompanies(event)"
                  >
                    <input
                      type="checkbox"
                      class="company-checkbox"
                      id="all-companies"
                    />
                    <div class="company-name">
                      🚀 ALL COMPANIES (Quick Connect)
                    </div>
                  </div>

                  <!-- Individual Companies -->
                  <div
                    class="company-item"
                    onclick="toggleCompany('rac', event)"
                  >
                    <input
                      type="checkbox"
                      class="company-checkbox"
                      id="company-rac"
                    />
                    <div class="company-name">
                      Rirratjingu Aboriginal Corporation 8538
                    </div>
                  </div>

                  <div
                    class="company-item"
                    onclick="toggleCompany('mining', event)"
                  >
                    <input
                      type="checkbox"
                      class="company-checkbox"
                      id="company-mining"
                    />
                    <div class="company-name">
                      Rirratjingu Mining Pty Ltd 7168
                    </div>
                  </div>

                  <div
                    class="company-item"
                    onclick="toggleCompany('property', event)"
                  >
                    <input
                      type="checkbox"
                      class="company-checkbox"
                      id="company-property"
                    />
                    <div class="company-name">
                      Rirratjingu Property Management & Maintenance Services Pty
                      Ltd
                    </div>
                  </div>

                  <div
                    class="company-item"
                    onclick="toggleCompany('enterprises', event)"
                  >
                    <input
                      type="checkbox"
                      class="company-checkbox"
                      id="company-enterprises"
                    />
                    <div class="company-name">
                      Rirratjingu Enterprises Pty Ltd
                    </div>
                  </div>

                  <div
                    class="company-item"
                    onclick="toggleCompany('invest', event)"
                  >
                    <input
                      type="checkbox"
                      class="company-checkbox"
                      id="company-invest"
                    />
                    <div class="company-name">
                      Rirratjingu Invest P/ L ATF Miliditjpi Trust
                    </div>
                  </div>

                  <div
                    class="company-item"
                    onclick="toggleCompany('ngarrkuwuy', event)"
                  >
                    <input
                      type="checkbox"
                      class="company-checkbox"
                      id="company-ngarrkuwuy"
                    />
                    <div class="company-name">
                      Ngarrkuwuy Developments Pty Ltd
                    </div>
                  </div>

                  <div
                    class="company-item"
                    onclick="toggleCompany('marrin', event)"
                  >
                    <input
                      type="checkbox"
                      class="company-checkbox"
                      id="company-marrin"
                    />
                    <div class="company-name">
                      Marrin Square Developments Pty Ltd
                    </div>
                  </div>
                </div>

                <div class="selection-summary" id="selectionSummary">
                  <strong>Selected: 0 companies</strong>
                </div>

                <button
                  class="continue-btn"
                  id="continueBtn"
                  onclick="startOAuthFlow()"
                  disabled
                >
                  Continue with Selected Companies
                </button>
              </div>

              <!-- Step 2: OAuth Flow -->
              <div class="oauth-flow" id="step2">
                <h2>Connecting to Your Companies</h2>

                <div class="current-connection">
                  <h3 id="currentCompanyName">Ready to connect...</h3>
                  <div class="progress-bar">
                    <div
                      class="progress-fill"
                      id="progressFill"
                      style="width: 0%"
                    ></div>
                  </div>
                  <div id="progressText">Preparing connections...</div>
                </div>

                <div class="success-box" id="oauthInstructions">
                  <strong>Ready to start:</strong> Click "Start OAuth Flow" to
                  begin connecting to your selected companies.
                </div>

                <div id="oauthButtons">
                  <button
                    class="oauth-btn primary"
                    onclick="startNextOAuth()"
                    id="startOAuthBtn"
                  >
                    🔗 Start OAuth Flow
                  </button>
                </div>

                <div id="waitingMessage" style="display: none">
                  <div class="success-box">
                    <strong>Waiting for OAuth completion...</strong><br />
                    Complete the Xero authorization, then return here.
                  </div>
                  <button class="oauth-btn" onclick="checkOAuthStatus()">
                    ✅ I've completed the OAuth - Continue
                  </button>
                </div>
              </div>

              <!-- Step 3: Completion -->
              <div class="completion" id="step3">
                <h2>🎉 All Companies Connected!</h2>
                <div
                  class="connected-companies"
                  id="connectedCompaniesList"
                ></div>
                <div class="success-box">
                  <strong>Ready to launch!</strong> All selected companies are
                  now connected.
                </div>
                <button class="launch-btn" onclick="showMainDashboard()">
                  🚀 Launch Financial Dashboard
                </button>
              </div>
            </div>
          </div>

          <!-- ====== MAIN DASHBOARD ====== -->
          <div class="main-dashboard" id="mainDashboard">
            <div class="header">
              <h1>🏢 RAC Financial Dashboard</h1>
              <p>Real-Time Xero Integration - Live Data</p>
              <div class="live-indicator">
                <div class="live-dot"></div>
                Connected to Xero • Live Data
              </div>
              <button
                onclick="backgroundRefreshAllCompanies(event)"
                style="
                  margin-top: 10px;
                  padding: 8px 16px;
                  background: #007bff;
                  color: white;
                  border: none;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 0.9rem;
                "
              >
                🔄 Refresh Tokens
              </button>
              <button
                onclick="backToLoginManager()"
                style="
                  margin-top: 10px;
                  margin-left: 10px;
                  padding: 8px 16px;
                  background: #6c757d;
                  color: white;
                  border: none;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 0.9rem;
                "
              >
                🔙 Back to Login Manager
              </button>
              <button
                id="refresh-toggle-btn"
                onclick="toggleRefreshPanel()"
                style="
                  margin-top: 10px;
                  margin-left: 10px;
                  padding: 8px 16px;
                  background: #28a745;
                  color: white;
                  border: none;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 0.9rem;
                "
              >
                👁️ Show Refresh Status
              </button>
              <div id="token-status-display"></div>
            </div>
            <!-- Refresh Status Panel (Initially Hidden) -->
            <div
              id="refresh-status-panel"
              style="
                position: fixed;
                top: 60px;
                right: 10px;
                width: 350px;
                height: 300px;
                background: white;
                border: 1px solid #ccc;
                border-radius: 8px;
                z-index: 9999;
                display: none;
                overflow: auto;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
              "
            >
              <div style="padding: 15px">
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 10px;
                  "
                >
                  <h4 style="margin: 0; color: #333">OAuth Refresh Monitor</h4>
                  <button
                    onclick="toggleRefreshPanel()"
                    style="
                      background: none;
                      border: none;
                      font-size: 1.2rem;
                      cursor: pointer;
                    "
                  >
                    ×
                  </button>
                </div>
                <div
                  id="refresh-log"
                  style="
                    background: #f8f9fa;
                    padding: 10px;
                    border-radius: 4px;
                    font-family: monospace;
                    font-size: 0.8rem;
                    height: 120px;
                    overflow-y: auto;
                    border: 1px solid #eee;
                  "
                >
                  Ready to refresh OAuth connections...
                </div>
                <iframe
                  id="oauth-iframe"
                  style="
                    width: 100%;
                    height: 120px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    margin-top: 10px;
                  "
                ></iframe>
              </div>
            </div>
            <!-- Dashboard Controls -->
            <div class="controls" id="dashboard-controls">
              <h3>📊 Trial Balance Controls</h3>
              <div
                style="
                  display: flex;
                  gap: 20px;
                  align-items: center;
                  flex-wrap: wrap;
                "
              >
                <div style="display: flex; align-items: center; gap: 10px">
                  <label
                    for="report-date"
                    style="font-weight: bold; color: #13547a"
                    >📅 Report Date:</label
                  >
                  <input
                    type="date"
                    id="report-date"
                    onchange="updateReportDate(this.value)"
                    style="
                      padding: 8px 12px;
                      border: 2px solid #13547a;
                      border-radius: 6px;
                      font-size: 1rem;
                      background: white;
                      color: #333;
                      cursor: pointer;
                    "
                  />
                </div>
                <div style="display: flex; gap: 8px; align-items: center">
                  <span style="font-size: 0.9rem; color: #666">Quick:</span>
                  <button
                    onclick="setQuickDate('today')"
                    style="
                      padding: 6px 12px;
                      border: 1px solid #ccc;
                      background: white;
                      border-radius: 4px;
                      font-size: 0.85rem;
                      cursor: pointer;
                    "
                  >
                    Today
                  </button>
                  <button
                    onclick="setQuickDate('monthEnd')"
                    style="
                      padding: 6px 12px;
                      border: 1px solid #ccc;
                      background: white;
                      border-radius: 4px;
                      font-size: 0.85rem;
                      cursor: pointer;
                    "
                  >
                    Month End
                  </button>
                </div>
                <div
                  class="toggle-btn active"
                  onclick="setView('overview', event)"
                >
                  Overview
                </div>
                <div class="toggle-btn" onclick="setView('detailed', event)">
                  Detailed
                </div>
                <button
                  onclick="openAIChat()"
                  style="
                    background: #28a745;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 6px;
                    cursor: pointer;
                    margin-left: 10px;
                  "
                >
                  Open AI Assistant
                </button>
              </div>
              <div
                style="
                  margin-top: 15px;
                  padding: 10px;
                  background: #f8f9fa;
                  border-radius: 6px;
                  border-left: 4px solid #13547a;
                "
              >
                <div style="font-size: 0.9rem; color: #666">
                  <span style="font-weight: bold">Viewing:</span>
                  Trial Balance as at
                  <span
                    style="font-weight: bold; color: #13547a"
                    id="display-date"
                  ></span>
                </div>
              </div>
            </div>

            <div class="demo-grid" id="dashboard-content">
              <div class="loading">Loading live RAC financial data...</div>
            </div>

            <div class="last-updated">
              Last updated: <span id="timestamp"></span> • Data sources: Live
              RAC Xero Accounts
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- AI Chat Side Panel -->
    <div class="ai-chat-panel" id="aiChatPanel">
      <div class="chat-header">
        <h3>RAC AI Assistant</h3>
        <button class="close-chat-btn" onclick="closeAIChat()">×</button>
      </div>

      <div class="organization-selector">
        <select id="orgSelector" onchange="updateSelectedOrg()">
          <option value="Rirratjingu Aboriginal Corporation 8538">
            RAC Aboriginal Corporation
          </option>
          <option value="Rirratjingu Mining Pty Ltd 7168">RAC Mining</option>
          <option value="Rirratjingu Enterprises Pty Ltd">
            RAC Enterprises
          </option>
          <option
            value="Rirratjingu Property Management & Maintenance Services Pty Ltd"
          >
            RAC Property
          </option>
          <option value="Rirratjingu Invest P/ L ATF Miliditjpi Trust">
            RAC Invest Trust
          </option>
          <option value="Ngarrkuwuy Developments Pty Ltd">
            Ngarrkuwuy Developments
          </option>
          <option value="Marrin Square Developments Pty Ltd">
            Marrin Square
          </option>
        </select>
      </div>

      <div class="quick-actions">
        <div class="quick-actions-grid">
          <div class="quick-action-btn" onclick="quickAction('trial balance')">
            Trial Balance
          </div>
          <div class="quick-action-btn" onclick="quickAction('cash position')">
            Cash Position
          </div>
          <div
            class="quick-action-btn"
            onclick="quickAction('outstanding invoices')"
          >
            Outstanding Invoices
          </div>
          <div
            class="quick-action-btn"
            onclick="quickAction('financial ratios')"
          >
            Financial Ratios
          </div>
          <div
            class="quick-action-btn"
            onclick="quickAction('equity movements')"
          >
            Equity Analysis
          </div>
          <div class="quick-action-btn" onclick="quickAction('profit loss')">
            P&L Summary
          </div>
        </div>
      </div>

      <div class="chat-messages" id="chatMessages">
        <div class="message assistant">
          <div>
            Hello! I'm your RAC Financial AI Assistant. I can help you analyze
            data from your Xero accounts using 23+ specialized tools.
          </div>
          <div class="message-time" id="welcomeTime"></div>
        </div>
      </div>

      <div class="chat-input-area">
        <div class="chat-input-container">
          <textarea
            id="chatInput"
            class="chat-input"
            placeholder="Ask me about trial balance, cash position, ratios, or any financial analysis..."
            rows="1"
            onkeypress="handleChatKeyPress(event)"
            oninput="autoResize(this)"
          ></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()">
            <span>➤</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Chat Toggle Button -->
    <button class="chat-toggle-btn" id="chatToggleBtn" onclick="toggleAIChat()">
      AI
    </button>

    <script>
      console.log("=== PAGE LOAD DEBUG ===");
      console.log("Current URL:", window.location.href);
      console.log(
        "URL params:",
        new URLSearchParams(window.location.search).toString()
      );
      console.log("Refresh mode:", localStorage.getItem("oauthRefreshMode"));
      console.log("OAuth companies:", localStorage.getItem("oauthCompanies"));

      // Track what's visible
      setTimeout(() => {
        console.log(
          "Login manager display:",
          document.getElementById("loginManager")?.style.display
        );
        console.log(
          "Main dashboard display:",
          document.getElementById("mainDashboard")?.style.display
        );
        console.log(
          "Login manager exists:",
          !!document.getElementById("loginManager")
        );
        console.log(
          "Main dashboard exists:",
          !!document.getElementById("mainDashboard")
        );
      }, 100);

      // ====== GLOBAL VARIABLES ======
      let currentView = "overview";
      let dashboardData = {};
      let selectedReportDate = new Date().toISOString().split("T")[0];
      let tokenStatusInterval;
      // Chat-related global variables
      let selectedOrganization = "Rirratjingu Aboriginal Corporation 8538";
      let isChatOpen = false;
      let isLoading = false;

      // Chat toggle functions
      function openAIChat() {
        const chatPanel = document.getElementById("aiChatPanel");
        const dashboardArea = document.getElementById("dashboardArea");
        const chatToggleBtn = document.getElementById("chatToggleBtn");
        const chatInput = document.getElementById("chatInput");

        if (!chatPanel || !dashboardArea) {
          console.error("Chat elements not found in DOM");
          return;
        }

        isChatOpen = true;
        chatPanel.classList.add("open");
        dashboardArea.classList.add("with-chat");
        if (chatToggleBtn) chatToggleBtn.style.display = "none";
        if (chatInput) chatInput.focus();
      }

      function closeAIChat() {
        isChatOpen = false;
        document.getElementById("aiChatPanel").classList.remove("open");
        document.getElementById("dashboardArea").classList.remove("with-chat");
        document.getElementById("chatToggleBtn").style.display = "block";
      }

      function toggleAIChat() {
        if (isChatOpen) {
          closeAIChat();
        } else {
          openAIChat();
        }
      }

      // Organization selector
      function updateSelectedOrg() {
        selectedOrganization = document.getElementById("orgSelector").value;
        addMessage(
          "assistant",
          `Switched to analyzing data for: ${selectedOrganization.replace(
            "Rirratjingu ",
            "RAC "
          )}`
        );
      }

      // Quick actions
      function quickAction(query) {
        document.getElementById(
          "chatInput"
        ).value = `Show me the ${query} for ${selectedOrganization}`;
        sendMessage();
      }

      // Auto-resize textarea
      function autoResize(textarea) {
        textarea.style.height = "auto";
        textarea.style.height = Math.min(textarea.scrollHeight, 100) + "px";
      }

      // Handle Enter key
      function handleChatKeyPress(event) {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendMessage();
        }
      }

      // Send message
      async function sendMessage() {
        const input = document.getElementById("chatInput");
        const message = input.value.trim();

        if (!message || isLoading) return;

        addMessage("user", message);
        input.value = "";
        input.style.height = "auto";

        showTypingIndicator();
        isLoading = true;
        updateSendButton();

        try {
          const response = await processFinancialQuery(
            message,
            selectedOrganization
          );
          removeTypingIndicator();
          addMessage("assistant", response);
        } catch (error) {
          removeTypingIndicator();
          addMessage(
            "assistant",
            `Sorry, I encountered an error: ${error.message}`,
            "error"
          );
        }

        isLoading = false;
        updateSendButton();
      }

      // Add message to chat
      function addMessage(type, content, messageType = "normal") {
        const messagesContainer = document.getElementById("chatMessages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}`;

        let formattedContent = content;

        if (
          type === "assistant" &&
          messageType !== "error" &&
          content.includes("$")
        ) {
          formattedContent = `<div class="financial-data">${formatFinancialResponse(
            content
          )}</div>`;
        } else if (messageType === "error") {
          formattedContent = `<div class="error-box">${content}</div>`;
        }

        messageDiv.innerHTML = `
    <div>${formattedContent}</div>
    <div class="message-time">${new Date().toLocaleTimeString()}</div>
  `;

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // Typing indicator functions
      function showTypingIndicator() {
        const messagesContainer = document.getElementById("chatMessages");
        const typingDiv = document.createElement("div");
        typingDiv.className = "typing-indicator";
        typingDiv.id = "typingIndicator";
        typingDiv.innerHTML = `
    <div class="typing-dots">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <span>Analyzing financial data...</span>
  `;
        messagesContainer.appendChild(typingDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function removeTypingIndicator() {
        const typingIndicator = document.getElementById("typingIndicator");
        if (typingIndicator) {
          typingIndicator.remove();
        }
      }

      function updateSendButton() {
        const sendBtn = document.getElementById("sendBtn");
        sendBtn.disabled = isLoading;
        sendBtn.innerHTML = isLoading ? "<span>⟳</span>" : "<span>➤</span>";
      }

      function formatFinancialResponse(content) {
        return content
          .replace(/\*\*(.*?)\*\*/g, "<h4>$1</h4>")
          .replace(/\n/g, "<br>")
          .replace(/(\$[\d,]+)/g, "<strong>$1</strong>");
      }

      // Temporary placeholder for MCP integration (we'll replace this in the next step)
      async function processFinancialQuery(query, organization) {
        // Simulate API delay
        await new Promise((resolve) => setTimeout(resolve, 1500));

        return `**Mock Response for ${organization.replace(
          "Rirratjingu ",
          "RAC "
        )}**
  
Query: "${query}"

This is a placeholder response. In the next step, we'll connect this to your actual MCP server endpoints to get real financial data.

Available tools: Trial Balance, Cash Position, Outstanding Invoices, Financial Ratios, and 19 more analysis functions.`;
      }

      // Multi-Company Login Manager Variables
      const companies = {
        rac: "Rirratjingu Aboriginal Corporation 8538",
        mining: "Rirratjingu Mining Pty Ltd 7168",
        property:
          "Rirratjingu Property Management & Maintenance Services Pty Ltd",
        enterprises: "Rirratjingu Enterprises Pty Ltd",
        invest: "Rirratjingu Invest P/ L ATF Miliditjpi Trust",
        ngarrkuwuy: "Ngarrkuwuy Developments Pty Ltd",
        marrin: "Marrin Square Developments Pty Ltd",
      };

      let selectedCompanies = [];
      let oauthProgress = 0;
      let connectedCompanies = [];
      let isOAuthInProgress = false;

      // ====== LOGIN MANAGER FUNCTIONS ======
      function loadSavedPreferences() {
        const saved = localStorage.getItem("racCompanyPreferences");
        const refreshMode = localStorage.getItem("oauthRefreshMode");

        if (refreshMode === "true") {
          console.log("🔄 Detected OAuth refresh mode");

          // Auto-select saved companies
          if (saved) {
            try {
              selectedCompanies = JSON.parse(saved);
              selectedCompanies.forEach((companyId) => {
                const checkbox = document.getElementById(
                  `company-${companyId}`
                );
                if (checkbox) checkbox.checked = true;
              });
              updateSelectionSummary();

              // Auto-start the OAuth flow
              console.log("🚀 Auto-starting OAuth refresh...");
              setTimeout(() => {
                startOAuthFlow();
              }, 1000);
            } catch (error) {
              console.log("Error in refresh mode:", error);
            }
          }
        } else if (saved) {
          // Normal load mode
          try {
            selectedCompanies = JSON.parse(saved);
            selectedCompanies.forEach((companyId) => {
              const checkbox = document.getElementById(`company-${companyId}`);
              if (checkbox) checkbox.checked = true;
            });
            updateSelectionSummary();
          } catch (error) {
            console.log("No valid saved preferences");
          }
        }
      }

      function savePreferences() {
        localStorage.setItem(
          "racCompanyPreferences",
          JSON.stringify(selectedCompanies)
        );
      }

      function toggleCompany(companyId, event) {
        event.stopPropagation();
        const checkbox = document.getElementById(`company-${companyId}`);
        checkbox.checked = !checkbox.checked;

        if (checkbox.checked) {
          if (!selectedCompanies.includes(companyId)) {
            selectedCompanies.push(companyId);
          }
        } else {
          selectedCompanies = selectedCompanies.filter(
            (id) => id !== companyId
          );
          document.getElementById("all-companies").checked = false;
        }

        updateSelectionSummary();
        savePreferences();
      }

      function toggleAllCompanies(event) {
        event.stopPropagation();
        const allCheckbox = document.getElementById("all-companies");
        allCheckbox.checked = !allCheckbox.checked;

        if (allCheckbox.checked) {
          selectedCompanies = Object.keys(companies);
          Object.keys(companies).forEach((companyId) => {
            document.getElementById(`company-${companyId}`).checked = true;
          });
        } else {
          selectedCompanies = [];
          Object.keys(companies).forEach((companyId) => {
            document.getElementById(`company-${companyId}`).checked = false;
          });
        }

        updateSelectionSummary();
        savePreferences();
      }

      function updateSelectionSummary() {
        const summary = document.getElementById("selectionSummary");
        const continueBtn = document.getElementById("continueBtn");

        summary.innerHTML = `<strong>Selected: ${selectedCompanies.length} companies</strong>`;

        if (selectedCompanies.length > 0) {
          const companyNames = selectedCompanies.map((id) => companies[id]);
          summary.innerHTML += `<br><small>${companyNames.join(", ")}</small>`;
          continueBtn.disabled = false;
        } else {
          continueBtn.disabled = true;
        }
      }

      function startOAuthFlow() {
        if (selectedCompanies.length === 0) {
          alert("Please select at least one company to continue.");
          return;
        }

        document.getElementById("step1").style.display = "none";
        document.getElementById("step2").style.display = "block";
        document.getElementById("step1Indicator").classList.add("completed");
        document.getElementById("step1Indicator").classList.remove("active");
        document.getElementById("step2Indicator").classList.add("active");

        oauthProgress = 0;
        connectedCompanies = [];
        localStorage.setItem(
          "oauthCompanies",
          JSON.stringify(selectedCompanies)
        );
        localStorage.setItem("oauthProgress", "0");
        updateOAuthProgress();
      }

      function updateOAuthProgress() {
        const currentCompanyName =
          document.getElementById("currentCompanyName");
        const progressFill = document.getElementById("progressFill");
        const progressText = document.getElementById("progressText");

        if (oauthProgress < selectedCompanies.length) {
          const companyId = selectedCompanies[oauthProgress];
          const companyName = companies[companyId];

          currentCompanyName.textContent = `Ready to connect: ${companyName} (${
            oauthProgress + 1
          }/${selectedCompanies.length})`;
          const progressPercent =
            (oauthProgress / selectedCompanies.length) * 100;
          progressFill.style.width = progressPercent + "%";
          progressText.textContent = `Step ${oauthProgress + 1} of ${
            selectedCompanies.length
          }`;

          document.getElementById("oauthInstructions").innerHTML = `
                    <strong>Next Company:</strong> ${companyName}<br>
                    <small>When the Xero login opens, select "${companyName}" from the dropdown and authorize access.</small>
                `;
        }
      }

      function startNextOAuth() {
        if (oauthProgress >= selectedCompanies.length) {
          showCompletion();
          return;
        }

        const companyId = selectedCompanies[oauthProgress];
        const companyName = companies[companyId];

        localStorage.setItem("currentOAuthCompany", companyId);
        localStorage.setItem("currentOAuthCompanyName", companyName);

        isOAuthInProgress = true;
        document.getElementById("startOAuthBtn").style.display = "none";
        document.getElementById("waitingMessage").style.display = "block";

        window.location.href = "/auth";
      }

      async function checkOAuthStatus() {
        try {
          const response = await fetch("/api/connection-status");
          const connections = await response.json();

          const currentCompanyName = localStorage.getItem(
            "currentOAuthCompanyName"
          );
          const currentCompanyId = localStorage.getItem("currentOAuthCompany");

          const newConnection = connections.find(
            (conn) => conn.tenantName === currentCompanyName && conn.connected
          );

          if (newConnection) {
            connectedCompanies.push({
              id: currentCompanyId,
              name: currentCompanyName,
              tenantId: newConnection.tenantId,
            });

            oauthProgress++;
            localStorage.setItem("oauthProgress", oauthProgress.toString());

            isOAuthInProgress = false;
            document.getElementById("startOAuthBtn").style.display =
              "inline-block";
            document.getElementById("waitingMessage").style.display = "none";

            if (oauthProgress < selectedCompanies.length) {
              updateOAuthProgress();
              document.getElementById(
                "startOAuthBtn"
              ).textContent = `🔗 Connect Next Company (${oauthProgress + 1}/${
                selectedCompanies.length
              })`;
            } else {
              showCompletion();
            }
          } else {
            alert(
              `❌ Failed to connect ${currentCompanyName}. Please try again.`
            );
            isOAuthInProgress = false;
            document.getElementById("startOAuthBtn").style.display =
              "inline-block";
            document.getElementById("waitingMessage").style.display = "none";
          }
        } catch (error) {
          console.error("❌ Error checking OAuth status:", error);
          alert("❌ Error checking connection status. Please try again.");
          isOAuthInProgress = false;
          document.getElementById("startOAuthBtn").style.display =
            "inline-block";
          document.getElementById("waitingMessage").style.display = "none";
        }
      }

      function showCompletion() {
        document.getElementById("step2").style.display = "none";
        document.getElementById("step3").style.display = "block";
        document.getElementById("step2Indicator").classList.add("completed");
        document.getElementById("step2Indicator").classList.remove("active");
        document.getElementById("step3Indicator").classList.add("active");

        const connectedList = document.getElementById("connectedCompaniesList");
        connectedList.innerHTML = connectedCompanies
          .map(
            (company) => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border: 1px solid #28a745; background: #f8fff9; border-radius: 6px; margin-bottom: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 12px; height: 12px; border-radius: 50%; background: #28a745;"></div>
                        <strong>${company.name}</strong>
                    </div>
                    <div style="color: #28a745; font-size: 0.9rem;">✅ Connected</div>
                </div>
            `
          )
          .join("");

        // Auto-launch after 3 seconds
        setTimeout(() => showMainDashboard(), 3000);
      }

      function showMainDashboard() {
        // Check if this is completing an OAuth refresh
        const refreshMode = localStorage.getItem("oauthRefreshMode");
        if (refreshMode === "true") {
          console.log("✅ OAuth refresh completed, cleaning up...");

          // Clear refresh mode flags
          localStorage.removeItem("oauthRefreshMode");
          localStorage.removeItem("oauthProgress");

          // Show success message
          showTokenRefreshStatus("🎉 All connections refreshed successfully!");
          console.log("🎉 OAuth refresh cycle completed!");
        }

        localStorage.removeItem("oauthCompanies");
        localStorage.removeItem("oauthProgress");
        localStorage.removeItem("currentOAuthCompany");
        localStorage.removeItem("currentOAuthCompanyName");
        localStorage.setItem("racCompaniesConnected", "true");

        document.getElementById("loginManager").style.display = "none";
        document.getElementById("mainDashboard").style.display = "block";

        initializeMainDashboard();
      }

      function backToLoginManager() {
        if (
          confirm(
            "Return to login manager? This will clear your current session."
          )
        ) {
          localStorage.removeItem("racCompaniesConnected");
          document.getElementById("mainDashboard").style.display = "none";
          document.getElementById("loginManager").style.display = "block";
          resetLoginManager();
        }
      }

      function resetLoginManager() {
        selectedCompanies = [];
        oauthProgress = 0;
        connectedCompanies = [];
        isOAuthInProgress = false;

        document.getElementById("step1").style.display = "block";
        document.getElementById("step2").style.display = "none";
        document.getElementById("step3").style.display = "none";

        document.getElementById("step1Indicator").className = "step active";
        document.getElementById("step2Indicator").className = "step";
        document.getElementById("step3Indicator").className = "step";

        document
          .querySelectorAll(".company-checkbox")
          .forEach((cb) => (cb.checked = false));
        updateSelectionSummary();
        loadSavedPreferences();
      }

      function handleOAuthReturn() {
        const urlParams = new URLSearchParams(window.location.search);
        const isSuccess = urlParams.has("success");
        const isError = urlParams.has("error");
        const oauthCompanies = localStorage.getItem("oauthCompanies");

        if (isSuccess && oauthCompanies) {
          selectedCompanies = JSON.parse(oauthCompanies);
          oauthProgress = parseInt(localStorage.getItem("oauthProgress")) || 0;

          document.getElementById("loginManager").style.display = "block";
          document.getElementById("mainDashboard").style.display = "none";
          document.getElementById("step1").style.display = "none";
          document.getElementById("step2").style.display = "block";
          document.getElementById("step1Indicator").classList.add("completed");
          document.getElementById("step2Indicator").classList.add("active");

          setTimeout(() => checkOAuthStatus(), 1000);
        }

        if (isSuccess || isError) {
          history.replaceState({}, document.title, window.location.pathname);
        }
      }

      // ====== MAIN DASHBOARD FUNCTIONS ======
      function initializeMainDashboard() {
        document.getElementById("report-date").value = selectedReportDate;
        document.getElementById("display-date").textContent =
          formatDisplayDate(selectedReportDate);
        loadTrialBalanceData();
        startTokenMonitoring();
        updateTimestamp();
        setInterval(updateTimestamp, 30000);

        // Add this line:
        document.getElementById("welcomeTime").textContent =
          new Date().toLocaleTimeString();
      }

      async function loadTrialBalanceData() {
        try {
          const response = await fetch(
            `/api/consolidated-trial-balance?date=${selectedReportDate}`
          );
          const data = await response.json();
          dashboardData = data;
          renderTrialBalanceView(data);
        } catch (error) {
          console.error("Error loading trial balance:", error);
          showError("Failed to load trial balance data");
        }
      }

      function renderTrialBalanceView(data) {
        const content = document.getElementById("dashboard-content");
        const totals = data.consolidated.totals;
        const balanceCheck = data.consolidated.balanceCheck;
        const summary = data.summary;

        content.innerHTML = `
               <div class="demo-card financial-overview">
                   <div class="card-header">
                       <h3>⚖️ RAC Consolidated Trial Balance</h3>
                       <p>Financial position across ${
                         data.companies.length
                       } RAC entities</p>
                   </div>
                   <div class="card-content">
                       <div class="dashboard-mockup">
                           <div style="margin-bottom: 20px; padding: 15px; border-radius: 8px; ${
                             balanceCheck.debitsEqualCredits
                               ? "background: #d4edda; border: 1px solid #c3e6cb; color: #155724;"
                               : "background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24;"
                           }">
                               <div style="font-weight: bold; margin-bottom: 5px;">
                                   ${
                                     balanceCheck.debitsEqualCredits
                                       ? "✅ Books are BALANCED"
                                       : "⚠️ Books are OUT OF BALANCE"
                                   }
                               </div>
                               <div style="font-size: 0.9rem;">
                                   Debits: $${totals.totalDebits.toLocaleString()} | Credits: $${totals.totalCredits.toLocaleString()}
                               </div>
                           </div>

                           <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                               <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                   <div style="font-size: 1.4rem; font-weight: bold; color: #28a745;">$${totals.totalAssets.toLocaleString()}</div>
                                   <div style="font-size: 1rem; color: #666;">Total Assets</div>
                               </div>
                               <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                   <div style="font-size: 1.4rem; font-weight: bold; color: #dc3545;">$${totals.totalLiabilities.toLocaleString()}</div>
                                   <div style="font-size: 1rem; color: #666;">Total Liabilities</div>
                               </div>
                               <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                   <div style="font-size: 1.4rem; font-weight: bold; color: #17a2b8;">$${totals.totalEquity.toLocaleString()}</div>
                                   <div style="font-size: 1rem; color: #666;">Total Equity</div>
                               </div>
                           </div>

                           <div id="companies-breakdown">
                               ${data.companies
                                 .map(
                                   (company, companyIndex) => `
                                   <div class="company-card" style="margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
                                       <div onclick="toggleCompanyExpansion(${companyIndex})" style="background: #f8f9fa; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                           <div>
                                               <span id="company-toggle-${companyIndex}" style="margin-right: 8px;">▶</span>
                                               <strong>${
                                                 company.tenantName
                                               }</strong>
                                               <span style="margin-left: 10px; color: #666;">(${
                                                 company.accountCounts
                                                   .totalAccounts
                                               } accounts)</span>
                                           </div>
                                           <div style="text-align: right; font-size: 0.9rem; color: #666;">
                                               Assets: $${company.totals.totalAssets.toLocaleString()}
                                           </div>
                                       </div>
                                       <div id="company-sections-${companyIndex}" style="display: none; padding: 10px;">
                                           ${Object.entries(company.sections)
                                             .filter(
                                               ([key, section]) =>
                                                 section.accounts.length > 0
                                             )
                                             .map(
                                               ([sectionKey, section]) => `
                                               <div style="margin-bottom: 10px;">
                                                   <div onclick="toggleSection(${companyIndex}, '${sectionKey}')" style="background: #f1f3f4; padding: 8px; cursor: pointer; display: flex; justify-content: space-between;">
                                                       <span>
                                                           <span id="section-toggle-${companyIndex}-${sectionKey}">▶</span>
                                                           <strong>${
                                                             section.title
                                                           }</strong> (${
                                                 section.accounts.length
                                               })
                                                       </span>
                                                       <strong>$${section.total.toLocaleString()}</strong>
                                                   </div>
                                                   <div id="section-accounts-${companyIndex}-${sectionKey}" style="display: none; padding: 5px;">
                                                       <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; padding: 5px; font-weight: bold; font-size: 0.9rem; background: #f8f9fa;">
                                                           <div>Account</div>
                                                           <div style="text-align: right;">Debit</div>
                                                           <div style="text-align: right;">Credit</div>
                                                       </div>
                                                       ${section.accounts
                                                         .map(
                                                           (account) => `
                                                           <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; padding: 5px; border-bottom: 1px solid #eee; font-size: 0.85rem;">
                                                               <div>${
                                                                 account.name
                                                               }</div>
                                                               <div style="text-align: right;">${
                                                                 account.debit >
                                                                 0
                                                                   ? "$" +
                                                                     account.debit.toLocaleString()
                                                                   : "-"
                                                               }</div>
                                                               <div style="text-align: right;">${
                                                                 account.credit >
                                                                 0
                                                                   ? "$" +
                                                                     account.credit.toLocaleString()
                                                                   : "-"
                                                               }</div>
                                                           </div>
                                                       `
                                                         )
                                                         .join("")}
                                                   </div>
                                               </div>
                                           `
                                             )
                                             .join("")}
                                       </div>
                                   </div>
                               `
                                 )
                                 .join("")}
                           </div>
                       </div>
                       <div class="${
                         balanceCheck.debitsEqualCredits
                           ? "success-box"
                           : "alert-box"
                       }">
                           ${
                             balanceCheck.debitsEqualCredits
                               ? "✅ Trial Balance is accurate"
                               : "⚠️ Trial Balance shows discrepancies"
                           }
                       </div>
                   </div>
               </div>

               <div class="demo-card">
                   <div class="card-header">
                       <h3>📈 Portfolio Overview</h3>
                       <p>RAC financial portfolio summary</p>
                   </div>
                   <div class="card-content">
                       <div class="dashboard-mockup">
                           <div class="metric-row">
                               <span class="metric-label">Total Portfolio Value</span>
                               <span class="metric-value large">$${(
                                 totals.totalAssets - totals.totalLiabilities
                               ).toLocaleString()}</span>
                           </div>
                           <div class="metric-row">
                               <span class="metric-label">Connected Entities</span>
                               <span class="metric-value">${
                                 summary.totalCompanies
                               } companies</span>
                           </div>
                           <div class="metric-row">
                               <span class="metric-label">Total Accounts</span>
                               <span class="metric-value">${
                                 summary.totalAccounts
                               } accounts</span>
                           </div>
                       </div>
                   </div>
               </div>
           `;
      }

      // ====== EXPANSION FUNCTIONS ======
      function toggleCompanyExpansion(companyIndex) {
        const sectionsDiv = document.getElementById(
          `company-sections-${companyIndex}`
        );
        const toggleIcon = document.getElementById(
          `company-toggle-${companyIndex}`
        );

        if (sectionsDiv.style.display === "none") {
          sectionsDiv.style.display = "block";
          toggleIcon.textContent = "▼";
        } else {
          sectionsDiv.style.display = "none";
          toggleIcon.textContent = "▶";
        }
      }

      function toggleSection(companyIndex, sectionKey) {
        const accountsDiv = document.getElementById(
          `section-accounts-${companyIndex}-${sectionKey}`
        );
        const toggleIcon = document.getElementById(
          `section-toggle-${companyIndex}-${sectionKey}`
        );

        if (accountsDiv.style.display === "none") {
          accountsDiv.style.display = "block";
          toggleIcon.textContent = "▼";
        } else {
          accountsDiv.style.display = "none";
          toggleIcon.textContent = "▶";
        }
      }

      // ====== OAUTH FUNCTIONS ======
      // ====== BACKGROUND OAUTH REFRESH FUNCTIONS ======
      async function backgroundRefreshAllCompanies(event) {
        if (event) event.preventDefault();

        console.log("🔄 Starting background OAuth refresh...");

        try {
          const connectedCompanies = JSON.parse(
            localStorage.getItem("racCompanyPreferences") || "[]"
          );

          if (connectedCompanies.length === 0) {
            updateRefreshLog("No companies to refresh", "error");
            return;
          }

          updateRefreshLog(
            `Starting refresh for ${connectedCompanies.length} companies...`
          );

          // Show refresh panel
          document.getElementById("refresh-status-panel").style.display =
            "block";

          // Process each company in hidden iframe
          for (let i = 0; i < connectedCompanies.length; i++) {
            const company = connectedCompanies[i];
            updateRefreshLog(
              `🔄 Refreshing ${company} (${i + 1}/${
                connectedCompanies.length
              })...`
            );

            await refreshCompanyInPopup(company);
            await new Promise((resolve) => setTimeout(resolve, 2000));
          }

          updateRefreshLog(
            "✅ All companies refreshed! Checking token times..."
          );
          checkTokenTimes();
        } catch (error) {
          console.error("❌ Background refresh error:", error);
          updateRefreshLog(`Refresh error: ${error.message}`, "error");
        }
      }

      // ====== REFRESH PANEL HELPER FUNCTIONS ======
      function toggleRefreshPanel() {
        const panel = document.getElementById("refresh-status-panel");
        panel.style.display = panel.style.display === "none" ? "block" : "none";
      }

      function updateRefreshLog(message, type = "info") {
        const log = document.getElementById("refresh-log");
        const timestamp = new Date().toLocaleTimeString();
        const icon = type === "error" ? "❌" : type === "success" ? "✅" : "🔄";

        log.innerHTML += `<div style="color: ${
          type === "error" ? "#dc3545" : type === "success" ? "#28a745" : "#666"
        };">
    [${timestamp}] ${icon} ${message}
  </div>`;

        // Auto-scroll to bottom
        log.scrollTop = log.scrollHeight;
      }

      async function refreshCompanyInPopup(companyId) {
        const companyName = companies[companyId];

        updateRefreshLog(`Opening popup for ${companyName}...`);

        // Open popup window
        const popup = window.open(
          "/auth",
          "xero-oauth",
          "width=500,height=600,scrollbars=yes"
        );

        if (!popup) {
          updateRefreshLog(`❌ Popup blocked for ${companyName}`, "error");
          return;
        }

        // Wait for popup to load
        await new Promise((resolve) => setTimeout(resolve, 3000));

        // Try to automate the popup content
        try {
          const popupDoc = popup.document;

          updateRefreshLog(`Attempting automation for ${companyName}...`);

          // Find and select company dropdown
          const dropdown = popupDoc.querySelector("select");
          if (dropdown) {
            updateRefreshLog(
              `Found dropdown with ${dropdown.options.length} options`
            );

            for (let option of dropdown.options) {
              if (
                option.textContent.includes(companyName) ||
                option.textContent.includes("7168")
              ) {
                dropdown.value = option.value;
                dropdown.dispatchEvent(new Event("change", { bubbles: true }));
                updateRefreshLog(`✅ Selected: ${option.textContent}`);
                break;
              }
            }
          } else {
            updateRefreshLog(`⚠️ Dropdown not found`);
          }

          // Wait a moment then find Allow button
          await new Promise((resolve) => setTimeout(resolve, 1000));

          const allowButton = popupDoc.querySelector("button");
          if (allowButton && allowButton.textContent.includes("Allow")) {
            allowButton.click();
            updateRefreshLog(`✅ Clicked Allow button for ${companyName}`);
          } else {
            updateRefreshLog(
              `⚠️ Allow button not found - please click manually`
            );
          }
        } catch (error) {
          updateRefreshLog(`❌ Automation failed: ${error.message}`, "error");
          updateRefreshLog(`Please complete OAuth manually in popup`, "info");
        }

        // Wait for completion
        await waitForPopupCompletion(popup, companyName);
      }

      async function waitForPopupCompletion(popup, companyName) {
        return new Promise((resolve) => {
          updateRefreshLog(`Waiting for ${companyName} OAuth completion...`);

          // Check for OAuth success (faster detection)
          const checkSuccess = setInterval(() => {
            try {
              // If popup URL contains 'success' or redirects to dashboard, close it
              if (
                popup.location.href.includes("success") ||
                popup.location.href.includes("/dashboard")
              ) {
                popup.close();
                updateRefreshLog(`✅ OAuth success detected - popup closed`);
                clearInterval(checkSuccess);
                clearInterval(checkClosed);
                resolve();
              }
            } catch (e) {
              // Cross-origin access blocked, that's fine - continue checking
            }
          }, 500);

          // Also check if popup closed manually
          const checkClosed = setInterval(() => {
            if (popup.closed) {
              updateRefreshLog(`✅ ${companyName} OAuth completed`);
              clearInterval(checkSuccess);
              clearInterval(checkClosed);
              resolve();
            }
          }, 1000);

          // Timeout after 60 seconds
          setTimeout(() => {
            if (!popup.closed) {
              popup.close();
              updateRefreshLog(`⚠️ ${companyName} timed out`, "error");
            }
            clearInterval(checkSuccess);
            clearInterval(checkClosed);
            resolve();
          }, 60000);
        });
      }

      async function checkTokenTimes() {
        try {
          const response = await fetch("/api/debug/database");
          const data = await response.json();

          updateRefreshLog("Checking token expiry times...");

          data.tokens.forEach((token) => {
            if (!token.expired) {
              const status = token.expires_in_minutes > 27 ? "✅" : "⚠️";
              updateRefreshLog(
                `${status} ${token.tenant_name}: ${token.expires_in_minutes} minutes remaining`
              );
            }
          });
        } catch (error) {
          updateRefreshLog(`Error checking tokens: ${error.message}`, "error");
        }
      }

      async function automateOAuthInIframe(iframe, companyName) {
        try {
          updateRefreshLog(`Automating forms for ${companyName}...`);

          // Wait for iframe content to be accessible
          await new Promise((resolve) => setTimeout(resolve, 1000));

          const iframeDoc =
            iframe.contentDocument || iframe.contentWindow.document;

          // Step 1: Wait for company dropdown to appear
          await waitForElementInIframe(iframeDoc, "select", 3000);

          // Step 2: Select the correct company
          const dropdown = iframeDoc.querySelector("select");
          if (dropdown) {
            // Find option that matches company name
            const options = dropdown.querySelectorAll("option");
            for (let option of options) {
              if (option.textContent.includes(companyName)) {
                dropdown.value = option.value;
                updateRefreshLog(`Selected company: ${companyName}`);
                break;
              }
            }
          }

          // Step 3: Wait for and click "Allow access" button
          await waitForElementInIframe(iframeDoc, "button", 2000);

          const allowButton = iframeDoc.querySelector(
            'button[contains*="Allow access"], button[contains*="Allow"]'
          );
          if (allowButton) {
            allowButton.click();
            updateRefreshLog(`Clicked Allow button for ${companyName}`);
          } else {
            updateRefreshLog(
              `⚠️ Allow button not found for ${companyName}`,
              "error"
            );
          }

          // Wait for OAuth completion
          await new Promise((resolve) => setTimeout(resolve, 2000));
        } catch (error) {
          updateRefreshLog(
            `Automation error for ${companyName}: ${error.message}`,
            "error"
          );
        }
      }

      async function waitForElementInIframe(
        iframeDoc,
        selector,
        timeout = 5000
      ) {
        const startTime = Date.now();

        while (Date.now() - startTime < timeout) {
          const element = iframeDoc.querySelector(selector);
          if (element) {
            updateRefreshLog(`Found element: ${selector}`);
            return element;
          }
          await new Promise((resolve) => setTimeout(resolve, 100));
        }

        updateRefreshLog(`⚠️ Timeout waiting for: ${selector}`, "error");
        return null;
      }

      function showTokenRefreshStatus(message, type = "success") {
        console.log("📢 Status:", message);

        // Find or create status display area
        let statusElement = document.querySelector(".token-refresh-status");
        if (!statusElement) {
          // Create status element in the green banner area
          const banner =
            document.querySelector(".text-green-600")?.parentElement;
          if (banner) {
            statusElement = document.createElement("div");
            statusElement.className = "token-refresh-status";
            statusElement.style.cssText =
              "margin-top: 5px; font-size: 0.9rem; font-weight: bold;";
            banner.appendChild(statusElement);
          }
        }

        if (statusElement) {
          statusElement.textContent = message;
          statusElement.style.color = type === "error" ? "#dc3545" : "#28a745";

          // Clear message after 5 seconds
          setTimeout(() => {
            statusElement.textContent = "";
          }, 5000);
        }
      }
      async function startTokenMonitoring() {
        const checkTokens = async () => {
          try {
            const response = await fetch("/api/token-status");
            const tokenStatus = await response.json();
            updateTokenStatusDisplay(tokenStatus);
          } catch (error) {
            console.error("Error monitoring tokens:", error);
          }
        };

        checkTokens();
        tokenStatusInterval = setInterval(checkTokens, 2 * 60 * 1000);
      }

      function updateTokenStatusDisplay(tokenStatus) {
        let statusHtml = "";
        if (tokenStatus.expiringTokens > 0) {
          statusHtml = `
                   <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 8px 12px; margin-top: 10px; font-size: 0.9rem;">
                       ⚠️ ${tokenStatus.expiringTokens} token(s) expiring soon
                   </div>
               `;
        } else if (tokenStatus.connectedTokens > 0) {
          statusHtml = `
                   <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 6px; padding: 8px 12px; margin-top: 10px; font-size: 0.9rem;">
                       ✅ ${tokenStatus.connectedTokens} connection(s) active
                   </div>
               `;
        }

        let statusDiv = document.getElementById("token-status-display");
        if (!statusDiv && statusHtml) {
          statusDiv = document.createElement("div");
          statusDiv.id = "token-status-display";
          document.querySelector(".header").appendChild(statusDiv);
        }
        if (statusDiv) {
          statusDiv.innerHTML = statusHtml;
        }
      }

      function showNotification(message) {
        const notification = document.createElement("div");
        notification.style.cssText = `
               position: fixed; top: 20px; right: 20px; z-index: 9999;
               background: ${message.includes("✅") ? "#d4edda" : "#f8d7da"};
               border: 1px solid ${
                 message.includes("✅") ? "#c3e6cb" : "#f5c6cb"
               };
               color: ${message.includes("✅") ? "#155724" : "#721c24"};
               padding: 12px 20px; border-radius: 6px; font-weight: bold;
               box-shadow: 0 4px 12px rgba(0,0,0,0.1);
           `;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => document.body.removeChild(notification), 5000);
      }

      // ====== DATE FUNCTIONS ======
      function updateReportDate(newDate) {
        selectedReportDate = newDate;
        document.getElementById("display-date").textContent =
          formatDisplayDate(newDate);
        loadTrialBalanceData();
      }

      function setQuickDate(option) {
        const today = new Date();
        let newDate = today;

        if (option === "monthEnd") {
          newDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        }

        const dateString = newDate.toISOString().split("T")[0];
        selectedReportDate = dateString;
        document.getElementById("report-date").value = dateString;
        document.getElementById("display-date").textContent =
          formatDisplayDate(dateString);
        loadTrialBalanceData();
      }

      function formatDisplayDate(dateString) {
        const date = new Date(dateString + "T00:00:00");
        return date.toLocaleDateString("en-AU", {
          year: "numeric",
          month: "long",
          day: "numeric",
          weekday: "long",
        });
      }

      function setView(viewType, event) {
        currentView = viewType;
        document
          .querySelectorAll(".toggle-btn")
          .forEach((btn) => btn.classList.remove("active"));
        event.target.classList.add("active");
        loadTrialBalanceData();
      }

      function showError(message) {
        document.getElementById(
          "dashboard-content"
        ).innerHTML = `<div class="error">❌ ${message}</div>`;
      }

      function updateTimestamp() {
        const timestampElement = document.getElementById("timestamp");
        if (timestampElement) {
          timestampElement.textContent = new Date().toLocaleString();
        }
      }

      // ====== INITIALIZATION ======
      async function initializePage() {
        handleOAuthReturn();

        if (localStorage.getItem("oauthCompanies")) {
          return;
        }

        try {
          const response = await fetch("/api/connection-status");
          const connections = await response.json();
          const connectedCount = connections.filter(
            (conn) => conn.connected
          ).length;

          if (connectedCount > 0) {
            document.getElementById("loginManager").style.display = "none";
            document.getElementById("mainDashboard").style.display = "block";
            initializeMainDashboard();
          } else {
            document.getElementById("loginManager").style.display = "block";
            document.getElementById("mainDashboard").style.display = "none";
            loadSavedPreferences();
          }
        } catch (error) {
          document.getElementById("loginManager").style.display = "block";
          document.getElementById("mainDashboard").style.display = "none";
          loadSavedPreferences();
        }
      }

      // ====== EVENT LISTENERS ======
      document.addEventListener("DOMContentLoaded", initializePage);
      window.addEventListener("popstate", handleOAuthReturn);
      window.addEventListener("beforeunload", () => {
        if (tokenStatusInterval) clearInterval(tokenStatusInterval);
      });
    </script>
  </body>
</html>
