<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RAC MCP - Integrated Dashboard with Enhanced Chat Filtering</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        height: 100vh;
        overflow: hidden;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      /* CONNECTION MANAGER STYLES */
      .connection-manager {
        min-height: 100vh;
        padding: 2rem;
        display: block;
      }

      .login-container {
        max-width: 800px;
        margin: 40px auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      .login-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        text-align: center;
      }

      .login-header h1 {
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
      }

      .login-content {
        padding: 2rem;
      }

      .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
      }

      .step {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        background: #f8f9fa;
        color: #666;
        font-size: 0.9rem;
        margin: 0 0.5rem;
      }

      .step.active {
        background: #667eea;
        color: white;
      }

      .step.completed {
        background: #28a745;
        color: white;
      }

      .step-number {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
      }

      .company-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .company-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        transition: background-color 0.2s;
        cursor: pointer;
      }

      .company-item:hover {
        background-color: #f8f9fa;
      }

      .company-item.all-companies {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: bold;
        margin-bottom: 1rem;
      }

      .company-checkbox {
        width: 18px;
        height: 18px;
        margin-right: 1rem;
        cursor: pointer;
      }

      .company-name {
        flex: 1;
        font-size: 1rem;
      }

      .selection-summary {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
        text-align: center;
      }

      .continue-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 6px;
        font-size: 1rem;
        cursor: pointer;
        width: 100%;
        transition: background 0.2s;
      }

      .continue-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .oauth-flow {
        display: none;
        text-align: center;
      }

      .current-connection {
        background: #f8f9fa;
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
      }

      .progress-bar {
        background: #e0e0e0;
        border-radius: 10px;
        height: 8px;
        margin: 15px 0;
        overflow: hidden;
      }

      .progress-fill {
        background: linear-gradient(45deg, #4caf50, #8bc34a);
        height: 100%;
        transition: width 0.3s ease;
      }

      .oauth-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 6px;
        font-size: 1rem;
        cursor: pointer;
        margin: 0.5rem;
      }

      .oauth-btn.primary {
        background: #667eea;
      }

      .completion {
        display: none;
        text-align: center;
      }

      .launch-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 1.5rem 3rem;
        border-radius: 8px;
        font-size: 1.1rem;
        cursor: pointer;
        transition: background 0.2s;
        margin-top: 1rem;
      }

      .success-box {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 8px;
        padding: 12px;
        margin: 10px 0;
        color: #155724;
      }

      /* SPLIT SCREEN DASHBOARD STYLES */
      .main-dashboard {
        display: none;
        height: 100vh;
        background: #f5f5f5;
      }

      .header {
        background: #2c3e50;
        color: white;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        position: relative;
      }

      .header h1 {
        font-size: 18px;
        font-weight: 600;
      }

      .header .session-info {
        font-size: 14px;
        opacity: 0.9;
      }

      .main-container {
        display: block; /* Change from flex */
        height: calc(100vh - 60px);
        position: relative;
      }

      .ai-chat-panel {
        display: none; /* Hide chat panel entirely */
      }

      .dashboard-panel {
        width: 100%; /* Full width */
        background: #fafafa;
        display: flex;
        flex-direction: column;
        position: relative;
      }

      .panel-header {
        background: #34495e;
        color: white;
        padding: 12px 20px;
        font-weight: 600;
        font-size: 14px;
        border-bottom: 1px solid #2c3e50;
      }

      /* ENHANCED COMPANY FILTER BAR FOR CHAT */
      .company-filter-bar {
        background: #ecf0f1;
        padding: 12px 20px;
        border-bottom: 1px solid #bdc3c7;
        font-size: 13px;
      }

      .company-filter-bar .filter-label {
        display: inline-block;
        margin-right: 15px;
        font-weight: 600;
        color: #2c3e50;
      }

      .company-checkboxes {
        display: inline-flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 8px;
      }

      .company-checkbox-item {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .company-checkbox-item:hover {
        background: rgba(52, 152, 219, 0.1);
      }

      .company-checkbox-item input[type="checkbox"] {
        margin: 0;
        cursor: pointer;
      }

      .company-checkbox-item label {
        font-weight: 500;
        color: #2c3e50;
        cursor: pointer;
        font-size: 12px;
      }

      .company-checkbox-item.balanced label {
        color: #27ae60;
      }

      .company-checkbox-item.imbalanced label {
        color: #e74c3c;
      }

      /* QUICK FILTER BUTTONS */
      .quick-filter-buttons {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }

      .quick-filter-btn {
        padding: 4px 8px;
        border: 1px solid #bdc3c7;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        transition: all 0.2s;
      }

      .quick-filter-btn:hover {
        background: #3498db;
        color: white;
        border-color: #3498db;
      }

      /* QUICK ANALYSIS GRID */
      .chat-quick-actions {
        padding: 12px 20px;
        background: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
      }

      .quick-action-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 8px;
      }

      .quick-action-btn {
        padding: 8px 10px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        font-size: 11px;
        text-align: center;
        transition: all 0.2s;
      }

      .quick-action-btn:hover {
        background: #3498db;
        color: white;
        border-color: #3498db;
      }

      /* ANALYSIS STATUS BOX */
      .company-analysis-status {
        background: #e8f4f8;
        border: 1px solid #bee5eb;
        border-radius: 4px;
        padding: 8px 12px;
        margin: 8px 0;
        font-size: 12px;
        color: #0c5460;
      }

      .filter-summary {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 4px;
        padding: 8px 12px;
        margin-top: 8px;
        font-size: 12px;
        color: #856404;
      }

      .ai-chat-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
      }

      .dashboard-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
      }

      .chat-messages {
        flex: 1;
        margin-bottom: 20px;
      }

      .message {
        margin-bottom: 15px;
        padding: 12px 16px;
        border-radius: 8px;
        max-width: 85%;
      }

      .message.user {
        background: #e3f2fd;
        border: 1px solid #bbdefb;
        margin-left: auto;
        text-align: right;
      }

      .message.assistant {
        background: #f1f8e9;
        border: 1px solid #c8e6c9;
        margin-right: auto;
      }

      .chat-input-area {
        border-top: 1px solid #e0e0e0;
        padding: 15px;
        background: #fafafa;
      }

      .chat-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        resize: vertical;
        min-height: 44px;
        font-family: inherit;
      }

      .chat-input:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
      }

      .send-button {
        margin-top: 10px;
        background: #3498db;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
      }

      .send-button:hover {
        background: #2980b9;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .dashboard-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: 1px solid #e0e0e0;
      }

      .dashboard-card h3 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 16px;
      }

      .metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .metric:last-child {
        border-bottom: none;
      }

      .metric-value {
        font-weight: 600;
        color: #27ae60;
      }

      .metric-value.negative {
        color: #e74c3c;
      }

      .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-indicator.balanced {
        background: #27ae60;
      }

      .status-indicator.imbalanced {
        background: #e74c3c;
      }

      .resizer {
        display: none; /* Remove resizer */
      }

      .resizer:hover {
        background: #3498db;
      }

      .toolbar {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      .toolbar button {
        padding: 8px 12px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }

      .toolbar button:hover {
        background: #f0f0f0;
      }

      .toolbar button.active {
        background: #3498db;
        color: white;
        border-color: #3498db;
      }

      /* Loading states */
      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Back to connection button */
      .back-to-connections {
        background: #6c757d;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        margin-left: 10px;
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .main-container {
          flex-direction: column;
        }

        .ai-chat-panel,
        .dashboard-panel {
          width: 100%;
          height: 50%;
        }

        .resizer {
          display: none;
        }

        .dashboard-grid {
          grid-template-columns: 1fr;
        }

        .company-checkboxes {
          flex-direction: column;
          gap: 6px;
        }
      }

      .hidden {
        display: none !important;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  </head>
  <body>
    <!-- CONNECTION MANAGER SECTION -->
    <div class="connection-manager" id="connectionManager">
      <div class="login-container">
        <div class="login-header">
          <h1>RAC Multi-Company Login Manager</h1>
          <p>Streamlined access to your Xero organisations</p>
        </div>

        <div class="login-content">
          <!-- Step Indicator -->
          <div class="step-indicator">
            <div class="step active" id="step1Indicator">
              <div class="step-number">1</div>
              <span>Select Companies</span>
            </div>
            <div class="step" id="step2Indicator">
              <div class="step-number">2</div>
              <span>OAuth Authentication</span>
            </div>
            <div class="step" id="step3Indicator">
              <div class="step-number">3</div>
              <span>Launch Dashboard</span>
            </div>
          </div>

          <!-- Step 1: Company Selection -->
          <div class="company-selection" id="step1">
            <h2 style="text-align: center; margin-bottom: 1rem; color: #333">
              Select Companies to Connect
            </h2>

            <div class="company-list">
              <!-- ALL Companies Option -->
              <div
                class="company-item all-companies"
                onclick="toggleAllCompanies(event)"
              >
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="all-companies"
                />
                <div class="company-name">🚀 ALL COMPANIES (Quick Connect)</div>
              </div>

              <!-- Individual Companies -->
              <div class="company-item" onclick="toggleCompany('rac', event)">
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="company-rac"
                />
                <div class="company-name">
                  Rirratjingu Aboriginal Corporation 8538
                </div>
              </div>

              <div
                class="company-item"
                onclick="toggleCompany('mining', event)"
              >
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="company-mining"
                />
                <div class="company-name">Rirratjingu Mining Pty Ltd 7168</div>
              </div>

              <div
                class="company-item"
                onclick="toggleCompany('property', event)"
              >
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="company-property"
                />
                <div class="company-name">
                  Rirratjingu Property Management & Maintenance Services Pty Ltd
                </div>
              </div>

              <div
                class="company-item"
                onclick="toggleCompany('enterprises', event)"
              >
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="company-enterprises"
                />
                <div class="company-name">Rirratjingu Enterprises Pty Ltd</div>
              </div>

              <div
                class="company-item"
                onclick="toggleCompany('invest', event)"
              >
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="company-invest"
                />
                <div class="company-name">
                  Rirratjingu Invest P/ L ATF Miliditjpi Trust
                </div>
              </div>

              <div
                class="company-item"
                onclick="toggleCompany('ngarrkuwuy', event)"
              >
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="company-ngarrkuwuy"
                />
                <div class="company-name">Ngarrkuwuy Developments Pty Ltd</div>
              </div>

              <div
                class="company-item"
                onclick="toggleCompany('marrin', event)"
              >
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="company-marrin"
                />
                <div class="company-name">
                  Marrin Square Developments Pty Ltd
                </div>
              </div>
            </div>

            <div class="selection-summary" id="selectionSummary">
              <strong>Selected: 0 companies</strong>
            </div>

            <button
              class="continue-btn"
              id="continueBtn"
              onclick="startOAuthFlow()"
              disabled
            >
              Continue with Selected Companies
            </button>
          </div>

          <!-- Step 2: OAuth Flow -->
          <div class="oauth-flow" id="step2">
            <h2>Connecting to Your Companies</h2>

            <div class="current-connection">
              <h3 id="currentCompanyName">Ready to connect...</h3>
              <div class="progress-bar">
                <div
                  class="progress-fill"
                  id="progressFill"
                  style="width: 0%"
                ></div>
              </div>
              <div id="progressText">Preparing connections...</div>
            </div>

            <div class="success-box" id="oauthInstructions">
              <strong>Ready to start:</strong> Click "Start OAuth Flow" to begin
              connecting to your selected companies.
            </div>

            <div id="oauthButtons">
              <button
                class="oauth-btn primary"
                onclick="startNextOAuth()"
                id="startOAuthBtn"
              >
                🔗 Start OAuth Flow
              </button>
            </div>

            <div id="waitingMessage" style="display: none">
              <div class="success-box">
                <strong>Waiting for OAuth completion...</strong><br />
                Complete the Xero authorization, then return here.
              </div>
              <button class="oauth-btn" onclick="checkOAuthStatus()">
                ✅ I've completed the OAuth - Continue
              </button>
            </div>
          </div>

          <!-- Step 3: Completion -->
          <div class="completion" id="step3">
            <h2>🎉 All Companies Connected!</h2>
            <div class="connected-companies" id="connectedCompaniesList"></div>
            <div class="success-box">
              <strong>Ready to launch!</strong> All selected companies are now
              connected.
            </div>
            <button class="launch-btn" onclick="showMainDashboard()">
              🚀 Launch Financial Dashboard
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- SINGLE PANEL DASHBOARD SECTION -->
    <div class="main-dashboard" id="mainDashboard">
      <div class="header">
        <h1>RAC Financial Dashboard</h1>
        <div class="session-info">
          Session: Active | Connected Companies:
          <span id="connectedCount">0</span>
          <button class="back-to-connections" onclick="backToConnections()">
            🔙 Manage Connections
          </button>
        </div>
      </div>

      <div class="main-container">
        <div class="dashboard-panel">
          <div class="panel-header">
            <span class="status-indicator balanced" id="dashboardStatus"></span>
            Financial Dashboard - Live Data

            <!-- Simple company filter moved to header -->
            <div
              style="
                display: inline-flex;
                gap: 15px;
                margin-left: 30px;
                font-size: 13px;
              "
            >
              <span style="font-weight: 600">Companies:</span>
              <div id="companyFilters" style="display: inline-flex; gap: 10px">
                <!-- Company checkboxes will be populated here -->
              </div>
            </div>
          </div>

          <div class="dashboard-content">
            <div class="toolbar">
              <button class="active" onclick="setView('overview', this)">
                Overview
              </button>
              <button onclick="setView('trial-balance', this)">
                Trial Balance
              </button>
              <button onclick="setView('cash-flow', this)">Cash Flow</button>
              <button onclick="setView('p-and-l', this)">P&L</button>
              <button onclick="setView('year-over-year', this)">
                YoY Analysis
              </button>
              <button onclick="setView('monthly-analysis', this)">
                Monthly Analysis
              </button>
              <button onclick="setView('alerts', this)">Alerts</button>
            </div>

            <div id="dashboardData">
              <div class="loading">
                <div class="loading-spinner"></div>
                Loading financial data from connected companies...
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      // ====== GLOBAL VARIABLES ======
      const companies = {
        rac: "Rirratjingu Aboriginal Corporation 8538",
        mining: "Rirratjingu Mining Pty Ltd 7168",
        property:
          "Rirratjingu Property Management & Maintenance Services Pty Ltd",
        enterprises: "Rirratjingu Enterprises Pty Ltd",
        invest: "Rirratjingu Invest P/ L ATF Miliditjpi Trust",
        ngarrkuwuy: "Ngarrkuwuy Developments Pty Ltd",
        marrin: "Marrin Square Developments Pty Ltd",
      };

      let selectedCompanies = [];
      let oauthProgress = 0;
      let connectedCompanies = [];
      let isOAuthInProgress = false;
      let activeCompanyFilters = [];
      let currentView = "overview";
      // Global variables for monthly analysis
      let monthlyData = null;
      let monthlyViewMode = "fy"; // 'fy' or 'monthly'
      let selectedMonth = "";
      let selectedYear = new Date().getFullYear();

      // ====== CONNECTION MANAGER FUNCTIONS ======

      function loadSavedPreferences() {
        const saved = localStorage.getItem("racCompanyPreferences");
        if (saved) {
          try {
            selectedCompanies = JSON.parse(saved);
            selectedCompanies.forEach((companyId) => {
              const checkbox = document.getElementById(`company-${companyId}`);
              if (checkbox) checkbox.checked = true;
            });
            updateSelectionSummary();
          } catch (error) {
            console.log("No valid saved preferences");
          }
        }
      }

      function savePreferences() {
        localStorage.setItem(
          "racCompanyPreferences",
          JSON.stringify(selectedCompanies)
        );
      }

      function toggleCompany(companyId, event) {
        event.stopPropagation();
        const checkbox = document.getElementById(`company-${companyId}`);
        checkbox.checked = !checkbox.checked;

        if (checkbox.checked) {
          if (!selectedCompanies.includes(companyId)) {
            selectedCompanies.push(companyId);
          }
        } else {
          selectedCompanies = selectedCompanies.filter(
            (id) => id !== companyId
          );
          document.getElementById("all-companies").checked = false;
        }

        updateSelectionSummary();
        savePreferences();
      }

      function toggleAllCompanies(event) {
        event.stopPropagation();
        const allCheckbox = document.getElementById("all-companies");
        allCheckbox.checked = !allCheckbox.checked;

        if (allCheckbox.checked) {
          selectedCompanies = Object.keys(companies);
          Object.keys(companies).forEach((companyId) => {
            document.getElementById(`company-${companyId}`).checked = true;
          });
        } else {
          selectedCompanies = [];
          Object.keys(companies).forEach((companyId) => {
            document.getElementById(`company-${companyId}`).checked = false;
          });
        }

        updateSelectionSummary();
        savePreferences();
      }

      function updateSelectionSummary() {
        const summary = document.getElementById("selectionSummary");
        const continueBtn = document.getElementById("continueBtn");

        summary.innerHTML = `<strong>Selected: ${selectedCompanies.length} companies</strong>`;

        if (selectedCompanies.length > 0) {
          const companyNames = selectedCompanies.map((id) => companies[id]);
          summary.innerHTML += `<br><small>${companyNames.join(", ")}</small>`;
          continueBtn.disabled = false;
        } else {
          continueBtn.disabled = true;
        }
      }

      function startOAuthFlow() {
        if (selectedCompanies.length === 0) {
          alert("Please select at least one company to continue.");
          return;
        }

        document.getElementById("step1").style.display = "none";
        document.getElementById("step2").style.display = "block";
        document.getElementById("step1Indicator").classList.add("completed");
        document.getElementById("step1Indicator").classList.remove("active");
        document.getElementById("step2Indicator").classList.add("active");

        oauthProgress = 0;
        connectedCompanies = [];
        localStorage.setItem(
          "oauthCompanies",
          JSON.stringify(selectedCompanies)
        );
        localStorage.setItem("oauthProgress", "0");
        updateOAuthProgress();
      }

      function updateOAuthProgress() {
        const currentCompanyName =
          document.getElementById("currentCompanyName");
        const progressFill = document.getElementById("progressFill");
        const progressText = document.getElementById("progressText");

        if (oauthProgress < selectedCompanies.length) {
          const companyId = selectedCompanies[oauthProgress];
          const companyName = companies[companyId];

          currentCompanyName.textContent = `Ready to connect: ${companyName} (${
            oauthProgress + 1
          }/${selectedCompanies.length})`;
          const progressPercent =
            (oauthProgress / selectedCompanies.length) * 100;
          progressFill.style.width = progressPercent + "%";
          progressText.textContent = `Step ${oauthProgress + 1} of ${
            selectedCompanies.length
          }`;

          document.getElementById("oauthInstructions").innerHTML = `
                          <strong>Next Company:</strong> ${companyName}<br>
                          <small>When the Xero login opens, select "${companyName}" from the dropdown and authorize access.</small>
                      `;
        }
      }

      function startNextOAuth() {
        if (oauthProgress >= selectedCompanies.length) {
          showCompletion();
          return;
        }

        const companyId = selectedCompanies[oauthProgress];
        const companyName = companies[companyId];

        localStorage.setItem("currentOAuthCompany", companyId);
        localStorage.setItem("currentOAuthCompanyName", companyName);

        isOAuthInProgress = true;
        document.getElementById("startOAuthBtn").style.display = "none";
        document.getElementById("waitingMessage").style.display = "block";

        window.location.href = "/auth";
      }

      async function checkOAuthStatus() {
        try {
          const response = await fetch("/api/connection-status");
          const connections = await response.json();

          const currentCompanyName = localStorage.getItem(
            "currentOAuthCompanyName"
          );
          const currentCompanyId = localStorage.getItem("currentOAuthCompany");

          const newConnection = connections.find(
            (conn) => conn.tenantName === currentCompanyName && conn.connected
          );

          if (newConnection) {
            connectedCompanies.push({
              id: currentCompanyId,
              name: currentCompanyName,
              tenantId: newConnection.tenantId,
            });

            oauthProgress++;
            localStorage.setItem("oauthProgress", oauthProgress.toString());

            isOAuthInProgress = false;
            document.getElementById("startOAuthBtn").style.display =
              "inline-block";
            document.getElementById("waitingMessage").style.display = "none";

            if (oauthProgress < selectedCompanies.length) {
              updateOAuthProgress();
              document.getElementById(
                "startOAuthBtn"
              ).textContent = `🔗 Connect Next Company (${oauthProgress + 1}/${
                selectedCompanies.length
              })`;
            } else {
              showCompletion();
            }
          } else {
            alert(
              `❌ Failed to connect ${currentCompanyName}. Please try again.`
            );
            isOAuthInProgress = false;
            document.getElementById("startOAuthBtn").style.display =
              "inline-block";
            document.getElementById("waitingMessage").style.display = "none";
          }
        } catch (error) {
          console.error("❌ Error checking OAuth status:", error);
          alert("❌ Error checking connection status. Please try again.");
          isOAuthInProgress = false;
          document.getElementById("startOAuthBtn").style.display =
            "inline-block";
          document.getElementById("waitingMessage").style.display = "none";
        }
      }

      function showCompletion() {
        document.getElementById("step2").style.display = "none";
        document.getElementById("step3").style.display = "block";
        document.getElementById("step2Indicator").classList.add("completed");
        document.getElementById("step2Indicator").classList.remove("active");
        document.getElementById("step3Indicator").classList.add("active");

        const connectedList = document.getElementById("connectedCompaniesList");
        connectedList.innerHTML = connectedCompanies
          .map(
            (company) => `
                      <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border: 1px solid #28a745; background: #f8fff9; border-radius: 6px; margin-bottom: 0.5rem;">
                          <div style="display: flex; align-items: center; gap: 0.5rem;">
                              <div style="width: 12px; height: 12px; border-radius: 50%; background: #28a745;"></div>
                              <strong>${company.name}</strong>
                          </div>
                          <div style="color: #28a745; font-size: 0.9rem;">✅ Connected</div>
                      </div>
                  `
          )
          .join("");

        // Auto-launch after 3 seconds
        setTimeout(() => showMainDashboard(), 3000);
      }

      function showMainDashboard() {
        localStorage.removeItem("oauthCompanies");
        localStorage.removeItem("oauthProgress");
        localStorage.removeItem("currentOAuthCompany");
        localStorage.removeItem("currentOAuthCompanyName");
        localStorage.setItem("racCompaniesConnected", "true");

        document.getElementById("connectionManager").style.display = "none";
        document.getElementById("mainDashboard").style.display = "block";

        initializeMainDashboard();
      }

      function handleOAuthReturn() {
        const urlParams = new URLSearchParams(window.location.search);
        const isSuccess = urlParams.has("success");
        const isError = urlParams.has("error");
        const oauthCompanies = localStorage.getItem("oauthCompanies");

        if (isSuccess && oauthCompanies) {
          selectedCompanies = JSON.parse(oauthCompanies);
          oauthProgress = parseInt(localStorage.getItem("oauthProgress")) || 0;

          document.getElementById("connectionManager").style.display = "block";
          document.getElementById("mainDashboard").style.display = "none";
          document.getElementById("step1").style.display = "none";
          document.getElementById("step2").style.display = "block";
          document.getElementById("step1Indicator").classList.add("completed");
          document.getElementById("step2Indicator").classList.add("active");

          setTimeout(() => checkOAuthStatus(), 1000);
        }

        if (isSuccess || isError) {
          history.replaceState({}, document.title, window.location.pathname);
        }
      }

      // ====== DASHBOARD FUNCTIONS ======

      async function initializeMainDashboard() {
        try {
          await loadConnectedCompanies();
          setupCompanyFilters();
          await loadDashboardData();
          initializeChat();
          initializeResizer();
        } catch (error) {
          console.error("Error initializing dashboard:", error);
        }
      }

      async function loadConnectedCompanies() {
        try {
          const response = await fetch("/api/connection-status");
          const connections = await response.json();

          connectedCompanies = connections.filter((conn) => conn.connected);
          activeCompanyFilters = connectedCompanies.map(
            (conn) => conn.tenantId
          );

          document.getElementById("connectedCount").textContent =
            connectedCompanies.length;

          // Update status indicators
          const hasConnections = connectedCompanies.length > 0;
          // Remove this line since aiStatus element no longer exists:
          // document.getElementById("aiStatus").className = `status-indicator ${
          //   hasConnections ? "balanced" : "imbalanced"
          // }`;
          document.getElementById(
            "dashboardStatus"
          ).className = `status-indicator ${
            hasConnections ? "balanced" : "imbalanced"
          }`;
        } catch (error) {
          console.error("Error loading connected companies:", error);
          connectedCompanies = [];
        }
      }

      function setupCompanyFilters() {
        const filtersContainer = document.getElementById("companyFilters");
        const summaryElement = document.getElementById("filterSummary");
        const chatStatus = document.getElementById("chatAnalysisStatus");

        if (connectedCompanies.length === 0) {
          filtersContainer.innerHTML =
            '<div style="color: #e74c3c;">No companies connected</div>';
          summaryElement.textContent =
            "No connected companies found. Please manage connections.";
          chatStatus.textContent = "No companies available for analysis";
          chatStatus.style.background = "#f8d7da";
          chatStatus.style.color = "#721c24";
          return;
        }

        filtersContainer.innerHTML = connectedCompanies
          .map((company) => {
            const shortName = company.tenantName
              .replace("Rirratjingu ", "")
              .replace(" Pty Ltd", "");
            return `
              <div class="company-checkbox-item balanced">
                <input type="checkbox"
                       id="filter-${company.tenantId}"
                       checked
                       onchange="handleCompanyFilterChange('${company.tenantId}')">
                <label for="filter-${company.tenantId}"
                       onclick="toggleCompanyFilterByLabel('${company.tenantId}')">${shortName}</label>
              </div>
            `;
          })
          .join("");

        //updateFilterSummary();
        //updateChatAnalysisStatus();
      }

      // Add these functions after the setupCompanyFilters() function:

      function handleCompanyFilterChange(tenantId) {
        const checkbox = document.getElementById(`filter-${tenantId}`);

        if (checkbox.checked) {
          if (!activeCompanyFilters.includes(tenantId)) {
            activeCompanyFilters.push(tenantId);
          }
        } else {
          activeCompanyFilters = activeCompanyFilters.filter(
            (id) => id !== tenantId
          );
        }

        //updateFilterSummary();
        //updateChatAnalysisStatus();
        loadDashboardData();

        // Add chat message about filter change
        const selectedCompanies = getSelectedCompanyNames();
        addMessage(
          "assistant",
          `Analysis scope updated: Now analyzing ${
            selectedCompanies.length
          } companies: ${selectedCompanies.join(", ")}`
        );
      }

      function toggleCompanyFilterByLabel(tenantId) {
        const checkbox = document.getElementById(`filter-${tenantId}`);
        checkbox.checked = !checkbox.checked;

        // Trigger the change event
        const event = new Event("change");
        checkbox.dispatchEvent(event);
      }

      function getSelectedCompanyNames() {
        return activeCompanyFilters.map((tenantId) => {
          const company = connectedCompanies.find(
            (c) => c.tenantId === tenantId
          );
          return company
            ? company.tenantName
                .replace("Rirratjingu ", "")
                .replace(" Pty Ltd", "")
            : "Unknown";
        });
      }

      // ====== QUICK FILTER FUNCTIONS ======
      function selectAllCompanies() {
        activeCompanyFilters = connectedCompanies.map((c) => c.tenantId);
        connectedCompanies.forEach((company) => {
          const checkbox = document.getElementById(
            `filter-${company.tenantId}`
          );
          if (checkbox) checkbox.checked = true;
        });
        //updateFilterSummary();
        //updateChatAnalysisStatus();
        loadDashboardData();
        addMessage(
          "assistant",
          "Analysis scope updated: Now analyzing all connected companies"
        );
      }

      function selectNoCompanies() {
        activeCompanyFilters = [];
        connectedCompanies.forEach((company) => {
          const checkbox = document.getElementById(
            `filter-${company.tenantId}`
          );
          if (checkbox) checkbox.checked = false;
        });
        //updateFilterSummary();
        //updateChatAnalysisStatus();
        loadDashboardData();
        addMessage(
          "assistant",
          "Analysis scope cleared: No companies selected. Choose companies above to begin analysis."
        );
      }

      function selectMainEntities() {
        // Select main entities: Aboriginal Corp and Mining
        const mainEntityNames = ["Aboriginal Corporation", "Mining"];
        activeCompanyFilters = [];

        connectedCompanies.forEach((company) => {
          const checkbox = document.getElementById(
            `filter-${company.tenantId}`
          );
          const isMain = mainEntityNames.some((name) =>
            company.tenantName.includes(name)
          );

          if (checkbox) checkbox.checked = isMain;
          if (isMain) activeCompanyFilters.push(company.tenantId);
        });

        //updateFilterSummary();
        //updateChatAnalysisStatus();
        loadDashboardData();

        const selectedNames = getSelectedCompanyNames();
        addMessage(
          "assistant",
          `Analysis scope updated: Focusing on main entities - ${selectedNames.join(
            ", "
          )}`
        );
      }

      // ====== QUICK ANALYSIS FUNCTIONS ======
      function quickAnalysis(type) {
        const selectedCompanies = getSelectedCompanyNames();

        if (selectedCompanies.length === 0) {
          addMessage(
            "assistant",
            "Please select companies using the filters above before requesting analysis."
          );
          return;
        }

        let query = "";
        let analysisType = "";

        switch (type) {
          case "trial-balance":
            query = "Show me the trial balance";
            analysisType = "Trial Balance Analysis";
            break;
          case "cash-position":
            query = "What is the current cash position?";
            analysisType = "Cash Position Analysis";
            break;
          case "profit-loss":
            query = "Show me the profit and loss summary";
            analysisType = "Profit & Loss Analysis";
            break;
          case "financial-ratios":
            query = "Calculate key financial ratios";
            analysisType = "Financial Ratios Analysis";
            break;
          case "outstanding-invoices":
            query = "Show me outstanding invoices";
            analysisType = "Outstanding Invoices Analysis";
            break;
          case "consolidate-all":
            query = "Show me consolidated financial summary";
            analysisType = "Consolidated Analysis";
            break;
        }

        addMessage("user", query);

        // Show analysis in progress
        setTimeout(() => {
          addMessage(
            "assistant",
            `Processing ${analysisType} for: ${selectedCompanies.join(", ")}...`
          );

          // Simulate actual MCP analysis - replace with real MCP calls
          setTimeout(() => {
            addMessage(
              "assistant",
              `${analysisType} completed for ${selectedCompanies.length} companies. Here's the summary: [This would contain actual financial data from your MCP server tools]`
            );
          }, 2000);
        }, 500);
      }

      // ====== CHAT FUNCTIONS ======

      function initializeChat() {
        const chatInput = document.getElementById("chatInput");
        if (!chatInput) return; // Add this line to prevent the error

        chatInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
      }

      function sendMessage() {
        const chatInput = document.getElementById("chatInput");
        const message = chatInput.value.trim();

        if (!message) return;

        const selectedCompanies = getSelectedCompanyNames();

        if (selectedCompanies.length === 0) {
          addMessage(
            "assistant",
            "Please select companies using the filters above before asking questions."
          );
          return;
        }

        addMessage("user", message);
        chatInput.value = "";

        // Show analysis scope and processing message
        setTimeout(() => {
          const scope =
            selectedCompanies.length === connectedCompanies.length
              ? `all ${connectedCompanies.length} connected companies`
              : `${
                  selectedCompanies.length
                } selected companies: ${selectedCompanies.join(", ")}`;

          addMessage(
            "assistant",
            `I'll analyze ${scope} for your query: "${message}". Accessing RAC Xero MCP system with ${selectedCompanies.length} company scope...`
          );

          // Here you would integrate with your actual MCP server
          // For now, showing example of what the integration would look like
          setTimeout(() => {
            addMessage(
              "assistant",
              `Analysis complete for ${selectedCompanies.join(
                ", "
              )}. [This response would contain actual financial data from your MCP server based on the selected companies and query type.]`
            );
          }, 2000);
        }, 500);
      }

      function addMessage(type, content) {
        const messagesContainer = document.getElementById("chatMessages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}`;
        messageDiv.innerHTML = `<strong>${
          type === "user" ? "You" : "Claude"
        }:</strong> ${content}`;
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // ====== DASHBOARD DATA LOADING FUNCTIONS ======

      async function loadDashboardData() {
        const dashboardElement = document.getElementById("dashboardData");

        if (activeCompanyFilters.length === 0) {
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #666;">
        <h3>No Companies Selected</h3>
        <p>Please select companies using the filters above to view financial data.</p>
      </div>
    `;
          return;
        }

        // Show loading with specific company count
        const selectedCompanyNames = getSelectedCompanyNames();
        dashboardElement.innerHTML = `
    <div class="loading">
      <div class="loading-spinner"></div>
      Loading ${currentView} data from ${
          activeCompanyFilters.length
        } companies:<br>
      <small>${selectedCompanyNames.join(", ")}</small>
    </div>
  `;

        try {
          if (currentView === "overview") {
            await loadOverviewDataWithYoY();
          } else if (currentView === "trial-balance") {
            await loadTrialBalanceData();
          } else if (currentView === "cash-flow") {
            await loadCashFlowData();
          } else if (currentView === "p-and-l") {
            await loadProfitLossData();
          } else if (currentView === "year-over-year") {
            await loadYearOverYearData(); // <- Add this line
          } else if (currentView === "monthly-analysis") {
            await loadMonthlyAnalysisData();
          } else if (currentView === "alerts") {
            await loadAlertsData();
          }
        } catch (error) {
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c;">
        <h3>Error Loading Data</h3>
        <p>Failed to load dashboard data: ${error.message}</p>
        <button onclick="loadDashboardData()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Retry
        </button>
      </div>
    `;
        }
      }

      // ====== ENHANCED loadOverviewDataWithYoY() WITH MORE BUSINESS METRICS ======

      async function loadOverviewDataWithYoY() {
        // Check if any companies are selected
        if (activeCompanyFilters.length === 0) {
          const dashboardElement = document.getElementById("dashboardData");
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #666;">
        <h3>No Companies Selected</h3>
        <p>Please select companies using the filters above to view financial data.</p>
      </div>
    `;
          return;
        }

        try {
          // Load consolidated data + enhanced metrics for selected companies
          const response = await fetch("/api/consolidated-trial-balance");
          const data = await response.json();

          // Enhanced matching logic (keeping the good parts from before)
          const selectedCompanies = [];
          const enhancedMetrics = [];

          for (const tenantId of activeCompanyFilters) {
            const connectedCompany = connectedCompanies.find(
              (c) => c.tenantId === tenantId
            );
            if (!connectedCompany) continue;

            // Find matching company data
            let matchedCompany = data.companies?.find(
              (company) => company.tenantId === tenantId
            );

            if (!matchedCompany) {
              matchedCompany = data.companies?.find((company) => {
                const companyName = company.tenantName.toLowerCase();
                const targetName = connectedCompany.tenantName.toLowerCase();
                return (
                  (companyName.includes("mining") &&
                    targetName.includes("mining")) ||
                  (companyName.includes("aboriginal") &&
                    targetName.includes("aboriginal")) ||
                  (companyName.includes("property") &&
                    targetName.includes("property"))
                );
              });
            }

            if (matchedCompany) {
              selectedCompanies.push(matchedCompany);

              // Load enhanced metrics for each selected company
              try {
                const orgName = getOrganizationName(
                  connectedCompany.tenantName
                );

                // Fetch multiple data sources in parallel
                const [cashResponse, ratiosResponse, profitLossResponse] =
                  await Promise.all([
                    fetch("/api/cash-position", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ organizationName: orgName }),
                    }).catch(() => null),

                    fetch("/api/financial-ratios", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ organizationName: orgName }),
                    }).catch(() => null),

                    fetch("/api/profit-loss-summary", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ organizationName: orgName }),
                    }).catch(() => null),
                  ]);

                // Read response text once and store it
                // Read response JSON once and store it with debugging
                let cashData = null,
                  ratiosData = null,
                  profitLossData = null;

                if (cashResponse) {
                  if (cashResponse.ok) {
                    cashData = await cashResponse.json();
                    console.log("Cash data for", orgName, ":", cashData);
                  } else {
                    console.error(
                      "Cash API error for",
                      orgName,
                      ":",
                      cashResponse.status,
                      await cashResponse.text()
                    );
                  }
                }

                if (ratiosResponse) {
                  if (ratiosResponse.ok) {
                    ratiosData = await ratiosResponse.json();
                    console.log("Ratios data for", orgName, ":", ratiosData);
                  } else {
                    console.error(
                      "Ratios API error for",
                      orgName,
                      ":",
                      ratiosResponse.status,
                      await ratiosResponse.text()
                    );
                  }
                }

                if (profitLossResponse) {
                  if (profitLossResponse.ok) {
                    profitLossData = await profitLossResponse.json();
                    console.log("P&L data for", orgName, ":", profitLossData);
                  } else {
                    console.error(
                      "P&L API error for",
                      orgName,
                      ":",
                      profitLossResponse.status,
                      await profitLossResponse.text()
                    );
                  }
                }

                // Parse enhanced metrics using stored text
                // Extract from JSON responses
                const enhancedData = {
                  tenantId: tenantId,
                  companyName: connectedCompany.tenantName,

                  // Basic financials from trial balance
                  totalAssets: matchedCompany.totals?.totalAssets || 0,
                  totalLiabilities: Math.abs(
                    matchedCompany.totals?.totalLiabilities || 0
                  ),
                  totalEquity: matchedCompany.totals?.totalEquity || 0,
                  balanced:
                    matchedCompany.balanceCheck?.debitsEqualCredits || false,

                  // Enhanced metrics from API responses
                  cashPosition: cashData?.totalCash || 0,
                  currentRatio:
                    ratiosData?.ratios?.liquidity?.currentRatio || 0,
                  debtToEquity: ratiosData?.ratios?.leverage?.debtToEquity || 0,
                  netProfitMargin:
                    ratiosData?.ratios?.profitability?.netProfitMargin || 0,
                  returnOnAssets:
                    ratiosData?.ratios?.profitability?.returnOnAssets || 0,
                  revenue: profitLossData?.summary?.totalRevenue || 0,
                  netProfit: profitLossData?.summary?.netProfit || 0,
                };
                enhancedMetrics.push(enhancedData);
              } catch (error) {
                console.error(
                  `Error loading enhanced metrics for ${connectedCompany.tenantName}:`,
                  error
                );
                enhancedMetrics.push({
                  tenantId: tenantId,
                  companyName: connectedCompany.tenantName,
                  totalAssets: matchedCompany.totals?.totalAssets || 0,
                  totalLiabilities: Math.abs(
                    matchedCompany.totals?.totalLiabilities || 0
                  ),
                  totalEquity: matchedCompany.totals?.totalEquity || 0,
                  balanced:
                    matchedCompany.balanceCheck?.debitsEqualCredits || false,
                  error: true,
                });
              }
            }
          }

          // Calculate consolidated totals
          const totals = enhancedMetrics.reduce(
            (acc, company) => {
              if (company.error) return acc;
              acc.totalAssets += company.totalAssets || 0;
              acc.totalLiabilities += company.totalLiabilities || 0;
              acc.totalEquity += company.totalEquity || 0;
              acc.totalCash += company.cashPosition || 0;
              acc.totalRevenue += company.revenue || 0;
              acc.totalProfit += company.netProfit || 0;
              return acc;
            },
            {
              totalAssets: 0,
              totalLiabilities: 0,
              totalEquity: 0,
              totalCash: 0,
              totalRevenue: 0,
              totalProfit: 0,
            }
          );

          const balancedCompanies = enhancedMetrics.filter(
            (c) => !c.error && c.balanced
          ).length;

          const dashboardElement = document.getElementById("dashboardData");
          dashboardElement.innerHTML = `
      <!-- ENHANCED FINANCIAL OVERVIEW -->
      <div class="dashboard-grid" style="grid-template-columns: repeat(3, 1fr);">
        
        <div class="dashboard-card">
          <h3>📊 Financial Position</h3>
          <div class="metric">
            <span>Total Assets</span>
            <span class="metric-value">$${totals.totalAssets.toLocaleString()}</span>
          </div>
          <div class="metric">
            <span>Total Liabilities</span>
            <span class="metric-value">$${totals.totalLiabilities.toLocaleString()}</span>
          </div>
          <div class="metric">
            <span>Net Equity</span>
            <span class="metric-value">$${totals.totalEquity.toLocaleString()}</span>
          </div>
          <div class="metric">
            <span>Net Worth</span>
            <span class="metric-value">$${(
              totals.totalAssets - totals.totalLiabilities
            ).toLocaleString()}</span>
          </div>
        </div>

        <div class="dashboard-card">
          <h3>💰 Cash & Performance</h3>
          <div class="metric">
            <span>Total Cash Position</span>
            <span class="metric-value">$${totals.totalCash.toLocaleString()}</span>
          </div>
          <div class="metric">
            <span>Annual Revenue</span>
            <span class="metric-value">$${totals.totalRevenue.toLocaleString()}</span>
          </div>
          <div class="metric">
            <span>Net Profit</span>
            <span class="metric-value ${
              totals.totalProfit > 0 ? "" : "negative"
            }">$${totals.totalProfit.toLocaleString()}</span>
          </div>
          <div class="metric">
            <span>Profit Margin</span>
            <span class="metric-value">${
              totals.totalRevenue > 0
                ? ((totals.totalProfit / totals.totalRevenue) * 100).toFixed(1)
                : 0
            }%</span>
          </div>
        </div>

        <div class="dashboard-card">
          <h3>⚖️ Health & Risk</h3>
          <div class="metric">
            <span>Companies</span>
            <span class="metric-value">${enhancedMetrics.length}</span>
          </div>
          <div class="metric">
            <span>Balanced Books</span>
            <span class="metric-value ${
              balancedCompanies === enhancedMetrics.length ? "" : "negative"
            }">${balancedCompanies}/${enhancedMetrics.length}</span>
          </div>
          <div class="metric">
            <span>Debt/Equity Ratio</span>
            <span class="metric-value">${
              totals.totalEquity > 0
                ? (totals.totalLiabilities / totals.totalEquity).toFixed(2)
                : "N/A"
            }</span>
          </div>
          <div class="metric">
            <span>Overall Status</span>
            <span class="metric-value ${
              balancedCompanies === enhancedMetrics.length ? "" : "negative"
            }">
              ${
                balancedCompanies === enhancedMetrics.length
                  ? "✅ Healthy"
                  : "⚠️ Review Needed"
              }
            </span>
          </div>
        </div>
      </div>

      <!-- COMPANY BREAKDOWN WITH ENHANCED METRICS -->
      <div class="dashboard-card">
        <h3>📈 Company Performance Breakdown</h3>
        ${enhancedMetrics
          .map(
            (company) => `
          <div style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 15px; margin: 10px 0; background: ${
            company.balanced ? "#f8fff8" : "#fff8f8"
          };">
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <strong style="font-size: 16px;">${company.companyName.replace(
                "Rirratjingu ",
                ""
              )}</strong>
              <span class="metric-value ${
                company.error ? "negative" : company.balanced ? "" : "negative"
              }" style="font-size: 14px;">
                ${
                  company.error
                    ? "⚠️ Data Error"
                    : company.balanced
                    ? "✅ Balanced"
                    : "❌ Imbalanced"
                }
              </span>
            </div>

            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; font-size: 13px;">
              <div>
                <div style="color: #666; margin-bottom: 3px;">Assets</div>
                <div style="font-weight: 600;">$${(
                  company.totalAssets || 0
                ).toLocaleString()}</div>
              </div>
              <div>
                <div style="color: #666; margin-bottom: 3px;">Revenue</div>
                <div style="font-weight: 600;">$${(
                  company.revenue || 0
                ).toLocaleString()}</div>
              </div>
              <div>
                <div style="color: #666; margin-bottom: 3px;">Net Profit</div>
                <div style="font-weight: 600; color: ${
                  (company.netProfit || 0) > 0 ? "#27ae60" : "#e74c3c"
                };">$${(company.netProfit || 0).toLocaleString()}</div>
              </div>
              <div>
                <div style="color: #666; margin-bottom: 3px;">Profit Margin</div>
                <div style="font-weight: 600;">${(
                  company.netProfitMargin || 0
                ).toFixed(1)}%</div>
              </div>
            </div>

            ${
              !company.error
                ? `
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; font-size: 13px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #f0f0f0;">
                <div>
                  <div style="color: #666; margin-bottom: 3px;">Cash Position</div>
                  <div style="font-weight: 600;">$${(
                    company.cashPosition || 0
                  ).toLocaleString()}</div>
                </div>
                <div>
                  <div style="color: #666; margin-bottom: 3px;">Current Ratio</div>
                  <div style="font-weight: 600;">${(
                    company.currentRatio || 0
                  ).toFixed(2)}</div>
                </div>
                <div>
                  <div style="color: #666; margin-bottom: 3px;">ROA</div>
                  <div style="font-weight: 600;">${(
                    company.returnOnAssets || 0
                  ).toFixed(1)}%</div>
                </div>
                <div>
                  <div style="color: #666; margin-bottom: 3px;">D/E Ratio</div>
                  <div style="font-weight: 600;">${(
                    company.debtToEquity || 0
                  ).toFixed(2)}</div>
                </div>
              </div>
            `
                : ""
            }
          </div>
        `
          )
          .join("")}
      </div>
    `;
        } catch (error) {
          console.error("Error in enhanced loadOverviewDataWithYoY:", error);
          const dashboardElement = document.getElementById("dashboardData");
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c;">
        <h3>Error Loading Enhanced Data</h3>
        <p>Failed to load dashboard data: ${error.message}</p>
        <button onclick="loadDashboardData()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Retry
        </button>
      </div>
    `;
        }
      }

      async function loadYearOverYearData() {
        if (activeCompanyFilters.length === 0) {
          const dashboardElement = document.getElementById("dashboardData");
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #666;">
        <h3>No Companies Selected</h3>
        <p>Please select companies using the filters above to view YoY analysis.</p>
      </div>
    `;
          return;
        }

        const dashboardElement = document.getElementById("dashboardData");
        const selectedCompanyNames = getSelectedCompanyNames();

        dashboardElement.innerHTML = `
    <div class="loading">
      <div class="loading-spinner"></div>
      Loading year-over-year analysis for ${
        activeCompanyFilters.length
      } companies:<br>
      <small>${selectedCompanyNames.join(", ")}</small>
    </div>
  `;

        try {
          // Calculate date ranges
          const currentYear = new Date().getFullYear();
          const priorYear = currentYear - 1;
          const currentYearEnd = `${currentYear}-12-31`;
          const priorYearEnd = `${priorYear}-12-31`;
          const currentDate = new Date().toISOString().split("T")[0];

          // Load YoY data for each selected company
          const yoyData = [];

          for (const tenantId of activeCompanyFilters) {
            const connectedCompany = connectedCompanies.find(
              (c) => c.tenantId === tenantId
            );
            if (!connectedCompany) continue;

            try {
              const orgName = getOrganizationName(connectedCompany.tenantName);

              // Get current year data
              const [currentTB, currentPL, currentCash] = await Promise.all([
                fetch("/api/trial-balance", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    organizationName: orgName,
                    reportDate: currentDate,
                  }),
                }),
                fetch("/api/profit-loss-summary", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    organizationName: orgName,
                    periodMonths: 12,
                  }),
                }),
                fetch("/api/cash-position", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ organizationName: orgName }),
                }),
              ]);

              // Get prior year data
              const [priorTB, priorPL] = await Promise.all([
                fetch("/api/trial-balance", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    organizationName: orgName,
                    reportDate: priorYearEnd,
                  }),
                }),
                fetch("/api/profit-loss-summary", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    organizationName: orgName,
                    date: priorYearEnd,
                    periodMonths: 12,
                  }),
                }),
              ]);

              // Parse responses
              const currentYearData = {
                tb: currentTB.ok ? await currentTB.json() : null,
                pl: currentPL.ok ? await currentPL.json() : null,
                cash: currentCash.ok ? await currentCash.json() : null,
              };

              const priorYearData = {
                tb: priorTB.ok ? await priorTB.json() : null,
                pl: priorPL.ok ? await priorPL.json() : null,
              };

              // Calculate YoY metrics
              const yoyMetrics = calculateYoYMetrics(
                currentYearData,
                priorYearData,
                connectedCompany.tenantName
              );
              yoyData.push(yoyMetrics);
            } catch (error) {
              console.error(
                `Error loading YoY data for ${connectedCompany.tenantName}:`,
                error
              );
              yoyData.push({
                companyName: connectedCompany.tenantName,
                error: true,
                errorMessage: error.message,
              });
            }
          }

          // Calculate consolidated YoY metrics
          const consolidatedYoY = calculateConsolidatedYoY(yoyData);

          // Render YoY dashboard
          renderYoYDashboard(yoyData, consolidatedYoY, currentYear, priorYear);
        } catch (error) {
          console.error("Error in YoY analysis:", error);
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c;">
        <h3>Error Loading YoY Data</h3>
        <p>Failed to load year-over-year analysis: ${error.message}</p>
        <button onclick="loadDashboardData()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Retry
        </button>
      </div>
    `;
        }
      }

      // 3. Calculate YoY metrics for individual company
      function calculateYoYMetrics(currentData, priorData, companyName) {
        const current = {
          assets: currentData.tb?.trialBalance?.totals?.totalAssets || 0,
          liabilities:
            currentData.tb?.trialBalance?.totals?.totalLiabilities || 0,
          equity: currentData.tb?.trialBalance?.totals?.totalEquity || 0,
          revenue: currentData.pl?.summary?.totalRevenue || 0,
          expenses: currentData.pl?.summary?.totalExpenses || 0,
          netProfit: currentData.pl?.summary?.netProfit || 0,
          cashPosition: currentData.cash?.totalCash || 0,
        };

        const prior = {
          assets: priorData.tb?.trialBalance?.totals?.totalAssets || 0,
          liabilities:
            priorData.tb?.trialBalance?.totals?.totalLiabilities || 0,
          equity: priorData.tb?.trialBalance?.totals?.totalEquity || 0,
          revenue: priorData.pl?.summary?.totalRevenue || 0,
          expenses: priorData.pl?.summary?.totalExpenses || 0,
          netProfit: priorData.pl?.summary?.netProfit || 0,
        };

        // Calculate growth rates
        const growth = {
          assets: calculateGrowthRate(prior.assets, current.assets),
          liabilities: calculateGrowthRate(
            prior.liabilities,
            current.liabilities
          ),
          equity: calculateGrowthRate(prior.equity, current.equity),
          revenue: calculateGrowthRate(prior.revenue, current.revenue),
          expenses: calculateGrowthRate(prior.expenses, current.expenses),
          netProfit: calculateGrowthRate(prior.netProfit, current.netProfit),
        };

        return {
          companyName: companyName.replace("Rirratjingu ", ""),
          current,
          prior,
          growth,
          profitMarginCurrent:
            current.revenue > 0
              ? (current.netProfit / current.revenue) * 100
              : 0,
          profitMarginPrior:
            prior.revenue > 0 ? (prior.netProfit / prior.revenue) * 100 : 0,
        };
      }

      // 4. Calculate growth rate with proper handling of negative numbers
      function calculateGrowthRate(prior, current) {
        if (prior === 0 && current === 0) return 0;
        if (prior === 0) return current > 0 ? 100 : -100;
        return ((current - prior) / Math.abs(prior)) * 100;
      }

      // 5. Calculate consolidated YoY metrics
      function calculateConsolidatedYoY(yoyData) {
        const validData = yoyData.filter((d) => !d.error);

        const consolidatedCurrent = validData.reduce(
          (acc, company) => {
            acc.assets += company.current.assets;
            acc.liabilities += company.current.liabilities;
            acc.equity += company.current.equity;
            acc.revenue += company.current.revenue;
            acc.expenses += company.current.expenses;
            acc.netProfit += company.current.netProfit;
            acc.cashPosition += company.current.cashPosition;
            return acc;
          },
          {
            assets: 0,
            liabilities: 0,
            equity: 0,
            revenue: 0,
            expenses: 0,
            netProfit: 0,
            cashPosition: 0,
          }
        );

        const consolidatedPrior = validData.reduce(
          (acc, company) => {
            acc.assets += company.prior.assets;
            acc.liabilities += company.prior.liabilities;
            acc.equity += company.prior.equity;
            acc.revenue += company.prior.revenue;
            acc.expenses += company.prior.expenses;
            acc.netProfit += company.prior.netProfit;
            return acc;
          },
          {
            assets: 0,
            liabilities: 0,
            equity: 0,
            revenue: 0,
            expenses: 0,
            netProfit: 0,
          }
        );

        return {
          current: consolidatedCurrent,
          prior: consolidatedPrior,
          growth: {
            assets: calculateGrowthRate(
              consolidatedPrior.assets,
              consolidatedCurrent.assets
            ),
            liabilities: calculateGrowthRate(
              consolidatedPrior.liabilities,
              consolidatedCurrent.liabilities
            ),
            equity: calculateGrowthRate(
              consolidatedPrior.equity,
              consolidatedCurrent.equity
            ),
            revenue: calculateGrowthRate(
              consolidatedPrior.revenue,
              consolidatedCurrent.revenue
            ),
            expenses: calculateGrowthRate(
              consolidatedPrior.expenses,
              consolidatedCurrent.expenses
            ),
            netProfit: calculateGrowthRate(
              consolidatedPrior.netProfit,
              consolidatedCurrent.netProfit
            ),
          },
        };
      }

      // 6. Render YoY dashboard
      function renderYoYDashboard(
        yoyData,
        consolidatedYoY,
        currentYear,
        priorYear
      ) {
        const dashboardElement = document.getElementById("dashboardData");

        dashboardElement.innerHTML = `
    <!-- CONSOLIDATED YoY SUMMARY -->
    <div class="dashboard-grid" style="grid-template-columns: repeat(3, 1fr);">
      
      <div class="dashboard-card">
        <h3>📊 Asset Growth Analysis</h3>
        <div class="metric">
          <span>${currentYear} Assets</span>
          <span class="metric-value">$${consolidatedYoY.current.assets.toLocaleString()}</span>
        </div>
        <div class="metric">
          <span>${priorYear} Assets</span>
          <span class="metric-value">$${consolidatedYoY.prior.assets.toLocaleString()}</span>
        </div>
        <div class="metric">
          <span>Asset Growth</span>
          <span class="metric-value ${
            consolidatedYoY.growth.assets >= 0 ? "" : "negative"
          }">
            ${
              consolidatedYoY.growth.assets >= 0 ? "+" : ""
            }${consolidatedYoY.growth.assets.toFixed(1)}%
          </span>
        </div>
        <div class="metric">
          <span>Net Worth Change</span>
          <span class="metric-value ${
            consolidatedYoY.growth.equity >= 0 ? "" : "negative"
          }">
            ${
              consolidatedYoY.growth.equity >= 0 ? "+" : ""
            }${consolidatedYoY.growth.equity.toFixed(1)}%
          </span>
        </div>
      </div>

      <div class="dashboard-card">
        <h3>💰 Revenue Performance</h3>
        <div class="metric">
          <span>${currentYear} Revenue</span>
          <span class="metric-value">$${consolidatedYoY.current.revenue.toLocaleString()}</span>
        </div>
        <div class="metric">
          <span>${priorYear} Revenue</span>
          <span class="metric-value">$${consolidatedYoY.prior.revenue.toLocaleString()}</span>
        </div>
        <div class="metric">
          <span>Revenue Growth</span>
          <span class="metric-value ${
            consolidatedYoY.growth.revenue >= 0 ? "" : "negative"
          }">
            ${
              consolidatedYoY.growth.revenue >= 0 ? "+" : ""
            }${consolidatedYoY.growth.revenue.toFixed(1)}%
          </span>
        </div>
        <div class="metric">
          <span>Profit Growth</span>
          <span class="metric-value ${
            consolidatedYoY.growth.netProfit >= 0 ? "" : "negative"
          }">
            ${
              consolidatedYoY.growth.netProfit >= 0 ? "+" : ""
            }${consolidatedYoY.growth.netProfit.toFixed(1)}%
          </span>
        </div>
      </div>

      <div class="dashboard-card">
        <h3>⚖️ Financial Health Trends</h3>
        <div class="metric">
          <span>Companies Analyzed</span>
          <span class="metric-value">${
            yoyData.filter((d) => !d.error).length
          }</span>
        </div>
        <div class="metric">
          <span>Current Profit Margin</span>
          <span class="metric-value">
            ${
              consolidatedYoY.current.revenue > 0
                ? (
                    (consolidatedYoY.current.netProfit /
                      consolidatedYoY.current.revenue) *
                    100
                  ).toFixed(1)
                : 0
            }%
          </span>
        </div>
        <div class="metric">
          <span>Prior Profit Margin</span>
          <span class="metric-value">
            ${
              consolidatedYoY.prior.revenue > 0
                ? (
                    (consolidatedYoY.prior.netProfit /
                      consolidatedYoY.prior.revenue) *
                    100
                  ).toFixed(1)
                : 0
            }%
          </span>
        </div>
        <div class="metric">
          <span>Overall Trend</span>
          <span class="metric-value ${
            consolidatedYoY.growth.revenue > 0 &&
            consolidatedYoY.growth.netProfit > 0
              ? ""
              : "negative"
          }">
            ${
              consolidatedYoY.growth.revenue > 0 &&
              consolidatedYoY.growth.netProfit > 0
                ? "✅ Growing"
                : "⚠️ Declining"
            }
          </span>
        </div>
      </div>
    </div>

    <!-- COMPANY-BY-COMPANY YoY ANALYSIS -->
    <div class="dashboard-card">
      <h3>📈 Company Performance Comparison (${currentYear} vs ${priorYear})</h3>
      ${yoyData
        .map((company) => {
          if (company.error) {
            return `
            <div style="border: 1px solid #e74c3c; border-radius: 6px; padding: 15px; margin: 10px 0; background: #fff5f5;">
              <strong style="color: #e74c3c;">${company.companyName}</strong>
              <div style="color: #666; margin-top: 5px;">Error loading YoY data: ${company.errorMessage}</div>
            </div>
          `;
          }

          return `
          <div style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 15px; margin: 10px 0; background: #fafafa;">
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <strong style="font-size: 16px;">${company.companyName}</strong>
              <div style="display: flex; gap: 15px; font-size: 14px;">
                <span style="color: ${
                  company.growth.revenue >= 0 ? "#27ae60" : "#e74c3c"
                };">
                  Revenue: ${
                    company.growth.revenue >= 0 ? "+" : ""
                  }${company.growth.revenue.toFixed(1)}%
                </span>
                <span style="color: ${
                  company.growth.netProfit >= 0 ? "#27ae60" : "#e74c3c"
                };">
                  Profit: ${
                    company.growth.netProfit >= 0 ? "+" : ""
                  }${company.growth.netProfit.toFixed(1)}%
                </span>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; font-size: 13px;">
              <div>
                <div style="color: #666; margin-bottom: 3px;">${currentYear} Revenue</div>
                <div style="font-weight: 600;">$${company.current.revenue.toLocaleString()}</div>
              </div>
              <div>
                <div style="color: #666; margin-bottom: 3px;">${priorYear} Revenue</div>
                <div style="font-weight: 600;">$${company.prior.revenue.toLocaleString()}</div>
              </div>
              <div>
                <div style="color: #666; margin-bottom: 3px;">${currentYear} Profit</div>
                <div style="font-weight: 600; color: ${
                  company.current.netProfit >= 0 ? "#27ae60" : "#e74c3c"
                };">
                  $${company.current.netProfit.toLocaleString()}
                </div>
              </div>
              <div>
                <div style="color: #666; margin-bottom: 3px;">${priorYear} Profit</div>
                <div style="font-weight: 600; color: ${
                  company.prior.netProfit >= 0 ? "#27ae60" : "#e74c3c"
                };">
                  $${company.prior.netProfit.toLocaleString()}
                </div>
              </div>
              <div>
                <div style="color: #666; margin-bottom: 3px;">Margin ${currentYear}</div>
                <div style="font-weight: 600;">${company.profitMarginCurrent.toFixed(
                  1
                )}%</div>
              </div>
              <div>
                <div style="color: #666; margin-bottom: 3px;">Margin ${priorYear}</div>
                <div style="font-weight: 600;">${company.profitMarginPrior.toFixed(
                  1
                )}%</div>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; font-size: 13px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0;">
              <div>
                <div style="color: #666; margin-bottom: 3px;">Asset Growth</div>
                <div style="font-weight: 600; color: ${
                  company.growth.assets >= 0 ? "#27ae60" : "#e74c3c"
                };">
                  ${
                    company.growth.assets >= 0 ? "+" : ""
                  }${company.growth.assets.toFixed(1)}%
                </div>
              </div>
              <div>
                <div style="color: #666; margin-bottom: 3px;">Equity Growth</div>
                <div style="font-weight: 600; color: ${
                  company.growth.equity >= 0 ? "#27ae60" : "#e74c3c"
                };">
                  ${
                    company.growth.equity >= 0 ? "+" : ""
                  }${company.growth.equity.toFixed(1)}%
                </div>
              </div>
              <div>
                <div style="color: #666; margin-bottom: 3px;">Overall Status</div>
                <div style="font-weight: 600; color: ${
                  company.growth.revenue > 0 && company.growth.netProfit > 0
                    ? "#27ae60"
                    : company.growth.revenue > 0
                    ? "#f39c12"
                    : "#e74c3c"
                };">
                  ${
                    company.growth.revenue > 0 && company.growth.netProfit > 0
                      ? "Strong Growth"
                      : company.growth.revenue > 0
                      ? "Mixed Results"
                      : "Declining"
                  }
                </div>
              </div>
            </div>
          </div>
        `;
        })
        .join("")}
    </div>

    <!-- YoY INSIGHTS -->
    <div class="dashboard-card">
      <h3>💡 Key Year-over-Year Insights</h3>
      <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 10px 0;">
        ${generateYoYInsights(consolidatedYoY, yoyData)}
      </div>
    </div>
  `;
      }

      function debugDropdown() {
        const select = document.getElementById("yearSelect");
        console.log("All dropdown options:");
        for (let i = 0; i < select.options.length; i++) {
          console.log(
            `Option ${i}: value="${select.options[i].value}" text="${select.options[i].text}"`
          );
        }
      }

      // 7. Generate insights based on YoY data
      function generateYoYInsights(consolidatedYoY, yoyData) {
        const insights = [];
        const validCompanies = yoyData.filter((d) => !d.error);

        // Revenue insights
        if (consolidatedYoY.growth.revenue > 10) {
          insights.push(
            `<strong>Strong Revenue Growth:</strong> Consolidated revenue increased by ${consolidatedYoY.growth.revenue.toFixed(
              1
            )}%, indicating robust business expansion.`
          );
        } else if (consolidatedYoY.growth.revenue < -5) {
          insights.push(
            `<strong>Revenue Decline:</strong> Consolidated revenue decreased by ${Math.abs(
              consolidatedYoY.growth.revenue
            ).toFixed(1)}%, requiring strategic attention.`
          );
        }

        // Profit insights
        if (consolidatedYoY.growth.netProfit > 15) {
          insights.push(
            `<strong>Excellent Profitability:</strong> Net profit growth of ${consolidatedYoY.growth.netProfit.toFixed(
              1
            )}% demonstrates strong operational efficiency.`
          );
        } else if (consolidatedYoY.growth.netProfit < -10) {
          insights.push(
            `<strong>Profitability Concerns:</strong> Net profit declined by ${Math.abs(
              consolidatedYoY.growth.netProfit
            ).toFixed(1)}%, suggesting need for cost management review.`
          );
        }

        // Company performance insights
        const growingCompanies = validCompanies.filter(
          (c) => c.growth.revenue > 0 && c.growth.netProfit > 0
        );
        const decliningCompanies = validCompanies.filter(
          (c) => c.growth.revenue < 0 || c.growth.netProfit < 0
        );

        if (growingCompanies.length > 0) {
          insights.push(
            `<strong>High Performers:</strong> ${growingCompanies
              .map((c) => c.companyName)
              .join(", ")} showing positive growth in both revenue and profit.`
          );
        }

        if (decliningCompanies.length > 0) {
          insights.push(
            `<strong>Areas for Review:</strong> ${decliningCompanies
              .map((c) => c.companyName)
              .join(", ")} may require strategic intervention.`
          );
        }

        // Asset growth insights
        if (consolidatedYoY.growth.assets > 5) {
          insights.push(
            `<strong>Asset Expansion:</strong> ${consolidatedYoY.growth.assets.toFixed(
              1
            )}% asset growth indicates successful capital investment and business development.`
          );
        }

        return insights.length > 0
          ? insights.join("<br><br>")
          : "Analyzing year-over-year trends...";
      }

      // Monthly Analysis Functions
      async function loadMonthlyAnalysisData() {
        if (activeCompanyFilters.length === 0) {
          const dashboardElement = document.getElementById("dashboardData");
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #666;">
        <h3>No Companies Selected</h3>
        <p>Please select companies using the filters above to view monthly analysis.</p>
      </div>
    `;
          return;
        }

        const dashboardElement = document.getElementById("dashboardData");
        const selectedCompanyNames = getSelectedCompanyNames();

        dashboardElement.innerHTML = `
    <div class="loading">
      <div class="loading-spinner"></div>
      Loading monthly analysis for ${activeCompanyFilters.length} companies:<br>
      <small>${selectedCompanyNames.join(", ")}</small>
    </div>
  `;

        try {
          // Load monthly data for each selected company
          const monthlyDataResults = [];

          for (const tenantId of activeCompanyFilters) {
            const connectedCompany = connectedCompanies.find(
              (c) => c.tenantId === tenantId
            );
            if (!connectedCompany) continue;

            const orgName = getOrganizationName(connectedCompany.tenantName);

            const response = await fetch("/api/monthly-pl-report", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                organizationName: orgName,
                year: selectedYear - 1, // Request previous calendar year for FY data
              }),
            });

            if (response.ok) {
              const data = await response.json();
              monthlyDataResults.push({
                companyName: connectedCompany.tenantName.replace(
                  "Rirratjingu ",
                  ""
                ),
                ...data.data,
              });
            }
          }

          if (monthlyDataResults.length === 0) {
            throw new Error("No monthly data available for selected companies");
          }

          // Render monthly analysis dashboard
          renderSimpleMonthlyAnalysis(monthlyDataResults);
        } catch (error) {
          console.error("Error loading monthly analysis:", error);
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c;">
        <h3>Error Loading Monthly Analysis</h3>
        <p>Failed to load monthly data: ${error.message}</p>
        <button onclick="loadDashboardData()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Retry
        </button>
      </div>
    `;
        }
      }

      // Replace your complex renderMonthlyAnalysisDashboard function with this simple version
      function renderSimpleMonthlyAnalysis(monthlyDataResults) {
        const dashboardElement = document.getElementById("dashboardData");

        // Process each company separately
        let html = "";

        monthlyDataResults.forEach((companyData) => {
          // Calculate totals from monthly data for verification
          let calculatedRevenue = 0;
          let calculatedExpenses = 0;
          let calculatedProfit = 0;

          companyData.months.forEach((month) => {
            calculatedRevenue += month.revenue.total;
            calculatedExpenses += month.expenses.total;
            calculatedProfit += month.netProfit;
          });

          html += `
      <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="color: #2c3e50; margin-bottom: 15px;">${
          companyData.organization
        } - ${companyData.year}</h3>
        
        <!-- YTD Summary Box -->
        <div style="background: #f8f9fa; padding: 15px; margin-bottom: 20px; border-radius: 6px;">
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; text-align: center;">
            <div>
              <div style="font-size: 1.4em; font-weight: bold; color: #27ae60;">$${companyData.cytd.totalRevenue.toLocaleString()}</div>
              <div style="color: #666;">YTD Revenue</div>
            </div>
            <div>
              <div style="font-size: 1.4em; font-weight: bold; color: #e74c3c;">$${companyData.cytd.totalExpenses.toLocaleString()}</div>
              <div style="color: #666;">YTD Expenses</div>
            </div>
            <div>
              <div style="font-size: 1.4em; font-weight: bold; color: ${
                companyData.cytd.netProfit >= 0 ? "#27ae60" : "#e74c3c"
              };">$${companyData.cytd.netProfit.toLocaleString()}</div>
              <div style="color: #666;">YTD Net Profit</div>
            </div>
          </div>
          <div style="text-align: center; margin-top: 10px; color: #666;">
            Profit Margin: ${companyData.cytd.profitMargin.toFixed(
              1
            )}% | Months with Data: ${companyData.cytd.monthsIncluded}
          </div>
        </div>
        
        <!-- Monthly Breakdown Table -->
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
            <thead>
              <tr style="background: #f8f9fa;">
                <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">Month</th>
                <th style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Revenue</th>
                <th style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Expenses</th>
                <th style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Net Profit</th>
                <th style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Margin %</th>
              </tr>
            </thead>
            <tbody>
              ${companyData.months
                .map(
                  (month) => `
                <tr style="border-bottom: 1px solid #f0f0f0;">
                  <td style="padding: 8px 10px; border: 1px solid #f0f0f0;">${
                    month.monthName
                  }</td>
                  <td style="padding: 8px 10px; text-align: right; border: 1px solid #f0f0f0;">$${month.revenue.total.toLocaleString()}</td>
                  <td style="padding: 8px 10px; text-align: right; border: 1px solid #f0f0f0;">$${month.expenses.total.toLocaleString()}</td>
                  <td style="padding: 8px 10px; text-align: right; border: 1px solid #f0f0f0; color: ${
                    month.netProfit >= 0 ? "#27ae60" : "#e74c3c"
                  }; font-weight: 600;">
                    $${month.netProfit.toLocaleString()}
                  </td>
                  <td style="padding: 8px 10px; text-align: right; border: 1px solid #f0f0f0;">
                    ${
                      month.revenue.total > 0
                        ? (
                            (month.netProfit / month.revenue.total) *
                            100
                          ).toFixed(1)
                        : "0.0"
                    }%
                  </td>
                </tr>
              `
                )
                .join("")}
              
              <!-- TOTALS ROW FOR RECONCILIATION -->
              <tr style="background: #e8f4f8; border-top: 2px solid #3498db; font-weight: bold;">
                <td style="padding: 10px; border: 1px solid #3498db;">CALCULATED TOTALS</td>
                <td style="padding: 10px; text-align: right; border: 1px solid #3498db; color: #27ae60;">
                  $${calculatedRevenue.toLocaleString()}
                </td>
                <td style="padding: 10px; text-align: right; border: 1px solid #3498db; color: #e74c3c;">
                  $${calculatedExpenses.toLocaleString()}
                </td>
                <td style="padding: 10px; text-align: right; border: 1px solid #3498db; color: ${
                  calculatedProfit >= 0 ? "#27ae60" : "#e74c3c"
                };">
                  $${calculatedProfit.toLocaleString()}
                </td>
                <td style="padding: 10px; text-align: right; border: 1px solid #3498db;">
                  ${
                    calculatedRevenue > 0
                      ? ((calculatedProfit / calculatedRevenue) * 100).toFixed(
                          1
                        )
                      : "0.0"
                  }%
                </td>
              </tr>
              
              <!-- RECONCILIATION CHECK -->
              <tr style="background: ${
                Math.abs(calculatedRevenue - companyData.cytd.totalRevenue) <
                  1 &&
                Math.abs(calculatedExpenses - companyData.cytd.totalExpenses) <
                  1 &&
                Math.abs(calculatedProfit - companyData.cytd.netProfit) < 1
                  ? "#d4edda"
                  : "#f8d7da"
              };">
                <td style="padding: 10px; font-weight: bold;">RECONCILIATION</td>
                <td style="padding: 10px; text-align: right; font-size: 12px;">
                  ${
                    Math.abs(
                      calculatedRevenue - companyData.cytd.totalRevenue
                    ) < 1
                      ? "✅ Match"
                      : `❌ Diff: $${(
                          calculatedRevenue - companyData.cytd.totalRevenue
                        ).toLocaleString()}`
                  }
                </td>
                <td style="padding: 10px; text-align: right; font-size: 12px;">
                  ${
                    Math.abs(
                      calculatedExpenses - companyData.cytd.totalExpenses
                    ) < 1
                      ? "✅ Match"
                      : `❌ Diff: $${(
                          calculatedExpenses - companyData.cytd.totalExpenses
                        ).toLocaleString()}`
                  }
                </td>
                <td style="padding: 10px; text-align: right; font-size: 12px;">
                  ${
                    Math.abs(calculatedProfit - companyData.cytd.netProfit) < 1
                      ? "✅ Match"
                      : `❌ Diff: $${(
                          calculatedProfit - companyData.cytd.netProfit
                        ).toLocaleString()}`
                  }
                </td>
                <td style="padding: 10px; text-align: right; font-size: 12px;">
                  ${
                    Math.abs(
                      calculatedRevenue - companyData.cytd.totalRevenue
                    ) < 1
                      ? "✅"
                      : "❌"
                  }
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    `;
        });

        dashboardElement.innerHTML = html;
      }

      // Update your loadMonthlyAnalysisData function to call this simpler version:
      // Replace the call to renderMonthlyAnalysisDashboard(monthlyDataResults);
      // With: renderSimpleMonthlyAnalysis(monthlyDataResults);

      function calculateConsolidatedMonthlyData(monthlyDataResults) {
        if (monthlyDataResults.length === 0) return null;

        // Initialize consolidated data structure
        const consolidated = {
          year: monthlyDataResults[0].year,
          totalRevenue: 0,
          totalExpenses: 0,
          netProfit: 0,
          profitMargin: 0,
          monthsIncluded: 0,
          months: [],
        };

        // Initialize Financial Year months (July to June)
        const fyMonthNames = [
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
        ];

        for (let i = 0; i < 12; i++) {
          // For FY 2025: July-Dec 2024, Jan-June 2025
          const isFirstHalf = i < 6; // July-December
          const calendarYear = isFirstHalf
            ? consolidated.year - 1
            : consolidated.year;
          const calendarMonth = isFirstHalf ? i + 7 : i - 5; // Map FY index to calendar month

          consolidated.months.push({
            month: `${calendarYear}-${calendarMonth
              .toString()
              .padStart(2, "0")}`,
            monthName: fyMonthNames[i],
            fyIndex: i, // Track FY position
            revenue: 0,
            expenses: 0,
            netProfit: 0,
            profitMargin: 0,
          });
        }

        // Aggregate data from all companies
        monthlyDataResults.forEach((company) => {
          consolidated.totalRevenue += company.cytd.totalRevenue;
          consolidated.totalExpenses += company.cytd.totalExpenses;
          consolidated.netProfit += company.cytd.netProfit;

          // Map calendar year data to financial year structure
          company.months.forEach((monthData) => {
            // Extract calendar month from monthData (e.g., "2024-07" = July 2024)
            const [dataYear, dataMonth] = monthData.month
              .split("-")
              .map(Number);

            // Find corresponding FY index
            let fyIndex = -1;
            if (dataMonth >= 7) {
              // July-December (first half of FY)
              fyIndex = dataMonth - 7;
            } else {
              // January-June (second half of FY)
              fyIndex = dataMonth + 5;
            }

            // Add to consolidated data if we have a valid FY index
            if (fyIndex >= 0 && fyIndex < 12) {
              consolidated.months[fyIndex].revenue += monthData.revenue.total;
              consolidated.months[fyIndex].expenses += monthData.expenses.total;
              consolidated.months[fyIndex].netProfit += monthData.netProfit;
            }
          });
        });

        // Calculate consolidated profit margin
        consolidated.profitMargin =
          consolidated.totalRevenue > 0
            ? (consolidated.netProfit / consolidated.totalRevenue) * 100
            : 0;

        // Calculate month profit margins and count months with data
        consolidated.months.forEach((month) => {
          month.profitMargin =
            month.revenue > 0 ? (month.netProfit / month.revenue) * 100 : 0;
        });

        // Count months with data
        consolidated.monthsIncluded = consolidated.months.filter(
          (m) => m.revenue > 0
        ).length;

        return consolidated;
      }

      // Event handlers for monthly analysis
      function handleMonthlyViewChange() {
        const viewMode = document.getElementById("monthlyViewMode").value;
        const monthSelector = document.getElementById("monthSelector");

        if (viewMode === "monthly") {
          monthSelector.style.display = "block";
        } else {
          monthSelector.style.display = "none";
          document.getElementById("monthSelect").value = "";
          // Show full year view
        }
        // Add this line to refresh the display
        loadDashboardData();
      }

      function handleMonthSelection() {
        const selectedMonth = document.getElementById("monthSelect").value;
        if (selectedMonth) {
          // Show specific month detail
          showMonthDetailView(selectedMonth);
        }
      }

      function handleYearChange() {
        const year = document.getElementById("yearSelect").value;
        selectedYear = parseInt(year);
        console.log("Year changed to:", selectedYear); // Add this
        // Update the dropdown display to match the selected value
        document.getElementById("yearSelect").value = year;
        loadDashboardData(); // This should reload with new year
      }

      function showMonthDetail(monthCode, monthName) {
        // Switch to monthly view mode
        document.getElementById("monthlyViewMode").value = "monthly";
        document.getElementById("monthSelector").style.display = "block";
        document.getElementById("monthSelect").value = monthCode.split("-")[1];

        showMonthDetailView(monthCode.split("-")[1]);
      }

      function showMonthDetailView(monthNumber) {
        // Update metrics to show single month
        // This would filter the display to show only the selected month's data
        console.log("Showing detail for month:", monthNumber);
        // Implementation would update the metrics display to show single month
      }

      function createMonthlyTrendChart(consolidatedData) {
        const canvas = document.getElementById("monthlyTrendChart");
        if (!canvas) return;

        const ctx = canvas.getContext("2d");

        // Destroy existing chart if it exists
        if (window.monthlyChart) {
          window.monthlyChart.destroy();
        }

        const labels = consolidatedData.months.map((m) =>
          m.monthName.substring(0, 3)
        );
        const revenue = consolidatedData.months.map((m) => m.revenue);
        const expenses = consolidatedData.months.map((m) => m.expenses);
        const profit = consolidatedData.months.map((m) => m.netProfit);

        window.monthlyChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Revenue",
                data: revenue,
                borderColor: "#3498db",
                backgroundColor: "rgba(52, 152, 219, 0.1)",
                fill: false,
                tension: 0.4,
                pointBackgroundColor: "#3498db",
                pointBorderColor: "#2980b9",
                pointBorderWidth: 2,
                pointRadius: 4,
              },
              {
                label: "Expenses",
                data: expenses,
                borderColor: "#e74c3c",
                backgroundColor: "rgba(231, 76, 60, 0.1)",
                fill: false,
                tension: 0.4,
                pointBackgroundColor: "#e74c3c",
                pointBorderColor: "#c0392b",
                pointBorderWidth: 2,
                pointRadius: 4,
              },
              {
                label: "Net Profit",
                data: profit,
                borderColor: "#27ae60",
                backgroundColor: "rgba(39, 174, 96, 0.1)",
                fill: false,
                tension: 0.4,
                pointBackgroundColor: "#27ae60",
                pointBorderColor: "#229954",
                pointBorderWidth: 2,
                pointRadius: 4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: false,
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return (
                      context.dataset.label +
                      ": $" +
                      context.parsed.y.toLocaleString()
                    );
                  },
                },
              },
              legend: {
                position: "top",
              },
            },
            scales: {
              y: {
                beginAtZero: false,
                ticks: {
                  callback: function (value) {
                    return "$" + (value / 1000000).toFixed(1) + "M";
                  },
                },
              },
            },
            interaction: {
              intersect: false,
              mode: "index",
            },
          },
        });
      }

      // ====== HELPER FUNCTIONS FOR PARSING MCP RESPONSES ======

      function getOrganizationName(tenantName) {
        if (tenantName.includes("Mining")) return "Mining";
        if (tenantName.includes("Aboriginal Corporation"))
          return "Aboriginal Corporation";
        if (tenantName.includes("Property")) return "Property";
        if (tenantName.includes("Enterprises")) return "Enterprises";
        if (tenantName.includes("Invest")) return "Invest";
        if (tenantName.includes("Ngarrkuwuy")) return "Ngarrkuwuy";
        if (tenantName.includes("Marrin")) return "Marrin";
        return "Unknown";
      }

      async function loadTrialBalanceData() {
        if (activeCompanyFilters.length === 0) {
          const dashboardElement = document.getElementById("dashboardData");
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #666;">
        <h3>No Companies Selected</h3>
        <p>Please select companies using the filters above to view trial balance.</p>
      </div>
    `;
          return;
        }

        const dashboardElement = document.getElementById("dashboardData");
        dashboardElement.innerHTML = `
    <div class="loading">
      <div class="loading-spinner"></div>
      Loading detailed trial balance data...
    </div>
  `;

        try {
          const trialBalanceData = [];

          for (const tenantId of activeCompanyFilters) {
            const connectedCompany = connectedCompanies.find(
              (c) => c.tenantId === tenantId
            );
            if (!connectedCompany) continue;

            const orgName = getOrganizationName(connectedCompany.tenantName);

            const response = await fetch("/api/trial-balance", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ organizationName: orgName }),
            });

            if (response.ok) {
              const data = await response.json();
              trialBalanceData.push({
                companyName: connectedCompany.tenantName.replace(
                  "Rirratjingu ",
                  ""
                ),
                ...data,
              });
            }
          }

          // Render detailed trial balance
          dashboardElement.innerHTML = `
      ${trialBalanceData
        .map(
          (company) => `
        <div class="dashboard-card">
          <h3>${company.companyName} - Trial Balance</h3>
          <div style="margin-bottom: 15px;">
            <strong>Status:</strong> 
            <span style="color: ${
              company.balanceCheck.debitsEqualCredits ? "#27ae60" : "#e74c3c"
            };">
              ${
                company.balanceCheck.debitsEqualCredits
                  ? "✅ Balanced"
                  : "⚠️ Out of Balance"
              }
            </span>
            ${
              !company.balanceCheck.debitsEqualCredits
                ? `<span style="margin-left: 10px; color: #e74c3c;">
                Difference: $${company.balanceCheck.difference.toLocaleString()}
              </span>`
                : ""
            }
          </div>

          <div style="display: grid; grid-template-columns: repeat(3, minmax(300px, 1fr)); gap: 20px; align-items: start;">
            <div>
              <h4>Assets (${company.trialBalance.assets.length} accounts)</h4>
              <div style="overflow: visible;">
                ${company.trialBalance.assets
                  .map(
                    (account) => `
                  <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #f0f0f0;">
  <span style="font-size: 13px; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 10px;">${
    account.name
  }</span>
  <span style="font-weight: 600; white-space: nowrap;">$${account.balance.toLocaleString()}</span>
</div>
                `
                  )
                  .join("")}
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-top: 2px solid #27ae60; font-weight: bold; color: #27ae60;">
                  <span>Total Assets</span>
                  <span>$${company.trialBalance.totals.totalAssets.toLocaleString()}</span>
                </div>
              </div>
            </div>

            <div>
  <h4>Liabilities (${company.trialBalance.liabilities.length} accounts)</h4>
  <div style="overflow: visible;">
    ${company.trialBalance.liabilities
      .map(
        (account) => `
      <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #f0f0f0;">
        <span style="font-size: 13px; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 10px;">${
          account.name
        }</span>
        <span style="font-weight: 600; white-space: nowrap;">$${account.balance.toLocaleString()}</span>
      </div>
    `
      )
      .join("")}
    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-top: 2px solid #e74c3c; font-weight: bold; color: #e74c3c;">
      <span>Total Liabilities</span>
      <span>$${company.trialBalance.totals.totalLiabilities.toLocaleString()}</span>
    </div>
  </div>
</div>
            <div>
              <h4>Equity (${company.trialBalance.equity.length} accounts)</h4>
              <div style="overflow: visible;">
                ${company.trialBalance.equity
                  .map(
                    (account) => `
                  <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #f0f0f0;">
        <span style="font-size: 13px; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 10px;">${
          account.name
        }</span>
        <span style="font-weight: 600; white-space: nowrap;">$${account.balance.toLocaleString()}</span>
      </div>
                `
                  )
                  .join("")}
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-top: 2px solid #3498db; font-weight: bold; color: #3498db;">
                  <span>Total Equity</span>
                  <span>$${company.trialBalance.totals.totalEquity.toLocaleString()}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `
        )
        .join("")}
    `;
        } catch (error) {
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c;">
        <h3>Error Loading Trial Balance</h3>
        <p>${error.message}</p>
      </div>
    `;
        }
      }

      async function loadCashFlowData() {
        if (activeCompanyFilters.length === 0) {
          const dashboardElement = document.getElementById("dashboardData");
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #666;">
        <h3>No Companies Selected</h3>
        <p>Please select companies using the filters above to view cash flow.</p>
      </div>
    `;
          return;
        }

        const dashboardElement = document.getElementById("dashboardData");
        dashboardElement.innerHTML = `
    <div class="loading">
      <div class="loading-spinner"></div>
      Loading cash flow data...
    </div>
  `;

        try {
          const cashData = [];

          for (const tenantId of activeCompanyFilters) {
            const connectedCompany = connectedCompanies.find(
              (c) => c.tenantId === tenantId
            );
            if (!connectedCompany) continue;

            const orgName = getOrganizationName(connectedCompany.tenantName);

            const response = await fetch("/api/cash-position", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ organizationName: orgName }),
            });

            if (response.ok) {
              const data = await response.json();
              cashData.push({
                companyName: connectedCompany.tenantName.replace(
                  "Rirratjingu ",
                  ""
                ),
                ...data,
              });
            }
          }

          const totalCash = cashData.reduce(
            (sum, company) => sum + company.totalCash,
            0
          );

          dashboardElement.innerHTML = `
      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h3>Consolidated Cash Position</h3>
          <div class="metric">
            <span>Total Cash Across All Entities</span>
            <span class="metric-value">$${totalCash.toLocaleString()}</span>
          </div>
          <div class="metric">
            <span>Companies Analyzed</span>
            <span class="metric-value">${cashData.length}</span>
          </div>
        </div>
      </div>

      ${cashData
        .map(
          (company) => `
        <div class="dashboard-card">
          <h3>${company.companyName} - Bank Accounts</h3>
          <div style="margin-bottom: 15px;">
            <strong>Total Cash:</strong> $${company.totalCash.toLocaleString()}
          </div>
          
          ${
            company.bankAccounts.length > 0
              ? `
            <div style="max-height: 400px; overflow-y: auto;">
              ${company.bankAccounts
                .map(
                  (account) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                  <div>
                    <div style="font-weight: 600;">${account.name}</div>
                    <div style="font-size: 12px; color: #666;">Code: ${
                      account.code
                    }</div>
                  </div>
                  <div style="font-weight: 600; text-align: right;">
                    $${account.balance.toLocaleString()}
                  </div>
                </div>
              `
                )
                .join("")}
            </div>
          `
              : `
            <div style="text-align: center; padding: 20px; color: #666;">
              No bank accounts found
            </div>
          `
          }
        </div>
      `
        )
        .join("")}
    `;
        } catch (error) {
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c;">
        <h3>Error Loading Cash Flow Data</h3>
        <p>${error.message}</p>
      </div>
    `;
        }
      }

      async function loadProfitLossData() {
        if (activeCompanyFilters.length === 0) {
          const dashboardElement = document.getElementById("dashboardData");
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #666;">
        <h3>No Companies Selected</h3>
        <p>Please select companies using the filters above to view P&L.</p>
      </div>
    `;
          return;
        }

        const dashboardElement = document.getElementById("dashboardData");
        dashboardElement.innerHTML = `
    <div class="loading">
      <div class="loading-spinner"></div>
      Loading profit & loss data...
    </div>
  `;

        try {
          const plData = [];

          for (const tenantId of activeCompanyFilters) {
            const connectedCompany = connectedCompanies.find(
              (c) => c.tenantId === tenantId
            );
            if (!connectedCompany) continue;

            const orgName = getOrganizationName(connectedCompany.tenantName);

            const response = await fetch("/api/profit-loss-summary", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ organizationName: orgName }),
            });

            if (response.ok) {
              const data = await response.json();
              plData.push({
                companyName: connectedCompany.tenantName.replace(
                  "Rirratjingu ",
                  ""
                ),
                ...data,
              });
            }
          }

          const consolidated = plData.reduce(
            (acc, company) => {
              acc.totalRevenue += company.summary.totalRevenue;
              acc.totalExpenses += company.summary.totalExpenses;
              acc.netProfit += company.summary.netProfit;
              return acc;
            },
            { totalRevenue: 0, totalExpenses: 0, netProfit: 0 }
          );

          dashboardElement.innerHTML = `
      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h3>Consolidated P&L Summary</h3>
          <div class="metric">
            <span>Total Revenue</span>
            <span class="metric-value">$${consolidated.totalRevenue.toLocaleString()}</span>
          </div>
          <div class="metric">
            <span>Total Expenses</span>
            <span class="metric-value">$${consolidated.totalExpenses.toLocaleString()}</span>
          </div>
          <div class="metric">
            <span>Net Profit</span>
            <span class="metric-value ${
              consolidated.netProfit >= 0 ? "" : "negative"
            }">
              $${consolidated.netProfit.toLocaleString()}
            </span>
          </div>
          <div class="metric">
            <span>Profit Margin</span>
            <span class="metric-value">
              ${
                consolidated.totalRevenue > 0
                  ? (
                      (consolidated.netProfit / consolidated.totalRevenue) *
                      100
                    ).toFixed(1)
                  : 0
              }%
            </span>
          </div>
        </div>
      </div>

      ${plData
        .map(
          (company) => `
        <div class="dashboard-card">
          <h3>${company.companyName} - Profit & Loss</h3>
          <div style="margin-bottom: 15px;">
            <strong>Period:</strong> ${company.period.from} to ${
            company.period.to
          }
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <h4>Revenue (${
                company.summary.revenueAccounts.length
              } accounts)</h4>
              ${company.summary.revenueAccounts
                .slice(0, 10)
                .map(
                  (account) => `
                <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                  <span style="font-size: 13px;">${account.name}</span>
                  <span style="font-weight: 600;">$${account.amount.toLocaleString()}</span>
                </div>
              `
                )
                .join("")}
              <div style="border-top: 2px solid #27ae60; padding: 8px 0; font-weight: bold; color: #27ae60;">
                Total Revenue: $${company.summary.totalRevenue.toLocaleString()}
              </div>
            </div>

            <div>
              <h4>Expenses (${
                company.summary.expenseAccounts.length
              } accounts)</h4>
              ${company.summary.expenseAccounts
                .slice(0, 10)
                .map(
                  (account) => `
                <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                  <span style="font-size: 13px;">${account.name}</span>
                  <span style="font-weight: 600;">$${account.amount.toLocaleString()}</span>
                </div>
              `
                )
                .join("")}
              <div style="border-top: 2px solid #e74c3c; padding: 8px 0; font-weight: bold; color: #e74c3c;">
                Total Expenses: $${company.summary.totalExpenses.toLocaleString()}
              </div>
            </div>
          </div>

          <div style="margin-top: 15px; padding: 15px; background: ${
            company.summary.netProfit >= 0 ? "#f8fff8" : "#fff8f8"
          }; border-radius: 6px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-weight: bold; font-size: 16px;">Net Profit:</span>
              <span style="font-weight: bold; font-size: 18px; color: ${
                company.summary.netProfit >= 0 ? "#27ae60" : "#e74c3c"
              };">
                $${company.summary.netProfit.toLocaleString()}
              </span>
            </div>
            <div style="margin-top: 5px;">
              <span>Profit Margin: ${(
                (company.summary.netProfit / company.summary.totalRevenue) *
                100
              ).toFixed(1)}%</span>
            </div>
          </div>
        </div>
      `
        )
        .join("")}
    `;
        } catch (error) {
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c;">
        <h3>Error Loading P&L Data</h3>
        <p>${error.message}</p>
      </div>
    `;
        }
      }

      async function loadAlertsData() {
        if (activeCompanyFilters.length === 0) {
          const dashboardElement = document.getElementById("dashboardData");
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #666;">
        <h3>No Companies Selected</h3>
        <p>Please select companies using the filters above to view alerts.</p>
      </div>
    `;
          return;
        }

        const dashboardElement = document.getElementById("dashboardData");
        dashboardElement.innerHTML = `
    <div class="loading">
      <div class="loading-spinner"></div>
      Analyzing financial data for alerts...
    </div>
  `;

        try {
          const alerts = [];

          // Check each selected company for issues
          for (const tenantId of activeCompanyFilters) {
            const connectedCompany = connectedCompanies.find(
              (c) => c.tenantId === tenantId
            );
            if (!connectedCompany) continue;

            const orgName = getOrganizationName(connectedCompany.tenantName);

            // Get multiple data points for comprehensive alerts
            const [tbResponse, cashResponse, ratiosResponse] =
              await Promise.all([
                fetch("/api/trial-balance", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ organizationName: orgName }),
                }).catch(() => null),
                fetch("/api/cash-position", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ organizationName: orgName }),
                }).catch(() => null),
                fetch("/api/financial-ratios", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ organizationName: orgName }),
                }).catch(() => null),
              ]);

            const companyName = connectedCompany.tenantName.replace(
              "Rirratjingu ",
              ""
            );

            // Parse responses
            const tbData =
              tbResponse && tbResponse.ok ? await tbResponse.json() : null;
            const cashData =
              cashResponse && cashResponse.ok
                ? await cashResponse.json()
                : null;
            const ratiosData =
              ratiosResponse && ratiosResponse.ok
                ? await ratiosResponse.json()
                : null;

            // Check for trial balance issues
            if (tbData && !tbData.balanceCheck.debitsEqualCredits) {
              alerts.push({
                type: "critical",
                company: companyName,
                title: "Trial Balance Imbalance",
                message: `Books are out of balance by $${Math.abs(
                  tbData.balanceCheck.difference
                ).toLocaleString()}`,
                action: "Review journal entries and account reconciliations",
              });
            }

            // Check for cash flow concerns
            if (
              cashData &&
              cashData.totalCash === 0 &&
              cashData.bankAccounts.length > 0
            ) {
              alerts.push({
                type: "warning",
                company: companyName,
                title: "Zero Cash Position",
                message: `${cashData.bankAccounts.length} bank accounts but $0 total cash`,
                action: "Verify bank account balances and connectivity",
              });
            }

            // Check financial ratios for concerning trends
            if (ratiosData) {
              const currentRatio =
                ratiosData.ratios?.liquidity?.currentRatio || 0;
              const debtToEquity =
                ratiosData.ratios?.leverage?.debtToEquity || 0;
              const profitMargin =
                ratiosData.ratios?.profitability?.netProfitMargin || 0;

              if (currentRatio < 1.0 && currentRatio > 0) {
                alerts.push({
                  type: "warning",
                  company: companyName,
                  title: "Low Liquidity Ratio",
                  message: `Current ratio of ${currentRatio.toFixed(
                    2
                  )} indicates potential cash flow issues`,
                  action: "Review accounts payable and receivable timing",
                });
              }

              if (debtToEquity > 2.0) {
                alerts.push({
                  type: "warning",
                  company: companyName,
                  title: "High Debt-to-Equity Ratio",
                  message: `Debt-to-equity ratio of ${debtToEquity.toFixed(
                    2
                  )} may indicate overleveraging`,
                  action: "Consider debt reduction strategies",
                });
              }

              if (profitMargin < -10) {
                alerts.push({
                  type: "critical",
                  company: companyName,
                  title: "Negative Profit Margin",
                  message: `Profit margin of ${profitMargin.toFixed(
                    1
                  )}% indicates significant losses`,
                  action:
                    "Urgent review of operations and cost structure needed",
                });
              }
            }

            // Check for data loading errors
            if (!tbData && !cashData && !ratiosData) {
              alerts.push({
                type: "info",
                company: companyName,
                title: "Data Connection Issues",
                message: "Unable to load financial data for analysis",
                action: "Check Xero connection and token status",
              });
            }
          }

          // Add system-wide alerts
          try {
            const tokenResponse = await fetch("/api/token-status");
            if (tokenResponse.ok) {
              const tokenStatus = await tokenResponse.json();
              if (tokenStatus.expiringTokens > 0) {
                alerts.push({
                  type: "warning",
                  company: "System",
                  title: "OAuth Token Expiry",
                  message: `${tokenStatus.expiringTokens} token(s) expiring soon`,
                  action: "Refresh OAuth connections to maintain data access",
                });
              }
            }
          } catch (error) {
            // Token status check failed, add alert
            alerts.push({
              type: "info",
              company: "System",
              title: "Token Status Unknown",
              message: "Unable to check OAuth token expiry status",
              action: "Monitor connection stability",
            });
          }

          // Render alerts dashboard
          const criticalAlerts = alerts.filter((a) => a.type === "critical");
          const warningAlerts = alerts.filter((a) => a.type === "warning");
          const infoAlerts = alerts.filter((a) => a.type === "info");

          dashboardElement.innerHTML = `
      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h3>Alert Summary</h3>
          <div class="metric">
            <span>Critical Issues</span>
            <span class="metric-value ${
              criticalAlerts.length > 0 ? "negative" : ""
            }">${criticalAlerts.length}</span>
          </div>
          <div class="metric">
            <span>Warnings</span>
            <span class="metric-value">${warningAlerts.length}</span>
          </div>
          <div class="metric">
            <span>Information</span>
            <span class="metric-value">${infoAlerts.length}</span>
          </div>
          <div class="metric">
            <span>Overall Status</span>
            <span class="metric-value ${
              criticalAlerts.length > 0
                ? "negative"
                : warningAlerts.length > 0
                ? ""
                : ""
            }">
              ${
                criticalAlerts.length > 0
                  ? "🔴 Critical"
                  : warningAlerts.length > 0
                  ? "🟡 Caution"
                  : "🟢 Healthy"
              }
            </span>
          </div>
        </div>
      </div>

      <div class="dashboard-card">
        <h3>Financial Alerts & Recommendations</h3>
        
        ${
          alerts.length === 0
            ? `
          <div style="text-align: center; padding: 40px; color: #27ae60;">
            <h4>🟢 All Systems Healthy</h4>
            <p>No financial alerts detected for the selected companies.</p>
          </div>
        `
            : alerts
                .map(
                  (alert) => `
          <div style="padding: 15px; margin: 10px 0; border-radius: 6px; border-left: 4px solid ${
            alert.type === "critical"
              ? "#e74c3c"
              : alert.type === "warning"
              ? "#f39c12"
              : "#3498db"
          }; background: ${
                    alert.type === "critical"
                      ? "#fff5f5"
                      : alert.type === "warning"
                      ? "#fffdf5"
                      : "#f8fffe"
                  };">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
              <div>
                <strong style="color: ${
                  alert.type === "critical"
                    ? "#c0392b"
                    : alert.type === "warning"
                    ? "#d68910"
                    : "#2471a3"
                };">
                  ${
                    alert.type === "critical"
                      ? "🔴"
                      : alert.type === "warning"
                      ? "🟡"
                      : "🔵"
                  } 
                  ${alert.title}
                </strong>
                <div style="font-size: 12px; color: #666; margin-top: 2px;">${
                  alert.company
                }</div>
              </div>
              <span style="background: ${
                alert.type === "critical"
                  ? "#e74c3c"
                  : alert.type === "warning"
                  ? "#f39c12"
                  : "#3498db"
              }; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; text-transform: uppercase;">
                ${alert.type}
              </span>
            </div>
            <div style="color: #333; margin-bottom: 8px;">${alert.message}</div>
            <div style="color: #666; font-size: 13px; font-style: italic;">
              <strong>Recommended Action:</strong> ${alert.action}
            </div>
          </div>
        `
                )
                .join("")
        }
      </div>
    `;
        } catch (error) {
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c;">
        <h3>Error Loading Alerts</h3>
        <p>Failed to analyze financial data: ${error.message}</p>
        <button onclick="loadDashboardData()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Retry
        </button>
      </div>
    `;
        }
      }

      function setView(view, button) {
        currentView = view;

        // Update active button
        document
          .querySelectorAll(".toolbar button")
          .forEach((btn) => btn.classList.remove("active"));
        button.classList.add("active");

        // Reload dashboard data for new view
        loadDashboardData();
      }

      function backToConnections() {
        if (
          confirm(
            "Return to connection manager? This will allow you to modify your company connections."
          )
        ) {
          document.getElementById("mainDashboard").style.display = "none";
          document.getElementById("connectionManager").style.display = "block";

          // Reset to step 1
          document.getElementById("step1").style.display = "block";
          document.getElementById("step2").style.display = "none";
          document.getElementById("step3").style.display = "none";

          document.getElementById("step1Indicator").className = "step active";
          document.getElementById("step2Indicator").className = "step";
          document.getElementById("step3Indicator").className = "step";

          loadSavedPreferences();
        }
      }

      // ====== RESIZER FUNCTIONALITY ======

      function initializeResizer() {
        let isResizing = false;

        document
          .querySelector(".resizer")
          .addEventListener("mousedown", function (e) {
            isResizing = true;
            document.addEventListener("mousemove", handleMouseMove);
            document.addEventListener("mouseup", function () {
              isResizing = false;
              document.removeEventListener("mousemove", handleMouseMove);
            });
          });

        function handleMouseMove(e) {
          if (!isResizing) return;

          const container = document.querySelector(".main-container");
          const containerRect = container.getBoundingClientRect();
          const percentage =
            ((e.clientX - containerRect.left) / containerRect.width) * 100;

          if (percentage > 20 && percentage < 80) {
            document.querySelector(".ai-chat-panel").style.width =
              percentage + "%";
            document.querySelector(".dashboard-panel").style.width =
              100 - percentage + "%";
            document.querySelector(".resizer").style.left = percentage + "%";
          }
        }
      }

      // ====== INITIALIZATION ======

      async function initializePage() {
        handleOAuthReturn();

        if (localStorage.getItem("oauthCompanies")) {
          return;
        }

        try {
          const response = await fetch("/api/connection-status");
          const connections = await response.json();
          const connectedCount = connections.filter(
            (conn) => conn.connected
          ).length;

          if (connectedCount > 0) {
            document.getElementById("connectionManager").style.display = "none";
            document.getElementById("mainDashboard").style.display = "block";
            initializeMainDashboard();
          } else {
            document.getElementById("connectionManager").style.display =
              "block";
            document.getElementById("mainDashboard").style.display = "none";
            loadSavedPreferences();
          }
        } catch (error) {
          document.getElementById("connectionManager").style.display = "block";
          document.getElementById("mainDashboard").style.display = "none";
          loadSavedPreferences();
        }
      }

      // ====== EVENT LISTENERS ======

      document.addEventListener("DOMContentLoaded", function () {
        initializePage();
      });

      window.addEventListener("popstate", handleOAuthReturn);
    </script>
  </body>
</html>
